<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-快速教程-SpringBoot-WebFlux-快速入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/03/%E5%BF%AB%E9%80%9F%E6%95%99%E7%A8%8B-SpringBoot-WebFlux-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-03T06:29:57.000Z" itemprop="datePublished">2020-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/03/%E5%BF%AB%E9%80%9F%E6%95%99%E7%A8%8B-SpringBoot-WebFlux-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">快速教程-SpringBoot-WebFlux-快速入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="WebFlux-快速入门"><a href="#WebFlux-快速入门" class="headerlink" title="WebFlux 快速入门"></a>WebFlux 快速入门</h1><h2 id="1-Spring-Boot-2-0-WebFlux"><a href="#1-Spring-Boot-2-0-WebFlux" class="headerlink" title="1. Spring Boot 2.0 WebFlux"></a>1. Spring Boot 2.0 WebFlux</h2><p>了解 WebFlux ,首先了解下什么是 Reactive Streams。Reactive Streams 是 JVM 中面向流的库标准和规范：</p>
<ul>
<li>处理可能无限数量的元素</li>
<li>按顺序处理</li>
<li>组件之间异步传递</li>
<li>强制性非阻塞背压（Backpressure）</li>
</ul>
<h3 id="1-1-Backpressure-背压"><a href="#1-1-Backpressure-背压" class="headerlink" title="1.1 Backpressure(背压)"></a>1.1 <strong>Backpressure(背压)</strong></h3><p>背压是一种常用策略，使得发布者拥有无限制的缓冲区存储元素，用于确保发布者发布元素太快时，不会去压制订阅者。</p>
<h3 id="1-2-Reactive-Streams（响应式流）"><a href="#1-2-Reactive-Streams（响应式流）" class="headerlink" title="1.2 Reactive Streams（响应式流）"></a>1.2 <strong>Reactive Streams（响应式流）</strong></h3><p>一般由以下组成：</p>
<ul>
<li>发布者：发布元素到订阅者</li>
<li>订阅者：消费元素</li>
<li>订阅：在发布者中，订阅被创建时，将与订阅者共享</li>
<li>处理器：发布者与订阅者之间处理数据</li>
</ul>
<h3 id="1-3-响应式编程"><a href="#1-3-响应式编程" class="headerlink" title="1.3 响应式编程"></a>1.3 <strong>响应式编程</strong></h3><p>有了 Reactive Streams 这种标准和规范，利用规范可以进行响应式编程。那再了解下什么是 Reactive programming 响应式编程。响应式编程是基于异步和事件驱动的非阻塞程序，只是垂直通过在 JVM 内启动少量线程扩展，而不是水平通过集群扩展。这就是一个编程范例，具体项目中如何体现呢？</p>
<p>响应式项目编程实战中，通过基于 Reactive Streams 规范实现的框架 Reactor 去实战。Reactor 一般提供两种响应式 API ：</p>
<ul>
<li>Mono：实现发布者，并返回 0 或 1 个元素</li>
<li>Flux：实现发布者，并返回 N 个元素</li>
</ul>
<h3 id="1-4-Spring-Webflux"><a href="#1-4-Spring-Webflux" class="headerlink" title="1.4 Spring Webflux"></a>1.4 <strong>Spring Webflux</strong></h3><p>Spring Boot Webflux 就是基于 Reactor 实现的。Spring Boot 2.0 包括一个新的 spring-webflux 模块。该模块包含对响应式 HTTP 和 WebSocket 客户端的支持，以及对 REST，HTML 和 WebSocket 交互等程序的支持。一般来说，Spring MVC 用于同步处理，Spring Webflux 用于异步处理。</p>
<p>Spring Boot Webflux 有两种编程模型实现，一种类似 Spring MVC 注解方式，另一种是使用其功能性端点方式。</p>
<h2 id="2-Spring-Boot-2-0-WebFlux-特性"><a href="#2-Spring-Boot-2-0-WebFlux-特性" class="headerlink" title="2. Spring Boot 2.0 WebFlux 特性"></a>2. Spring Boot 2.0 WebFlux 特性</h2><p>常用的 Spring Boot 2.0 WebFlux 生产的特性如下：</p>
<ul>
<li>响应式 API</li>
<li>编程模型</li>
<li>适用性</li>
<li>内嵌容器</li>
<li>Starter 组件</li>
</ul>
<p>还有对日志、Web、消息、测试及扩展等支持。</p>
<h3 id="2-1-响应式-API"><a href="#2-1-响应式-API" class="headerlink" title="2.1 响应式 API"></a>2.1 响应式 API</h3><p>Reactor 框架是 Spring Boot Webflux 响应库依赖，通过 Reactive Streams 并与其他响应库交互。提供了 两种响应式 API : Mono 和 Flux。一般是将 Publisher 作为输入，在框架内部转换成 Reactor 类型并处理逻辑，然后返回 Flux 或 Mono 作为输出。</p>
<h3 id="2-2-适用性"><a href="#2-2-适用性" class="headerlink" title="2.2 适用性"></a>2.2 适用性</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gff3pfhcatj30mf0cgtf4.jpg" alt="image-20200603144913693"></p>
<p>一图就很明确了，WebFlux 和 MVC 有交集，方便大家迁移。但是注意：</p>
<ul>
<li>MVC 能满足场景的，就不需要更改为 WebFlux。</li>
<li>要注意容器的支持，可以看看下面内嵌容器的支持。</li>
<li>微服务体系结构，WebFlux 和 MVC 可以混合使用。尤其开发 IO 密集型服务的时候，选择 WebFlux 去实现。</li>
</ul>
<h3 id="2-3-编程模型"><a href="#2-3-编程模型" class="headerlink" title="2.3 编程模型"></a>2.3 编程模型</h3><p>Spring 5 web 模块包含了 Spring WebFlux 的 HTTP 抽象。类似 Servlet API , WebFlux 提供了 WebHandler API 去定义非阻塞 API 抽象接口。可以选择以下两种编程模型实现：</p>
<ul>
<li>注解控制层。和 MVC 保持一致，WebFlux 也支持响应性 @RequestBody 注解。</li>
<li>功能性端点。基于 lambda 轻量级编程模型，用来路由和处理请求的小工具。和上面最大的区别就是，这种模型，全程控制了请求 – 响应的生命流程</li>
</ul>
<h3 id="2-4-内嵌容器"><a href="#2-4-内嵌容器" class="headerlink" title="2.4 内嵌容器"></a>2.4 内嵌容器</h3><p>跟 Spring Boot 大框架一样启动应用，但 WebFlux 默认是通过 Netty 启动，并且自动设置了默认端口为 8080。另外还提供了对 Jetty、Undertow 等容器的支持。开发者自行在添加对应的容器 Starter 组件依赖，即可配置并使用对应内嵌容器实例。</p>
<p>但是要注意，必须是 Servlet 3.1+ 容器，如 Tomcat、Jetty；或者非 Servlet 容器，如 Netty 和 Undertow。</p>
<h3 id="2-5-Starter-组件"><a href="#2-5-Starter-组件" class="headerlink" title="2.5 Starter 组件"></a>2.5 Starter 组件</h3><p>跟 Spring Boot 大框架一样，Spring Boot Webflux 提供了很多 “开箱即用” 的 Starter 组件。Starter 组件是可被加载在应用中的 Maven 依赖项。只需要在 Maven 配置中添加对应的依赖配置，即可使用对应的 Starter 组件。例如，添加 <code>spring-boot-starter-webflux</code> 依赖，就可用于构建响应式 API 服务，其包含了 Web Flux 和 Tomcat 内嵌容器等。</p>
<h2 id="3-Spring-Boot-2-0-WebFlux-组件"><a href="#3-Spring-Boot-2-0-WebFlux-组件" class="headerlink" title="3. Spring Boot 2.0 WebFlux 组件"></a>3. Spring Boot 2.0 WebFlux 组件</h2><p>Spring Boot WebFlux 官方提供了很多 Starter 组件，每个模块会有多种技术实现选型支持，来实现各种复杂的业务需求：</p>
<ul>
<li>Web：Spring WebFlux</li>
<li>模板引擎：Thymeleaf</li>
<li>存储：Redis、MongoDB、Cassandra。不支持 MySQL</li>
<li>内嵌容器：Tomcat、Jetty、Undertow</li>
</ul>
<h2 id="4-快速入门"><a href="#4-快速入门" class="headerlink" title="4. 快速入门"></a>4. 快速入门</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>spring-boot-starter-webflux 依赖，是核心需要学习 webflux 的包，里面默认包含了 spring-boot-starter-reactor-netty 、spring 5 webflux 包。也就是说默认是通过 netty 启动的。</p>
<p>reactor-test、spring-boot-starter-test 两个依赖搭配是用于单元测试。</p>
<p>spring-boot-maven-plugin 是 Spring Boot Maven 插件，可以运行、编译等调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.BodyInserters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.ServerRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.ServerResponse;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CityHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">helloCity</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.ok().contentType(MediaType.TEXT_PLAIN)</span><br><span class="line">                .body(BodyInserters.fromObject(<span class="string">"Hello, City!"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServerResponse 是对响应的封装，可以设置响应状态，响应头，响应正文。比如 ok 代表的是 200 响应码、MediaType 枚举是代表这文本内容类型、返回的是 String 的对象。</p>
<p>这里用 Mono 作为返回对象，是因为返回包含了一个 ServerResponse 对象，而不是多个元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.spring.springboot.handler.CityHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.RequestPredicates;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.RouterFunction;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.RouterFunctions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.ServerResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CityRouter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title">routeCity</span><span class="params">(CityHandler cityHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RouterFunctions</span><br><span class="line">                .route(RequestPredicates.GET(<span class="string">"/hello"</span>)</span><br><span class="line">                                .and(RequestPredicates.accept(MediaType.TEXT_PLAIN)),</span><br><span class="line">                        cityHandler::helloCity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/03/%E5%BF%AB%E9%80%9F%E6%95%99%E7%A8%8B-SpringBoot-WebFlux-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" data-id="ckbg9kucu001c2r0746hj9khz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-02/" rel="tag">Spring Boot-基础-02</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebFlux/" rel="tag">WebFlux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Web开发-SprintBoot-Tomcat-Jetty-Undertow-基准测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/03/Web%E5%BC%80%E5%8F%91-SprintBoot-Tomcat-Jetty-Undertow-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2020-06-03T03:38:59.000Z" itemprop="datePublished">2020-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/03/Web%E5%BC%80%E5%8F%91-SprintBoot-Tomcat-Jetty-Undertow-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/">Web开发-SprintBoot-Tomcat-Jetty-Undertow-基准测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="性能测试——-Tomcat、Jetty、Undertow-基准测试"><a href="#性能测试——-Tomcat、Jetty、Undertow-基准测试" class="headerlink" title="性能测试—— Tomcat、Jetty、Undertow 基准测试"></a>性能测试—— Tomcat、Jetty、Undertow 基准测试</h1><h2 id="1-测试环境"><a href="#1-测试环境" class="headerlink" title="1. 测试环境"></a>1. 测试环境</h2><p>JVM 本身有<a href="https://codeday.me/bug/20180203/128666.html" target="_blank" rel="noopener">预热</a>的过程，Tomcat、Jetty、Undertow 本也有预热的过程（例如说，线程的初始化），所以需要多次测试，取平均值。</p>
<p>本文，使用 wrk 如下命令进行测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./wrk -t50 -c400 -d30s http://127.0.0.1:8080</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-t50</code> 参数，设置 50 并发线程。</li>
<li><code>-c400</code> 参数，设置 400 连接。</li>
<li><code>-d30s</code> 参数，设置执行 30s 的时长的 HTTP 请求。</li>
<li><code>http://127.0.0.1:8080</code> 参数，请求本地的 Web 服务。</li>
</ul>
<h2 id="2-Tomcat-NIO"><a href="#2-Tomcat-NIO" class="headerlink" title="2. Tomcat NIO"></a>2. Tomcat NIO</h2><p>Tomcat 一共分成三种模式：</p>
<ul>
<li>BIO (blocking I/O)模式：阻塞式 I/O 操作，表示 Tomcat 使用的是传统的 Java I/O 操作（即 <code>java.io</code> 包）。在 Tomcat 7 以及以前版本，默认使用 BIO 模式运行。一般情况下，BIO 模式是三种运行模式中性能最低的。</li>
<li>NIO (Non-blocking I/O)模式：非阻塞时 I/O 操作，表示 Tomcat 使用的是 JDK 1.4 后新提供的 I/O 操作（即 <code>java.nio</code> 包）。在 Tomcat 8 以及到目前最新版本的 Tomcat 9 ，默认使用的都是 NIO 模式运行。相比 BIO 模式来说，它能提供更好的并发性能。</li>
<li>APR (Apache Portable Runtime/Apache 可移植运行库) 模式：APR 是 <a href="https://httpd.apache.org/" target="_blank" rel="noopener">Apache</a> HTTP 服务器的支持库。可以理解成，Tomcat 将以 <a href="https://zh.wikipedia.org/zh-hans/Java本地接口" target="_blank" rel="noopener">JNI</a> 的方式，调用 Apache HTTP 服务器的核心动态链接库来处理文件或网络传输，从而大大的提升 Tomcat 对静态文件的处理性能。Tomcat APR 模式，也是 Tomcat 上运行高并发应用的首选模式。</li>
</ul>
<p>启动 Tomcat 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar lab-05-tomcat-1.0-SNAPSHOT.jar -Xms2g -Xmx2g -Xmn1g -XX:MaxMetaspaceSize=256m -Xss256k</span><br></pre></td></tr></table></figure>

<p>执行 wrk 进行性能测试，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./wrk -t50 -c400 -d30s http://127.0.0.1:8080/hello</span></span><br><span class="line"></span><br><span class="line">Running 30s test @ http://127.0.0.1:8080/hello</span><br><span class="line">  50 threads and 400 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    13.81ms    7.09ms 159.52ms   86.27%</span><br><span class="line">    Req/Sec   594.55     62.11     1.98k    78.31%</span><br><span class="line">  890078 requests in 30.09s, 100.32MB read</span><br><span class="line">Requests/sec:  29575.99</span><br><span class="line">Transfer/sec:      3.33MB</span><br></pre></td></tr></table></figure>

<ul>
<li>QPS 为 29575.99 。</li>
<li>平均延迟为 13.81ms。</li>
</ul>
<h2 id="3-Tomcat-APR"><a href="#3-Tomcat-APR" class="headerlink" title="3. Tomcat APR"></a>3. Tomcat APR</h2><ol>
<li><p>安装 APR 。</p>
<p><em>Apache Portable Runtime/Apache 可移植运行库</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install apr-devel -f</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 Tomcat Native 。</p>
<p><em>Tomcat 将以 JNI 的方式调用 APR 的实现库</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install tomcat-native</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置 Tomcat 使用 APR 。</p>
</li>
</ol>
<p>启动 Tomcat 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar lab-05-tomcat-1.0-SNAPSHOT.jar -Xms2g -Xmx2g -Xmn1g -XX:MaxMetaspaceSize=256m -Xss256k</span><br></pre></td></tr></table></figure>

<p>执行 wrk 进行性能测试，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./wrk -t50 -c400 -d30s http://127.0.0.1:8080</span></span><br><span class="line"></span><br><span class="line">Running 30s test @ http://127.0.0.1:8080/hello</span><br><span class="line">  50 threads and 400 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    12.15ms    5.12ms 229.46ms   87.59%</span><br><span class="line">    Req/Sec   667.77     62.65     2.01k    80.34%</span><br><span class="line">  999673 requests in 30.10s, 112.67MB read</span><br><span class="line">Requests/sec:  33213.47</span><br><span class="line">Transfer/sec:      3.74MB</span><br></pre></td></tr></table></figure>

<ul>
<li>QPS 为 33213.47 。</li>
<li>平均延迟为 12.15ms。</li>
</ul>
<p>相比 Tomcat NIO 模式，大概有 3500 QPS 左右的提升，12% 左右的性能提升。</p>
<h2 id="4-Jetty"><a href="#4-Jetty" class="headerlink" title="4. Jetty"></a>4. Jetty</h2><p>启动 Jetty 容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar lab-05-jetty-apr-1.0-SNAPSHOT.jar -Xms2g -Xmx2g -Xmn1g -XX:MaxMetaspaceSize=256m -Xss256k</span><br></pre></td></tr></table></figure>

<p>执行 wrk 进行性能测试，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./wrk -t50 -c400 -d30s http://127.0.0.1:8080</span></span><br><span class="line"></span><br><span class="line">Running 30s test @ http://127.0.0.1:8080/hello</span><br><span class="line">  50 threads and 400 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     9.61ms    4.82ms 110.04ms   73.24%</span><br><span class="line">    Req/Sec   849.00    167.82     5.16k    87.43%</span><br><span class="line">  1270290 requests in 30.11s, 145.37MB read</span><br><span class="line">Requests/sec:  42193.37</span><br><span class="line">Transfer/sec:      4.83MB</span><br></pre></td></tr></table></figure>

<ul>
<li>QPS 为 42193.37 。</li>
<li>平均延迟为 9.61ms 毫秒。</li>
</ul>
<p>相比 Tomcat NIO 模式，大概有 12617.38 QPS 提升，43% 左右的性能提升。</p>
<h2 id="5-Undertow"><a href="#5-Undertow" class="headerlink" title="5. Undertow"></a>5. Undertow</h2><p>启动 Undertow 服务器:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar lab-05-undertow-1.0.0.jar -Xms2g -Xmx2g -Xmn1g -XX:MaxMetaspaceSize=256m -Xss256k</span><br></pre></td></tr></table></figure>

<p>执行 wrk 进行性能测试，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./wrk -t50 -c400 -d30s http://127.0.0.1:8080</span></span><br><span class="line"></span><br><span class="line">Running 30s test @ http://127.0.0.1:8080/hello</span><br><span class="line">  50 threads and 400 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    10.09ms    4.36ms 207.32ms   74.34%</span><br><span class="line">    Req/Sec   802.76     99.60     2.16k    73.54%</span><br><span class="line">  1198795 requests in 30.10s, 164.63MB read</span><br><span class="line">Requests/sec:  39822.02</span><br><span class="line">Transfer/sec:      5.47MB</span><br></pre></td></tr></table></figure>

<ul>
<li>QPS 为 39822.02 。</li>
<li>平均延迟为 18.46 毫秒。</li>
</ul>
<p>相比 Tomcat NIO 模式，大概有 10246.03 QPS 提升，34% 左右的性能提升。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/03/Web%E5%BC%80%E5%8F%91-SprintBoot-Tomcat-Jetty-Undertow-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" data-id="ckbg9kucw001f2r07dyeqhsc6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jetty/" rel="tag">Jetty</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Undertow/" rel="tag">Undertow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" rel="tag">基准测试</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Web开发-SpringBoot-WebSocket入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/03/Web%E5%BC%80%E5%8F%91-SpringBoot-WebSocket%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-03T02:21:29.000Z" itemprop="datePublished">2020-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/03/Web%E5%BC%80%E5%8F%91-SpringBoot-WebSocket%E5%85%A5%E9%97%A8/">Web开发-SpringBoot-WebSocket入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-WebSocket-入门"><a href="#Spring-Boot-WebSocket-入门" class="headerlink" title="Spring Boot WebSocket 入门"></a>Spring Boot WebSocket 入门</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>WebSocket 协议<strong>重点</strong>是提供了服务端主动向客户端发送数据的能力，这样就可以完成<strong>实时性</strong>较高的需求。</p>
<p>在实现提供 WebSocket 服务的项目中，一般有如下几种解决方案：</p>
<ul>
<li>方案一 <a href="https://docs.spring.io/spring-framework/docs/5.0.0.BUILD-SNAPSHOT/spring-framework-reference/html/websocket.html" target="_blank" rel="noopener">Spring WebSocket</a></li>
<li>方案二 <a href="https://www.cnblogs.com/xdp-gacl/p/5193279.html" target="_blank" rel="noopener">Tomcat WebSocket</a></li>
<li>方案三 <a href="https://netty.io/news/2012/11/15/websocket-enhancement.html" target="_blank" rel="noopener">Netty WebSocket</a></li>
</ul>
<h2 id="2-Tomcat-WebSocket-快速入门"><a href="#2-Tomcat-WebSocket-快速入门" class="headerlink" title="2. Tomcat WebSocket 快速入门"></a>2. Tomcat WebSocket 快速入门</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 实现对 WebSocket 相关依赖的引入，方便~ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 引入 Fastjson ，实现对 JSON 的序列化，因为后续我们会使用它解析消息 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.62<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>定义 Websocket 服务的端点（EndPoint）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@ServerEndpoint</span>(<span class="string">"/"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketServerEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(Session session, EndpointConfig config)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[onOpen][session(&#123;&#125;) 接入]"</span>, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Session session, String message)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[onOpen][session(&#123;&#125;) 接收到一条消息(&#123;&#125;)]"</span>, session, message); <span class="comment">// 生产环境下，请设置成 debug 级别</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(Session session, CloseReason closeReason)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[onClose][session(&#123;&#125;) 连接关闭。关闭原因是(&#123;&#125;)&#125;]"</span>, session, closeReason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Session session, Throwable throwable)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[onClose][session(&#123;&#125;) 发生异常]"</span>, session, throwable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <code>@Controller</code> 注解，保证创建一个 WebsocketServerEndpoint Bean 。</li>
<li>在类上，添加 JSR-356 定义的 <a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/server/src/main/java/javax/websocket/server/ServerEndpoint.java" target="_blank" rel="noopener"><code>@ServerEndpoint</code></a> 注解，标记这是一个 WebSocket EndPoint ，路径为 <code>/</code> 。</li>
<li>WebSocket 一共有四个事件，分别对应使用 JSR-356 定义的 <a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/client/src/main/java/javax/websocket/OnOpen.java" target="_blank" rel="noopener"><code>@OnOpen</code></a>、<a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/client/src/main/java/javax/websocket/OnMessage.java" target="_blank" rel="noopener"><code>@OnMessage</code></a>、<a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/client/src/main/java/javax/websocket/OnClose.java" target="_blank" rel="noopener"><code>@OnClose</code></a>、<a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/client/src/main/java/javax/websocket/OnError.java" target="_blank" rel="noopener"><code>@OnError</code></a> 注解。</li>
</ul>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebSocketConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// @EnableWebSocket // 无需添加该注解，因为我们并不是使用 Spring WebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerEndpointExporter <span class="title">serverEndpointExporter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServerEndpointExporter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 <code>#serverEndpointExporter()</code> 方法中，创建 ServerEndpointExporter Bean 。该 Bean 的作用，是扫描添加有 <code>@ServerEndpoint</code> 注解的 Bean 。</li>
</ul>
<p><strong>消息</strong></p>
<p>在 HTTP 协议中，是基于 Request/Response 请求响应的<strong>同步</strong>模型，进行交互。在 Websocket 协议中，是基于 Message 消息的<strong>异步</strong>模型，进行交互。</p>
<p>因为 WebSocket 协议，不像 HTTP 协议有 URI 可以区分不同的 API 请求操作，所以需要在 WebSocket 的 Message 里，增加能够标识消息类型，这里采用 <code>type</code> 字段。所以在这个示例中，采用的 Message 采用 JSON 格式编码，格式如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    type: "", // 消息类型</span><br><span class="line">    body: &#123;&#125; // 消息体</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>type</code> 字段，消息类型。通过该字段，知道使用哪个 MessageHandler 消息处理器。</li>
<li><code>body</code> 字段，消息体。不同的消息类型，会有不同的消息体。</li>
<li>Message 采用 JSON 格式编码，主要考虑便捷性，实际项目下，也可以考虑 <a href="https://github.com/protocolbuffers/protobuf" target="_blank" rel="noopener">Protobuf</a> 等更加高效且节省流量的编码格式。</li>
</ul>
<p>基础消息体，所有消息体都要实现该接口。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Message.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户认证请求。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AuthRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthRequest</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"AUTH_REQUEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证 Token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>TYPE</code> 静态属性，消息类型为 <code>AUTH_REQUEST</code> 。</li>
<li><code>accessToken</code> 属性，认证 Token 。在 WebSocket 协议中，也需要认证当前连接，用户身份是什么。一般情况下，采用用户调用 HTTP 登陆接口，登陆成功后返回的访问令牌 <code>accessToken</code> 。</li>
</ul>
<p>用户认证响应。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AuthResponse.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthResponse</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"AUTH_RESPONSE"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应状态码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应提示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>TYPE</code> 静态属性，消息类型为 <code>AUTH_REQUEST</code> 。实际上，我们在每个 Message 实现类上，都增加了 <code>TYPE</code> 静态属性，作为消息类型。</li>
<li><code>code</code> 属性，响应状态码。</li>
<li><code>message</code> 属性，响应提示。</li>
</ul>
<p>用户成功认证之后，会广播用户加入群聊的通知 Message 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserJoinNoticeRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserJoinNoticeRequest</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"USER_JOIN_NOTICE_REQUEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 昵称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>优化小想法</strong></p>
<p>实际上，可以在需要使用到 Request/Response 模型的地方，将 Message 进行拓展：</p>
<ul>
<li>Request 抽象类，增加 <code>requestId</code> 字段，表示请求编号。</li>
<li>Response 抽象类，增加 <code>requestId</code> 字段，和每一个 Request 请求映射上。同时，里面统一定义 <code>code</code> 和 <code>message</code> 属性，表示响应状态码和响应提示。</li>
</ul>
<p>这样，在使用到同步模型的业务场景下，Message 实现类使用 Request/Reponse 作为后缀。例如说，用户认证请求、删除一个好友请求等等。</p>
<p>而在使用到异步模型能的业务场景下，Message 实现类还是继续 Message 作为后缀。例如说，发送一条消息，用户操作完后，无需阻塞等待结果</p>
<p>发送给指定人的私聊消息的 Message。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendToOneRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendToOneRequest</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"SEND_TO_ONE_REQUEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送给的用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String toUser;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msgId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>发送给所有人的群聊消息的 Message。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendToAllRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendToAllRequest</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"SEND_TO_ALL_REQUEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msgId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在服务端接收到发送消息的请求，需要<strong>异步</strong>响应发送是否成功。发送消息响应结果的 Message 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendResponse.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendResponse</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"SEND_RESPONSE"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msgId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应状态码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应提示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重点看 <code>msgId</code> 字段，消息编号。客户端在发送消息，通过使用 <a href="https://zh.wikipedia.org/zh-hans/通用唯一识别码" target="_blank" rel="noopener">UUID</a> 算法，生成全局唯一消息编号。这样，服务端通过 SendResponse 消息响应，通过 <code>msgId</code> 做映射。</li>
</ul>
<p>在服务端接收到发送消息的请求，需要转发消息给对应的人。发送消息给一个用户的 Message 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendResponse.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendToUserRequest</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"SEND_TO_USER_REQUEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msgId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>相比 SendToOneRequest 来说，少一个 <code>toUser</code> 字段。因为，可以通过 WebSocket 连接，已经知道发送给谁了。</li>
</ul>
<p><strong>消息处理器</strong></p>
<p>每个客户端发起的 Message 消息类型，会声明对应的 MessageHandler 消息处理器。这个就类似在 SpringMVC 中，每个 API 接口对应一个 Controller 的 Method 方法。</p>
<p>消息处理器接口。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MessageHandler.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageHandler</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Message</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行处理消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session 会话</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Session session, T message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 消息类型，即每个 Message 实现类上的 TYPE 静态字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getType</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义了泛型 <code>&lt;T&gt;</code> ，需要是 Message 的实现类。</li>
</ul>
<p>处理 AuthRequest 消息。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AuthMessageHandler.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthMessageHandler</span> <span class="keyword">implements</span> <span class="title">MessageHandler</span>&lt;<span class="title">AuthRequest</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Session session, AuthRequest message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 如果未传递 accessToken </span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(message.getAccessToken())) &#123;</span><br><span class="line">            WebSocketUtil.send(session, AuthResponse.TYPE,</span><br><span class="line">                    <span class="keyword">new</span> AuthResponse().setCode(<span class="number">1</span>).setMessage(<span class="string">"认证 accessToken 未传入"</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加到 WebSocketUtil 中</span></span><br><span class="line">        WebSocketUtil.addSession(session, message.getAccessToken()); <span class="comment">// 考虑到代码简化，我们先直接使用 accessToken 作为 User</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否认证成功。这里，假装直接成功</span></span><br><span class="line">        WebSocketUtil.send(session, AuthResponse.TYPE, <span class="keyword">new</span> AuthResponse().setCode(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知所有人，某个人加入了。这个是可选逻辑，仅仅是为了演示</span></span><br><span class="line">        WebSocketUtil.broadcast(UserJoinNoticeRequest.TYPE,</span><br><span class="line">                <span class="keyword">new</span> UserJoinNoticeRequest().setNickname(message.getAccessToken())); <span class="comment">// 考虑到代码简化，我们先直接使用 accessToken 作为 User</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AuthRequest.TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>处理 SendToOneRequest 消息。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendToOneRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendToOneHandler</span> <span class="keyword">implements</span> <span class="title">MessageHandler</span>&lt;<span class="title">SendToOneRequest</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Session session, SendToOneRequest message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里，假装直接成功</span></span><br><span class="line">        SendResponse sendResponse = <span class="keyword">new</span> SendResponse().setMsgId(message.getMsgId()).setCode(<span class="number">0</span>);</span><br><span class="line">        WebSocketUtil.send(session, SendResponse.TYPE, sendResponse);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建转发的消息</span></span><br><span class="line">        SendToUserRequest sendToUserRequest = <span class="keyword">new</span> SendToUserRequest().setMsgId(message.getMsgId())</span><br><span class="line">                .setContent(message.getContent());</span><br><span class="line">        <span class="comment">// 广播发送</span></span><br><span class="line">        WebSocketUtil.send(message.getToUser(), SendToUserRequest.TYPE, sendToUserRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SendToOneRequest.TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>处理 SendToAllRequest 消息。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendToAllRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendToAllHandler</span> <span class="keyword">implements</span> <span class="title">MessageHandler</span>&lt;<span class="title">SendToAllRequest</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Session session, SendToAllRequest message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里，假装直接成功</span></span><br><span class="line">        SendResponse sendResponse = <span class="keyword">new</span> SendResponse().setMsgId(message.getMsgId()).setCode(<span class="number">0</span>);</span><br><span class="line">        WebSocketUtil.send(session, SendResponse.TYPE, sendResponse);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建转发的消息</span></span><br><span class="line">        SendToUserRequest sendToUserRequest = <span class="keyword">new</span> SendToUserRequest().setMsgId(message.getMsgId())</span><br><span class="line">                .setContent(message.getContent());</span><br><span class="line">        <span class="comment">// 广播发送</span></span><br><span class="line">        WebSocketUtil.broadcast(SendToUserRequest.TYPE, sendToUserRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SendToAllRequest.TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>WebSocketUtil</code> 工具类，主要提供两方面的功能：</p>
<ul>
<li>Session 会话的管理</li>
<li>多种发送消息的方式</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebSocketUtil.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(WebSocketUtil<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 会话相关 ==========</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Session 与用户的映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Session, String&gt; SESSION_USER_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户与 Session 的映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Session&gt; USER_SESSION_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加 Session 。在这个方法中，会添加用户和 Session 之间的映射</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session Session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addSession</span><span class="params">(Session session, String user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 更新 USER_SESSION_MAP</span></span><br><span class="line">        USER_SESSION_MAP.put(user, session);</span><br><span class="line">        <span class="comment">// 更新 SESSION_USER_MAP</span></span><br><span class="line">        SESSION_USER_MAP.put(session, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除 Session 。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session Session</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeSession</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 从 SESSION_USER_MAP 中移除</span></span><br><span class="line">        String user = SESSION_USER_MAP.remove(session);</span><br><span class="line">        <span class="comment">// 从 USER_SESSION_MAP 中移除</span></span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span> &amp;&amp; user.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            USER_SESSION_MAP.remove(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 消息相关 ==========</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 广播发送消息给所有在线用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 消息类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Message&gt; <span class="function"><span class="keyword">void</span> <span class="title">broadcast</span><span class="params">(String type, T message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建消息</span></span><br><span class="line">        String messageText = buildTextMessage(type, message);</span><br><span class="line">        <span class="comment">// 遍历 SESSION_USER_MAP ，进行逐个发送</span></span><br><span class="line">        <span class="keyword">for</span> (Session session : SESSION_USER_MAP.keySet()) &#123;</span><br><span class="line">            sendTextMessage(session, messageText);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息给单个用户的 Session</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session Session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 消息类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Message&gt; <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(Session session, String type, T message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建消息</span></span><br><span class="line">        String messageText = buildTextMessage(type, message);</span><br><span class="line">        <span class="comment">// 遍历给单个 Session ，进行逐个发送</span></span><br><span class="line">        sendTextMessage(session, messageText);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息给指定用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 指定用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 发送是否成功你那个</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Message&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">send</span><span class="params">(String user, String type, T message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获得用户对应的 Session</span></span><br><span class="line">        Session session = USER_SESSION_MAP.get(user);</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"[send][user(&#123;&#125;) 不存在对应的 session]"</span>, user);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        send(session, type, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建完整的消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T extends Message&gt; <span class="function">String <span class="title">buildTextMessage</span><span class="params">(String type, T message)</span> </span>&#123;</span><br><span class="line">        JSONObject messageObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        messageObject.put(<span class="string">"type"</span>, type);</span><br><span class="line">        messageObject.put(<span class="string">"body"</span>, message);</span><br><span class="line">        <span class="keyword">return</span> messageObject.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 真正发送消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session Session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageText 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendTextMessage</span><span class="params">(Session session, String messageText)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"[sendTextMessage][session 为 null]"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        RemoteEndpoint.Basic basic = session.getBasicRemote();</span><br><span class="line">        <span class="keyword">if</span> (basic == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"[sendTextMessage][session 的  为 null]"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            basic.sendText(messageText);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"[sendTextMessage][session(&#123;&#125;) 发送消息&#123;&#125;) 发生异常"</span>,</span><br><span class="line">                    session, messageText, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>完善 WebsokcetServerEndpoint</strong></p>
<p>实现 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-beans/src/main/java/org/springframework/beans/factory/InitializingBean.java" target="_blank" rel="noopener">InitializingBean</a> 接口，在 <code>#afterPropertiesSet()</code> 方法中，扫描所有 MessageHandler Bean ，添加到 MessageHandler 集合中。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息类型与 MessageHandler 的映射</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意，这里设置成静态变量。虽然说 WebsocketServerEndpoint 是单例，但是 Spring Boot 还是会为每个 WebSocket 创建一个 WebsocketServerEndpoint Bean 。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, MessageHandler&gt; HANDLERS = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 通过 ApplicationContext 获得所有 MessageHandler Bean</span></span><br><span class="line">    applicationContext.getBeansOfType(MessageHandler<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>() // 获得所有 <span class="title">MessageHandler</span> <span class="title">Bean</span></span></span><br><span class="line"><span class="class">            .<span class="title">forEach</span>(<span class="title">messageHandler</span> -&gt; <span class="title">HANDLERS</span>.<span class="title">put</span>(<span class="title">messageHandler</span>.<span class="title">getType</span>(), <span class="title">messageHandler</span>))</span>; <span class="comment">// 添加到 handlers 中</span></span><br><span class="line">    logger.info(<span class="string">"[afterPropertiesSet][消息处理器数量：&#123;&#125;]"</span>, HANDLERS.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>重新实现 <code>#onOpen(Session session, EndpointConfig config)</code> 方法，实现连接时，使用 <code>accessToken</code> 参数进行用户认证。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@OnOpen</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(Session session, EndpointConfig config)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[onOpen][session(&#123;&#125;) 接入]"</span>, session);</span><br><span class="line">    <span class="comment">// &lt;1&gt; 解析 accessToken</span></span><br><span class="line">    List&lt;String&gt; accessTokenValues = session.getRequestParameterMap().get(<span class="string">"accessToken"</span>);</span><br><span class="line">    String accessToken = !CollectionUtils.isEmpty(accessTokenValues) ? accessTokenValues.get(<span class="number">0</span>) : <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// &lt;2&gt; 创建 AuthRequest 消息类型</span></span><br><span class="line">    AuthRequest authRequest = <span class="keyword">new</span> AuthRequest().setAccessToken(accessToken);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 获得消息处理器</span></span><br><span class="line">    MessageHandler&lt;AuthRequest&gt; messageHandler = HANDLERS.get(AuthRequest.TYPE);</span><br><span class="line">    <span class="keyword">if</span> (messageHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        logger.error(<span class="string">"[onOpen][认证消息类型，不存在消息处理器]"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    messageHandler.execute(session, authRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code> 处，解析 <code>ws://</code> 地址上的 <code>accessToken</code> 的请求参。例如说：<code>ws://127.0.0.1:8080?accessToken=QINQIN</code> 。</li>
<li><code>&lt;2&gt;</code> 处，创建 AuthRequest 消息类型，并设置 <code>accessToken</code> 属性。</li>
<li><code>&lt;3&gt;</code> 处，获得 AuthRequest 消息类型对应的 MessageHandler 消息处理器，然后调用 <code>MessageHandler#execute(session, message)</code> 方法，执行处理用户认证请求。</li>
</ul>
<p>重新实现 <code>#onMessage(Session session, String message)</code> 方法，实现不同的消息，转发给不同的 MessageHandler 消息处理器。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Session session, String message)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[onOpen][session(&#123;&#125;) 接收到一条消息(&#123;&#125;)]"</span>, session, message); <span class="comment">// 生产环境下，请设置成 debug 级别</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// &lt;1&gt; 获得消息类型</span></span><br><span class="line">        JSONObject jsonMessage = JSON.parseObject(message);</span><br><span class="line">        String messageType = jsonMessage.getString(<span class="string">"type"</span>);</span><br><span class="line">        <span class="comment">// &lt;2&gt; 获得消息处理器</span></span><br><span class="line">        MessageHandler messageHandler = HANDLERS.get(messageType);</span><br><span class="line">        <span class="keyword">if</span> (messageHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">"[onMessage][消息类型(&#123;&#125;) 不存在消息处理器]"</span>, messageType);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &lt;3&gt; 解析消息</span></span><br><span class="line">        Class&lt;? extends Message&gt; messageClass = <span class="keyword">this</span>.getMessageClass(messageHandler);</span><br><span class="line">        <span class="comment">// &lt;4&gt; 处理消息</span></span><br><span class="line">        Message messageObj = JSON.parseObject(jsonMessage.getString(<span class="string">"body"</span>), messageClass);</span><br><span class="line">        messageHandler.execute(session, messageObj);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        logger.info(<span class="string">"[onMessage][session(&#123;&#125;) message(&#123;&#125;) 发生异常]"</span>, session, throwable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>&lt;1&gt;</code> 处，获得消息类型，从 <code>&quot;type&quot;</code> 字段中。</p>
</li>
<li><p><code>&lt;2&gt;</code> 处，获得消息类型对应的 MessageHandler 消息处理器。</p>
</li>
<li><p><code>&lt;3&gt;</code> 处，调用 <code>#getMessageClass(MessageHandler handler)</code> 方法，通过 MessageHandler 中，通过解析其类上的泛型，获得消息类型对应的 Class 类。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Class&lt;? extends Message&gt; getMessageClass(MessageHandler handler) &#123;</span><br><span class="line">    <span class="comment">// 获得 Bean 对应的 Class 类名。因为有可能被 AOP 代理过。</span></span><br><span class="line">    Class&lt;?&gt; targetClass = AopProxyUtils.ultimateTargetClass(handler);</span><br><span class="line">    <span class="comment">// 获得接口的 Type 数组</span></span><br><span class="line">    Type[] interfaces = targetClass.getGenericInterfaces();</span><br><span class="line">    Class&lt;?&gt; superclass = targetClass.getSuperclass();</span><br><span class="line">    <span class="keyword">while</span> ((Objects.isNull(interfaces) || <span class="number">0</span> == interfaces.length) &amp;&amp; Objects.nonNull(superclass)) &#123; <span class="comment">// 此处，是以父类的接口为准</span></span><br><span class="line">        interfaces = superclass.getGenericInterfaces();</span><br><span class="line">        superclass = targetClass.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(interfaces)) &#123;</span><br><span class="line">        <span class="comment">// 遍历 interfaces 数组</span></span><br><span class="line">        <span class="keyword">for</span> (Type type : interfaces) &#123;</span><br><span class="line">            <span class="comment">// 要求 type 是泛型参数</span></span><br><span class="line">            <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                ParameterizedType parameterizedType = (ParameterizedType) type;</span><br><span class="line">                <span class="comment">// 要求是 MessageHandler 接口</span></span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(parameterizedType.getRawType(), MessageHandler<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                    Type[] actualTypeArguments = parameterizedType.getActualTypeArguments();</span><br><span class="line">                    <span class="comment">// 取首个元素</span></span><br><span class="line">                    <span class="keyword">if</span> (Objects.nonNull(actualTypeArguments) &amp;&amp; actualTypeArguments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> (Class&lt;Message&gt;) actualTypeArguments[<span class="number">0</span>];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"类型(%s) 获得不到消息类型"</span>, handler));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"类型(%s) 获得不到消息类型"</span>, handler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这是参考 <a href="https://github.com/apache/rocketmq-spring/" target="_blank" rel="noopener"><code>rocketmq-spring</code></a> 项目的 <a href="https://github.com/apache/rocketmq-spring/blob/8b2426ea89d704d61c00497a1320b9b9ccd5a61e/rocketmq-spring-boot/src/main/java/org/apache/rocketmq/spring/support/DefaultRocketMQListenerContainer.java#L408-L435" target="_blank" rel="noopener"><code>DefaultRocketMQListenerContainer#getMessageType()</code></a> 方法，进行略微修改。</li>
</ul>
</li>
<li><p><code>&lt;4&gt;</code> 处，调用 <code>MessageHandler#execute(session, message)</code> 方法，执行处理请求。</p>
</li>
<li><p>另外，这里增加了 <code>try-catch</code> 代码，避免整个执行的过程中，发生异常。如果在 onMessage 事件的处理中，发生异常，该消息对应的 Session 会话会被<strong>自动</strong>关闭。显然，这个不符合要求。例如说，在 MessageHandler 处理消息的过程中，发生一些异常是无法避免的。</p>
</li>
</ul>
<p>重新实现 <code>#onClose(Session session, CloseReason closeReason)</code> 方法，实现移除关闭的 Session 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(Session session, CloseReason closeReason)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[onClose][session(&#123;&#125;) 连接关闭。关闭原因是(&#123;&#125;)&#125;]"</span>, session, closeReason);</span><br><span class="line">    WebSocketUtil.removeSession(session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>#onError(Session session, Throwable throwable)</code> 方法，保持不变。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@OnError</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Session session, Throwable throwable)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[onClose][session(&#123;&#125;) 发生异常]"</span>, session, throwable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-Spring-WebSocket-快速入门"><a href="#3-Spring-WebSocket-快速入门" class="headerlink" title="3. Spring WebSocket 快速入门"></a>3. Spring WebSocket 快速入门</h2><p>因为 Tomcat WebSocket 使用的是 <a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/client/src/main/java/javax/websocket/Session.java" target="_blank" rel="noopener">Session</a> 作为会话，而 Spring WebSocket 使用的是 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-websocket/src/main/java/org/springframework/web/socket/WebSocketSession.java" target="_blank" rel="noopener">WebSocketSession</a> 作为会话，导致需要<strong>略微</strong>修改下 WebSocketUtil 工具类。改动非常略微，点击 <code>WebSocketUtil</code>查看下。 主要有两点：</p>
<ul>
<li>将所有使用 Session 类的地方，调整成 WebSocketSession 类。</li>
<li>将发送消息，从 Session 修改成 WebSocketSession 。</li>
</ul>
<p>创建 <code>DemoWebSocketShakeInterceptor</code> 拦截器。因为 WebSocketSession 无法获得 ws 地址上的请求参数，所以只好通过该拦截器，获得 <code>accessToken</code> 请求参数，设置到 <code>attributes</code> 中。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DemoWebSocketShakeInterceptor.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoWebSocketShakeInterceptor</span> <span class="keyword">extends</span> <span class="title">HttpSessionHandshakeInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 拦截 Handshake 事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">beforeHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获得 accessToken</span></span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> ServletServerHttpRequest) &#123;</span><br><span class="line">            ServletServerHttpRequest serverRequest = (ServletServerHttpRequest) request;</span><br><span class="line">            attributes.put(<span class="string">"accessToken"</span>, serverRequest.getServletRequest().getParameter(<span class="string">"accessToken"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用父方法，继续执行逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.beforeHandshake(request, response, wsHandler, attributes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DemoWebSocketHandler.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoWebSocketHandler</span> <span class="keyword">extends</span> <span class="title">TextWebSocketHandler</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息类型与 MessageHandler 的映射</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 无需设置成静态变量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MessageHandler&gt; HANDLERS = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 对应 open 事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[afterConnectionEstablished][session(&#123;&#125;) 接入]"</span>, session);</span><br><span class="line">        <span class="comment">// 解析 accessToken</span></span><br><span class="line">        String accessToken = (String) session.getAttributes().get(<span class="string">"accessToken"</span>);</span><br><span class="line">        <span class="comment">// 创建 AuthRequest 消息类型</span></span><br><span class="line">        AuthRequest authRequest = <span class="keyword">new</span> AuthRequest().setAccessToken(accessToken);</span><br><span class="line">        <span class="comment">// 获得消息处理器</span></span><br><span class="line">        MessageHandler&lt;AuthRequest&gt; messageHandler = HANDLERS.get(AuthRequest.TYPE);</span><br><span class="line">        <span class="keyword">if</span> (messageHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">"[onOpen][认证消息类型，不存在消息处理器]"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        messageHandler.execute(session, authRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 对应 message 事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage textMessage)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[handleMessage][session(&#123;&#125;) 接收到一条消息(&#123;&#125;)]"</span>, session, textMessage); <span class="comment">// 生产环境下，请设置成 debug 级别</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获得消息类型</span></span><br><span class="line">            JSONObject jsonMessage = JSON.parseObject(textMessage.getPayload());</span><br><span class="line">            String messageType = jsonMessage.getString(<span class="string">"type"</span>);</span><br><span class="line">            <span class="comment">// 获得消息处理器</span></span><br><span class="line">            MessageHandler messageHandler = HANDLERS.get(messageType);</span><br><span class="line">            <span class="keyword">if</span> (messageHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.error(<span class="string">"[onMessage][消息类型(&#123;&#125;) 不存在消息处理器]"</span>, messageType);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析消息</span></span><br><span class="line">            Class&lt;? extends Message&gt; messageClass = <span class="keyword">this</span>.getMessageClass(messageHandler);</span><br><span class="line">            <span class="comment">// 处理消息</span></span><br><span class="line">            Message messageObj = JSON.parseObject(jsonMessage.getString(<span class="string">"body"</span>), messageClass);</span><br><span class="line">            messageHandler.execute(session, messageObj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            logger.info(<span class="string">"[onMessage][session(&#123;&#125;) message(&#123;&#125;) 发生异常]"</span>, session, throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 对应 close 事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[afterConnectionClosed][session(&#123;&#125;) 连接关闭。关闭原因是(&#123;&#125;)&#125;]"</span>, session, status);</span><br><span class="line">        WebSocketUtil.removeSession(session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 对应 error 事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleTransportError</span><span class="params">(WebSocketSession session, Throwable exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[handleTransportError][session(&#123;&#125;) 发生异常]"</span>, session, exception);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 通过 ApplicationContext 获得所有 MessageHandler Bean</span></span><br><span class="line">        applicationContext.getBeansOfType(MessageHandler<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>() // 获得所有 <span class="title">MessageHandler</span> <span class="title">Bean</span></span></span><br><span class="line"><span class="class">                .<span class="title">forEach</span>(<span class="title">messageHandler</span> -&gt; <span class="title">HANDLERS</span>.<span class="title">put</span>(<span class="title">messageHandler</span>.<span class="title">getType</span>(), <span class="title">messageHandler</span>))</span>; <span class="comment">// 添加到 handlers 中</span></span><br><span class="line">        logger.info(<span class="string">"[afterPropertiesSet][消息处理器数量：&#123;&#125;]"</span>, HANDLERS.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends Message&gt; getMessageClass(MessageHandler handler) &#123;</span><br><span class="line">        <span class="comment">// 获得 Bean 对应的 Class 类名。因为有可能被 AOP 代理过。</span></span><br><span class="line">        Class&lt;?&gt; targetClass = AopProxyUtils.ultimateTargetClass(handler);</span><br><span class="line">        <span class="comment">// 获得接口的 Type 数组</span></span><br><span class="line">        Type[] interfaces = targetClass.getGenericInterfaces();</span><br><span class="line">        Class&lt;?&gt; superclass = targetClass.getSuperclass();</span><br><span class="line">        <span class="keyword">while</span> ((Objects.isNull(interfaces) || <span class="number">0</span> == interfaces.length) &amp;&amp; Objects.nonNull(superclass)) &#123; <span class="comment">// 此处，是以父类的接口为准</span></span><br><span class="line">            interfaces = superclass.getGenericInterfaces();</span><br><span class="line">            superclass = targetClass.getSuperclass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(interfaces)) &#123;</span><br><span class="line">            <span class="comment">// 遍历 interfaces 数组</span></span><br><span class="line">            <span class="keyword">for</span> (Type type : interfaces) &#123;</span><br><span class="line">                <span class="comment">// 要求 type 是泛型参数</span></span><br><span class="line">                <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                    ParameterizedType parameterizedType = (ParameterizedType) type;</span><br><span class="line">                    <span class="comment">// 要求是 MessageHandler 接口</span></span><br><span class="line">                    <span class="keyword">if</span> (Objects.equals(parameterizedType.getRawType(), MessageHandler<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                        Type[] actualTypeArguments = parameterizedType.getActualTypeArguments();</span><br><span class="line">                        <span class="comment">// 取首个元素</span></span><br><span class="line">                        <span class="keyword">if</span> (Objects.nonNull(actualTypeArguments) &amp;&amp; actualTypeArguments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> (Class&lt;Message&gt;) actualTypeArguments[<span class="number">0</span>];</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"类型(%s) 获得不到消息类型"</span>, handler));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"类型(%s) 获得不到消息类型"</span>, handler));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebSocketConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span> <span class="comment">// 开启 Spring WebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfiguration</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addHandler(<span class="keyword">this</span>.webSocketHandler(), <span class="string">"/"</span>) <span class="comment">// 配置处理器</span></span><br><span class="line">                .addInterceptors(<span class="keyword">new</span> DemoWebSocketShakeInterceptor()) <span class="comment">// 配置拦截器</span></span><br><span class="line">                .setAllowedOrigins(<span class="string">"*"</span>); <span class="comment">// 解决跨域问题</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DemoWebSocketHandler <span class="title">webSocketHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DemoWebSocketHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DemoWebSocketShakeInterceptor <span class="title">webSocketShakeInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DemoWebSocketShakeInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <code>@EnableWebSocket</code> 注解，开启 Spring WebSocket 功能。</li>
</ul>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>考虑下边界场景，客户端网络环境较差，特别是在移动端场景下，出现网络<strong>闪断</strong>，可能会出现连接实际已经断开，而服务端以为客户端处于在线的情况。此时，服务端会将消息发给客户端，那么消息实际就发送到“空气”中，产生丢失的情况。要解决这种情况下的问题，需要引入客户端的 ACK 消息机制。目前，主流的有两种做法。</p>
<p>第一种，基于每一条消息编号 ACK 。整体流程如下：</p>
<ul>
<li>无论客户端是否在线，服务端都先把接收到的消息持久化到数据库中。如果客户端此时在线，服务端将<strong>完整消息</strong>推送给客户端。</li>
<li>客户端在接收到消息之后，发送 ACK 消息编号给服务端，告知已经收到该消息。服务端在收到 ACK 消息编号的时候，标记该消息已经发送成功。</li>
<li>服务端定时轮询，在线的客户端，是否有超过 N 秒未 ACK 的消息。如果有，则重新发送消息给对应的客户端。</li>
</ul>
<p>这种方案，因为客户端逐条 ACK 消息编号，所以会导致客户端和服务端交互次数过多。当然，客户端可以异步批量 ACK 多条消息，从而减少次数。</p>
<p>不过因为服务端仍然需要定时轮询，也会导致服务端压力较大。所以，这种方案基本已经不采用了。</p>
<p>第二种，基于滑动窗口 ACK 。整体流程如下：</p>
<ul>
<li>无论客户端是否在线，服务端都先把接收到的消息持久化到数据库中。如果客户端此时在线，服务端将<strong>消息编号</strong>推送给客户端。</li>
<li>客户端在接收到<strong>消息编号</strong>之后，和本地的消息编号进行比对。如果比本地的小，说明该消息已经收到，忽略不处理；如果比本地的大，使用<strong>本地的</strong>消息编号，向服务端拉取<strong>大于</strong>本地的消息编号的消息列表，即增量消息列表。拉取完成后，更新消息列表中最大的消息编号为<strong>新的本地的</strong>消息编号。</li>
<li>服务端在收到客户端拉取增量的消息列表时，将请求的编号记录到数据库中，用于知道客户端此时本地的最新消息编号。</li>
<li>考虑到服务端将<strong>消息编号</strong>推送给客户端，也会存在丢失的情况，所以客户端会每 N 秒定时向服务端拉取<strong>大于</strong>本地的消息编号的消息列表。</li>
</ul>
<p>这种方式，在业务被称为<strong>推拉结合</strong>的方案，在分布式消息队列、配置中心、注册中心实现实时的数据同步，经常被采用。</p>
<p>并且，采用这种方案的情况下，客户端和服务端不一定需要使用<strong>长连接</strong>，也可以使用<strong>长轮询</strong>所替代。客户端发送带有消息版本号的 HTTP 请求到服务端。</p>
<ul>
<li>如果服务端<strong>已有</strong>比客户端新的消息编号，则直接返回增量的消息列表。</li>
<li>如果服务端<strong>没有</strong>比客户端新的消息编号，则 HOLD 住请求，直到有新的消息列表可以返回，或者 HTTP 请求超时。</li>
<li>客户端在收到 HTTP 请求超时时，立即又重新发起带有消息版本号的 HTTP 请求到服务端。如此反复循环，通过消息编号作为<strong>增量标识</strong>，达到实时获取消息的目的。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/03/Web%E5%BC%80%E5%8F%91-SpringBoot-WebSocket%E5%85%A5%E9%97%A8/" data-id="ckbg9kuct001b2r070gu32rac" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebSocket/" rel="tag">WebSocket</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Java基础容器" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/02/Java%E5%9F%BA%E7%A1%80%E5%AE%B9%E5%99%A8/" class="article-date">
  <time datetime="2020-06-02T09:41:19.000Z" itemprop="datePublished">2020-06-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/02/Java%E5%9F%BA%E7%A1%80%E5%AE%B9%E5%99%A8/">Java基础容器</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Java-容器"><a href="#Java-容器" class="headerlink" title="Java 容器"></a>Java 容器</h1><h2 id="1-ArrayList-与-LinkedList-的区别"><a href="#1-ArrayList-与-LinkedList-的区别" class="headerlink" title="1. ArrayList 与 LinkedList 的区别"></a>1. ArrayList 与 LinkedList 的区别</h2><h3 id="1-底层使用的数据结果"><a href="#1-底层使用的数据结果" class="headerlink" title="1. 底层使用的数据结果"></a>1. 底层使用的数据结果</h3><ul>
<li>Arraylist 底层使用的是Object数组，初始化时就会指向的会是一个static修饰的空数组，数组长度一开始为<strong>0</strong>，插入第一个元素时数组长度会初始化为<strong>10</strong>，之后每次数组空间不够进行扩容时都是增加为原来的<strong>1.5倍</strong>。ArrayList的空间浪费主要体现在在list列表的结尾会预留一定的容量空间，而LinkedList的空间花费则体现在它的每一个元素都需要消耗比ArrayList更多的空间（因为要存放直接后继和直接前驱以及数据）</li>
<li>LinkedList 底层使用的是双向链表数据结构，每个节点保存了指向前驱节点和后继结点的指针。初始化时，不执行任何操作，添加第一个元素时，再去构造链表中的节点。</li>
</ul>
<h3 id="2-是否保证线程安全"><a href="#2-是否保证线程安全" class="headerlink" title="2. 是否保证线程安全"></a>2. 是否保证线程安全</h3><p>ArrayList 和 LinkedList 都是不同步的，也就是不保证线程安全。</p>
<p>因为ArrayList的插入元素的方法就是裸奔的，直接将原数组index及后面的元素拷贝到index+1及后面的位置上，然后将index位置设置为插入的值，并发修改时保证不了数据安全性，所以也不允许并发修改，一旦检测到并发修改，会抛出ConcurrentModificationException异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ArrayList的插入元素的方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">        rangeCheckForAdd(index);</span><br><span class="line">        ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">        System.arraycopy(elementData, index, elementData, index + <span class="number">1</span>,</span><br><span class="line">                         size - index);<span class="comment">//将原数组index之后的元素拷贝到原数组index+1后面的位置上</span></span><br><span class="line">        elementData[index] = element;</span><br><span class="line">        size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-插入和删除的复杂度"><a href="#3-插入和删除的复杂度" class="headerlink" title="3. 插入和删除的复杂度"></a>3. 插入和删除的复杂度</h3><ul>
<li>ArrayList 采用数组存储，元素的物理存储地址是连续的，支持以O(1)的时间复杂度对元素快速访问。插入和删除元素后，需要将后面的元素进行移动，所以插入和删除元素的时间复杂度受元素位置的影响。复杂度是 O（n）</li>
<li>LinkedList 采用链表存储，所以不能快速随机访问。所以首尾插入，删除元素时间复杂度不受元素位置的影响，都是近似 O(1)(如果是插入到中间位置还需要考虑寻找插入位置的时间复杂度)。而数组为近似 O(n)。</li>
</ul>
<h3 id="4-继承树"><a href="#4-继承树" class="headerlink" title="4. 继承树"></a>4. 继承树</h3><ul>
<li>ArrayList继承于AbstractList抽象类，实现了List, RandomAccess, Cloneable, java.io.Serializable接口 。</li>
<li>LinkedList继承自AbstractSequentialList 实现List, Deque, Cloneable, java.io.Serializable接口。</li>
</ul>
<p>AbstractSequentialList是AbstractList类的子类，实现了根据下标来访问元素的一些方法，主要是通过listIterator遍历获取特定元素。</p>
<p>List接口代表的是有序结合，与Set相反，List的元素是按照移动的顺序进行排列。</p>
<p>Cloneable接口代表类会重写父类Object的clone()方法，支持对实例对象的clone操作。</p>
<p>java.io.Serializable接口代表类支持序列化。</p>
<p>RandomAccess是一个标示性接口，代表ArrayList支持快速访问，而LinkedList不支持。</p>
<p>Deque接口是双端队列的意思，代表LinkedList支持两端元素插入和移除。</p>
<h3 id="5-使ArralyList、LinkedList-变成线程安全的"><a href="#5-使ArralyList、LinkedList-变成线程安全的" class="headerlink" title="5.  使ArralyList、LinkedList 变成线程安全的"></a>5.  使ArralyList、LinkedList 变成线程安全的</h3><h4 id="1-使用-SynchronizedList"><a href="#1-使用-SynchronizedList" class="headerlink" title="1. 使用 SynchronizedList"></a>1. 使用 SynchronizedList</h4><p>SynchronizedList是一个线程安全的包装类。继承于SynchronizedCollection，SynchronizedCollection实现了Collection接口，SynchronizedList包含一个List对象，对List的访问修改方法进行了一些封装，在封装的方法中会对list使用同步锁加锁，然后再进行存取和修改操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LinkedList&lt;Integer&gt;    linkedList    = <span class="keyword">new</span> LinkedList&lt;Integer&gt;();</span><br><span class="line"><span class="comment">//调用Collections的synchronizedList方法，传入一个linkedList，会返回一个SynchronizedList实例对象</span></span><br><span class="line">List&lt;Integer&gt; synchronizedList =  Collections.synchronizedList(linkedList);</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用Collections的synchronizedList方法，ArrayList，返回一个SynchronizedRandomAccessList实例对象</span></span><br><span class="line">ArrayList&lt;Integer&gt;    arrayList    = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">List&lt;Integer&gt; synchronizedRandomAccessList =  Collections.synchronizedList(linkedList);</span><br></pre></td></tr></table></figure>

<p><code>Collections.synchronizedList()</code>方法会判断传入的对象是否实现了 <code>RandomAccess</code>接口，是的话，会返回一个<code>SynchronizedRandomAccessList</code>对象，<code>SynchronizedRandomAccessList</code>是<code>SynchronizedList</code>的子类，只是会多一个以线程安全的方式获取子数组的方法)。</p>
<p>SynchronizedList类的部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">SynchronizedCollection</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;E&gt; list;<span class="comment">//源list</span></span><br><span class="line">       <span class="keyword">final</span> Object mutex; </span><br><span class="line"></span><br><span class="line">        SynchronizedCollection(Collection&lt;E&gt; c) &#123;</span><br><span class="line">            <span class="keyword">this</span>.c = Objects.requireNonNull(c);</span><br><span class="line">            mutex = <span class="keyword">this</span>;<span class="comment">//mutex就是SynchronizedList实例自己，作为同步锁使用</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">            是父类中的成员变量，在父类中会将list赋值给mutex</span><br><span class="line">                    <span class="keyword">return</span> list.get(index);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> list.set(index, element);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-使用-CopyOnWriteArrayList"><a href="#2-使用-CopyOnWriteArrayList" class="headerlink" title="2. 使用 CopyOnWriteArrayList"></a>2. 使用 CopyOnWriteArrayList</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/02/Java%E5%9F%BA%E7%A1%80%E5%AE%B9%E5%99%A8/" data-id="ckbg9kubk00012r07d2yn82jf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java-%E5%9F%BA%E7%A1%80-01/" rel="tag">Java 基础-01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%B9%E5%99%A8/" rel="tag">容器</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Web开发-SpringBoot参数校验Validation入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/02/Web%E5%BC%80%E5%8F%91-SpringBoot%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8CValidation%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-02T03:02:26.000Z" itemprop="datePublished">2020-06-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/02/Web%E5%BC%80%E5%8F%91-SpringBoot%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8CValidation%E5%85%A5%E9%97%A8/">Web开发-SpringBoot参数校验Validation入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-参数校验-Validation-入门"><a href="#Spring-Boot-参数校验-Validation-入门" class="headerlink" title="Spring Boot 参数校验 Validation 入门"></a>Spring Boot 参数校验 Validation 入门</h1><h2 id="1-Bean-Validation-定义的约束注解"><a href="#1-Bean-Validation-定义的约束注解" class="headerlink" title="1. Bean Validation 定义的约束注解"></a>1. Bean Validation 定义的约束注解</h2><p><a href="https://github.com/eclipse-ee4j/beanvalidation-api/tree/master/src/main/java/javax/validation/constraints" target="_blank" rel="noopener"><code>javax.validation.constraints</code></a> 包下，定义了一系列的约束( constraint )注解。如下</p>
<ul>
<li><p>空和非空检查</p>
<ul>
<li><p><code>@NotBlank</code> ：只能用于字符串不为 <code>null</code> ，并且字符串 <code>#trim()</code> 以后 length 要大于 0 。</p>
</li>
<li><p><code>@NotEmpty</code> ：集合对象的元素不为 0 ，即集合不为空，也可以用于字符串不为 <code>null</code> 。</p>
</li>
<li><p><code>@NotNull</code> ：不能为 <code>null</code> 。</p>
</li>
<li><p><code>@Null</code> ：必须为 <code>null</code> 。</p>
</li>
</ul>
</li>
<li><p>数值检查</p>
<ul>
<li><code>@DecimalMax(value)</code> ：被注释的元素必须是一个数字，其值必须小于等于指定的最大值。</li>
<li><code>@DecimalMin(value)</code> ：被注释的元素必须是一个数字，其值必须大于等于指定的最小值。</li>
<li><code>@Digits(integer, fraction)</code> ：被注释的元素必须是一个数字，其值必须在可接受的范围内。</li>
<li><code>@Positive</code> ：判断正数。</li>
<li><code>@PositiveOrZero</code> ：判断正数或 0 。</li>
<li><code>@Max(value)</code> ：该字段的值只能小于或等于该值。</li>
<li><code>@Min(value)</code> ：该字段的值只能大于或等于该值。</li>
<li><code>@Negative</code> ：判断负数。</li>
<li><code>@NegativeOrZero</code> ：判断负数或 0 。</li>
</ul>
</li>
<li><p>Boolean 值检查</p>
<ul>
<li><code>@AssertFalse</code> ：被注释的元素必须为 <code>true</code> 。</li>
<li><code>@AssertTrue</code> ：被注释的元素必须为 <code>false</code> 。</li>
</ul>
</li>
<li><p>长度检查</p>
<ul>
<li><code>@Size(max, min)</code> ：检查该字段的 <code>size</code> 是否在 <code>min</code> 和 <code>max</code> 之间，可以是字符串、数组、集合、Map 等。</li>
</ul>
</li>
<li><p>日期检查</p>
<ul>
<li><code>@Future</code> ：被注释的元素必须是一个将来的日期。</li>
<li><code>@FutureOrPresent</code> ：判断日期是否是将来或现在日期。</li>
<li><code>@Past</code> ：检查该字段的日期是在过去。</li>
<li><code>@PastOrPresent</code> ：判断日期是否是过去或现在日期。</li>
</ul>
</li>
<li><p>其它检查</p>
<ul>
<li><code>@Email</code> ：被注释的元素必须是电子邮箱地址。</li>
<li><code>@Pattern(value)</code> ：被注释的元素必须符合指定的正则表达式。</li>
</ul>
</li>
</ul>
<h2 id="2-Hibernate-Validator-附加的约束注解"><a href="#2-Hibernate-Validator-附加的约束注解" class="headerlink" title="2. Hibernate Validator 附加的约束注解"></a>2. Hibernate Validator 附加的约束注解</h2><p><a href="https://github.com/hibernate/hibernate-validator/tree/master/engine/src/main/java/org/hibernate/validator/constraints" target="_blank" rel="noopener"><code>org.hibernate.validator.constraints</code></a> 包下，定义了一系列的约束( constraint )注解。如下：</p>
<ul>
<li><code>@Range(min=, max=)</code> ：被注释的元素必须在合适的范围内。</li>
<li><code>@Length(min=, max=)</code> ：被注释的字符串的大小必须在指定的范围内。</li>
<li><code>@URL(protocol=,host=,port=,regexp=,flags=)</code> ：被注释的字符串必须是一个有效的 URL 。</li>
<li><code>@SafeHtml</code> ：判断提交的 HTML 是否安全。例如说，不能包含 javascript 脚本等等。</li>
<li>… 等等，就不一一列举了。</li>
</ul>
<h2 id="3-Valid-和-Validated"><a href="#3-Valid-和-Validated" class="headerlink" title="3. @Valid 和 @Validated"></a>3. @Valid 和 @Validated</h2><p><a href="https://docs.oracle.com/javaee/7/api/javax/validation/Valid.html" target="_blank" rel="noopener"><code>@Valid</code></a> 注解，是 Bean Validation 所定义，可以添加在普通方法、构造方法、方法参数、方法返回、成员变量上，表示它们需要进行约束校验。</p>
<p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/validation/annotation/Validated.java" target="_blank" rel="noopener"><code>@Validated</code></a> 注解，是 Spring Validation 锁定义，可以添加在类、方法参数、普通方法上，表示它们需要进行约束校验。同时，<code>@Validated</code> 有 <code>value</code> 属性，支持分组校验。属性如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Validated.java</span></span><br><span class="line"></span><br><span class="line">Class&lt;?&gt;[] value() <span class="keyword">default</span> &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>① 声明式校验</strong></p>
<p>Spring Validation <strong>仅</strong>对 <code>@Validated</code> 注解，实现声明式校验。</p>
<p><strong>② 分组校验</strong></p>
<p>Bean Validation 提供的 <code>@Valid</code> 注解，因为没有分组校验的属性，所以无法提供分组校验。此时，我们只能使用 <code>@Validated</code> 注解。</p>
<p><strong>③ 嵌套校验</strong></p>
<p>相比来说，<code>@Valid</code> 注解的地方，多了【成员变量】。这就导致，如果有嵌套对象的时候，只能使用 <code>@Valid</code> 注解。例如说：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Valid</span></span><br><span class="line">    <span class="keyword">private</span> UserProfile profile;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserProfile.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserProfile</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果不在 <code>User.profile</code> 属性上，添加 <code>@Valid</code> 注解，就会导致 <code>UserProfile.nickname</code> 属性，不会进行校验。</li>
</ul>
<p><strong>总结</strong></p>
<p>总的来说，绝大多数场景下，使用 <code>@Validated</code> 注解即可。</p>
<p>而在有嵌套校验的场景，使用 <code>@Valid</code> 注解添加到成员属性上。</p>
<h3 id="3-1-示例"><a href="#3-1-示例" class="headerlink" title="3.1. 示例"></a>3.1. 示例</h3><p>在 Spring Boot 体系中，也提供了 <a href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-validation" target="_blank" rel="noopener"><code>spring-boot-starter-validation</code></a> 依赖。在这里，并没有引入。该依赖的目的，重点也是引入 <code>hibernate-validator</code> 依赖，这在 <code>spring-boot-starter-web</code> 已经引入，所以无需重复引入。</p>
<p>创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-22/lab-22-validation-01/src/main/java/cn/iocoder/springboot/lab22/validation/Application.java" target="_blank" rel="noopener"><code>Application.java</code></a> 类，配置 <code>@SpringBootApplication</code> 注解即可。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span>(exposeProxy = <span class="keyword">true</span>) <span class="comment">// http://www.voidcn.com/article/p-zddcuyii-bpt.html</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加 <code>@EnableAspectJAutoProxy</code> 注解，重点是配置 <code>exposeProxy = true</code> ，因为希望 Spring AOP 能将当前代理对象设置到 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-aop/src/main/java/org/springframework/aop/framework/AopContext.java" target="_blank" rel="noopener">AopContext</a> 中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserAddDTO.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAddDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"登陆账号不能为空"</span>)</span><br><span class="line">    <span class="meta">@Length</span>(min = <span class="number">5</span>, max = <span class="number">16</span>, message = <span class="string">"账号长度为 5-16 位"</span>)</span><br><span class="line">    <span class="meta">@Pattern</span>(regexp = <span class="string">"^[A-Za-z0-9]+$"</span>, message = <span class="string">"账号格式为数字以及字母"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"密码不能为空"</span>)</span><br><span class="line">    <span class="meta">@Length</span>(min = <span class="number">4</span>, max = <span class="number">16</span>, message = <span class="string">"密码长度为 4-16 位"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 setting/getting 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> @<span class="title">Min</span><span class="params">(value = <span class="number">1</span>L, message = <span class="string">"编号必须大于 0"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[get][id: &#123;&#125;]"</span>, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(@Valid UserAddDTO addDTO)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[add][addDTO: &#123;&#125;]"</span>, addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <code>@Validated</code> 注解，表示 UserController 是所有接口都需要进行参数校验。</li>
<li>对于 <code>#get(id)</code> 方法，我们在 <code>id</code> 参数上，添加了 <code>@Min</code> 注解，校验 <code>id</code> 必须大于 0 。校验不通过示例如下图：</li>
</ul>
<p>​       <img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfdryzchhbj30p60nimzj.jpg" alt="不通过示例 1"></p>
<ul>
<li>对于 <code>#add(addDTO)</code> 方法，我们在 <code>addDTO</code> 参数上，添加了 <code>@Valid</code> 注解，实现对该参数的校验。校验不通过示例如下图：</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfds47vsmbj30od0x9147.jpg" alt="image-20200602112244798"></p>
<ul>
<li><code>errors</code> 字段，参数错误明细<strong>数组</strong>。每一个数组元素，对应一个参数错误明细。这里，<code>username</code> 违背了长度不满足 <code>[5, 16]</code> 。</li>
</ul>
<p><strong>第一点</strong>，<code>#get(id)</code> 方法上，并没有给 <code>id</code> 添加 <code>@Valid</code> 注解，而 <code>#add(addDTO)</code> 方法上，给 <code>addDTO</code> 添加 <code>@Valid</code> 注解。这个差异，是为什么呢？</p>
<p>​        因为 UserController 使用了 <code>@Validated</code> 注解，那么 Spring Validation 就会使用 AOP 进行切面，进行参数校验。而该切面的拦截器，使用的是 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/validation/beanvalidation/MethodValidationInterceptor.java" target="_blank" rel="noopener">MethodValidationInterceptor</a> 。</p>
<ul>
<li>对于 <code>#get(id)</code> 方法，需要校验的参数 <code>id</code> ，是<strong>平铺</strong>开的，所以无需添加 <code>@Valid</code> 注解。</li>
<li>对于 <code>#add(addDTO)</code> 方法，需要校验的参数 <code>addDTO</code> ，实际相当于<strong>嵌套校验</strong>，要校验的参数的都在 <code>addDTO</code> 里面，所以需要添加 <code>@Valid</code> 注解。</li>
</ul>
<p><strong>第二点</strong>，<code>#get(id)</code> 方法的返回的结果是 <code>status = 500</code> ，而 <code>#add(addDTO)</code> 方法的返回的结果是 <code>status = 400</code> 。</p>
<ul>
<li>对于 <code>#get(id)</code> 方法，在 MethodValidationInterceptor 拦截器中，校验到参数不正确，会抛出 <a href="https://github.com/eclipse-ee4j/beanvalidation-api/blob/master/src/main/java/javax/validation/ConstraintViolationException.java" target="_blank" rel="noopener">ConstraintViolationException</a> 异常。</li>
<li>对于 <code>#add(addDTO)</code> 方法，因为 <code>addDTO</code> 是个 POJO 对象，所以会走 SpringMVC 的 <a href="https://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/validation.html#validation-binder" target="_blank" rel="noopener">DataBinder</a> 机制，它会调用 <code>DataBinder#validate(Object... validationHints)</code> 方法，进行校验。在校验不通过时，会抛出 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/validation/BindException.html" target="_blank" rel="noopener">BindException</a> 。</li>
</ul>
<p>在 SpringMVC 中，默认使用 <a href="https://hyrepo.com/tech/spring-mvc-error-handling/" target="_blank" rel="noopener">DefaultHandlerExceptionResolver</a> 处理异常。</p>
<ul>
<li>对于 BindException 异常，处理成 400 的状态码。</li>
<li>对于 ConstraintViolationException 异常，没有特殊处理，所以处理成 500 的状态码。</li>
</ul>
<p>相比在 Controller 添加参数校验来说，在 Service 进行参数校验，会更加安全可靠。Controller 的参数校验可以不做，<strong>Service 的参数校验一定要做</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserService.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">(@Min(value = <span class="number">1</span>L, message = <span class="string">"编号必须大于 0"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[get][id: &#123;&#125;]"</span>, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(@Valid UserAddDTO addDTO)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[add][addDTO: &#123;&#125;]"</span>, addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add01</span><span class="params">(UserAddDTO addDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.add(addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add02</span><span class="params">(UserAddDTO addDTO)</span> </span>&#123;</span><br><span class="line">        self().add(addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> UserService <span class="title">self</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (UserService) AopContext.currentProxy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserService.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= Application<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">UserServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        userService.get(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAdd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserAddDTO addDTO = <span class="keyword">new</span> UserAddDTO();</span><br><span class="line">        userService.add(addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAdd01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserAddDTO addDTO = <span class="keyword">new</span> UserAddDTO();</span><br><span class="line">        userService.add01(addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAdd02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserAddDTO addDTO = <span class="keyword">new</span> UserAddDTO();</span><br><span class="line">        userService.add02(addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>① <code>#testGet()</code> 测试方法</strong></p>
<p>执行，抛出 ConstraintViolationException 异常。日志如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javax.validation.ConstraintViolationException: get.id: 编号必须大于 <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	at org.springframework.validation.beanvalidation.MethodValidationInterceptor.invoke(MethodValidationInterceptor.java:<span class="number">116</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>符合预期</li>
</ul>
<p><strong>② <code>#testAdd()</code> 测试方法</strong></p>
<p>执行，抛出 ConstraintViolationException 异常。日志如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javax.validation.ConstraintViolationException: add.addDTO.username: 登陆账号不能为空, add.addDTO.password: 密码不能为空</span><br><span class="line"></span><br><span class="line">	at org.springframework.validation.beanvalidation.MethodValidationInterceptor.invoke(MethodValidationInterceptor.java:<span class="number">116</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>符合期望。不同于我们在调用 <code>UserController#add(addDTO)</code> 方法，这里被 MethodValidationInterceptor 拦截，进行参数校验，而不是 DataBinder 当中。</li>
</ul>
<p><strong>③ <code>#testAdd01()</code> 测试方法</strong></p>
<p>执行，正常结束。因为进行 <code>this.add(addDTO)</code> 调用时，<code>this</code> 并不是 Spring AOP 代理对象，所以并不会被 MethodValidationInterceptor 所拦截。</p>
<h2 id="5-自定义约束"><a href="#5-自定义约束" class="headerlink" title="5. 自定义约束"></a>5. 自定义约束</h2><p>开发自定义约束一共只要<strong>两步</strong>：1）编写自定义约束的<strong>注解</strong>；2）编写自定义的<strong>校验器 ConstraintValidator</strong> 。</p>
<h3 id="5-1-示例"><a href="#5-1-示例" class="headerlink" title="5.1 示例"></a>5.1 示例</h3><p>创建 IntArrayValuable 接口，用于返回值数组。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IntArrayValuable.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IntArrayValuable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span>[] array();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GenderEnum.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> GenderEnum implements IntArrayValuable &#123;</span><br><span class="line"></span><br><span class="line">    MALE(<span class="number">1</span>, <span class="string">"男"</span>),</span><br><span class="line">    FEMALE(<span class="number">2</span>, <span class="string">"女"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 值数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] ARRAYS = Arrays.stream(values()).mapToInt(GenderEnum::getValue).toArray();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer value;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    GenderEnum(Integer value, String name) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] array() &#123;</span><br><span class="line">        <span class="keyword">return</span> ARRAYS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现 IntArrayValuable 接口，返回值数组 <code>ARRAYS</code> 。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InEnum.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(&#123;METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = InEnumValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">InEnum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实现 IntArrayValuable 接口的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? extends IntArrayValuable&gt; value();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 提示内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "必须在指定范围 </span>&#123;value&#125;<span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * @return 分组</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    Class&lt;?&gt;[] groups() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * @return Payload 数组</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     *  Defines several &#123;@code @InEnum&#125; constraints on the same element.</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    @Target(&#123;METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE&#125;)</span></span><br><span class="line"><span class="string">    @Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="string">    @Documented</span></span><br><span class="line"><span class="string">    @interface List &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        InEnum[] value();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <code>@@Constraint(validatedBy = InEnumValidator.class)</code> 注解，设置使用的<strong>自定义约束的校验器</strong>。</li>
<li><code>value()</code> 属性，设置实现 IntArrayValuable 接口的类。这样，就能获得参数需要校验的值数组。</li>
<li><code>message()</code> 属性，设置提示内容。默认为 <code>&quot;必须在指定范围 {value}&quot;</code> 。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InEnumValidator.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InEnumValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">InEnum</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 值数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Integer&gt; values;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(InEnum annotation)</span> </span>&#123;</span><br><span class="line">        IntArrayValuable[] values = annotation.value().getEnumConstants();</span><br><span class="line">        <span class="keyword">if</span> (values.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.values = Collections.emptySet();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.values = Arrays.stream(values[<span class="number">0</span>].array()).boxed().collect(Collectors.toSet());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Integer value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// &lt;2.1&gt; 校验通过</span></span><br><span class="line">        <span class="keyword">if</span> (values.contains(value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &lt;2.2.1&gt;校验不通过，自定义提示语句（因为，注解上的 value 是枚举类，无法获得枚举类的实际值）</span></span><br><span class="line">        context.disableDefaultConstraintViolation(); <span class="comment">// 禁用默认的 message 的值</span></span><br><span class="line">        context.buildConstraintViolationWithTemplate(context.getDefaultConstraintMessageTemplate()</span><br><span class="line">                .replaceAll(<span class="string">"\\&#123;value&#125;"</span>, values.toString())).addConstraintViolation(); <span class="comment">// 重新添加错误提示语句      </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// &lt;2.2.2.&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现 <a href="https://github.com/beanvalidation/beanvalidation-api/blob/master/src/main/java/javax/validation/ConstraintValidator.java" target="_blank" rel="noopener">ConstraintValidator</a> 接口<ul>
<li>第一个泛型为 <code>A extends Annotation</code> ，设置对应的自定义约束的注解。例如说，这里设置了 <code>@InEnum</code> 注解。</li>
<li>第二个泛型为 <code>T</code> ，设置对应的参数值的类型。例如说，这里设置了 Integer 类型。</li>
</ul>
</li>
<li>实现 <code>#initialize(annotation)</code> 方法，获得 <code>@InEnum</code> 注解的 <code>values()</code> 属性，获得值数组，设置到 <code>values</code> 属性。</li>
<li>实现 <code>#isValid(value, context)</code> 方法，实现校验参数值，是否在 <code>values</code> 范围内。<ul>
<li><code>&lt;2.1&gt;</code> 处，校验参数值在范围内，直接返回 <code>true</code> ，校验通过。</li>
<li><code>&lt;2.2.1&gt;</code> 处，校验不通过，自定义提示语句。</li>
<li><code>&lt;2.2.2&gt;</code> 处，校验不通过，所以返回 <code>false</code> 。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserUpdateGenderDTO.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserUpdateGenderDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull</span>(message = <span class="string">"用户编号不能为空"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull</span>(message = <span class="string">"性别不能为空"</span>)</span><br><span class="line">    <span class="meta">@InEnum</span>(value = GenderEnum<span class="class">.<span class="keyword">class</span>, <span class="title">message</span> </span>= <span class="string">"性别必须是 &#123;value&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 <code>gender</code> 字段上，添加 <code>@InEnum(value = GenderEnum.class, message = &quot;性别必须是 {value}&quot;)</code> 注解，限制传入的参数值，必须在 GenderEnum 枚举范围内。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/update_gender"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateGender</span><span class="params">(@Valid UserUpdateGenderDTO updateGenderDTO)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[updateGender][updateGenderDTO: &#123;&#125;]"</span>, updateGenderDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模拟请求该 API 接口，响应结果如下：<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfdzr3hjekj31560og77b.jpg" alt="响应结果"></p>
<h2 id="6-分组校验"><a href="#6-分组校验" class="headerlink" title="6. 分组校验"></a>6. 分组校验</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserUpdateStatusDTO.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserUpdateStatusDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分组 01 ，要求状态必须为 true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Group01</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态 02 ，要求状态必须为 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Group02</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AssertTrue</span>(message = <span class="string">"状态必须为 true"</span>, groups = Group01<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">AssertFalse</span>(<span class="title">message</span> </span>= <span class="string">"状态必须为 false"</span>, groups = Group02<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">Boolean</span> <span class="title">status</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建了 Group01 和 Group02 接口，作为两个校验分组。不一定要定义在 UserUpdateStatusDTO 类中，这里仅仅是为了方便。</li>
<li><code>status</code> 字段，在 Group01 校验分组时，必须为 <code>true</code> ；在 Group02 校验分组时，必须为 <code>false</code> 。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/update_status_true"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateStatusTrue</span><span class="params">(@Validated(UserUpdateStatusDTO.Group01.class)</span> UserUpdateStatusDTO updateStatusDTO) </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[updateStatusTrue][updateStatusDTO: &#123;&#125;]"</span>, updateStatusDTO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/update_status_false"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateStatusFalse</span><span class="params">(@Validated(UserUpdateStatusDTO.Group02.class)</span> UserUpdateStatusDTO updateStatusDTO) </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[updateStatusFalse][updateStatusDTO: &#123;&#125;]"</span>, updateStatusDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>对于 <code>#updateStatusTrue(updateStatusDTO)</code> 方法，我们在 <code>updateStatusDTO</code> 参数上，添加了 <code>@Validated</code> 注解，并且设置校验分组为 Group01 。校验不通过示例如下图：<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfe12iny8rj312c0oidiv.jpg" alt="不通过示例 1"></p>
</li>
<li><p>对于 <code>#updateStatusFalse(updateStatusDTO)</code> 方法，我们在 <code>updateStatusDTO</code> 参数上，添加了 <code>@Validated</code> 注解，并且设置校验分组为 Group02 。校验不通过示例如下图：<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfe148ktp3j30vm0oqgod.jpg" alt="不通过示例 2"></p>
</li>
</ul>
<p>所以，使用分组校验，核心在于添加上 <code>@Validated</code> 注解，并设置对应的校验分组。</p>
<h2 id="7-手动校验"><a href="#7-手动校验" class="headerlink" title="7. 手动校验"></a>7. 手动校验</h2><p>增加手动参数校验的示例。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserServiceTest.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span> <span class="comment">// &lt;1.1&gt;</span></span><br><span class="line"><span class="keyword">private</span> Validator validator;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testValidator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 打印，查看 validator 的类型 // &lt;1.2&gt;</span></span><br><span class="line">    System.out.println(validator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 UserAddDTO 对象 // &lt;2&gt;</span></span><br><span class="line">    UserAddDTO addDTO = <span class="keyword">new</span> UserAddDTO();</span><br><span class="line">    <span class="comment">// 校验 // &lt;3&gt;</span></span><br><span class="line">    Set&lt;ConstraintViolation&lt;UserAddDTO&gt;&gt; result = validator.validate(addDTO);</span><br><span class="line">    <span class="comment">// 打印校验结果 // &lt;4&gt;</span></span><br><span class="line">    <span class="keyword">for</span> (ConstraintViolation&lt;UserAddDTO&gt; constraintViolation : result) &#123;</span><br><span class="line">        <span class="comment">// 属性:消息</span></span><br><span class="line">        System.out.println(constraintViolation.getPropertyPath() + <span class="string">":"</span> + constraintViolation.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>&lt;1.1&gt;</code> 处，注入 Validator Bean 对象。</p>
</li>
<li><p><code>&lt;1.2&gt;</code> 处，打印 <code>validator</code> 的类型。输出如下：</p>
<p><code>org.springframework.validation.beanvalidation.LocalValidatorFactoryBean@48c3205a</code></p>
<ul>
<li><code>validator</code> 的类型为 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/validation/beanvalidation/LocalValidatorFactoryBean.java" target="_blank" rel="noopener">LocalValidatorFactoryBean</a> 。LocalValidatorFactoryBean 提供 JSR-303、JSR-349 的支持，同时兼容 Hibernate Validator 。</li>
<li>在 Spring Boot 体系中，使用 <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/validation/ValidationAutoConfiguration.java" target="_blank" rel="noopener">ValidationAutoConfiguration</a> 自动化配置类，默认创建 LocalValidatorFactoryBean 作为 Validator Bean 。</li>
</ul>
</li>
<li><p><code>&lt;2&gt;</code> 处，创建 UserAddDTO 对象。</p>
</li>
<li><p><code>&lt;3&gt;</code> 处，调用 <code>Validator#validate(T object, Class&lt;?&gt;... groups)</code> 方法，进行参数校验。</p>
</li>
<li><p><code>&lt;4&gt;</code> 处，打印校验结果。输出如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username:登陆账号不能为空</span><br><span class="line">password:密码不能为空</span><br></pre></td></tr></table></figure>

<ul>
<li>如果校验通过，则返回的 <code>Set&lt;ConstraintViolation&lt;?&gt;&gt;</code> 集合为空。</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/02/Web%E5%BC%80%E5%8F%91-SpringBoot%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8CValidation%E5%85%A5%E9%97%A8/" data-id="ckbg9kucq00152r07a1zy4w3i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SPring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">SPring Boot-基础-01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Validation/" rel="tag">Validation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Web开发-SpringBootAPI接口文档Swagger入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/01/Web%E5%BC%80%E5%8F%91-SpringBootAPI%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3Swagger%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-01T03:28:52.000Z" itemprop="datePublished">2020-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/01/Web%E5%BC%80%E5%8F%91-SpringBootAPI%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3Swagger%E5%85%A5%E9%97%A8/">Web开发-SpringBootAPI接口文档Swagger入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-API-接口文档-Swagger-入门"><a href="#Spring-Boot-API-接口文档-Swagger-入门" class="headerlink" title="Spring Boot API 接口文档 Swagger 入门"></a>Spring Boot API 接口文档 Swagger 入门</h1><h2 id="1-快速入门-Swagger"><a href="#1-快速入门-Swagger" class="headerlink" title="1. 快速入门 Swagger"></a>1. 快速入门 Swagger</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入 Swagger 依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 引入 Swagger UI 依赖，以实现 API 接口的 UI 界面 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建 SwaggerConfiguration 配置类，用于配置 Swagger 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SwaggerConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2 <span class="comment">// 标记项目启用 Swagger API 接口文档</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 Docket 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2) <span class="comment">// 文档类型，使用 Swagger2</span></span><br><span class="line">                .apiInfo(<span class="keyword">this</span>.apiInfo()) <span class="comment">// 设置 API 信息</span></span><br><span class="line">                <span class="comment">// 扫描 Controller 包路径，获得 API 接口</span></span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"cn.iocoder.springboot.lab24.apidoc.controller"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                <span class="comment">// 构建出 Docket 对象</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 API 信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                .title(<span class="string">"测试接口文档示例"</span>)</span><br><span class="line">                .description(<span class="string">"我是一段描述"</span>)</span><br><span class="line">                .version(<span class="string">"1.0.0"</span>) <span class="comment">// 版本号</span></span><br><span class="line">                .contact(<span class="keyword">new</span> Contact(<span class="string">"芋艿"</span>, <span class="string">"http://www.iocoder.cn"</span>, <span class="string">"zhijiantianya@gmail.com"</span>)) <span class="comment">// 联系人</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <a href="http://springfox.github.io/springfox/javadoc/2.5.0/index.html?springfox/documentation/swagger2/annotations/EnableSwagger2.html" target="_blank" rel="noopener"><code>@EnableSwagger2</code></a> 注解， 标记项目启用 Swagger API 接口文档。</li>
<li>通过 <code>#createRestApi()</code> 方法，创建 Swagger <a href="https://github.com/springfox/springfox/blob/master/springfox-spring-web/src/main/java/springfox/documentation/spring/web/plugins/Docket.java" target="_blank" rel="noopener">Docket</a> Bean 。其他配置：<ul>
<li><a href="https://github.com/springfox/springfox/blob/master/springfox-spring-web/src/main/java/springfox/documentation/spring/web/plugins/Docket.java" target="_blank" rel="noopener">Docket.java</a></li>
<li><a href="https://github.com/springfox/springfox/blob/master/springfox-core/src/main/java/springfox/documentation/service/ApiInfo.java" target="_blank" rel="noopener">ApiInfo.java</a></li>
</ul>
</li>
</ul>
<p>创建 <code>UserController</code> 类，提供用户 API 接口。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"用户 API 接口"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"查询用户列表"</span>, notes = <span class="string">"目前仅仅是作为测试，所以返回用户全列表"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserVO&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 查询列表</span></span><br><span class="line">        List&lt;UserVO&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">1</span>).setUsername(<span class="string">"yudaoyuanma"</span>));</span><br><span class="line">        result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">2</span>).setUsername(<span class="string">"woshiyutou"</span>));</span><br><span class="line">        result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">3</span>).setUsername(<span class="string">"chifanshuijiao"</span>));</span><br><span class="line">        <span class="comment">// 返回列表</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/get"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"获得指定用户编号的用户"</span>)</span><br><span class="line">    <span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>, value = <span class="string">"用户编号"</span>, paramType = <span class="string">"query"</span>, dataTypeClass = Integer<span class="class">.<span class="keyword">class</span>, <span class="title">required</span> </span>= <span class="keyword">true</span>, example = <span class="string">"1024"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserVO <span class="title">get</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        <span class="comment">// 查询并返回用户</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserVO().setId(id).setUsername(UUID.randomUUID().toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"add"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"添加用户"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">add</span><span class="params">(UserAddDTO addDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 插入用户记录，返回编号</span></span><br><span class="line">        Integer returnId = UUID.randomUUID().hashCode();</span><br><span class="line">        <span class="comment">// 返回用户编号</span></span><br><span class="line">        <span class="keyword">return</span> returnId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"更新指定用户编号的用户"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">update</span><span class="params">(UserUpdateDTO updateDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 更新用户记录</span></span><br><span class="line">        Boolean success = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// 返回更新是否成功</span></span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/delete"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"删除指定用户编号的用户"</span>)</span><br><span class="line">    <span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>, value = <span class="string">"用户编号"</span>, paramType = <span class="string">"query"</span>, dataTypeClass = Integer<span class="class">.<span class="keyword">class</span>, <span class="title">required</span> </span>= <span class="keyword">true</span>, example = <span class="string">"1024"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">delete</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        <span class="comment">// 删除用户记录</span></span><br><span class="line">        Boolean success = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 返回是否更新成功</span></span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-注解"><a href="#2-注解" class="headerlink" title="2. 注解"></a>2. 注解</h2><h3 id="1-Api"><a href="#1-Api" class="headerlink" title="1. @Api"></a>1. <code>@Api</code></h3><p><a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/Api.java" target="_blank" rel="noopener"><code>@Api</code></a> 注解，添加在 Controller 类上，标记它作为 Swagger 文档资源。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"用户 API 接口"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下:</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcqgfrqrbj30mx040gnm.jpg" alt="image-20200601133941415"></p>
<p><code>@Api</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>tags</code> 属性：用于控制 API 所属的标签列表。<code>[]</code> 数组，可以填写多个。 <ul>
<li>可以在<strong>一个</strong> Controller 上的 <code>@Api</code> 的 <code>tags</code> 属性，设置<strong>多个</strong>标签，那么这个 Controller 下的 API 接口，就会出现在这<strong>两个</strong>标签中。</li>
<li>如果在<strong>多个</strong> Controller 上的 <code>@Api</code> 的 <code>tags</code> 属性，设置<strong>一个</strong>标签，那么这些 Controller 下的 API 接口，仅会出现在这<strong>一个</strong>标签中。</li>
<li>本质上，<code>tags</code> 就是为了分组 API 接口，和 Controller 本质上是一个目的。所以绝大数场景下，我们只会给一个 Controller 一个<strong>唯一</strong>的标签。例如说，UserController 的 <code>tags</code> 设置为 <code>&quot;用户 API 接口&quot;</code> 。</li>
</ul>
</li>
</ul>
<p><code>@Api</code> 注解的<strong>不常用属性</strong>，如下：</p>
<ul>
<li><code>produces</code> 属性：请求请求头的<strong>可接受类型</strong>( <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept" target="_blank" rel="noopener">Accept</a> )。如果有多个，使用 <code>,</code> 分隔。</li>
<li><code>consumes</code> 属性：请求请求头的<strong>提交内容类型</strong>( <a href="https://juejin.im/post/5cb34fc06fb9a068a75d3555" target="_blank" rel="noopener">Content-Type</a> )。如果有多个，使用 <code>,</code> 分隔。</li>
<li><code>protocols</code> 属性：协议，可选值为 <code>&quot;http&quot;</code>、<code>&quot;https&quot;</code>、<code>&quot;ws&quot;</code>、<code>&quot;wss&quot;</code> 。如果有多个，使用 <code>,</code> 分隔。</li>
<li><code>authorizations</code> 属性：授权相关的配置，<code>[]</code> 数组，使用 <a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/Authorization.java" target="_blank" rel="noopener"><code>@Authorization</code></a> 注解。</li>
<li><code>hidden</code> 属性：是否隐藏，不再 API 接口文档中显示。</li>
</ul>
<p><code>@Api</code> 注解的<strong>废弃属性</strong>，不建议使用，有 <code>value</code>、<code>description</code>、<code>basePath</code>、<code>position</code> 。</p>
<h3 id="2-ApiOperation"><a href="#2-ApiOperation" class="headerlink" title="2. @ApiOperation"></a>2. <code>@ApiOperation</code></h3><p><a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ApiOperation.java" target="_blank" rel="noopener"><code>@ApiOperation</code></a> 注解，添加在 Controller 方法上，标记它是一个 API 操作。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"查询用户列表"</span>, notes = <span class="string">"目前仅仅是作为测试，所以返回用户全列表"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;UserVO&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 查询列表</span></span><br><span class="line">    List&lt;UserVO&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">1</span>).setUsername(<span class="string">"yudaoyuanma"</span>));</span><br><span class="line">    result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">2</span>).setUsername(<span class="string">"woshiyutou"</span>));</span><br><span class="line">    result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">3</span>).setUsername(<span class="string">"chifanshuijiao"</span>));</span><br><span class="line">    <span class="comment">// 返回列表</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcqo5tcm2j30pk0ft79e.jpg" alt="image-20200601134708940"></p>
<p><code>@ApiOperation</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>value</code> 属性：API 操作名。</li>
<li><code>notes</code> 属性：API 操作的描述。</li>
</ul>
<p><code>@ApiOperation</code> 注解的<strong>不常用属性</strong>，如下：</p>
<ul>
<li><code>tags</code> 属性：和 <code>@API</code> 注解的 <code>tags</code> 属性一致。</li>
<li><code>nickname</code> 属性：API 操作接口的唯一标识，主要用于和第三方工具做对接。</li>
<li><code>httpMethod</code> 属性：请求方法，可选值为 <code>GET</code>、<code>HEAD</code>、<code>POST</code>、<code>PUT</code>、<code>DELETE</code>、<code>OPTIONS</code>、<code>PATCH</code> 。因为 Swagger 会解析 SpringMVC 的注解，所以一般无需填写。</li>
<li><code>produces</code> 属性：和 <code>@API</code> 注解的 <code>produces</code> 属性一致。</li>
<li><code>consumes</code> 属性：和 <code>@API</code> 注解的 <code>consumes</code> 属性一致。</li>
<li><code>protocols</code> 属性：和 <code>@API</code> 注解的 <code>protocols</code> 属性一致。</li>
<li><code>authorizations</code> 属性：和 <code>@API</code> 注解的 <code>authorizations</code> 属性一致。</li>
<li><code>hidden</code> 属性：和 <code>@API</code> 注解的 <code>hidden</code> 属性一致。</li>
<li><code>response</code> 属性：响应结果类型。因为 Swagger 会解析方法的返回类型，所以一般无需填写。</li>
<li><code>responseContainer</code> 属性：响应结果的容器，可选值为 <code>List</code>、<code>Set</code>、<code>Map</code> 。</li>
<li><code>responseReference</code> 属性：指定对响应类型的引用。这个引用可以是本地，也可以是远程。并且，当设置了它时，会覆盖 <code>response</code> 属性。可以忽略这个属性。</li>
<li><code>responseHeaders</code> 属性：响应头，<code>[]</code> 数组，使用 <a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ResponseHeader.java" target="_blank" rel="noopener"><code>@ResponseHeader</code></a> 注解。</li>
<li><code>code</code> 属性：响应状态码，默认为 200 。</li>
<li><code>extensions</code> 属性：拓展属性，<code>[]</code> 属性，使用 <a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/Extension.java" target="_blank" rel="noopener"><code>@Extension</code></a> 注解。</li>
<li><code>ignoreJsonView</code> 属性：在解析操作和类型，忽略 JsonView 注释。主要是为了向后兼容。</li>
</ul>
<p><code>@ApiOperation</code> 注解的<strong>废弃属性</strong>，不建议使用，有 <code>position</code> 。</p>
<h3 id="3-ApiImplicitParam"><a href="#3-ApiImplicitParam" class="headerlink" title="3. @ApiImplicitParam"></a>3. <code>@ApiImplicitParam</code></h3><p><a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ApiImplicitParam.java" target="_blank" rel="noopener"><code>@ApiImplicitParam</code></a> 注解，添加在 Controller 方法上，声明每个请求参数的信息。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/delete"</span>)</span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"删除指定用户编号的用户"</span>)</span><br><span class="line"><span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>, value = <span class="string">"用户编号"</span>, paramType = <span class="string">"query"</span>, dataTypeClass = Integer<span class="class">.<span class="keyword">class</span>, <span class="title">required</span> </span>= <span class="keyword">true</span>, example = <span class="string">"1024"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">delete</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">    <span class="comment">// 删除用户记录</span></span><br><span class="line">    Boolean success = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 返回是否更新成功</span></span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcqtsmu9cj30pt05xjsu.jpg" alt="image-20200601135232838"></p>
<p><code>@ApiImplicitParam</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>name</code> 属性：参数名。</li>
<li><code>value</code> 属性：参数的简要说明。</li>
<li><code>required</code> 属性：是否为必传参数。默认为 <code>false</code> 。</li>
<li><code>dataType</code> 属性：数据类型，通过字符串 String 定义。</li>
<li><code>dataTypeClass</code> 属性：数据类型，通过 <code>dataTypeClass</code> 定义。在设置了 <code>dataTypeClass</code> 属性的情况下，会覆盖 <code>dataType</code> 属性。<strong>推荐采用这个方式</strong>。</li>
<li><code>paramType</code> 属性：参数所在位置的类型。有如下 5 种方式：<ul>
<li><code>&quot;path&quot;</code> 值：对应 SpringMVC 的 <code>@PathVariable</code> 注解。</li>
<li>【<em>默认值</em>】<code>&quot;query&quot;</code> 值：对应 SpringMVC 的 <code>@PathVariable</code> 注解。</li>
<li><code>&quot;body&quot;</code> 值：对应 SpringMVC 的 <code>@RequestBody</code> 注解。</li>
<li><code>&quot;header&quot;</code> 值：对应 SpringMVC 的 <code>@RequestHeader</code> 注解。</li>
<li><code>&quot;form&quot;</code> 值：Form 表单提交，对应 SpringMVC 的 <code>@PathVariable</code> 注解。</li>
<li><strong>绝大多数情况下，使用 <code>&quot;query&quot;</code> 值这个类型即可。</strong></li>
</ul>
</li>
<li><code>example</code> 属性：参数值的简单示例。</li>
<li><code>examples</code> 属性：参数值的复杂示例，使用 <a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/Example.java" target="_blank" rel="noopener"><code>@Example</code></a> 注解。</li>
</ul>
<p><code>@ApiImplicitParam</code> 注解的<strong>不常用属性</strong>，如下：</p>
<ul>
<li><code>defaultValue</code> 属性：默认值。</li>
<li><code>allowableValues</code> 属性：允许的值。如果要设置多个值，有两种方式：<ul>
<li>数组方式，即 <code>{value1, value2, value3}</code> 。例如说，<code>{1, 2, 3}</code> 。</li>
<li>范围方式，即 <code>[value1, value2]</code> 或 <code>[value1, value2)</code> 。例如说 <code>[1, 5]</code> 表示 1 到 5 的所有数字。如果有无穷的，可以使用 <code>(-infinity, value2]</code> 或 <code>[value1, infinity)</code> 。</li>
</ul>
</li>
<li><code>allowEmptyValue</code> 属性：是否允许空值。</li>
<li><code>allowMultiple</code> 属性：是否允许通过多次传递该参数来接受多个值。默认为 <code>false</code> 。</li>
<li><code>type</code> 属性：搞不懂具体用途，对应英文注释为 <code>Adds the ability to override the detected type</code> 。</li>
<li><code>readOnly</code> 属性：是否只读。</li>
<li><code>format</code> 属性：自定义的格式化。</li>
<li><code>collectionFormat</code> 属性：针对 Collection 集合的，自定义的格式化。</li>
</ul>
<p>需要添加在方法上添加多个 <code>@ApiImplicitParam</code> 注解时，可以使用 <a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ApiImplicitParams.java" target="_blank" rel="noopener">@ApiImplicitParams</a> 注解中添加多个。示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiImplicitParams</span>(&#123; <span class="comment">// 参数数组</span></span><br><span class="line">        <span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>, value = <span class="string">"用户编号"</span>, paramType = <span class="string">"query"</span>, dataTypeClass = Integer<span class="class">.<span class="keyword">class</span>, <span class="title">required</span> </span>= <span class="keyword">true</span>, example = <span class="string">"1024"</span>), <span class="comment">// 参数一</span></span><br><span class="line">        <span class="meta">@ApiImplicitParam</span>(name = <span class="string">"name"</span>, value = <span class="string">"昵称"</span>, paramType = <span class="string">"query"</span>, dataTypeClass = String<span class="class">.<span class="keyword">class</span>, <span class="title">required</span> </span>= <span class="keyword">true</span>, example = <span class="string">"芋道"</span>), <span class="comment">// 参数二</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="4-ApiModel"><a href="#4-ApiModel" class="headerlink" title="4. @ApiModel"></a>4. <code>@ApiModel</code></h3><p><a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ApiModel.java" target="_blank" rel="noopener"><code>@ApiModel</code></a> 注解，添加在 POJO 类，声明 POJO 类的信息。而在 Swagger 中，把这种 POJO 类称为 <strong>Model</strong> 类。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserVO.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModel</span>(<span class="string">"用户 VO"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcqykqf0kj30pm0dowgm.jpg" alt="image-20200601135709332"></p>
<p><code>@ApiModel</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>value</code> 属性：Model 名字。</li>
<li><code>description</code> 属性：Model 描述。</li>
</ul>
<h3 id="5-ApiModelProperty"><a href="#5-ApiModelProperty" class="headerlink" title="5. @ApiModelProperty"></a>5. <code>@ApiModelProperty</code></h3><p><a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ApiModelProperty.java" target="_blank" rel="noopener"><code>@ApiModelProperty</code></a> 注解，添加在 Model 类的成员变量上，声明每个成员变量的信息。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserVO.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModel</span>(<span class="string">"用户 VO"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户编号"</span>, required = <span class="keyword">true</span>, example = <span class="string">"1024"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"账号"</span>, required = <span class="keyword">true</span>, example = <span class="string">"yudaoyuanma"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcqzzsoamj30pg0fyjrm.jpg" alt="@ApiModelProperty 示例"></p>
<p><code>@ApiModelProperty</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>value</code> 属性：属性的描述。</li>
<li><code>dataType</code> 属性：和 <code>@ApiImplicitParam</code> 注解的 <code>dataType</code> 属性一致。不过因为 <code>@ApiModelProperty</code> 是添加在成员变量上，可以自动获得成员变量的类型。</li>
<li><code>required</code> 属性：和 <code>@ApiImplicitParam</code> 注解的 <code>required</code> 属性一致。</li>
<li><code>example</code> 属性：<code>@ApiImplicitParam</code> 注解的 <code>example</code> 属性一致。</li>
</ul>
<h3 id="6-ApiResponse"><a href="#6-ApiResponse" class="headerlink" title="6. @ApiResponse"></a>6. <code>@ApiResponse</code></h3><p>在大多数情况下，并不需要使用 <code>@ApiResponse</code> 注解，因为会类似 <code>UserController#get(id)</code> 方法这个接口，返回一个 Model 即可。</p>
<h2 id="3-更好看的-Swagger-UI-界面"><a href="#3-更好看的-Swagger-UI-界面" class="headerlink" title="3. 更好看的 Swagger UI 界面"></a>3. 更好看的 Swagger UI 界面</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1. swagger-bootstrap-ui 目前改名为 knife4j --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 2. 实现 swagger-bootstrap-ui 的自动化配置  --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 3. 因为 knife4j-spring 已经引入 Swagger 依赖，所以无需重复引入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>直接使用 Application 启动项目，无需做其它任何的变更，方便的说。</p>
<p>浏览器访问 <code>http://localhost:8080/doc.html</code> 地址，就可以看到 <strong>新</strong>的 Swagger 生成的 API 接口文档。<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcr552x9ej31h10u0jub.jpg" alt="swagger-bootstrap-ui 示例"></p>
<h2 id="4-更强大的-YApi"><a href="#4-更强大的-YApi" class="headerlink" title="4. 更强大的 YApi"></a>4. 更强大的 YApi</h2><p>使用 <a href="https://github.com/YMFE/yapi" target="_blank" rel="noopener">YApi</a> 可视化接口管理平台，自动调用 Swagger 提供的 <code>v2/api-docs</code> 接口，采集 Swagger 注解生成的 API 接口信息，从而录入到 YApi 中。</p>
<p>FROM <a href="https://github.com/YMFE/yapi" target="_blank" rel="noopener">https://github.com/YMFE/yapi</a></p>
<p>YApi 是<strong>高效</strong>、<strong>易用</strong>、<strong>功能强大</strong>的 api 管理平台，旨在为开发、产品、测试人员提供更优雅的接口管理服务。可以帮助开发者轻松创建、发布、维护 API，YApi 还为用户提供了优秀的交互体验，开发人员只需利用平台提供的接口数据写入工具以及简单的点击操作就可以实现接口的管理。</p>
<ul>
<li>基于 Json5 和 Mockjs 定义接口返回数据的结构和文档，效率提升多倍</li>
<li>扁平化权限设计，即保证了大型企业级项目的管理，又保证了易用性</li>
<li>类似 postman 的接口调试</li>
<li>自动化测试, 支持对 Response 断言</li>
<li>MockServer 除支持普通的随机 mock 外，还增加了 Mock 期望功能，根据设置的请求过滤规则，返回期望数据</li>
<li>支持 postman, har, swagger 数据导入</li>
<li>免费开源，内网部署，信息再也不怕泄露了</li>
</ul>
<h3 id="1-安装-mongodb"><a href="#1-安装-mongodb" class="headerlink" title="1. 安装 mongodb"></a>1. 安装 mongodb</h3><h3 id="2-安装-Node-js"><a href="#2-安装-Node-js" class="headerlink" title="2. 安装 Node.js"></a>2. 安装 Node.js</h3><h3 id="3-安装-yapi-cli"><a href="#3-安装-yapi-cli" class="headerlink" title="3. 安装 yapi-cli"></a>3. 安装 yapi-cli</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装 yapi-cli 工具</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install -g yapi-cli --registry https://registry.npm.taobao.org</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动 YApi 平台部署工具</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yapi server</span></span><br><span class="line">在浏览器打开 http://0.0.0.0:9090 访问。非本地服务器，请将 0.0.0.0 替换成指定的域名或ip</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/01/Web%E5%BC%80%E5%8F%91-SpringBootAPI%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3Swagger%E5%85%A5%E9%97%A8/" data-id="ckbg9kucl000x2r07h9ru4new" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swagger/" rel="tag">Swagger</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Java线程池" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/29/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/" class="article-date">
  <time datetime="2020-05-29T07:41:46.000Z" itemprop="datePublished">2020-05-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/29/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/">Java线程池</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Java-线程池"><a href="#Java-线程池" class="headerlink" title="Java 线程池"></a>Java 线程池</h1><h2 id="1-线程池"><a href="#1-线程池" class="headerlink" title="1. 线程池"></a>1. 线程池</h2><p><code>java.util.concurrent.Executors</code> </p>
<p>在代码的开头的注释上就写明了，它可以创建重复使用固定数量线程的线程池，如果在所有线程都处于活动状态时提交了其他任务，那么他们将在队列中等待线程可用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                      <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>做Java的，当然知道线程池，我们在做开发的时候有时候需要做的任务慢慢的增多，复杂性也会变得越来越强，所以线程的个数就会一点点的往上增加，而对应的线程占用的资源也就越来越多，多个线程占用资源的释放与注销需要维护，这时候多个线程的管理就显得有尤为重要。针对这一情况，sun公司提供了线程池，对线程集合的管理工具。所以线程池就出现了</p>
<h2 id="2-常见的线程池都有哪些-使用的场景是哪里呢？"><a href="#2-常见的线程池都有哪些-使用的场景是哪里呢？" class="headerlink" title="2.常见的线程池都有哪些,使用的场景是哪里呢？"></a>2.常见的线程池都有哪些,使用的场景是哪里呢？</h2><p>(1) newSingleThreadExecutor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">单个线程的线程池，即线程池中每次只有一个线程工作，单线程串行执行任务</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                              ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">             threadFactory, defaultHandler);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>(2)newFixedThreadPool</p>
<p>下面的两个方法是这个方法的重载，而它的意思很明确，建立一个线程数量固定的线程池，规定的最大线程数量，超过这个数量之后进来的任务，会放到等待队列中，如果有空闲线程，则在等待队列中获取，遵循先进先出原则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                      <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                      <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>(3)newCacheThreadExecutor</p>
<p>缓存型线程池，这个线程池的意思是在核心线程达到最大值之前，如果继续有任务进来就会创建新的核心线程，并加入核心线程池，即使有空闲的线程，也不会复用。</p>
<p>而达到最大核心线程数后，新任务进来，如果有空闲线程，则直接拿来使用，如果没有空闲线程，则新建临时线程.</p>
<p>而缓存型的线程池使用的是<code>SynchronousQueue</code>作为等待队列，不保存任何的任务，新的任务加入进来之后，他会创建临时线程来进行使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                      <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>(4)newScheduledThreadPool</p>
<p>计划型线程池,在它的注释中给出的很明确的解释，创建一个线程池，该线程池可以计划在给定的延迟，或周期性地执行。</p>
<p>也就是说，在新任务到达的时候，我们看到底有没有空闲线程，如果有，直接拿来使用，如果没有，则新建线程加入池。而这里面使用的就是DelayedWorkQueue作为等待队列，中间进行了一定的等待，等待时间过后，继续执行任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">newScheduledThreadPool</span><span class="params">(<span class="keyword">int</span> corePoolSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ScheduledThreadPoolExecutor(corePoolSize);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">newScheduledThreadPool</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">int</span> corePoolSize, ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ScheduledThreadPoolExecutor(corePoolSize, threadFactory);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-阿里巴巴开发手册"><a href="#3-阿里巴巴开发手册" class="headerlink" title="3.阿里巴巴开发手册"></a>3.阿里巴巴开发手册</h2><p><code>ExecutorService cachedThreadPool=Executors.newFixedThreadPool();</code></p>
<p>阿里巴巴说，强制线程池不允许使用 Executors 去创建</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf9dotncfuj30ii055go5.jpg" alt="image-20200529160114147"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">             Executors.defaultThreadFactory(), defaultHandler);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个方法里面有几个参数</p>
<ul>
<li>corePoolSize 要保留在池中的线程数，也就是线程池核心池的大小</li>
<li>maximumPoolSize 最大线程数</li>
<li>keepAliveTime 当线程数大于核心时，此为终止前多余的空闲线程等待新任务的最长时间。</li>
<li>unit keepAliveTime 参数的时间单位</li>
<li>workQueue 用来储存等待执行任务的队列。</li>
<li>threadFactory 线程工厂</li>
<li>handler 默认的拒绝执行处理程序</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/05/29/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/" data-id="ckbg9kubp00052r07hkyqewbr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Java基础知识-JavaGuide" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/28/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-JavaGuide/" class="article-date">
  <time datetime="2020-05-28T08:17:17.000Z" itemprop="datePublished">2020-05-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/28/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-JavaGuide/">Java基础知识-JavaGuide</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Java-基础知识"><a href="#Java-基础知识" class="headerlink" title="Java 基础知识"></a>Java 基础知识</h1><ul>
<li><p>Constructor 不能被 override（重写）,但是可以 overload（重载）,所以你可以看到一个类中有多个构造函数的情况。</p>
</li>
<li><p>重载：发生在同一个类中，方法名必须相同，参数类型不同、个数不同、顺序不同，方法返回值和访问修饰符可以不同</p>
</li>
<li><table>
<thead>
<tr>
<th>区别点</th>
<th>重载方法</th>
<th>重写方法</th>
</tr>
</thead>
<tbody><tr>
<td>发生范围</td>
<td>同一个类</td>
<td>子类 中</td>
</tr>
<tr>
<td>参数列表</td>
<td>必须修改</td>
<td>一定不能修改</td>
</tr>
<tr>
<td>返回类型</td>
<td>可修改</td>
<td>一定不能修改</td>
</tr>
<tr>
<td>异常</td>
<td>可修改</td>
<td>可以减少或删除，一定不能抛出新的或者更广的异常</td>
</tr>
<tr>
<td>访问修饰符</td>
<td>可修改</td>
<td>一定不能做更严格的限制（可以降低限制）</td>
</tr>
<tr>
<td>发生阶段</td>
<td>编译期</td>
<td>运行期</td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="String-StringBuffer-StringBuilder"><a href="#String-StringBuffer-StringBuilder" class="headerlink" title="String StringBuffer StringBuilder"></a>String StringBuffer StringBuilder</h2><ul>
<li><p><strong>线程安全性</strong></p>
<p>String 中的对象是不可变的，也就可以理解为常量，线程安全。AbstractStringBuilder 是 StringBuilder 与 StringBuffer 的公共父类，定义了一些字符串的基本操作，如 expandCapacity、append、insert、indexOf 等公共方法。StringBuffer 对方法加了同步锁或者对调用的方法加了同步锁，所以是线程安全的。StringBuilder 并没有对方法进行加同步锁，所以是非线程安全的。</p>
</li>
<li><p><strong>性能</strong></p>
<p>每次对 String 类型进行改变的时候，都会生成一个新的 String 对象，然后将指针指向新的 String 对象。StringBuffer 每次都会对 StringBuffer 对象本身进行操作，而不是生成新的对象并改变对象引用。相同情况下使用 StringBuilder 相比使用 StringBuffer 仅能获得 10%~15% 左右的性能提升，但却要冒多线程不安全的风险。</p>
</li>
<li><p><strong>对于三者使用的总结：</strong></p>
<ol>
<li>操作少量的数据: 适用 String</li>
<li>单线程操作字符串缓冲区下操作大量数据: 适用 StringBuilder</li>
<li>多线程操作字符串缓冲区下操作大量数据: 适用 StringBuffer</li>
</ol>
</li>
<li><p>Java 程序在执行子类的构造方法之前，如果没有用 <code>super()</code>来调用父类特定的构造方法，则会调用父类中“没有参数的构造方法”。因此，如果父类中只定义了有参数的构造方法，而在子类的构造方法中又没有用 <code>super()</code>来调用父类中特定的构造方法，则编译时将发生错误，因为 Java 程序在父类中找不到没有参数的构造方法可供执行。解决办法是在父类里加上一个不做事且没有参数的构造方法。</p>
</li>
</ul>
<h2 id="接口和抽象类的区别"><a href="#接口和抽象类的区别" class="headerlink" title="接口和抽象类的区别"></a>接口和抽象类的区别</h2><ol>
<li>接口的方法默认是 public，所有方法在接口中不能有实现(Java 8 开始接口方法可以有默认实现），而抽象类可以有非抽象的方法。</li>
<li>接口中除了 static、final 变量，不能有其他变量，而抽象类中则不一定。</li>
<li>一个类可以实现多个接口，但只能实现一个抽象类。接口自己本身可以通过 extends 关键字扩展多个接口。</li>
<li>接口方法默认修饰符是 public，抽象方法可以有 public、protected 和 default 这些修饰符（抽象方法就是为了被重写所以不能使用 private 关键字修饰！）。</li>
<li>从设计层面来说，抽象是对类的抽象，是一种模板设计，而接口是对行为的抽象，是一种行为的规范。</li>
</ol>
<ol>
<li>在 jdk 7 或更早版本中，接口里面只能有常量变量和抽象方法。这些接口方法必须由选择实现接口的类实现。</li>
<li>jdk8 的时候接口可以有默认方法和静态方法功能。</li>
<li>Jdk 9 在接口中引入了私有方法和私有静态方法。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/05/28/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-JavaGuide/" data-id="ckbg9kubo00042r07end88bjq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag">基础知识</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Web开发-SpringBoot分布式Session入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/28/Web%E5%BC%80%E5%8F%91-SpringBoot%E5%88%86%E5%B8%83%E5%BC%8FSession%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-05-28T06:03:09.000Z" itemprop="datePublished">2020-05-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/28/Web%E5%BC%80%E5%8F%91-SpringBoot%E5%88%86%E5%B8%83%E5%BC%8FSession%E5%85%A5%E9%97%A8/">Web开发-SpringBoot分布式Session入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-分布式-Session-入门"><a href="#Spring-Boot-分布式-Session-入门" class="headerlink" title="Spring Boot 分布式 Session 入门"></a>Spring Boot 分布式 Session 入门</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p><strong>在考虑高性能之前，一定要做高可用</strong></p>
<p>在部署生产环境下的 Tomcat 等 Web 容器的时候，<strong>一定是需要部署多个节点</strong>。此时，Session 的<strong>一致性</strong>就成为一个问题</p>
<p><em>Session 的一致性，简单来理解，就是相同 sessionid 在多个 Web 容器下，Session 的数据要一致。</em></p>
<p>先以用户使用浏览器，Web 服务器为<strong>单台</strong> TomcatA 举例子。</p>
<ul>
<li>浏览器在第一次访问 Web 服务器 TomcatA 时，TomcatA 会发现请求的 Cookie 中<strong>不</strong>存在 sessionid ，所以创建一个 sessionid 为 X 的 Session ，同时将该 sessionid 写回给浏览器的 Cookie 中。</li>
<li>浏览器在下一次访问 Web 服务器 TomcatA 时，TomcatA 会发现请求的 Cookie 中<strong>已</strong>存在 sessionid 为 X ，则直接获得 X 对应的 Session 。</li>
</ul>
<p><em>友情提示，Tomcat 产生的 sessionid 为 jsessionid 。</em></p>
<p>再以用户使用浏览器，Web 服务器为<strong>两台</strong> TomcatA、TomcatB 举例子。</p>
<ul>
<li>接上述例子，浏览器已经访问 TomcatA ，获得 sessionid 为 X 。同时，在多台 Tomcat 的情况下，我们需要采用 Nginx 做负载均衡。</li>
<li>浏览器又发起一次请求访问 Web 服务器，Nginx 负载均衡转发请求到 TomcatB 上。TomcatB 会发现请求的 Cookie 中<strong>已</strong>存在 sessionid 为 X ，则直接获得 X 对应的 Session 。结果呢，找不到 X 对应的 Session ，只好创建一个 sessionid 为 X 的 Session 。</li>
<li>此时，虽然说浏览器的 sessionid 是 X ，但是对应到两个 Tomcat 中两个 Session 。那么，如果在 TomcatA 上做的 Session 修改，TomcatB 的 Session 还是原样，这样就会出现 <strong>Session 不一致</strong>的问题。</li>
</ul>
<p>有三种方案保证 session 一致：</p>
<p><strong>第一种，Session 黏连</strong>。</p>
<p>使用 Nginx 实现会话黏连，将相同 sessionid 的浏览器所发起的请求，转发到同一台服务器。这样，就不会存在多个 Web 服务器创建多个 Session 的情况，也就不会发生 Session 不一致的问题。</p>
<p>不过，这种方式目前基本不被采用。因为，如果一台服务器重启，那么会导致转发到这个服务器上的 Session 全部丢失。</p>
<p><strong>第二种，Session 复制</strong>。</p>
<p>Web 服务器之间，进行 Session 复制同步。仅仅适用于实现 Session 复制的 Web 容器，例如说 Tomcat 、Weblogic 等等。</p>
<p>不过，这种方式目前基本也不被采用。试想一下，如果我们有 5 台 Web 服务器，所有的 Session 都要同步到每一个节点上，一个是效率低，一个是浪费内存。</p>
<p><strong>第三种，Session 外部化存储</strong>。</p>
<p>将 Session 存储外部化，持久化到 MySQL、Redis、MongoDB 等等数据库中</p>
<p>实现 Session 外部化存储有两种方式：</p>
<p>① 基于 Tomcat、Jetty 等 Web 容器<strong>自带的拓展</strong>，使用读取外部存储器的 Session 管理器。例如说：</p>
<ul>
<li><a href="https://github.com/redisson/redisson/wiki/14.-第三方框架整合#146-spring-session会话管理器" target="_blank" rel="noopener">《Redisson Tomcat会话管理器（Tomcat Session Manager）》</a> ，实现将 Tomcat 使用 Redis 存储 Session 。</li>
<li><a href="https://blog.csdn.net/xiao__gui/article/details/43271509" target="_blank" rel="noopener">《Jetty 集群配置 Session 存储到 MySQL、MongoDB》</a> ，实现 Jetty 使用 MySQL、MongoDB 存储 Session 。</li>
</ul>
<p>② 基于应用层封装 <a href="https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/http/HttpServletRequest.java" target="_blank" rel="noopener">HttpServletRequest</a> 请求对象，包装成自己的 RequestWrapper 对象，从而让实现调用 <a href="https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/http/HttpServletRequest.java#L542-L581" target="_blank" rel="noopener"><code>HttpServletRequest#getSession()</code></a> 方法时，获得读写外部存储器的 SessionWrapper 对象</p>
<ul>
<li>Spring Session 提供了 <a href="https://github.com/spring-projects/spring-session/blob/master/spring-session-core/src/main/java/org/springframework/session/web/http/SessionRepositoryFilter.java" target="_blank" rel="noopener">SessionRepositoryFilter</a> 过滤器，它会过滤请求时，将请求 HttpServletRequest 对象包装成 <a href="https://github.com/spring-projects/spring-session/blob/master/spring-session-core/src/main/java/org/springframework/session/web/http/SessionRepositoryFilter.java#L192-L418" target="_blank" rel="noopener">SessionRepositoryRequestWrapper</a> 对象。代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SessionRepositoryFilter.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// sessionRepository 是访问外部数据源的操作类，例如说访问 Redis、MySQL 等等</span></span><br><span class="line">    request.setAttribute(SESSION_REPOSITORY_ATTR, <span class="keyword">this</span>.sessionRepository);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将请求和响应进行包装成 SessionRepositoryRequestWrapper 和 SessionRepositoryResponseWrapper 对象</span></span><br><span class="line">    SessionRepositoryFilter&lt;S&gt;.SessionRepositoryRequestWrapper wrappedRequest = <span class="keyword">new</span> SessionRepositoryFilter.SessionRepositoryRequestWrapper(request, response, <span class="keyword">this</span>.servletContext);</span><br><span class="line">    SessionRepositoryFilter.SessionRepositoryResponseWrapper wrappedResponse = <span class="keyword">new</span> SessionRepositoryFilter.SessionRepositoryResponseWrapper(wrappedRequest, response);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继续执行下一个过滤器</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        filterChain.doFilter(wrappedRequest, wrappedResponse);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 请求结束，提交 Session 到外部数据源</span></span><br><span class="line">        wrappedRequest.commitSession();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用 <a href="https://github.com/spring-projects/spring-session/blob/master/spring-session-core/src/main/java/org/springframework/session/web/http/SessionRepositoryFilter.java#L325-L328" target="_blank" rel="noopener"><code>SessionRepositoryRequestWrapper#getSession()</code></a> 方法时，返回的是自己封装的 <a href="https://github.com/spring-projects/spring-session/blob/master/spring-session-core/src/main/java/org/springframework/session/web/http/SessionRepositoryFilter.java#L375-L390" target="_blank" rel="noopener">HttpSessionWrapper</a> 对象。代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SessionRepositoryFilter#SessionRepositoryRequestWrapper.java</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> HttpSessionWrapper <span class="title">getSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getSession(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>后续，调用 HttpSessionWrapper 的方法，例如说 <code>HttpSessionWrapper#setAttribute(String name, Object value)</code> 方法，访问的就是外部数据源，而不是内存中。</li>
</ul>
<h2 id="2-Spring-Session"><a href="#2-Spring-Session" class="headerlink" title="2. Spring Session"></a>2. Spring Session</h2><p>Spring Session 使支持集群会话变得非常简单，无需绑定到特定于应用程序容器的解决方案。它还提供了透明的集成:</p>
<ul>
<li><code>HttpSession</code> - 允许以中立通用的方式替换应用程序容器(即 Tomcat)中的 HttpSession ，并支持在请求头(Header)中提供 sessionid ，方便提供 RESTful API 。</li>
<li><code>WebSocket</code> - 提供在接收 WebSocket 消息时保持 HttpSession 活跃的能力。</li>
<li><code>WebSession</code> - 允许以与应用程序容器无关的方式替换 Spring WebFlux 的 WebSession 。</li>
</ul>
<ul>
<li>可以使用 Redis、JDBC（访问 MySQL、Oracle 等数据库）、Hazelcast 作为 Session 存储的数据源。</li>
<li>同时 Spring Session 也另外提供了 <a href="https://spring.io/projects/spring-session-data-mongodb" target="_blank" rel="noopener">Spring Session MongoDB</a> ，实现使用 MongoDB 作为 Session 存储的数据源</li>
</ul>
<h2 id="3-快速入门-Spring-Session-Redis"><a href="#3-快速入门-Spring-Session-Redis" class="headerlink" title="3. 快速入门 Spring Session + Redis"></a>3. 快速入门 Spring Session + Redis</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 实现对 Spring Session 使用 Redis 作为数据源的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 实现对 Spring Data Redis 的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 去掉对 Lettuce 的依赖，因为 Spring Boot 优先使用 Lettuce 作为 Redis 客户端 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引入 Jedis 的依赖，这样 Spring Boot 实现对 Jedis 的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 对应 RedisProperties 类</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="comment"># Redis 服务器密码，默认为空。生产中，一定要设置 Redis 密码！</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># Redis 数据库号，默认为 0 。</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span> <span class="comment"># Redis 连接超时时间，单位：毫秒。</span></span><br><span class="line">    <span class="comment"># 对应 RedisProperties.Jedis 内部类</span></span><br><span class="line">    <span class="attr">jedis:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># 连接池最大连接数，默认为 8 。使用负数表示没有限制。</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment"># 默认连接数最大空闲的连接数，默认为 8 。使用负数表示没有限制。</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 默认连接池最小空闲的连接数，默认为 0 。允许设置 0 和 正数。</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="number">-1</span> <span class="comment"># 连接池最大阻塞等待时间，单位：毫秒。默认为 -1 ，表示不限制。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SessionConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableRedisHttpSession</span> <span class="comment">// 自动化配置 Spring Session 使用 Redis 作为数据源</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 &#123;<span class="doctag">@link</span> RedisOperationsSessionRepository&#125; 使用的 RedisSerializer Bean 。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 具体可以看看 &#123;<span class="doctag">@link</span> RedisHttpSessionConfiguration#setDefaultRedisSerializer(RedisSerializer)&#125; 方法，</span></span><br><span class="line"><span class="comment">     * 它会引入名字为 "springSessionDefaultRedisSerializer" 的 Bean 。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> RedisSerializer Bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"springSessionDefaultRedisSerializer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisSerializer <span class="title">springSessionDefaultRedisSerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RedisSerializer.json();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <a href="https://github.com/spring-projects/spring-session/blob/master/spring-session-data-redis/src/main/java/org/springframework/session/data/redis/config/annotation/web/http/EnableRedisHttpSession.java" target="_blank" rel="noopener"><code>@EnableRedisHttpSession</code></a> 注解，开启自动化配置 Spring Session 使用 Redis 作为数据源。该注解有如下属性：<ul>
<li>maxInactiveIntervalInSeconds` 属性，Session 不活跃后的过期时间，默认为 1800 秒。</li>
<li><code>redisNamespace</code> 属性，在 Redis 的 key 的统一前缀，默认为 <code>&quot;spring:session&quot;</code> 。</li>
<li><code>redisFlushMode</code> 属性，Redis 会话刷新模式(<a href="https://github.com/spring-projects/spring-session/blob/master/spring-session-data-redis/src/main/java/org/springframework/session/data/redis/RedisFlushMode.java" target="_blank" rel="noopener">RedisFlushMode</a>)。目前有两种，默认为 <code>RedisFlushMode.ON_SAVE</code> 。<ul>
<li><code>RedisFlushMode.ON_SAVE</code> ，在请求执行完成时，统一写入 Redis 存储。</li>
<li><code>RedisFlushMode.IMMEDIATE</code> ，在每次修改 Session 时，立即写入 Redis 存储。</li>
</ul>
</li>
<li><code>cleanupCron</code> 属性，清理 Redis Session 会话过期的任务执行 CRON 表达式，默认为 <code>&quot;0 * * * * *&quot;</code> 每分钟执行一次。虽然说，Redis 自带了 key 的过期，但是惰性删除策略，实际过期的 Session 还在 Redis 中占用内存。所以，Spring Session 通过定时任务，删除 Redis 中过期的 Session ，尽快释放 Redis 的内存。</li>
</ul>
</li>
<li>在 <code>#springSessionDefaultRedisSerializer()</code> 方法，定义了一个 Bean 名字为 <code>&quot;springSessionDefaultRedisSerializer&quot;</code> 的 RedisSerializer Bean ，采用 JSON 序列化方式</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 假设，我们已经在 redis-cli 中</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; scan <span class="number">0</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"0"</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="string">"spring:session:sessions:expires:bea153af-3b36-451e-bbc9-2637bcdc5b37"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"spring:session:expirations:1574493180000"</span></span><br><span class="line">   <span class="number">3</span>) <span class="string">"spring:session:sessions:bea153af-3b36-451e-bbc9-2637bcdc5b37"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>每一个 Session 对应 Redis 三个 key-value 键值对。<ul>
<li>开头：以 <code>spring:session</code> 开头，可以通过 <code>@EnableRedisHttpSession</code> 注解的 <code>redisNamespace</code> 属性配置。</li>
<li>结尾：以对应 Session 的 sessionid 结尾。</li>
<li>中间：中间分别是 <code>&quot;session&quot;</code>、<code>&quot;expirations&quot;</code>、<code>sessions:expires</code> 。<strong>一般情况下，我们只需要关注中间为 <code>&quot;session&quot;</code> 的 key-value 键值对即可，它负责真正存储 Session 数据。</strong>对于中间为 <code>&quot;sessions:expires&quot;</code> 和 <code>&quot;expirations&quot;</code> 的两个来说，主要为了实现主动删除 Redis 过期的 Session 会话，解决 Redis 惰性删除的“问题”。</li>
</ul>
</li>
</ul>
<p>查看下 <code>&quot;spring:session:sessions:bea153af-3b36-451e-bbc9-2637bcdc5b37&quot;</code> 的内容。它是一个 Redis <strong>hash</strong> 数据结构。结果如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; HGETALL spring:session:sessions:bea153af<span class="number">-3</span>b36<span class="number">-451</span>e-bbc9<span class="number">-2637</span>bcdc5b37</span><br><span class="line">1) "lastAccessedTime" # 最后访问时间</span><br><span class="line"><span class="number">2</span>) <span class="string">"1574491333155"</span></span><br><span class="line">3) "maxInactiveInterval" # Session 允许最大不活跃时长，单位：秒。</span><br><span class="line"><span class="number">4</span>) <span class="string">"1800"</span></span><br><span class="line">5) "creationTime" # 创建时间</span><br><span class="line"><span class="number">6</span>) <span class="string">"1574491333107"</span></span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl spring:session:sessions:bea153af<span class="number">-3</span>b36<span class="number">-451</span>e-bbc9<span class="number">-2637</span>bcdc5b37</span><br><span class="line">(integer) 1089 # 虽然说，Spring Session Redis 实现了主动删除，但是并不妨碍这里也使用 Redis 自动过期策略。</span><br></pre></td></tr></table></figure>



<h2 id="4-快速入门-Spring-Session-MongoDB"><a href="#4-快速入门-Spring-Session-MongoDB" class="headerlink" title="4. 快速入门 Spring Session + MongoDB"></a>4. 快速入门 Spring Session + MongoDB</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 实现对 Spring Session 使用 MongoDB 作为数据源的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 自动化配置 Spring Data Mongodb --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="comment"># MongoDB 配置项，对应 MongoProperties 类</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">      <span class="attr">database:</span> <span class="string">yourdatabase</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">test01</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">password01</span></span><br><span class="line">      <span class="comment"># 上述属性，也可以只配置 uri</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org:</span></span><br><span class="line">      <span class="attr">springframework:</span></span><br><span class="line">        <span class="attr">data:</span></span><br><span class="line">          <span class="attr">mongodb:</span></span><br><span class="line">            <span class="attr">core:</span> <span class="string">DEBUG</span> <span class="comment"># 打印 mongodb 操作的具体语句。生产环境下，不建议开启。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableMongoHttpSession</span> <span class="comment">// 自动化配置 Spring Session 使用 MongoDB 作为数据源</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AbstractMongoSessionConverter <span class="title">mongoSessionConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JacksonMongoSessionConverter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <a href="https://github.com/spring-projects/spring-session-data-mongodb/blob/master/src/main/java/org/springframework/session/data/mongo/config/annotation/web/http/EnableMongoHttpSession.java" target="_blank" rel="noopener">@EnableMongoHttpSession</a> 注解，开启自动化配置 Spring Session 使用 MongoDB 作为数据源。该注解有如下属性：<ul>
<li><code>maxInactiveIntervalInSeconds</code> 属性，Session 不活跃后的过期时间，默认为 1800 秒。</li>
<li><code>collectionName</code> 属性，在 MongoDB 中，存储 Session 的集合名，默认为 <code>&quot;sessions&quot;</code> 。</li>
</ul>
</li>
<li>在 <code>#mongoSessionConverter()</code> 方法，创建了 JacksonMongoSessionConverter Bean 对象，采用 JSON 序列化</li>
</ul>
<p>目前，Spring Session MongoDB 基于 <strong>MongoDB 自动过期删除过期数据</strong>的机制，实现 Session 的自动过期。因为 MongoDB 的自动过期机制，并不是像 Redis 是惰性删除，所以无需实现定时任务，主动删除来释放内存。</p>
<p>查看下 <code>sessions</code> 集合的内容。结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="attr">"_id"</span> : <span class="string">"5a6e9b28-7740-422e-8d1c-50a4b2781d7a"</span>, </span><br><span class="line">    <span class="attr">"@class"</span> : <span class="string">"org.springframework.session.data.mongo.MongoSession"</span>, </span><br><span class="line">    <span class="attr">"createdMillis"</span> : NumberLong(<span class="number">1574501001259</span>), </span><br><span class="line">    <span class="attr">"accessedMillis"</span> : NumberLong(<span class="number">1574501010539</span>), </span><br><span class="line">    <span class="attr">"intervalSeconds"</span> : NumberInt(<span class="number">1800</span>), </span><br><span class="line">    <span class="attr">"expireAt"</span> : ISODate(<span class="string">"2019-11-23T17:53:30.539+0800"</span>), </span><br><span class="line">    <span class="attr">"attrs"</span> : &#123;</span><br><span class="line">        <span class="attr">"@class"</span> : <span class="string">"java.util.HashMap"</span>, </span><br><span class="line">        <span class="attr">"author"</span> : <span class="string">"nainai"</span>, </span><br><span class="line">        <span class="attr">"who"</span> : <span class="string">"yudaoyuanma"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"principal"</span> : <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>每个 Session 对应一条 <code>sessions</code> 集合的记录。对应到实体类是 <a href="https://github.com/spring-projects/spring-session-data-mongodb/blob/master/src/main/java/org/springframework/session/data/mongo/MongoSession.java" target="_blank" rel="noopener">MongoSession</a> 。代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MongoSession.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoSession</span> <span class="keyword">implements</span> <span class="title">Session</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> createdMillis;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> accessedMillis;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> intervalSeconds;</span><br><span class="line">    <span class="keyword">private</span> Date expireAt;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; attrs;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略方法</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>_id</code> 字段，sessionid 。</p>
</li>
<li><p><code>@class</code> 字段，记录对应的实体类，就是我们提到的 MongoSession 。</p>
</li>
<li><p><code>createdMillis</code> 字段，Session 创建时间戳。</p>
</li>
<li><p><code>accessedMillis</code> 字段，Session 最后访问时间戳。</p>
</li>
<li><p><code>intervalSeconds</code> 字段，Session 允许最大不活跃时长，单位：秒。</p>
</li>
<li><p><code>expireAt</code> 字段，Session 过期时间。在该字段上，我们创建了 <code>expireAt</code> 所以， 用于实现过期 Session 记录的自动删除。索引信息如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="attr">"v"</span> : <span class="number">2</span>, </span><br><span class="line">    <span class="attr">"name"</span> : <span class="string">"expireAt"</span>, </span><br><span class="line">    <span class="attr">"ns"</span> : <span class="string">"yourdatabase.sessions"</span>, </span><br><span class="line">    <span class="attr">"expireAfterSeconds"</span> : <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>attrs</code> 字段，Session 的 attribute 属性们。</p>
</li>
<li><p><code>principal</code> 字段，用户主体，和用户身份认证相关。</p>
</li>
</ul>
<h2 id="5-整合-Spring-Security"><a href="#5-整合-Spring-Security" class="headerlink" title="5. 整合 Spring Security"></a>5. 整合 Spring Security</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 实现对 Spring Security 的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 对应 RedisProperties 类</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="comment"># Redis 服务器密码，默认为空。生产中，一定要设置 Redis 密码！</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># Redis 数据库号，默认为 0 。</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span> <span class="comment"># Redis 连接超时时间，单位：毫秒。</span></span><br><span class="line">    <span class="comment"># 对应 RedisProperties.Jedis 内部类</span></span><br><span class="line">    <span class="attr">jedis:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># 连接池最大连接数，默认为 8 。使用负数表示没有限制。</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment"># 默认连接数最大空闲的连接数，默认为 8 。使用负数表示没有限制。</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 默认连接池最小空闲的连接数，默认为 0 。允许设置 0 和 正数。</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="number">-1</span> <span class="comment"># 连接池最大阻塞等待时间，单位：毫秒。默认为 -1 ，表示不限制。</span></span><br><span class="line">  <span class="comment"># 对应 SecurityProperties 类</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span> <span class="comment"># 配置内存中，可登陆的用户名和密码</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">yudaoyuanma</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nicai</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SessionConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableRedisHttpSession</span> <span class="comment">// 自动化配置 Spring Session 使用 Redis 作为数据源</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>去掉了自定义的 <strong>JSON</strong> RedisSerializer Bean 的配置。原因是，HttpSession 的 attributes 属性，是 <code>Map&lt;String, Object&gt;</code> 类型。</p>
<ul>
<li>在序列化 Session 到 Redis 中时，不存在问题。</li>
<li>在反序列化 Redis 的 key-value 键值对成 Session 时，如果 attributes 的 value 存在 POJO 对象的时候，因为不知道该 value 是什么 POJO 对象，导致无法反序列化错误。</li>
</ul>
<p><strong>因此，在使用 Spring Session 时，先老实使用 Java 序列化方式吧</strong>。</p>
<p>访问 <code>&quot;http://127.0.0.1:8080/&quot;</code> 地址，因为 使用了 Spring Security ，所以会被自动拦截重定向到 <code>&quot;http://127.0.0.1:8080/login&quot;</code></p>
<p>① 终端执行 <code>redis-cli</code> 命令，连接到 Redis 中，查看是否创建了一个 Session 。过程如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 确实创建了一个 sessionid 为 f65a475e-8550-49a4-b71d-0320c8cf887f 的 Session 。</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; scan <span class="number">0</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"0"</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="string">"spring:session:sessions:f65a475e-8550-49a4-b71d-0320c8cf887f"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"spring:session:sessions:expires:f65a475e-8550-49a4-b71d-0320c8cf887f"</span></span><br><span class="line">   <span class="number">3</span>) <span class="string">"spring:session:expirations:1574437980000"</span></span><br><span class="line">   </span><br><span class="line"># 查看 spring:session:sessions:f65a475e-8550-49a4-b71d-0320c8cf887f 存储的 value 。</span><br><span class="line"># 因为使用 Java 序列化方式，所以 hash 中的每个 key 对应的 value ，都无法直接读懂。不过大概啥意思，我们应该是明白的。</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; HGETALL spring:session:sessions:f65a475e<span class="number">-8550</span><span class="number">-49</span>a4-b71d<span class="number">-0320</span>c8cf887f</span><br><span class="line"> <span class="number">1</span>) <span class="string">"lastAccessedTime"</span></span><br><span class="line"> <span class="number">2</span>) <span class="string">"\xac\xed\x00\x05sr\x00\x0ejava.lang.Long;\x8b\xe4\x90\xcc\x8f#\xdf\x02\x00\x01J\x00\x05valuexr\x00\x10java.lang.Number\x86\xac\x95\x1d\x0b\x94\xe0\x8b\x02\x00\x00xp\x00\x00\x01n\x93\xb5\x80\xf6"</span></span><br><span class="line"> <span class="number">3</span>) <span class="string">"creationTime"</span></span><br><span class="line"> <span class="number">4</span>) <span class="string">"\xac\xed\x00\x05sr\x00\x0ejava.lang.Long;\x8b\xe4\x90\xcc\x8f#\xdf\x02\x00\x01J\x00\x05valuexr\x00\x10java.lang.Number\x86\xac\x95\x1d\x0b\x94\xe0\x8b\x02\x00\x00xp\x00\x00\x01n\x93\xb5\x80x"</span></span><br><span class="line"> <span class="number">5</span>) <span class="string">"sessionAttr:SPRING_SECURITY_SAVED_REQUEST"</span></span><br><span class="line"> <span class="number">6</span>) <span class="string">"\xac\xed\x00\x05sr\x00Aorg.springframework.security.web.savedrequest.DefaultSavedRequest\x1e@HD\xf96d\x94\x02\x00\x0eI\x00\nserverPortL\x00\x0bcontextPatht\x00\x12Ljava/lang/String;L\x00\acookiest\x00\x15Ljava/util/ArrayList;L\x00\aheaderst\x00\x0fLjava/util/Map;L\x00\alocalesq\x00~\x00\x02L\x00\x06methodq\x00~\x00\x01L\x00\nparametersq\x00~\x00\x03L\x00\bpathInfoq\x00~\x00\x01L\x00\x0bqueryStringq\x00~\x00\x01L\x00\nrequestURIq\x00~\x00\x01L\x00\nrequestURLq\x00~\x00\x01L\x00\x06schemeq\x00~\x00\x01L\x00\nserverNameq\x00~\x00\x01L\x00\x0bservletPathq\x00~\x00\x01xp\x00\x00\x1f\x90t\x00\x00sr\x00\x13java.util.ArrayListx\x81\xd2\x1d\x99\xc7a\x9d\x03\x00\x01I\x00\x04sizexp\x00\x00\x00\x01w\x04\x00\x00\x00\x01sr\x009org.springframework.security.web.savedrequest.SavedCookie\x03@+\x82\x9f\xc0\xb4f\x02\x00\bI\x00\x06maxAgeZ\x00\x06secureI\x00\aversionL\x00\acommentq\x00~\x00\x01L\x00\x06domainq\x00~\x00\x01L\x00\x04nameq\x00~\x00\x01L\x00\x04pathq\x00~\x00\x01L\x00\x05valueq\x00~\x00\x01xp\xff\xff\xff\xff\x00\x00\x00\x00\x00ppt\x00\aSESSIONpt\x000MDZhYjJiYTUtYzA2Ny00YmNhLWFiNWItODUyYmRmM2QwMGE1xsr\x00\x11java.util.TreeMap\x0c\xc1\xf6&gt;-%j\xe6\x03\x00\x01L\x00\ncomparatort\x00\x16Ljava/util/Comparator;xpsr\x00*java.lang.String$CaseInsensitiveComparatorw\x03\\&#125;\\P\xe5\xce\x02\x00\x00xpw\x04\x00\x00\x00\x0bt\x00\x06acceptsq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x00vtext/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3xt\x00\x0faccept-encodingsq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x00\x11gzip, deflate, brxt\x00\x0faccept-languagesq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x00#zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7xt\x00\nconnectionsq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x00\nkeep-alivext\x00\x06cookiesq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x008SESSION=MDZhYjJiYTUtYzA2Ny00YmNhLWFiNWItODUyYmRmM2QwMGE1xt\x00\x04hostsq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x00\x0e127.0.0.1:8080xt\x00\x0esec-fetch-modesq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x00\bnavigatext\x00\x0esec-fetch-sitesq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x00\x04nonext\x00\x0esec-fetch-usersq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x00\x02?1xt\x00\x19upgrade-insecure-requestssq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x00\x011xt\x00\nuser-agentsq\x00~\x00\x06\x00\x00\x00\x01w\x04\x00\x00\x00\x01t\x00xMozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36xxsq\x00~\x00\x06\x00\x00\x00\x04w\x04\x00\x00\x00\x04sr\x00\x10java.util.Locale~\xf8\x11`\x9c0\xf9\xec\x03\x00\x06I\x00\bhashcodeL\x00\acountryq\x00~\x00\x01L\x00\nextensionsq\x00~\x00\x01L\x00\blanguageq\x00~\x00\x01L\x00\x06scriptq\x00~\x00\x01L\x00\avariantq\x00~\x00\x01xp\xff\xff\xff\xfft\x00\x02CNq\x00~\x00\x05t\x00\x02zhq\x00~\x00\x05q\x00~\x00\x05xsq\x00~\x003\xff\xff\xff\xffq\x00~\x00\x05q\x00~\x00\x05q\x00~\x006q\x00~\x00\x05q\x00~\x00\x05xsq\x00~\x003\xff\xff\xff\xfft\x00\x02USq\x00~\x00\x05t\x00\x02enq\x00~\x00\x05q\x00~\x00\x05xsq\x00~\x003\xff\xff\xff\xffq\x00~\x00\x05q\x00~\x00\x05q\x00~\x00:q\x00~\x00\x05q\x00~\x00\x05xxt\x00\x03GETsq\x00~\x00\x0cpw\x04\x00\x00\x00\x00xppt\x00\x01/t\x00\x16http://127.0.0.1:8080/t\x00\x04httpt\x00\t127.0.0.1t\x00\x01/"</span></span><br><span class="line"> <span class="number">7</span>) <span class="string">"maxInactiveInterval"</span></span><br><span class="line"> <span class="number">8</span>) <span class="string">"\xac\xed\x00\x05sr\x00\x11java.lang.Integer\x12\xe2\xa0\xa4\xf7\x81\x878\x02\x00\x01I\x00\x05valuexr\x00\x10java.lang.Number\x86\xac\x95\x1d\x0b\x94\xe0\x8b\x02\x00\x00xp\x00\x00\a\b"</span></span><br><span class="line"> <span class="number">9</span>) <span class="string">"sessionAttr:org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository.CSRF_TOKEN"</span></span><br><span class="line"><span class="number">10</span>) <span class="string">"\xac\xed\x00\x05sr\x006org.springframework.security.web.csrf.DefaultCsrfTokenZ\xef\xb7\xc8/\xa2\xfb\xd5\x02\x00\x03L\x00\nheaderNamet\x00\x12Ljava/lang/String;L\x00\rparameterNameq\x00~\x00\x01L\x00\x05tokenq\x00~\x00\x01xpt\x00\x0cX-CSRF-TOKENt\x00\x05_csrft\x00$582ef040-9a9f-43be-9708-e5b94394e338"</span></span><br></pre></td></tr></table></figure>

<p>② 输入账号密码，并点击「Sign in」按钮，进行登录。登录成功后，跳转回 <code>&quot;http://127.0.0.1:8080/&quot;</code> 地址</p>
<p>在 Redis 的终端中，查看此时该 Session 的变化。过程如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 相比来说，多了一条 "spring:session:index:org.springframework.session.FindByIndexNameSessionRepository.PRINCIPAL_NAME_INDEX_NAME:yudaoyuanma"</span><br><span class="line"># 它代表的，就是我们刚登陆的用户名，注意结尾是 "yudaoyuanma" 。</span><br><span class="line"></span><br><span class="line"># 并且，比较神奇的是，原 sessionid="f65a475e-8550-49a4-b71d-0320c8cf887f" 的 Session 被删除。</span><br><span class="line"># 同时，一个新的 sessionid="127c5c93-1e57-4984-9780-5530a4bf9d0b" 的 Session 被创建</span><br><span class="line"># 原因可见 https://www.jianshu.com/p/057fcf061b94 文章的「Spring Security 固定 Session 的保护」。</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; scan <span class="number">0</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"0"</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="string">"spring:session:sessions:expires:127c5c93-1e57-4984-9780-5530a4bf9d0b"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"spring:session:expirations:1574438340000"</span></span><br><span class="line">   <span class="number">3</span>) <span class="string">"spring:session:index:org.springframework.session.FindByIndexNameSessionRepository.PRINCIPAL_NAME_INDEX_NAME:yudaoyuanma"</span></span><br><span class="line">   <span class="number">4</span>) <span class="string">"spring:session:sessions:127c5c93-1e57-4984-9780-5530a4bf9d0b"</span></span><br><span class="line">  </span><br><span class="line"># 该 key 是 Redis Set 数据结构，存储了该用户名对应的所有 sessionid 集合。</span><br><span class="line"># 所以，通过该 key ，我们可以获取到指定用户名，登陆的所有 sessionid 集合</span><br><span class="line"># 具体怎么操作，我们在 「5.6 FindByIndexNameSessionRepository」小节来看。</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; SMEMBERS spring:session:index:org.springframework.session.FindByIndexNameSessionRepository.PRINCIPAL_NAME_INDEX_NAME:yudaoyuanma</span><br><span class="line"><span class="number">1</span>) <span class="string">"\xac\xed\x00\x05t\x00$127c5c93-1e57-4984-9780-5530a4bf9d0b"</span></span><br></pre></td></tr></table></figure>

<p>③ 点击「Log Out」按钮，完成用户的登出操作。完成后，自动重定向到 <code>&quot;http://127.0.0.1:8080/login&quot;</code> 登陆地址</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 用户退出后，"spring:session:index:org.springframework.session.FindByIndexNameSessionRepository.PRINCIPAL_NAME_INDEX_NAME:yudaoyuanma" 被删除</span><br><span class="line"># 因为，该用户已经退出。</span><br><span class="line"></span><br><span class="line"># 用户退出后，新的 sessionid="1288372b-1ed3-417f-86ed-10c113a10783" 的 Session 被创建。</span><br><span class="line"></span><br><span class="line"># 神奇的是，老的 sessionid="127c5c93-1e57-4984-9780-5530a4bf9d0b" 的 Session 并未被删除，这是为什么呢？</span><br><span class="line"># Spring Session 在失效删除 Session 时，会保留该 sessionid 300 秒。对应源码为 RedisSessionExpirationPolicy#onExpirationUpdated(...) 方法的最后一行。</span><br><span class="line"># 具体原因，是为了实现 Session 过期的通知。</span><br><span class="line"># 详细的，可以看 《从 Spring-Session 源码看 Session 机制的实现细节》 http://www.iocoder.cn/Spring-Session/laoxu/spring-session-4/?self</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; scan <span class="number">0</span></span><br><span class="line"><span class="number">1</span>) <span class="string">"0"</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="string">"spring:session:expirations:1574439000000"</span></span><br><span class="line">   <span class="number">2</span>) <span class="string">"spring:session:expirations:1574437140000"</span></span><br><span class="line">   <span class="number">3</span>) <span class="string">"spring:session:expirations:1574438340000"</span></span><br><span class="line">   <span class="number">4</span>) <span class="string">"spring:session:sessions:expires:1288372b-1ed3-417f-86ed-10c113a10783"</span></span><br><span class="line">   <span class="number">5</span>) <span class="string">"spring:session:sessions:1288372b-1ed3-417f-86ed-10c113a10783"</span></span><br><span class="line">   <span class="number">6</span>) <span class="string">"spring:session:expirations:1574438940000"</span></span><br><span class="line">   <span class="number">7</span>) <span class="string">"spring:session:sessions:127c5c93-1e57-4984-9780-5530a4bf9d0b"</span></span><br></pre></td></tr></table></figure>



<p>Spring Session 定义了 <a href="https://github.com/spring-projects/spring-session/blob/master/spring-session-core/src/main/java/org/springframework/session/FindByIndexNameSessionRepository.java" target="_blank" rel="noopener"><code>org.springframework.session.FindByIndexNameSessionRepository</code></a> 接口，定义了根据用户名，查询登陆的所有 Session 信息。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FindByIndexNameSessionRepository.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FindByIndexNameSessionRepository</span>&lt;<span class="title">S</span> <span class="keyword">extends</span> <span class="title">Session</span>&gt;</span></span><br><span class="line"><span class="class">		<span class="keyword">extends</span> <span class="title">SessionRepository</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	String PRINCIPAL_NAME_INDEX_NAME = FindByIndexNameSessionRepository<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()</span></span><br><span class="line">			.concat(".PRINCIPAL_NAME_INDEX_NAME");</span><br><span class="line"></span><br><span class="line">	<span class="function">Map&lt;String, S&gt; <span class="title">findByIndexNameAndIndexValue</span><span class="params">(String indexName, String indexValue)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">default</span> Map&lt;String, S&gt; <span class="title">findByPrincipalName</span><span class="params">(String principalName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> findByIndexNameAndIndexValue(PRINCIPAL_NAME_INDEX_NAME, principalName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>#findByPrincipalName(principalName)</code> 方法，根据用户名，查询登陆的所有 Session 信息。因为用户可以多点登陆，所以一个用户名会对应多个 Session 信息。而返回的 Map 对象，其 key 为 sessionid 。</li>
<li><code>#findByPrincipalName(String principalName)</code> 方法的内部，会调用 <code>#findByIndexNameAndIndexValue(indexName, indexValue)</code> 方法，查询指定 <code>indexName</code> 的 value 等于 <code>indexValue</code> 的所有 Session 信息。这里，传入的是 <code>indexName</code> 为 <code>PRINCIPAL_NAME_INDEX_NAME</code> ，<code>indexValue</code> 为用户名。<code>&quot;spring:session:index:org.springframework.session.FindByIndexNameSessionRepository.PRINCIPAL_NAME_INDEX_NAME:yudaoyuanma&quot;</code> 这个 Redis key 。分解如下：<ul>
<li>第一部分，<code>&quot;spring:session:index&quot;</code> 为 index 固定前缀。</li>
<li>第二部分，<code>&quot;org.springframework.session.FindByIndexNameSessionRepository.PRINCIPAL_NAME_INDEX_NAME&quot;</code> 为 <code>indexName</code> 。</li>
<li>第三部分，<code>&quot;yudaoyuanma&quot;</code> 为 <code>indexValue</code> 用户名。</li>
<li>这样，在 <code>#findByIndexNameAndIndexValue(indexName, indexValue)</code> 方法的内部实现，会将三个部分拼接在一起，成为 <code>&quot;spring:session:index:org.springframework.session.FindByIndexNameSessionRepository.PRINCIPAL_NAME_INDEX_NAME:yudaoyuanma&quot;</code> 字符串，最终去 Redis 查询。也就是说，<code>&quot;spring:session:index&quot;</code> 的目的，是实现<strong>索引</strong>。在这里，就是<strong>索引</strong>用户登陆的多个 sessionid ，从而最终查询到所有 Session 信息。</li>
</ul>
</li>
</ul>
<p>在两个浏览器中，登陆用户名为 <code>&quot;yudaoyuanma&quot;</code> 的用户。<br>然后，浏览器访问 <code>&quot;http://127.0.0.1:8080/session/list?username=yudaoyuanma&quot;</code> 接口，查询用户名为 <code>&quot;yudaoyuanma&quot;</code> 的所有 Session 信息。响应结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">"f8ef73b0-a911-4921-9df9-056b4e18ce09"</span>:&#123;</span><br><span class="line">      <span class="string">"lastAccessedTime"</span>:<span class="string">"2019-11-22T17:37:36.331Z"</span>,</span><br><span class="line">      <span class="string">"expired"</span>:<span class="keyword">false</span>,</span><br><span class="line">      <span class="string">"maxInactiveInterval"</span>:<span class="string">"PT30M"</span>,</span><br><span class="line">      <span class="string">"new"</span>:<span class="keyword">false</span>,</span><br><span class="line">      <span class="string">"creationTime"</span>:<span class="string">"2019-11-22T17:09:01.157Z"</span>,</span><br><span class="line">      <span class="string">"attributeNames"</span>:[</span><br><span class="line">         <span class="string">"SPRING_SECURITY_CONTEXT"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"id"</span>:<span class="string">"f8ef73b0-a911-4921-9df9-056b4e18ce09"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="string">"ea037f98-112a-43c2-a337-d0d3d5a74a16"</span>:&#123;</span><br><span class="line">      <span class="string">"lastAccessedTime"</span>:<span class="string">"2019-11-22T17:37:27.631Z"</span>,</span><br><span class="line">      <span class="string">"expired"</span>:<span class="keyword">false</span>,</span><br><span class="line">      <span class="string">"maxInactiveInterval"</span>:<span class="string">"PT30M"</span>,</span><br><span class="line">      <span class="string">"new"</span>:<span class="keyword">false</span>,</span><br><span class="line">      <span class="string">"creationTime"</span>:<span class="string">"2019-11-22T17:37:21.915Z"</span>,</span><br><span class="line">      <span class="string">"attributeNames"</span>:[</span><br><span class="line">         <span class="string">"SPRING_SECURITY_CONTEXT"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"id"</span>:<span class="string">"ea037f98-112a-43c2-a337-d0d3d5a74a16"</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到我们在两个浏览器上，登陆的两个 Session 。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/05/28/Web%E5%BC%80%E5%8F%91-SpringBoot%E5%88%86%E5%B8%83%E5%BC%8FSession%E5%85%A5%E9%97%A8/" data-id="ckbg9kucs00192r078tzq7wvp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Java实践推荐" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/28/Java%E5%AE%9E%E8%B7%B5%E6%8E%A8%E8%8D%90/" class="article-date">
  <time datetime="2020-05-28T02:03:58.000Z" itemprop="datePublished">2020-05-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/28/Java%E5%AE%9E%E8%B7%B5%E6%8E%A8%E8%8D%90/">Java实践推荐</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Java-实践推荐"><a href="#Java-实践推荐" class="headerlink" title="Java 实践推荐"></a>Java 实践推荐</h1><h2 id="domain-包名"><a href="#domain-包名" class="headerlink" title="domain 包名"></a>domain 包名</h2><p>数据库映射对象，使用报名 <strong><code>com.xxx.entity</code></strong></p>
<h2 id="DTO"><a href="#DTO" class="headerlink" title="DTO"></a>DTO</h2><p>数据传输应该使用DTO对象作为传输对象</p>
<p><strong>只要是用于网络传输的对象，都认为他们可以当做是DTO对象</strong></p>
<p>约定某对象如果是DTO对象，就将名称改为XXDTO,比如订单下发OMS：OMSOrderInputDTO</p>
<h2 id="DTO-转化"><a href="#DTO-转化" class="headerlink" title="DTO 转化"></a>DTO 转化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/v1/api/user"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">addUser</span><span class="params">(UserInputDTO userInputDTO)</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUsername(userInputDTO.getUsername());</span><br><span class="line">        user.setAge(userInputDTO.getAge());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userService.addUser(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以使用<code>org.springframework.beans.BeanUtils#copyProperties</code>对代码进行重构和优化:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">addUser</span><span class="params">(UserInputDTO userInputDTO)</span></span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    BeanUtils.copyProperties(userInputDTO,user);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> userService.addUser(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BeanUtils.copyProperties是一个浅拷贝方法，复制属性时，只需要把DTO对象和要转化的对象两个的属性值设置为一样的名称，并且保证一样的类型就可以了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> User <span class="title">addUser</span><span class="params">(UserInputDTO userInputDTO)</span></span>&#123;</span><br><span class="line">         User user = convertFor(userInputDTO);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> userService.addUser(user);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> User <span class="title">convertFor</span><span class="params">(UserInputDTO userInputDTO)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">         User user = <span class="keyword">new</span> User();</span><br><span class="line">         BeanUtils.copyProperties(userInputDTO,user);</span><br><span class="line">         <span class="keyword">return</span> user;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h3 id="抽象接口定义"><a href="#抽象接口定义" class="headerlink" title="抽象接口定义"></a>抽象接口定义</h3><p>当实际工作中，完成了几个api的DTO转化时，会发现，这样的操作有很多很多，那么应该定义好一个接口，让所有这样的操作都有规则的进行。如果接口被定义以后，那么convertFor这个方法的语义将产生变化，他将是一个实现类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DTOConvert</span>&lt;<span class="title">S</span>,<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">convert</span><span class="params">(S s)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInputDTOConvert</span> <span class="keyword">implements</span> <span class="title">DTOConvert</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">convert</span><span class="params">(UserInputDTO userInputDTO)</span> </span>&#123;</span><br><span class="line">User user = <span class="keyword">new</span> User();</span><br><span class="line">BeanUtils.copyProperties(userInputDTO,user);</span><br><span class="line"><span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重构以后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/v1/api/user"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">addUser</span><span class="params">(UserInputDTO userInputDTO)</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> UserInputDTOConvert().convert(userInputDTO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userService.addUser(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>api中返回值是有些问题的，问题就在于不应该直接返回User实体，因为如果这样的话，就暴露了太多实体相关的信息，这样的返回值是不安全的，所以更应该返回一个DTO对象，可称它为<code>UserOutputDTO</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserOutputDTO <span class="title">addUser</span><span class="params">(UserInputDTO userInputDTO)</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> UserInputDTOConvert().convert(userInputDTO);</span><br><span class="line">        User saveUserResult = userService.addUser(user);</span><br><span class="line">        UserOutputDTO result = <span class="keyword">new</span> UserOutDTOConvert().convertToUser(saveUserResult);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> UserInputDTOConvert().convert(userInputDTO);</span><br></pre></td></tr></table></figure>

<p>发现，new这样一个DTO转化对象是没有必要的，而且每一个转化对象都是由在遇到DTO转化的时候才会出现，那应该考虑一下，是否可以将这个类和DTO进行聚合呢，看一下聚合结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInputDTO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">convertToUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        UserInputDTOConvert userInputDTOConvert = <span class="keyword">new</span> UserInputDTOConvert();</span><br><span class="line">        User convert = userInputDTOConvert.convert(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> convert;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInputDTOConvert</span> <span class="keyword">implements</span> <span class="title">DTOConvert</span>&lt;<span class="title">UserInputDTO</span>,<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">convert</span><span class="params">(UserInputDTO userInputDTO)</span> </span>&#123;</span><br><span class="line">            User user = <span class="keyword">new</span> User();</span><br><span class="line">            BeanUtils.copyProperties(userInputDTO,user);</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后api中的转化则由:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> UserInputDTOConvert().convert(userInputDTO);</span><br><span class="line">User saveUserResult = userService.addUser(user);</span><br></pre></td></tr></table></figure>

<p>变成了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User user = userInputDTO.convertToUser();</span><br><span class="line">User saveUserResult = userService.addUser(user);</span><br></pre></td></tr></table></figure>



<p>发现了com.google.common.base.Convert这样的定义:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Converter</span>&lt;<span class="title">A</span>, <span class="title">B</span>&gt; <span class="keyword">implements</span> <span class="title">Function</span>&lt;<span class="title">A</span>, <span class="title">B</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> B <span class="title">doForward</span><span class="params">(A a)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> A <span class="title">doBackward</span><span class="params">(B b)</span></span>;</span><br><span class="line">    <span class="comment">//其他略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源码可以了解到，GUAVA中的Convert可以完成正向转化和逆向转化，继续修改我们DTO中转化的这段代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInputDTOConvert</span> <span class="keyword">implements</span> <span class="title">DTOConvert</span>&lt;<span class="title">UserInputDTO</span>,<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">convert</span><span class="params">(UserInputDTO userInputDTO)</span> </span>&#123;</span><br><span class="line">                User user = <span class="keyword">new</span> User();</span><br><span class="line">                BeanUtils.copyProperties(userInputDTO,user);</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改后:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInputDTOConvert</span> <span class="keyword">extends</span> <span class="title">Converter</span>&lt;<span class="title">UserInputDTO</span>, <span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">protected</span> User <span class="title">doForward</span><span class="params">(UserInputDTO userInputDTO)</span> </span>&#123;</span><br><span class="line">                 User user = <span class="keyword">new</span> User();</span><br><span class="line">                 BeanUtils.copyProperties(userInputDTO,user);</span><br><span class="line">                 <span class="keyword">return</span> user;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">protected</span> UserInputDTO <span class="title">doBackward</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">                 UserInputDTO userInputDTO = <span class="keyword">new</span> UserInputDTO();</span><br><span class="line">                 BeanUtils.copyProperties(user,userInputDTO);</span><br><span class="line">                 <span class="keyword">return</span> userInputDTO;</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p>DTO：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDTO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">convertToUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">            UserDTOConvert userDTOConvert = <span class="keyword">new</span> UserDTOConvert();</span><br><span class="line">            User convert = userDTOConvert.convert(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> convert;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDTO <span class="title">convertFor</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">            UserDTOConvert userDTOConvert = <span class="keyword">new</span> UserDTOConvert();</span><br><span class="line">            UserDTO convert = userDTOConvert.reverse().convert(user);</span><br><span class="line">            <span class="keyword">return</span> convert;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDTOConvert</span> <span class="keyword">extends</span> <span class="title">Converter</span>&lt;<span class="title">UserDTO</span>, <span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> User <span class="title">doForward</span><span class="params">(UserDTO userDTO)</span> </span>&#123;</span><br><span class="line">                    User user = <span class="keyword">new</span> User();</span><br><span class="line">                    BeanUtils.copyProperties(userDTO,user);</span><br><span class="line">                    <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> UserDTO <span class="title">doBackward</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">                    UserDTO userDTO = <span class="keyword">new</span> UserDTO();</span><br><span class="line">                    BeanUtils.copyProperties(user,userDTO);</span><br><span class="line">                    <span class="keyword">return</span> userDTO;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>api:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> UserDTO <span class="title">addUser</span><span class="params">(UserDTO userDTO)</span></span>&#123;</span><br><span class="line">         User user =  userDTO.convertToUser();</span><br><span class="line">         User saveResultUser = userService.addUser(user);</span><br><span class="line">         UserDTO result = userDTO.convertFor(saveResultUser);</span><br><span class="line">         <span class="keyword">return</span> result;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>当然，上述只是表明了转化方向的正向或逆向，很多业务需求的出参和入参的DTO对象是不同的，那么需要更明显的告诉程序：逆向是无法调用的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDTOConvert</span> <span class="keyword">extends</span> <span class="title">Converter</span>&lt;<span class="title">UserDTO</span>, <span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">protected</span> User <span class="title">doForward</span><span class="params">(UserDTO userDTO)</span> </span>&#123;</span><br><span class="line">                 User user = <span class="keyword">new</span> User();</span><br><span class="line">                 BeanUtils.copyProperties(userDTO,user);</span><br><span class="line">                 <span class="keyword">return</span> user;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">protected</span> UserDTO <span class="title">doBackward</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"不支持逆向转化方法!"</span>);</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h2 id="bean-的验证"><a href="#bean-的验证" class="headerlink" title="bean 的验证"></a>bean 的验证</h2><h2 id="拥抱lombok"><a href="#拥抱lombok" class="headerlink" title="拥抱lombok"></a>拥抱lombok</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/05/28/Java%E5%AE%9E%E8%B7%B5%E6%8E%A8%E8%8D%90/" data-id="ckbg9kubt00082r075x36dpy3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CI-CD/" rel="tag">CI/CD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache/" rel="tag">Cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gitea/" rel="tag">Gitea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JPA/" rel="tag">JPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-%E5%9F%BA%E7%A1%80-01/" rel="tag">Java 基础-01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jetty/" rel="tag">Jetty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SPring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">SPring Boot-基础-01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">Spring Boot-基础-01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-02/" rel="tag">Spring Boot-基础-02</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/" rel="tag">SpringMVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swagger/" rel="tag">Swagger</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TeamCity/" rel="tag">TeamCity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Undertow/" rel="tag">Undertow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Validation/" rel="tag">Validation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebFlux/" rel="tag">WebFlux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebSocket/" rel="tag">WebSocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" rel="tag">分布式锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" rel="tag">基准测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag">基础知识</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%B9%E5%99%A8/" rel="tag">容器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/" rel="tag">数据库连接池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/" rel="tag">数据访问</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88/" rel="tag">集合</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CI-CD/" style="font-size: 10px;">CI/CD</a> <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Gitea/" style="font-size: 10px;">Gitea</a> <a href="/tags/JPA/" style="font-size: 10px;">JPA</a> <a href="/tags/Java/" style="font-size: 18px;">Java</a> <a href="/tags/Java-%E5%9F%BA%E7%A1%80-01/" style="font-size: 12px;">Java 基础-01</a> <a href="/tags/Jenkins/" style="font-size: 10px;">Jenkins</a> <a href="/tags/Jetty/" style="font-size: 10px;">Jetty</a> <a href="/tags/MyBatis/" style="font-size: 10px;">MyBatis</a> <a href="/tags/Redis/" style="font-size: 12px;">Redis</a> <a href="/tags/SPring-Boot-%E5%9F%BA%E7%A1%80-01/" style="font-size: 10px;">SPring Boot-基础-01</a> <a href="/tags/Spring-Boot/" style="font-size: 20px;">Spring Boot</a> <a href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" style="font-size: 16px;">Spring Boot-基础-01</a> <a href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-02/" style="font-size: 10px;">Spring Boot-基础-02</a> <a href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" style="font-size: 16px;">Spring Boot-基础01</a> <a href="/tags/SpringMVC/" style="font-size: 10px;">SpringMVC</a> <a href="/tags/Swagger/" style="font-size: 10px;">Swagger</a> <a href="/tags/TeamCity/" style="font-size: 10px;">TeamCity</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/Undertow/" style="font-size: 10px;">Undertow</a> <a href="/tags/Validation/" style="font-size: 10px;">Validation</a> <a href="/tags/Web/" style="font-size: 14px;">Web</a> <a href="/tags/WebFlux/" style="font-size: 10px;">WebFlux</a> <a href="/tags/WebSocket/" style="font-size: 10px;">WebSocket</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 10px;">分布式锁</a> <a href="/tags/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">基准测试</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">基础</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 10px;">基础知识</a> <a href="/tags/%E5%AE%B9%E5%99%A8/" style="font-size: 10px;">容器</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/" style="font-size: 10px;">数据库连接池</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/" style="font-size: 12px;">数据访问</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">线程池</a> <a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 10px;">缓存</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 12px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88/" style="font-size: 10px;">集合</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 10px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/04/15/%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/gitea_%E5%AE%89%E8%A3%85%E5%91%BD%E4%BB%A4/">Gitea 安装命令</a>
          </li>
        
          <li>
            <a href="/2021/04/12/docker/docker_%E5%91%BD%E4%BB%A4/">docker 命令</a>
          </li>
        
          <li>
            <a href="/2020/07/27/TeamCityVSJenkins%E9%80%89%E6%8B%A9%E6%AD%A3%E7%A1%AE%E7%9A%84CI-CD%E5%B7%A5%E5%85%B7/">TeamCityVSJenkins选择正确的CI/CD工具</a>
          </li>
        
          <li>
            <a href="/2020/07/27/SpringMvc-%E5%9F%BA%E7%A1%80/">SpringMvc-基础</a>
          </li>
        
          <li>
            <a href="/2020/07/17/Redis-%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">Redis-基于Redis分布式锁</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>