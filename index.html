<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-数据访问-SpringBoot-MyBatis入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/11/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-MyBatis%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-11T03:08:36.000Z" itemprop="datePublished">2020-06-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/11/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-MyBatis%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-MyBatis入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-MyBatis-入门"><a href="#Spring-Boot-MyBatis-入门" class="headerlink" title="Spring Boot MyBatis 入门"></a>Spring Boot MyBatis 入门</h1><h2 id="1-Mybatis-XML"><a href="#1-Mybatis-XML" class="headerlink" title="1. Mybatis + XML"></a>1. Mybatis + XML</h2><p>配置 <code>@MapperScan</code> 注解，扫描对应 Mapper 接口所在的包路径。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Application.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = <span class="string">"cn.iocoder.springboot.lab12.mybatis.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://47.112.193.81:3306/testb5f4?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">testb5f4</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">F4df4db0ed86@11</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis 配置内容</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis-config.xml</span> <span class="comment"># 配置 MyBatis 配置文件路径</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span> <span class="comment"># 配置 Mapper XML 地址</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">cn.iocoder.springboot.lab12.mybatis.dataobject</span> <span class="comment"># 配置数据库实体包路径</span></span><br></pre></td></tr></table></figure>



<p>在 <a href="https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-12/lab-12-mybatis-xml/src/main/resources" target="_blank" rel="noopener"><code>resources</code></a> 目录下，创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-12/lab-12-mybatis-xml/src/main/resources/mybatis-config.xml" target="_blank" rel="noopener"><code>mybatis-config.xml</code></a> 配置文件。配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用驼峰命名法转换字段。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Integer"</span> <span class="attr">type</span>=<span class="string">"java.lang.Integer"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Long"</span> <span class="attr">type</span>=<span class="string">"java.lang.Long"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"HashMap"</span> <span class="attr">type</span>=<span class="string">"java.util.HashMap"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"LinkedHashMap"</span> <span class="attr">type</span>=<span class="string">"java.util.LinkedHashMap"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"ArrayList"</span> <span class="attr">type</span>=<span class="string">"java.util.ArrayList"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"LinkedList"</span> <span class="attr">type</span>=<span class="string">"java.util.LinkedList"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>因为在数据库中的表的字段，是使用下划线风格，而数据库实体的字段使用驼峰风格，所以通过 <code>mapUnderscoreToCamelCase = true</code> 来自动转换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserMapper.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insert</span><span class="params">(UserDO user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateById</span><span class="params">(UserDO user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>; <span class="comment">// 生产请使用标记删除，除非有点想不开，嘿嘿。</span></span><br><span class="line"></span><br><span class="line">    <span class="function">UserDO <span class="title">selectById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">UserDO <span class="title">selectByUsername</span><span class="params">(@Param(<span class="string">"username"</span>)</span> String username)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;UserDO&gt; <span class="title">selectByIds</span><span class="params">(@Param(<span class="string">"ids"</span>)</span>Collection&lt;Integer&gt; ids)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@Repository</code> 注解，用于标记是数据访问 Bean 对象。在 MyBatis 的接口，实际<strong>非必须</strong>，只是为了避免在 Service 中，<code>@Autowired</code> 注入时无需报警。</li>
<li><code>@Param</code> 注解，声明变量名。<ul>
<li>在方法为单参数时，<strong>非必须</strong>。</li>
<li>在方法为多参数时，<strong>必须</strong>。</li>
</ul>
</li>
<li><code>#selectByUsername(@Param(&quot;username&quot;) String username)</code> 等方法，是使用 <em>By</em> 字段结尾。一般情况下，在 SQL 中的 <code>WHERE</code> 条件字段，建议能够带在方法名后。原因无它，简单明了。如果是多个字段，可以使用 <em>AND</em> 分隔。当然，如果查询字段比较多，可能方法名会比较长。</li>
</ul>
<p>在 <a href="https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-12/lab-12-mybatis-xml/src/main/resources/mapper" target="_blank" rel="noopener"><code>resources/mapper</code></a> 路径下，创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-12/lab-12-mybatis-xml/src/main/resources/mapper/UserMapper.xml" target="_blank" rel="noopener"><code>UserMapper.xml</code></a> 配置文件。代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"cn.iocoder.springboot.lab12.mybatis.mapper.UserMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"FIELDS"</span>&gt;</span></span><br><span class="line">        id, username, password, create_time</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert"</span> <span class="attr">parameterType</span>=<span class="string">"UserDO"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        INSERT INTO users (</span><br><span class="line">          username, password, create_time</span><br><span class="line">        ) VALUES (</span><br><span class="line">          #&#123;username&#125;, #&#123;password&#125;, #&#123;createTime&#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateById"</span> <span class="attr">parameterType</span>=<span class="string">"UserDO"</span>&gt;</span></span><br><span class="line">        UPDATE users</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null"</span>&gt;</span></span><br><span class="line">                , username = #&#123;username&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"password != null"</span>&gt;</span></span><br><span class="line">                , password = #&#123;password&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteById"</span> <span class="attr">parameterType</span>=<span class="string">"Integer"</span>&gt;</span></span><br><span class="line">        DELETE FROM users</span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectById"</span> <span class="attr">parameterType</span>=<span class="string">"Integer"</span> <span class="attr">resultType</span>=<span class="string">"UserDO"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"FIELDS"</span> /&gt;</span></span><br><span class="line">        FROM users</span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectByUsername"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span> <span class="attr">resultType</span>=<span class="string">"UserDO"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"FIELDS"</span> /&gt;</span></span><br><span class="line">        FROM users</span><br><span class="line">        WHERE username = #&#123;username&#125;</span><br><span class="line">        LIMIT 1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectByIds"</span> <span class="attr">resultType</span>=<span class="string">"UserDO"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"FIELDS"</span> /&gt;</span></span><br><span class="line">        FROM users</span><br><span class="line">        WHERE id IN</span><br><span class="line">            <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"id"</span> <span class="attr">collection</span>=<span class="string">"ids"</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">close</span>=<span class="string">")"</span> <span class="attr">index</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                #&#123;id&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>建议 1 ：对于绝大多数查询，我们是返回统一字段，所以可以使用 <code>&lt;sql /&gt;</code> 标签，定义 SQL 段。对于性能或者查询字段比较大的查询，按需要的字段查询。</li>
<li>建议 2 ：对于数据库的关键字，使用大写。例如说，<code>SELECT</code>、<code>WHERE</code> 等等。</li>
<li>建议 3 ：基本是每“块”数据库关键字占用一行</li>
</ul>
<h2 id="2-MyBatis-注解"><a href="#2-MyBatis-注解" class="headerlink" title="2. MyBatis + 注解"></a>2. MyBatis + 注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserMapper.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"INSERT INTO users(username, password, create_time) VALUES(#&#123;username&#125;, #&#123;password&#125;, #&#123;createTime&#125;)"</span>)</span><br><span class="line">    <span class="meta">@Options</span>(useGeneratedKeys = <span class="keyword">true</span>, keyProperty = <span class="string">"id"</span>, keyColumn = <span class="string">"id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insert</span><span class="params">(UserDO user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span>(value = &#123;</span><br><span class="line">            <span class="string">"&lt;script&gt;"</span>,</span><br><span class="line">            <span class="string">"UPDATE users"</span>,</span><br><span class="line">            <span class="string">"&lt;set&gt;"</span>,</span><br><span class="line">            <span class="string">"&lt;if test='username != null'&gt;, username = #&#123;username&#125;&lt;/if&gt;"</span>,</span><br><span class="line">            <span class="string">"&lt;if test='password != null'&gt;, password = #&#123;password&#125;&lt;/if&gt;"</span>,</span><br><span class="line">            <span class="string">"&lt;/set&gt;"</span>,</span><br><span class="line">            <span class="string">"&lt;/script&gt;"</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateById</span><span class="params">(UserDO user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"DELETE FROM users WHERE id = #&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>; <span class="comment">// 生产请使用标记删除，除非有点想不开，嘿嘿。</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT username, password, create_time FROM users WHERE id = #&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">UserDO <span class="title">selectById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT username, password, create_time FROM users WHERE username = #&#123;username&#125;"</span>)</span><br><span class="line">    <span class="function">UserDO <span class="title">selectByUsername</span><span class="params">(@Param(<span class="string">"username"</span>)</span> String username)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(value = &#123;</span><br><span class="line">            <span class="string">"&lt;script&gt;"</span>,</span><br><span class="line">            <span class="string">"SELECT username, password, create_time FROM users"</span>,</span><br><span class="line">            <span class="string">"WHERE id IN"</span>,</span><br><span class="line">            <span class="string">"&lt;foreach item='id' collection='ids' separator=',' open='(' close=')' index=''&gt;"</span>,</span><br><span class="line">            <span class="string">"#&#123;id&#125;"</span>,</span><br><span class="line">            <span class="string">"&lt;/foreach&gt;"</span>,</span><br><span class="line">            <span class="string">"&lt;/script&gt;"</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function">List&lt;UserDO&gt; <span class="title">selectByIds</span><span class="params">(@Param(<span class="string">"ids"</span>)</span> Collection&lt;Integer&gt; ids)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-MyBatis-Plus"><a href="#3-MyBatis-Plus" class="headerlink" title="3. MyBatis-Plus"></a>3. MyBatis-Plus</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 实现对 MyBatis Plus 的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://47.112.193.81:3306/testb5f4?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">testb5f4</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">F4df4db0ed86@11</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis-plus 配置内容</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span> <span class="comment"># 虽然默认为 true ，但是还是显示去指定下。</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span> <span class="comment"># ID 主键自增</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span> <span class="comment"># 逻辑已删除值(默认为 1)</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span> <span class="comment"># 逻辑未删除值(默认为 0)</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">cn.iocoder.springboot.lab12.mybatis.dataobject</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># logging</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># dao 开启 debug 模式 mybatis 输入 sql</span></span><br><span class="line">    <span class="attr">cn:</span></span><br><span class="line">      <span class="attr">iocoder:</span></span><br><span class="line">        <span class="attr">springboot:</span></span><br><span class="line">          <span class="attr">lab12:</span></span><br><span class="line">            <span class="attr">mybatis:</span></span><br><span class="line">              <span class="attr">mapper:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserDO.java</span></span><br><span class="line"><span class="meta">@TableName</span>(value = <span class="string">"users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码（明文）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ps：生产环境下，千万不要明文噢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableLogic</span></span><br><span class="line">    <span class="keyword">private</span> Integer deleted;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略 setting/getting 方法</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加了 <a href="https://mybatis.plus/guide/annotation.html#tablename" target="_blank" rel="noopener"><code>@TableName</code></a> 注解，设置了 UserDO 对应的表名是 <code>users</code> 。毕竟，我们要使用 MyBatis-Plus 给咱自动生成 CRUD 操作。</li>
<li>增加了 <code>deleted</code> 字段，并添加了 <code>@TableLogic</code> 注解，设置该字段为逻辑删除的标记。<ul>
<li>在 <code>application.yaml</code> 配置文件中，我们配置了删除（<code>logic-delete-value = 1</code>）和未删除（<code>logic-not-delete-value = 0</code>）。当然，也可以通过注解的 <code>value</code> 和 <code>delval</code> 来定义未删除和删除。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserMapper.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">UserDO</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> UserDO <span class="title">selectByUsername</span><span class="params">(@Param(<span class="string">"username"</span>)</span> String username) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> selectOne(<span class="keyword">new</span> QueryWrapper&lt;UserDO&gt;().eq(<span class="string">"username"</span>, username));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;UserDO&gt; <span class="title">selectByIds</span><span class="params">(@Param(<span class="string">"ids"</span>)</span> Collection&lt;Integer&gt; ids)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> IPage&lt;UserDO&gt; <span class="title">selectPageByCreateTime</span><span class="params">(IPage&lt;UserDO&gt; page, @Param(<span class="string">"createTime"</span>)</span> Date createTime) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> selectPage(page,</span><br><span class="line">                <span class="keyword">new</span> QueryWrapper&lt;UserDO&gt;().gt(<span class="string">"create_time"</span>, createTime));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/11/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-MyBatis%E5%85%A5%E9%97%A8/" data-id="ckbg9kucv001e2r07bcoq5stt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据访问-SpringBoot-数据库连接池入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/10/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-10T06:06:35.000Z" itemprop="datePublished">2020-06-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/10/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-数据库连接池入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-数据库连接池入门"><a href="#Spring-Boot-数据库连接池入门" class="headerlink" title="Spring Boot 数据库连接池入门"></a>Spring Boot 数据库连接池入门</h1><p>在目前数据库连接池的选型中，主要是</p>
<ul>
<li><a href="https://github.com/alibaba/druid" target="_blank" rel="noopener">Druid</a> ，为<strong>监控</strong>而生的数据库连接池。</li>
<li><a href="https://github.com/brettwooldridge/HikariCP" target="_blank" rel="noopener">HikariCP</a> ，号称<strong>性能</strong>最好的数据库连接池。</li>
</ul>
<h2 id="1-HikariCP-数据源"><a href="#1-HikariCP-数据源" class="headerlink" title="1. HikariCP 数据源"></a>1. HikariCP 数据源</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容，对应 DataSourceProperties 配置属性类</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span> <span class="comment"># 数据库账号</span></span><br><span class="line">    <span class="attr">password:</span> <span class="comment"># 数据库密码</span></span><br><span class="line">    <span class="comment"># HikariCP 自定义配置，对应 HikariConfig 配置属性类</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">minimum-idle:</span> <span class="number">10</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 10 个。</span></span><br><span class="line">      <span class="attr">maximum-pool-size:</span> <span class="number">10</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 10 个。</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">配置项</th>
<th align="left">描述</th>
<th align="left">构造器默认值</th>
<th align="left">默认配置validate之后的值</th>
<th align="left">validate重置</th>
</tr>
</thead>
<tbody><tr>
<td align="left">autoCommit</td>
<td align="left">自动提交从池中返回的连接</td>
<td align="left">true</td>
<td align="left">true</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">connectionTimeout</td>
<td align="left">等待来自池的连接的最大毫秒数</td>
<td align="left">SECONDS.toMillis(30) = 30000</td>
<td align="left">30000</td>
<td align="left">如果小于250毫秒，则被重置回30秒</td>
</tr>
<tr>
<td align="left">idleTimeout</td>
<td align="left">连接允许在池中闲置的最长时间</td>
<td align="left">MINUTES.toMillis(10) = 600000</td>
<td align="left">600000</td>
<td align="left">如果idleTimeout+1秒&gt;maxLifetime 且 maxLifetime&gt;0，则会被重置为0（代表永远不会退出）；如果idleTimeout!=0且小于10秒，则会被重置为10秒</td>
</tr>
<tr>
<td align="left">maxLifetime</td>
<td align="left">池中连接最长生命周期</td>
<td align="left">MINUTES.toMillis(30) = 1800000</td>
<td align="left">1800000</td>
<td align="left">如果不等于0且小于30秒则会被重置回30分钟</td>
</tr>
<tr>
<td align="left">connectionTestQuery</td>
<td align="left">如果您的驱动程序支持JDBC4，我们强烈建议您不要设置此属性</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">minimumIdle</td>
<td align="left">池中维护的最小空闲连接数</td>
<td align="left">-1</td>
<td align="left">10</td>
<td align="left">minIdle&lt;0或者minIdle&gt;maxPoolSize,则被重置为maxPoolSize</td>
</tr>
<tr>
<td align="left">maximumPoolSize</td>
<td align="left">池中最大连接数，包括闲置和使用中的连接</td>
<td align="left">-1</td>
<td align="left">10</td>
<td align="left">如果maxPoolSize小于1，则会被重置。当minIdle&lt;=0被重置为DEFAULT_POOL_SIZE则为10;如果minIdle&gt;0则重置为minIdle的值</td>
</tr>
<tr>
<td align="left">metricRegistry</td>
<td align="left">该属性允许您指定一个 Codahale / Dropwizard <code>MetricRegistry</code> 的实例，供池使用以记录各种指标</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">healthCheckRegistry</td>
<td align="left">该属性允许您指定池使用的Codahale / Dropwizard HealthCheckRegistry的实例来报告当前健康信息</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">poolName</td>
<td align="left">连接池的用户定义名称，主要出现在日志记录和JMX管理控制台中以识别池和池配置</td>
<td align="left">null</td>
<td align="left">HikariPool-1</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">initializationFailTimeout</td>
<td align="left">如果池无法成功初始化连接，则此属性控制池是否将 <code>fail fast</code></td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">isolateInternalQueries</td>
<td align="left">是否在其自己的事务中隔离内部池查询，例如连接活动测试</td>
<td align="left">false</td>
<td align="left">false</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">allowPoolSuspension</td>
<td align="left">控制池是否可以通过JMX暂停和恢复</td>
<td align="left">false</td>
<td align="left">false</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">readOnly</td>
<td align="left">从池中获取的连接是否默认处于只读模式</td>
<td align="left">false</td>
<td align="left">false</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">registerMbeans</td>
<td align="left">是否注册JMX管理Bean（<code>MBeans</code>）</td>
<td align="left">false</td>
<td align="left">false</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">catalog</td>
<td align="left">为支持 <code>catalog</code> 概念的数据库设置默认 <code>catalog</code></td>
<td align="left">driver default</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">connectionInitSql</td>
<td align="left">该属性设置一个SQL语句，在将每个新连接创建后，将其添加到池中之前执行该语句。</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">driverClassName</td>
<td align="left">HikariCP将尝试通过仅基于jdbcUrl的DriverManager解析驱动程序，但对于一些较旧的驱动程序，还必须指定driverClassName</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">transactionIsolation</td>
<td align="left">控制从池返回的连接的默认事务隔离级别</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">validationTimeout</td>
<td align="left">连接将被测试活动的最大时间量</td>
<td align="left">SECONDS.toMillis(5) = 5000</td>
<td align="left">5000</td>
<td align="left">如果小于250毫秒，则会被重置回5秒</td>
</tr>
<tr>
<td align="left">leakDetectionThreshold</td>
<td align="left">记录消息之前连接可能离开池的时间量，表示可能的连接泄漏</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">如果大于0且不是单元测试，则进一步判断：(leakDetectionThreshold &lt; SECONDS.toMillis(2) or (leakDetectionThreshold &gt; maxLifetime &amp;&amp; maxLifetime &gt; 0)，会被重置为0 . 即如果要生效则必须&gt;0，而且不能小于2秒，而且当maxLifetime &gt; 0时不能大于maxLifetime</td>
</tr>
<tr>
<td align="left">dataSource</td>
<td align="left">这个属性允许你直接设置数据源的实例被池包装，而不是让HikariCP通过反射来构造它</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">schema</td>
<td align="left">该属性为支持模式概念的数据库设置默认模式</td>
<td align="left">driver default</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">threadFactory</td>
<td align="left">此属性允许您设置将用于创建池使用的所有线程的java.util.concurrent.ThreadFactory的实例。</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">scheduledExecutor</td>
<td align="left">此属性允许您设置将用于各种内部计划任务的java.util.concurrent.ScheduledExecutorService实例</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
</tbody></table>
<h2 id="2-HikariCP-多数据源"><a href="#2-HikariCP-多数据源" class="headerlink" title="2. HikariCP 多数据源"></a>2. HikariCP 多数据源</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 订单数据源配置</span></span><br><span class="line">    <span class="attr">orders:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test_orders?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="comment"># HikariCP 自定义配置，对应 HikariConfig 配置属性类</span></span><br><span class="line">      <span class="attr">hikari:</span></span><br><span class="line">        <span class="attr">minimum-idle:</span> <span class="number">20</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 10 个。</span></span><br><span class="line">        <span class="attr">maximum-pool-size:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 10 个。</span></span><br><span class="line">    <span class="comment"># 用户数据源配置</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test_users?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="comment"># HikariCP 自定义配置，对应 HikariConfig 配置属性类</span></span><br><span class="line">      <span class="attr">hikari:</span></span><br><span class="line">        <span class="attr">minimum-idle:</span> <span class="number">15</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 10 个。</span></span><br><span class="line">        <span class="attr">maximum-pool-size:</span> <span class="number">15</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 10 个。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DataSourceConfig.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 orders 数据源的配置对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"ordersDataSourceProperties"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.orders"</span>) <span class="comment">// 读取 spring.datasource.orders 配置到 DataSourceProperties 对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceProperties <span class="title">ordersDataSourceProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 orders 数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"ordersDataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.orders.hikari"</span>) <span class="comment">// 读取 spring.datasource.orders 配置到 HikariDataSource 对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">ordersDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// &lt;1.1&gt; 获得 DataSourceProperties 对象</span></span><br><span class="line">        DataSourceProperties properties =  <span class="keyword">this</span>.ordersDataSourceProperties();</span><br><span class="line">        <span class="comment">// &lt;1.2&gt; 创建 HikariDataSource 对象</span></span><br><span class="line">        <span class="keyword">return</span> createHikariDataSource(properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 users 数据源的配置对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"usersDataSourceProperties"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.users"</span>) <span class="comment">// 读取 spring.datasource.users 配置到 DataSourceProperties 对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceProperties <span class="title">usersDataSourceProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 users 数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"usersDataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.users.hikari"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">usersDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获得 DataSourceProperties 对象</span></span><br><span class="line">        DataSourceProperties properties =  <span class="keyword">this</span>.usersDataSourceProperties();</span><br><span class="line">        <span class="comment">// 创建 HikariDataSource 对象</span></span><br><span class="line">        <span class="keyword">return</span> createHikariDataSource(properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HikariDataSource <span class="title">createHikariDataSource</span><span class="params">(DataSourceProperties properties)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 HikariDataSource 对象</span></span><br><span class="line">        HikariDataSource dataSource = properties.initializeDataSourceBuilder().type(HikariDataSource<span class="class">.<span class="keyword">class</span>).<span class="title">build</span>()</span>;</span><br><span class="line">        <span class="comment">// 设置线程池名</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(properties.getName())) &#123;</span><br><span class="line">            dataSource.setPoolName(properties.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>#ordersDataSourceProperties()</code> 方法，创建 <code>&quot;orders&quot;</code> 数据源的 DataSourceProperties 配置对象。<ul>
<li><a href="http://www.yihaomen.com/article/java/581.htm" target="_blank" rel="noopener"><code>@Primary</code></a> 注解，保证项目中有一个<strong>主</strong>的 DataSourceProperties Bean 。</li>
<li><code>new DataSourceProperties()</code> 代码段，会创建一个 DataSourceProperties 数据源的配置对象。</li>
<li>搭配上 <code>@Bean(name = &quot;ordersDataSourceProperties&quot;)</code> 注解，会创建一个名字为 <code>&quot;ordersDataSourceProperties&quot;</code> 的 DataSourceProperties Bean 。</li>
<li><code>@ConfigurationProperties(prefix = &quot;spring.datasource.orders&quot;)</code> 注解，会将 <code>&quot;spring.datasource.orders&quot;</code> 配置项，逐个属性赋值给 DataSourceProperties Bean 。</li>
</ul>
</li>
<li><code>#ordersDataSource()</code> 方法，创建 <code>orders</code> 数据源。<ul>
<li><code>&lt;1.1&gt;</code> 处，调用 <code>#ordersDataSourceProperties()</code> 方法，获得 <code>orders</code> 数据源的 DataSourceProperties 。</li>
<li><code>&lt;1.2&gt;</code> 处，调用 <code>#createHikariDataSource(DataSourceProperties properties)</code> 方法，创建 HikariDataSource 对象。这样，<code>&quot;spring.datasource.orders&quot;</code> 配置项，逐个属性赋值给 HikariDataSource Bean 。</li>
<li>搭配上 <code>@Bean(name = &quot;ordersDataSource&quot;)</code> 注解，会创建一个名字为 <code>&quot;ordersDataSource&quot;</code> 的 HikariDataSource Bean 。</li>
<li><code>@ConfigurationProperties(prefix = &quot;spring.datasource.orders.hikari&quot;)</code> 注解，会将 HikariCP 的 <code>&quot;spring.datasource.orders.hikari&quot;</code> 自定义配置项，逐个属性赋值给 HikariDataSource Bean </li>
</ul>
</li>
</ul>
<h2 id="3-Druid-单数据源"><a href="#3-Druid-单数据源" class="headerlink" title="3. Druid 单数据源"></a>3. Druid 单数据源</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 实现对 Druid 连接池的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容，对应 DataSourceProperties 配置属性类</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span> <span class="comment"># 数据库账号</span></span><br><span class="line">    <span class="attr">password:</span> <span class="comment"># 数据库密码</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 设置类型为 DruidDataSource</span></span><br><span class="line">    <span class="comment"># Druid 自定义配置，对应 DruidDataSource 中的 setting 方法的属性</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 0 个。</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 8 个。</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span> <span class="comment"># 配置 StatFilter ，对应文档 https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatFilter</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span> <span class="comment"># 开启慢查询记录</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">5000</span> <span class="comment"># 慢 SQL 的标准，单位：毫秒</span></span><br><span class="line">      <span class="attr">stat-view-servlet:</span> <span class="comment"># 配置 StatViewServlet ，对应文档 https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatViewServlet%E9%85%8D%E7%BD%AE</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 是否开启 StatViewServlet</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">yudaoyuanma</span> <span class="comment"># 账号</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="string">javaniubi</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>spring.datasource</code> 配置项，设置 Spring 数据源的通用配置。其中，<code>spring.datasource.type</code> 配置项，<strong>需要主动</strong>设置使用 DruidDataSource 。因为默认情况下，<code>spring-boot-starter-jdbc</code> 的 <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/jdbc/DataSourceBuilder.java#L49-L50" target="_blank" rel="noopener">DataSourceBuilder</a> 会按照 <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/jdbc/DataSourceBuilder.java#L49-L50" target="_blank" rel="noopener"><code>DATA_SOURCE_TYPE_NAMES</code></a> 的顺序，尝试推断数据源的类型。</li>
<li><code>spring.datasource.druid</code> 配置项，设置 Druid 连接池的自定义配置。然后 DruidDataSourceAutoConfigure 会自动化配置 Druid 连接池。<ul>
<li>在 <a href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter#配置属性" target="_blank" rel="noopener">《Druid —— 配置属性》</a> 和 <a href="https://github.com/alibaba/druid/wiki/DruidDataSource配置属性列表" target="_blank" rel="noopener">《DruidDataSource 配置属性列表》</a> 下，提供了各种 Druid 的配置项</li>
<li><code>filter.stat</code> 配置项，配置了 Druid <a href="https://github.com/alibaba/druid/blob/master/src/main/java/com/alibaba/druid/filter/stat/StatFilter.java" target="_blank" rel="noopener">StatFilter</a> ，用于统计监控信息。对应文档 <a href="https://github.com/alibaba/druid/wiki/配置_StatFilter" target="_blank" rel="noopener">《Druid —— 配置_StatFilter》</a> 。要注意，StatFilter 并不是 <a href="https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/Filter.java" target="_blank" rel="noopener"><code>javax.servlet.Filter</code></a> ，而是 Druid 提供的 <a href="https://github.com/alibaba/druid/wiki/配置_Filter配置" target="_blank" rel="noopener">Filter</a> 拓展机制。</li>
<li><code>filter.stat-view-servlet</code> 配置项，配置了 Druid <a href="https://github.com/alibaba/druid/blob/master/src/main/java/com/alibaba/druid/support/http/StatViewServlet.java" target="_blank" rel="noopener">StatViewServlet</a> ，用于提供监控信息的<strong>展示的 html 页面</strong>和 <strong>JSON API</strong> 。对应文档 <a href="https://github.com/alibaba/druid/wiki/配置_StatViewServlet配置" target="_blank" rel="noopener">《Druid —— 配置_StatViewServlet 配置》</a> 。StatViewServlet 就是 <a href="https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/Servlet.java" target="_blank" rel="noopener"><code>javax.servlet.Filter</code></a> 。</li>
</ul>
</li>
</ul>
<h2 id="4-Druid-多数据源"><a href="#4-Druid-多数据源" class="headerlink" title="4. Druid 多数据源"></a>4. Druid 多数据源</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 订单数据源配置</span></span><br><span class="line">    <span class="attr">orders:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test_orders?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 设置类型为 DruidDataSource</span></span><br><span class="line">      <span class="comment"># Druid 自定义配置，对应 DruidDataSource 中的 setting 方法的属性</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 0 个。</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 8 个。</span></span><br><span class="line">    <span class="comment"># 用户数据源配置</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test_users?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 设置类型为 DruidDataSource</span></span><br><span class="line">      <span class="comment"># Druid 自定义配置，对应 DruidDataSource 中的 setting 方法的属性</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 0 个。</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 8 个。</span></span><br><span class="line">    <span class="comment"># Druid 自定已配置</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="comment"># 过滤器配置</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span> <span class="comment"># 配置 StatFilter ，对应文档 https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatFilter</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span> <span class="comment"># 开启慢查询记录</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">5000</span> <span class="comment"># 慢 SQL 的标准，单位：毫秒</span></span><br><span class="line">      <span class="comment"># StatViewServlet 配置</span></span><br><span class="line">      <span class="attr">stat-view-servlet:</span> <span class="comment"># 配置 StatViewServlet ，对应文档 https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatViewServlet%E9%85%8D%E7%BD%AE</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 是否开启 StatViewServlet</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">yudaoyuanma</span> <span class="comment"># 账号</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="string">javaniubi</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Druid 的自定义配置，和 <code>url</code>、<code>driver-class-name</code> 等数据源的通用配置放在同一级，这样后续我们只需要使用 <code>@ConfigurationProperties(prefix = &quot;spring.datasource.orders&quot;)</code> 的方式，就能完成 DruidDataSource 的配置属性设置。</li>
<li>在 <code>spring.datasource.druid</code> 配置项下，配置了 <code>filter.stat</code> 和 <code>stat-view-servlet</code> 配置项，用于 Druid 监控功能。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DataSourceConfig.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 orders 数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"ordersDataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.orders"</span>) <span class="comment">// 读取 spring.datasource.orders 配置到 HikariDataSource 对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">ordersDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 users 数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"usersDataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.users"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">usersDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Application.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(Application<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"ordersDataSource"</span>)</span><br><span class="line">    <span class="keyword">private</span> DataSource ordersDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"usersDataSource"</span>)</span><br><span class="line">    <span class="keyword">private</span> DataSource usersDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 启动 Spring Boot 应用</span></span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// orders 数据源</span></span><br><span class="line">        logger.info(<span class="string">"[run][获得数据源：&#123;&#125;]"</span>, ordersDataSource.getClass());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// users 数据源</span></span><br><span class="line">        logger.info(<span class="string">"[run][获得数据源：&#123;&#125;]"</span>, usersDataSource.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/10/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%85%A5%E9%97%A8/" data-id="ckbg9kucx001g2r07dnvu5mlf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">Spring Boot-基础-01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/" rel="tag">数据库连接池</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据访问-SpringBoot-缓存Cache入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/08/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E7%BC%93%E5%AD%98Cache%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-08T03:32:02.000Z" itemprop="datePublished">2020-06-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/08/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E7%BC%93%E5%AD%98Cache%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-缓存Cache入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-缓存-Cache-入门"><a href="#Spring-Boot-缓存-Cache-入门" class="headerlink" title="Spring Boot 缓存 Cache 入门"></a>Spring Boot 缓存 Cache 入门</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><ul>
<li>读写分离。通过将读操作分流到从节点，避免主节点压力过多。</li>
<li>分库分表。通过将读写操作分摊到多个节点，避免单节点压力过多。</li>
<li>缓存。相比数据库来说，缓存往往能够提供更快的读性能，减小数据库的压力。</li>
</ul>
<p>在引入缓存之后，读操作的代码，往往代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserService.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserMapper userMapper; <span class="comment">// 读取 DB</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserCacheDao userCacheDao; <span class="comment">// 读取 Cache</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDO <span class="title">getUser</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从 Cache 中，查询用户信息</span></span><br><span class="line">    UserDO user = userCacheDao.get(id);</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果 Cache 查询不到，从 DB 中读取</span></span><br><span class="line">    user = userMapper.selectById(id);</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123; <span class="comment">// 非空，则缓存到 Cache 中</span></span><br><span class="line">        userCacheDao.put(user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回结果</span></span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这段代码，是比较常用的缓存策略，俗称<strong>“被动写”</strong>。整体步骤如下：<ul>
<li>1）首先，从 Cache 中，读取用户缓存。如果存在，则直接返回。</li>
<li>2）然后，从 DB 中，读取用户数据。如果存在，写入 Cache 中。</li>
<li>3）最后，返回 DB 的查询结果。</li>
</ul>
</li>
</ul>
<p>简单来说，可以像使用 <code>@Transactional</code> 声明式<strong>事务</strong>，使用 Spring Cache 提供的 <code>@Cacheable</code> 等注解， 声明式<strong>缓存</strong>。而在实现原理上，也是基于 Spring AOP 拦截，实现缓存相关的操作。</p>
<p>下面，我们使用 Spring Cache 将 <code>#getUser(Integer id)</code> 方法进行简化。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserService.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDO <span class="title">getUser2</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userMapper.selectById(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserMapper.java</span></span><br><span class="line"><span class="meta">@Cacheable</span>(value = <span class="string">"users"</span>, key = <span class="string">"#id"</span>)</span><br><span class="line"><span class="function">UserDO <span class="title">selectById</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 UserService 的 <code>#getUser2(Integer id)</code> 方法上，我们直接调用 UserMapper ，从 DB 中查询数据。</li>
<li>在 UserMapper 的 <code>#selectById(Integer id)</code> 方法上，有 <code>@Cacheable</code> 注解。Spring Cache 会拦截有 <code>@Cacheable</code> 注解的方法，实现“<strong>被动写</strong>”的逻辑。</li>
</ul>
<h2 id="2-注解"><a href="#2-注解" class="headerlink" title="2. 注解"></a>2. 注解</h2><p>在入门 Spring Cache 之前，先了解下其提供的所有注解：</p>
<ul>
<li><code>@Cacheable</code></li>
<li><code>@CachePut</code></li>
<li><code>@CacheEvict</code></li>
<li><code>@CacheConfig</code></li>
<li><code>@Caching</code></li>
<li><code>@EnableCaching</code></li>
</ul>
<h3 id="2-1-Cacheable"><a href="#2-1-Cacheable" class="headerlink" title="2.1 @Cacheable"></a>2.1 @Cacheable</h3><p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/cache/annotation/Cacheable.java" target="_blank" rel="noopener"><code>@Cacheable</code></a> 注解，添加在方法上，缓存方法的执行结果。执行过程如下：</p>
<ul>
<li>1）首先，判断方法执行结果的缓存。如果有，则直接返回该缓存结果。</li>
<li>2）然后，执行方法，获得方法结果。</li>
<li>3）之后，根据是否满足缓存的条件。如果满足，则缓存方法结果到缓存。</li>
<li>4）最后，返回方法结果。</li>
</ul>
<p><code>@Cacheable</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>cacheNames</code> 属性：缓存名。<strong>必填</strong>。<code>[]</code> 数组，可以填写多个缓存名。</li>
<li><code>values</code> 属性：和 <code>cacheNames</code> 属性相同，是它的别名。</li>
<li><code>key</code> 属性：缓存的 key 。允许空。<ul>
<li>如果为空，则默认方法的所有参数进行组合。</li>
<li>如果非空，则需要按照 <a href="http://itmyhome.com/spring/expressions.html" target="_blank" rel="noopener">SpEL(Spring Expression Language)</a> 来配置。例如说，<code>@Cacheable(value = &quot;users&quot;, key = &quot;#id&quot;)</code> ，使用方法参数 <code>id</code> 的值作为缓存的 key 。</li>
</ul>
</li>
<li><code>condition</code> 属性：基于方法入参，判断要缓存的条件。允许空。<ul>
<li>如果为空，则不进行入参的判断。</li>
<li>如果非空，则需要按照 <a href="http://itmyhome.com/spring/expressions.html" target="_blank" rel="noopener">SpEL(Spring Expression Language)</a> 来配置。例如说，<code>@Cacheable(condition=&quot;#id &gt; 0&quot;)</code> ，需要传入的 <code>id</code> 大于零。</li>
</ul>
</li>
<li><code>unless</code> 属性：基于方法返回，判断不缓存的条件。允许空。<ul>
<li>如果为空，则不进行入参的判断。</li>
<li>如果非空，则需要按照 <a href="http://itmyhome.com/spring/expressions.html" target="_blank" rel="noopener">SpEL(Spring Expression Language)</a> 来配置。例如说，<code>@Cacheable(unless=&quot;#result == null&quot;)</code> ，如果返回结果为 <code>null</code> ，则不进行缓存。</li>
<li>要注意，<code>condition</code> 和 <code>unless</code> 都是条件属性，差别在于前者针对入参，后者针对结果。</li>
</ul>
</li>
</ul>
<h3 id="2-2-CachePut"><a href="#2-2-CachePut" class="headerlink" title="2.2 @CachePut"></a>2.2 @CachePut</h3><p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/cache/annotation/CachePut.java" target="_blank" rel="noopener"><code>@CachePut</code></a> 注解，添加在方法上，缓存方法的执行结果。不同于 <code>@Cacheable</code> 注解，它的执行过程如下：</p>
<ul>
<li>1）首先，执行方法，获得方法结果。<strong>也就是说，无论是否有缓存，都会执行方法</strong>。</li>
<li>2）然后，根据是否满足缓存的条件。如果满足，则缓存方法结果到缓存。</li>
<li>3）最后，返回方法结果。</li>
</ul>
<p>一般来说，使用方式如下：</p>
<ul>
<li><code>@Cacheable</code>：搭配<strong>读</strong>操作，实现缓存的<strong>被动</strong>写。</li>
<li><code>@CachePut</code>：配置<strong>写</strong>操作，实现缓存的<strong>主动</strong>写。</li>
</ul>
<p><code>@Cacheable</code> 注解的属性，和 <code>@Cacheable</code> 注解的属性，基本<strong>一致</strong>，只少一个 <code>sync</code> 属性。</p>
<h3 id="2-3-CacheEvict"><a href="#2-3-CacheEvict" class="headerlink" title="2.3 @CacheEvict"></a>2.3 @CacheEvict</h3><p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/cache/annotation/CacheEvict.java" target="_blank" rel="noopener"><code>@CacheEvict</code></a> 注解，添加在方法上，删除缓存。</p>
<p>相比 <code>@CachePut</code> 注解，它额外多了两个属性：</p>
<ul>
<li><code>allEntries</code> 属性，是否删除缓存名( <code>cacheNames</code> )下，所有 key 对应的缓存。默认为 <code>false</code> ，只删除指定 key 的缓存。</li>
<li><code>beforeInvocation</code> 属性，是否在方法执行<strong>前</strong>删除缓存。默认为 <code>false</code> ，在方法执行<strong>后</strong>删除缓存。</li>
</ul>
<h3 id="2-4-CacheConfig"><a href="#2-4-CacheConfig" class="headerlink" title="2.4 @CacheConfig"></a>2.4 @CacheConfig</h3><p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/cache/annotation/CacheConfig.java" target="_blank" rel="noopener"><code>@CacheConfig</code></a> 注解，添加在类上，共享如下四个属性的配置：</p>
<ul>
<li><code>cacheNames</code></li>
<li><code>keyGenerator</code></li>
<li><code>cacheManager</code></li>
<li><code>cacheResolver</code></li>
</ul>
<h3 id="2-5-EnableCaching"><a href="#2-5-EnableCaching" class="headerlink" title="2.5 @EnableCaching"></a>2.5 @EnableCaching</h3><p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/cache/annotation/EnableCaching.java" target="_blank" rel="noopener"><code>@EnableCaching</code></a> 注解，标记开启 Spring Cache 功能，所以一定要添加。</p>
<h2 id="3-Spring-Boot-集成"><a href="#3-Spring-Boot-集成" class="headerlink" title="3. Spring Boot 集成"></a>3. Spring Boot 集成</h2><p>在 Spring Boot 里，提供了 <a href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-cache" target="_blank" rel="noopener"><code>spring-boot-starter-cache</code></a> 库，实现 Spring Cache 的自动化配置，通过 <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/cache/CacheAutoConfiguration.java" target="_blank" rel="noopener">CacheAutoConfiguration</a> 配置类。</p>
<p>在 Java 后端开发中，常见的缓存工具和框架列举如下：</p>
<ul>
<li><p>本地缓存：Guava LocalCache、Ehcache、Caffeine 。</p>
<p><em>Ehcache 的功能更加丰富，Caffeine 的性能要比 Guava LocalCache 好。</em></p>
</li>
<li><p>分布式缓存：Redis、Memcached、Tair 。</p>
<p><em>Redis 最为主流和常用。</em></p>
</li>
</ul>
<h2 id="4-Ehcache-示例"><a href="#4-Ehcache-示例" class="headerlink" title="4. Ehcache 示例"></a>4. Ehcache 示例</h2><p>EhCache 是一个纯 Java 的进程内缓存框架，具有快速、精干等特点，是 Hibernate 中默认的 CacheProvider 。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 实现对数据库连接池的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 本示例，我们使用 MySQL --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 实现对 MyBatis Plus 的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 实现对 Caches 的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Ehcache 依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.ehcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 方便等会写单元测试 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/lab-21-cache-demo?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span></span><br><span class="line">  <span class="comment"># cache 缓存配置内容</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ehcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis-plus 配置内容</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span> <span class="comment"># 虽然默认为 true ，但是还是显示去指定下。</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span> <span class="comment"># ID 主键自增</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span> <span class="comment"># 逻辑已删除值(默认为 1)</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span> <span class="comment"># 逻辑未删除值(默认为 0)</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">cn.iocoder.springboot.lab21.cache.dataobject</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># logging</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># dao 开启 debug 模式 mybatis 输入 sql</span></span><br><span class="line">    <span class="attr">cn:</span></span><br><span class="line">      <span class="attr">iocoder:</span></span><br><span class="line">        <span class="attr">springboot:</span></span><br><span class="line">          <span class="attr">lab21:</span></span><br><span class="line">            <span class="attr">cache:</span></span><br><span class="line">              <span class="attr">mapper:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>spring.datasource</code> 配置项下，设置数据源相关的配置。</li>
<li><code>spring.cache</code> 配置项下，设置 Cache 相关的配置。<ul>
<li><code>type</code> 属性，设置 Cache 使用方案为 Ehcache 。</li>
</ul>
</li>
<li><code>mybatis-plus</code> 配置项下，设置 MyBatis-Plus 相关的配置。</li>
<li><code>logging</code> 配置项，设置打印 SQL 日志，方便查看是否读取了 DB 。</li>
</ul>
<h3 id="4-3-Ehcache-配置文件"><a href="#4-3-Ehcache-配置文件" class="headerlink" title="4.3 Ehcache 配置文件"></a>4.3 Ehcache 配置文件</h3><p>在 <a href="https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-21/lab-21-cache-ehcache/src/main/resources" target="_blank" rel="noopener"><code>resources</code></a> 目录下，创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-21/lab-21-cache-ehcache/src/main/resources/ehcache.xml" target="_blank" rel="noopener"><code>ehcache.xml</code></a> 配置文件。配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"http://ehcache.org/ehcache.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- users 缓存 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- name：缓存名 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- maxElementsInMemory：最大缓存 key 数量 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- timeToLiveSeconds：缓存过期时长，单位：秒 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- memoryStoreEvictionPolicy：缓存淘汰策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"users"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">maxElementsInMemory</span>=<span class="string">"1000"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">timeToLiveSeconds</span>=<span class="string">"60"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">memoryStoreEvictionPolicy</span>=<span class="string">"LRU"</span>/&gt;</span>  <span class="comment">&lt;!-- 缓存淘汰策略 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Application.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = <span class="string">"cn.iocoder.springboot.lab21.cache.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 <code>@EnableCaching</code> 注解，开启 Spring Cache 功能。</li>
<li>配置 <code>@MapperScan</code> 注解，扫描对应 Mapper 接口所在的包路径。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserMapper.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@CacheConfig</span>(cacheNames = <span class="string">"users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">UserDO</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable</span>(key = <span class="string">"#id"</span>)</span><br><span class="line">    <span class="function">UserDO <span class="title">selectById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CachePut</span>(key = <span class="string">"#user.id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> UserDO <span class="title">insert0</span><span class="params">(UserDO user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 插入记录</span></span><br><span class="line">        <span class="keyword">this</span>.insert(user);</span><br><span class="line">        <span class="comment">// 返回用户</span></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict</span>(key = <span class="string">"#id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，我们添加了 <code>@CacheConfig(cacheNames = &quot;users&quot;)</code> 注解，统一配置该 UserMapper 使用的缓存名为 <code>users</code> 。</li>
<li><code>#selectById(Integer id)</code> 方法，添加了 <code>@Cacheable(key = &quot;#id&quot;)</code> 注解，优先读缓存。</li>
<li><code>#insert0(UserDO user)</code> 方法，添加了 <code>@CachePut(key = &quot;#user.id&quot;)</code> 注解，主动写缓存。</li>
<li><code>#deleteById(Integer id)</code> 方法，添加了 <code>@CacheEvict(key = &quot;#id&quot;)</code> 注解，删除缓存。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/08/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E7%BC%93%E5%AD%98Cache%E5%85%A5%E9%97%A8/" data-id="ckbg9kud2001o2r07a9zm6otm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cache/" rel="tag">Cache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">Spring Boot-基础-01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/" rel="tag">数据访问</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据访问-SpringBoot-Redis入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/03/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-Redis%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-03T07:43:58.000Z" itemprop="datePublished">2020-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/03/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-Redis%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-Redis入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-Redis-入门"><a href="#Spring-Boot-Redis-入门" class="headerlink" title="Spring Boot Redis 入门"></a>Spring Boot Redis 入门</h1><h2 id="1-快速入门"><a href="#1-快速入门" class="headerlink" title="1. 快速入门"></a>1. 快速入门</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 实现对 Spring Data Redis 的自动化配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 去掉对 Lettuce 的依赖，因为 Spring Boot 优先使用 Lettuce 作为 Redis 客户端 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 引入 Jedis 的依赖，这样 Spring Boot 实现对 Jedis 的自动化配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 方便等会写单元测试 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 等会示例会使用 fastjson 作为 JSON 序列化的工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.61<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Data Redis 默认使用 Jackson 作为 JSON 序列化的工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 对应 RedisProperties 类</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="comment"># Redis 服务器密码，默认为空。生产中，一定要设置 Redis 密码！</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># Redis 数据库号，默认为 0 。</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span> <span class="comment"># Redis 连接超时时间，单位：毫秒。</span></span><br><span class="line">    <span class="comment"># 对应 RedisProperties.Jedis 内部类</span></span><br><span class="line">    <span class="attr">jedis:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># 连接池最大连接数，默认为 8 。使用负数表示没有限制。</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment"># 默认连接数最小空闲的连接数，默认为 8 。使用负数表示没有限制。</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 默认连接池最小空闲的连接数，默认为 0 。允许设置 0 和 正数。</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="number">-1</span> <span class="comment"># 连接池最大阻塞等待时间，单位：毫秒。默认为 -1 ，表示不限制。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">Test01</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStringSetKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">"yunai"</span>, <span class="string">"shuai"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="1-1-RedisTemplate"><a href="#1-1-RedisTemplate" class="headerlink" title="1.1 RedisTemplate"></a>1.1 RedisTemplate</h3><p><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/RedisTemplate.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.core.RedisTemplate</code></a> 类，从类名上，我们就明明白白知道，提供 Redis 操作模板 API 。核心属性如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisTemplate.java</span></span><br><span class="line"><span class="comment">// 省略了一些不重要的属性。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;1&gt; 序列化相关属性</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>) <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer keySerializer = <span class="keyword">null</span>;</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>) <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer valueSerializer = <span class="keyword">null</span>;</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>) <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer hashKeySerializer = <span class="keyword">null</span>;</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>) <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer hashValueSerializer = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> RedisSerializer&lt;String&gt; stringSerializer = RedisSerializer.string();</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;2&gt; Lua 脚本执行器</span></span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> ScriptExecutor&lt;K&gt; scriptExecutor;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;3&gt; 常见数据结构操作类</span></span><br><span class="line"><span class="comment">// cache singleton objects (where possible)</span></span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> ValueOperations&lt;K, V&gt; valueOps;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> ListOperations&lt;K, V&gt; listOps;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> SetOperations&lt;K, V&gt; setOps;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> ZSetOperations&lt;K, V&gt; zSetOps;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> GeoOperations&lt;K, V&gt; geoOps;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> HyperLogLogOperations&lt;K, V&gt; hllOps;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code> 处，看到了四个序列化相关的属性，用于 KEY 和 VALUE 的序列化。<ul>
<li>例如说，在使用 POJO 对象存储到 Redis 中，一般情况下，会使用 JSON 方式序列化成字符串，存储到 Redis 中。</li>
<li>在上文中，看到了 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/StringRedisTemplate.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.core.StringRedisTemplate</code></a> 类，它继承 RedisTemplate 类，使用 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/StringRedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.StringRedisSerializer</code></a> 字符串序列化方式。</li>
</ul>
</li>
<li><code>&lt;2&gt;</code> 处，Lua 脚本执行器，提供 <a href="http://redis.cn/commands.html#scripting" target="_blank" rel="noopener">Redis scripting</a> API 操作。</li>
<li><code>&lt;3&gt;</code> 处，Redis 常见数据结构操作类。<ul>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/ValueOperations.java" target="_blank" rel="noopener">ValueOperations</a> 类，提供 <a href="http://redis.cn/commands.html#string" target="_blank" rel="noopener">Redis String</a> API 操作。</li>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/ListOperations.java" target="_blank" rel="noopener">ListOperations</a> 类，提供 <a href="http://redis.cn/commands.html#list" target="_blank" rel="noopener">Redis List</a> API 操作。</li>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/SetOperations.java" target="_blank" rel="noopener">SetOperations</a> 类，提供 <a href="http://redis.cn/commands.html#set" target="_blank" rel="noopener">Redis Set</a> API 操作。</li>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/ZSetOperations.java" target="_blank" rel="noopener">ZSetOperations</a> 类，提供 <a href="http://redis.cn/commands.html#sorted_set" target="_blank" rel="noopener">Redis ZSet(Sorted Set)</a> API 操作。</li>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/GeoOperations.java" target="_blank" rel="noopener">GeoOperations</a> 类，提供 <a href="http://redis.cn/commands.html#geo" target="_blank" rel="noopener">Redis Geo</a> API 操作。</li>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/HyperLogLogOperations.java" target="_blank" rel="noopener">HyperLogLogOperations</a> 类，提供 <a href="http://redis.cn/commands.html#hyperloglog" target="_blank" rel="noopener">Redis HyperLogLog</a> API 操作。</li>
</ul>
</li>
</ul>
<h2 id="2-序列化"><a href="#2-序列化" class="headerlink" title="2. 序列化"></a>2. 序列化</h2><h3 id="2-1-RedisSerializer"><a href="#2-1-RedisSerializer" class="headerlink" title="2.1 RedisSerializer"></a>2.1 RedisSerializer</h3><p><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/RedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.RedisSerializer</code></a> 接口，Redis 序列化接口，用于 Redis KEY 和 VALUE 的序列化。简化代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisSerializer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedisSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">byte</span>[] serialize(<span class="meta">@Nullable</span> T t) <span class="keyword">throws</span> SerializationException;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">T <span class="title">deserialize</span><span class="params">(@Nullable <span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> SerializationException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义了对象 <code>&lt;T&gt;</code> 和二进制数组的转换。</li>
</ul>
<h3 id="2-2-JDK-序列化方式"><a href="#2-2-JDK-序列化方式" class="headerlink" title="2.2 JDK 序列化方式"></a>2.2 JDK 序列化方式</h3><p><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/JdkSerializationRedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.JdkSerializationRedisSerializer</code></a> ，默认情况下，RedisTemplate 使用该数据列化方式。具体的，可以看看 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/RedisTemplate.java" target="_blank" rel="noopener"><code>RedisTemplate#afterPropertiesSet()</code></a> 方法，在 RedisTemplate 未设置序列化的情况下，使用 JdkSerializationRedisSerializer 作为序列化实现。在 Spring Boot 自动化配置 RedisTemplate Bean 对象时，就未设置。</p>
<p>不会使用 JdkSerializationRedisSerializer 进行序列化</p>
<h3 id="2-3-String-序列化方式"><a href="#2-3-String-序列化方式" class="headerlink" title="2.3 String 序列化方式"></a>2.3 String 序列化方式</h3><p>① <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/StringRedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.StringRedisSerializer</code></a> ，字符串和二进制数组的<strong>直接</strong>转换。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StringRedisSerializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Charset charset;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">deserialize</span><span class="params">(@Nullable <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (bytes == <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> String(bytes, charset));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(<span class="meta">@Nullable</span> String string) &#123;</span><br><span class="line">	<span class="keyword">return</span> (string == <span class="keyword">null</span> ? <span class="keyword">null</span> : string.getBytes(charset));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>绝大多数情况下， KEY 和 VALUE 都会使用这种序列化方案</strong>。而 VALUE 的序列化和反序列化，自己在逻辑调用 JSON 方法去序列化。</p>
<p>② <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/GenericToStringSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.GenericToStringSerializer</code></a> ，使用 Spring <a href="https://codeday.me/bug/20180111/117294.html" target="_blank" rel="noopener">ConversionService</a> 实现 <code>&lt;T&gt;</code> 对象和 String 的转换，从而 String 和二进制数组的转换。</p>
<p>例如说，序列化的过程，首先 <code>&lt;T&gt;</code> 对象通过 ConversionService 转换成 String ，然后 String 再序列化成二进制数组。</p>
<p>基本不会用</p>
<h3 id="2-4-JSON-序列化"><a href="#2-4-JSON-序列化" class="headerlink" title="2.4 JSON 序列化"></a>2.4 JSON 序列化</h3><p>① <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/GenericJackson2JsonRedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer</code></a> ，使用 Jackson 实现 JSON 的序列化方式，并且从 Generic 单词可以看出，是支持所有类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GenericJackson2JsonRedisSerializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GenericJackson2JsonRedisSerializer</span><span class="params">(@Nullable String classPropertyTypeName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>(<span class="keyword">new</span> ObjectMapper());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// simply setting &#123;@code mapper.disable(SerializationFeature.FAIL_ON_EMPTY_BEANS)&#125; does not help here since we need</span></span><br><span class="line">	<span class="comment">// the type hint embedded for deserialization using the default typing feature.</span></span><br><span class="line">	mapper.registerModule(<span class="keyword">new</span> SimpleModule().addSerializer(<span class="keyword">new</span> NullValueSerializer(classPropertyTypeName)));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &lt;1&gt;</span></span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasText(classPropertyTypeName)) &#123;</span><br><span class="line">		mapper.enableDefaultTypingAsProperty(DefaultTyping.NON_FINAL, classPropertyTypeName);</span><br><span class="line">	<span class="comment">// &lt;2&gt;</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mapper.enableDefaultTyping(DefaultTyping.NON_FINAL, As.PROPERTY);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code> 处，如果传入了 <code>classPropertyTypeName</code> 属性，就是使用使用传入对象的 <code>classPropertyTypeName</code> 属性对应的值，作为默认类型（Default Typing）。</li>
<li><code>&lt;2&gt;</code> 处，如果未传入 <code>classPropertyTypeName</code> 属性，则使用传入对象的类全名，作为默认类型（Default Typing）。</li>
</ul>
<p>Jackson 通过 Default Typing ，会在字符串多冗余一个类型，这样反序列化就知道具体的类型了。</p>
<ul>
<li><p>标准序列化的结果，如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"芋道源码"</span>,</span><br><span class="line">    <span class="attr">"gender"</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 Jackson Default Typing 机制序列化的结果，如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">       <span class="attr">"@class"</span>: <span class="string">"cn.iocoder.springboot.labs.lab10.springdatarediswithjedis.cacheobject.UserCacheObject"</span>,</span><br><span class="line">       <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">       <span class="attr">"name"</span>: <span class="string">"芋道源码"</span>,</span><br><span class="line">       <span class="attr">"gender"</span>: <span class="number">1</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>@class</code> 属性，它看似完美解决了反序列化后的对象类型，但是带来 JSON 字符串占用变大，所以实际项目中，也并不会采用 Jackson2JsonRedisSerializer 类。</p>
</li>
</ul>
<p>② <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/GenericJackson2JsonRedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer</code></a> ，使用 Jackson 实现 JSON 的序列化方式，并且显示指定 <code>&lt;T&gt;</code> 类型。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Jackson2JsonRedisSerializer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jackson2JsonRedisSerializer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">RedisSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ... 省略不重要的代码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset DEFAULT_CHARSET = StandardCharsets.UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定类型，和 &lt;T&gt; 要一致。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JavaType javaType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-配置序列化方式"><a href="#3-配置序列化方式" class="headerlink" title="3. 配置序列化方式"></a>3. 配置序列化方式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 RedisTemplate 对象</span></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        <span class="comment">// 设置 RedisConnection 工厂。它就是实现多种 Java Redis 客户端接入的秘密工厂。</span></span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 String 序列化方式，序列化 KEY 。</span></span><br><span class="line">        template.setKeySerializer(RedisSerializer.string());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 JSON 序列化方式（库是 Jackson ），序列化 VALUE 。</span></span><br><span class="line">        template.setValueSerializer(RedisSerializer.json());</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>RedisSerializer#string()</code> 静态方法，返回的就是使用 UTF-8 编码的 StringRedisSerializer 对象。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisSerializer.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> RedisSerializer&lt;String&gt; <span class="title">string</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> StringRedisSerializer.UTF_8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringRedisSerializer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> StringRedisSerializer ISO_8859_1 = <span class="keyword">new</span> StringRedisSerializer(StandardCharsets.ISO_8859_1);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>RedisSerializer#json()</code> 静态方法，返回 GenericJackson2JsonRedisSerializer 对象。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisSerializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> RedisSerializer&lt;Object&gt; <span class="title">json</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> GenericJackson2JsonRedisSerializer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="4-自定义-RedisSerializer-实现类"><a href="#4-自定义-RedisSerializer-实现类" class="headerlink" title="4. 自定义 RedisSerializer 实现类"></a>4. 自定义 RedisSerializer 实现类</h2><p>源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GenericFastJsonRedisSerializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericFastJsonRedisSerializer</span> <span class="keyword">implements</span> <span class="title">RedisSerializer</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ParserConfig defaultRedisConfig = <span class="keyword">new</span> ParserConfig();</span><br><span class="line">    <span class="keyword">static</span> &#123; defaultRedisConfig.setAutoTypeSupport(<span class="keyword">true</span>);&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object object) <span class="keyword">throws</span> SerializationException &#123;</span><br><span class="line">        <span class="comment">// 空，直接返回空数组</span></span><br><span class="line">        <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 使用 JSON 进行序列化成二进制数组，同时通过 SerializerFeature.WriteClassName 参数，声明写入类全名。</span></span><br><span class="line">            <span class="keyword">return</span> JSON.toJSONBytes(object, SerializerFeature.WriteClassName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">"Could not serialize: "</span> + ex.getMessage(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> SerializationException </span>&#123;</span><br><span class="line">        <span class="comment">// 如果为空，则返回空对象</span></span><br><span class="line">        <span class="keyword">if</span> (bytes == <span class="keyword">null</span> || bytes.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 使用 JSON 解析成对象。</span></span><br><span class="line">            <span class="keyword">return</span> JSON.parseObject(<span class="keyword">new</span> String(bytes, IOUtils.UTF8), Object<span class="class">.<span class="keyword">class</span>, <span class="title">defaultRedisConfig</span>)</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">"Could not deserialize: "</span> + ex.getMessage(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-项目实践"><a href="#5-项目实践" class="headerlink" title="5. 项目实践"></a>5. 项目实践</h2><h3 id="5-1-Cache-Object"><a href="#5-1-Cache-Object" class="headerlink" title="5.1 Cache Object"></a>5.1 Cache Object</h3><p>对于复杂的缓存对象，创建了 <code>cacheobject</code> 包，和 <code>dataobject</code> 包同层。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service # 业务逻辑层</span><br><span class="line">dao # 数据库访问层</span><br><span class="line">dataobject # DO</span><br><span class="line">cacheobject # 缓存对象</span><br></pre></td></tr></table></figure>

<p>并且所有的 Cache Object 对象使用 CacheObject 结尾，例如说 UserCacheObject、ProductCacheObject 。</p>
<h3 id="5-2-数据访问层"><a href="#5-2-数据访问层" class="headerlink" title="5.2 数据访问层"></a>5.2 数据访问层</h3><p>在访问数据库时，会创建 <code>dao</code> 包，存放每个 DO 对应的 Dao 对应。那么对于每一个 CacheObject 类，也会创建一个其对应的 Dao 类。例如说，UserCacheObject 对应 UserCacheObjectDao 类。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserCacheDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PATTERN = <span class="string">"user:%d"</span>; <span class="comment">// user:用户编号 &lt;1&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"SpringJavaInjectionPointsAutowiringInspection"</span>)</span><br><span class="line">    <span class="keyword">private</span> ValueOperations&lt;String, String&gt; operations; <span class="comment">// &lt;2&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">buildKey</span><span class="params">(Integer id)</span> </span>&#123; <span class="comment">// &lt;3&gt;</span></span><br><span class="line">        <span class="keyword">return</span> String.format(KEY_PATTERN, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserCacheObject <span class="title">get</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        String key = buildKey(id);</span><br><span class="line">        String value = operations.get(key);</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.parseObject(value, UserCacheObject<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Integer id, UserCacheObject object)</span> </span>&#123;</span><br><span class="line">        String key = buildKey(id);</span><br><span class="line">        String value = JSONUtil.toJSONString(object);</span><br><span class="line">        operations.set(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code> 处，通过静态变量，声明 KEY 的前缀，并且使用冒号作为间隔</li>
<li><code>&lt;2&gt;</code> 处，通过 <code>@Resource</code> 注入指定名字的 RedisTemplate 对应的 Operations 对象，这样明确每个 KEY 的类型。</li>
<li><code>&lt;3&gt;</code> 处，声明 <code>KEY_PATTERN</code> 对应的 KEY 拼接方法，避免散落在每个方法中。</li>
</ul>
<p>将 <code>dao</code> 包下拆成 <code>mysql</code>、<code>redis</code> 包。这样，MySQL 相关的 Dao 放在 <code>mysql</code> 包下，Redis 相关的 Dao 放在 <code>redis</code> 。</p>
<h2 id="6-示例补充"><a href="#6-示例补充" class="headerlink" title="6.  示例补充"></a>6.  示例补充</h2><h3 id="6-1-Pipleline"><a href="#6-1-Pipleline" class="headerlink" title="6.1 Pipleline"></a>6.1 Pipleline</h3><p>在 RedisTemplate 类中，提供了 2 组四个方法，用于执行 Redis Pipeline 操作。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;1&gt; 基于 Session 执行 Pipeline</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">executePipelined</span><span class="params">(SessionCallback&lt;?&gt; session)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> executePipelined(session, valueSerializer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">executePipelined</span><span class="params">(SessionCallback&lt;?&gt; session, @Nullable RedisSerializer&lt;?&gt; resultSerializer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ... 省略代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;2&gt; 直接执行 Pipeline</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">executePipelined</span><span class="params">(RedisCallback&lt;?&gt; action)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> executePipelined(action, valueSerializer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">executePipelined</span><span class="params">(RedisCallback&lt;?&gt; action, @Nullable RedisSerializer&lt;?&gt; resultSerializer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ... 省略代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>两组方法的差异，在于是否是 Session 中执行。</li>
<li>每组方法里，差别在于是否传入 RedisSerializer 参数。如果不传，则使用 RedisTemplate 自己的序列化相关的属性。</li>
</ul>
<h3 id="6-2-源码解读"><a href="#6-2-源码解读" class="headerlink" title="6.2 源码解读"></a>6.2 源码解读</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisTemplate.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">executePipelined</span><span class="params">(RedisCallback&lt;?&gt; action, @Nullable RedisSerializer&lt;?&gt; resultSerializer)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// &lt;1&gt; 执行 Redis 方法</span></span><br><span class="line">	<span class="keyword">return</span> execute((RedisCallback&lt;List&lt;Object&gt;&gt;) connection -&gt; &#123;</span><br><span class="line">		<span class="comment">// &lt;2&gt; 打开 pipeline</span></span><br><span class="line">		connection.openPipeline();</span><br><span class="line">		<span class="keyword">boolean</span> pipelinedClosed = <span class="keyword">false</span>; <span class="comment">// 标记 pipeline 是否关闭</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// &lt;3&gt; 执行</span></span><br><span class="line">			Object result = action.doInRedis(connection);</span><br><span class="line">			<span class="comment">// &lt;4&gt; 不要返回结果</span></span><br><span class="line">			<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> InvalidDataAccessApiUsageException(</span><br><span class="line">						<span class="string">"Callback cannot return a non-null value as it gets overwritten by the pipeline"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// &lt;5&gt; 提交 pipeline 执行</span></span><br><span class="line">			List&lt;Object&gt; closePipeline = connection.closePipeline();</span><br><span class="line">			pipelinedClosed = <span class="keyword">true</span>;</span><br><span class="line">			<span class="comment">// &lt;6&gt; 反序列化结果，并返回</span></span><br><span class="line">			<span class="keyword">return</span> deserializeMixedResults(closePipeline, resultSerializer, hashKeySerializer, hashValueSerializer);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (!pipelinedClosed) &#123;</span><br><span class="line">				connection.closePipeline();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code> 处，调用 <code>#execute(RedisCallback&lt;T&gt; action)</code> 方法，执行 Redis 方法。注意，此处传入的 <code>action</code> 参数，不是传入的 RedisCallback 参数。传入的会在该 <code>action</code> 中被执行。</li>
<li><code>&lt;2&gt;</code> 处，调用 <code>RedisConnection#openPipeline()</code> 方法，<strong>自动</strong>打开 Pipeline 模式。这样，就不需要手动去打开了。</li>
<li><code>&lt;3&gt;</code> 处，调用传入的实现的 <code>RedisCallback#doInRedis(RedisConnection connection)</code> 方法，执行在 Pipeline 中，想要执行的 Redis 操作。</li>
<li><code>&lt;4&gt;</code> 处，不要返回结果。因为 RedisCallback 是统一定义的接口，所以可以返回一个结果。但是在 Pipeline 中，未提交执行时，显然是没有结果，返回也没有意思。简单来说，就是在实现 <code>RedisCallback#doInRedis(RedisConnection connection)</code> 方法时，返回 <code>null</code> 即可。</li>
<li><code>&lt;5&gt;</code> 处，调用 <code>RedisConnection#closePipeline()</code> 方法，<strong>自动</strong>提交 Pipeline 执行，并返回执行结果。</li>
<li><code>&lt;6&gt;</code> 处，反序列化结果，并返回 Pipeline 结果。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisCallback.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedisCallback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Gets called by &#123;<span class="doctag">@link</span> RedisTemplate&#125; with an active Redis connection. Does not need to care about activating or</span></span><br><span class="line"><span class="comment">	 * closing the connection or handling exceptions.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> connection active Redis connection</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a result object or &#123;<span class="doctag">@code</span> null&#125; if none</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> DataAccessException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">T <span class="title">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>虽然接口名是以 Callback 结尾，但是通过 <code>#doInRedis(RedisConnection connection)</code> 方法可以很容易知道，实际可以理解是 Redis Action ，想要执行的 Redis 操作。</p>
</li>
<li><p>有一点要注意，传入的 <code>connection</code> 参数是 RedisConnection 对象，它提供的 <code>&#39;low level&#39;</code> 更底层的 Redis API 操作。例如说：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisStringCommands.java</span></span><br><span class="line"><span class="comment">// RedisConnection 实现 RedisStringCommands 接口</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span>[] get(<span class="keyword">byte</span>[] key);</span><br><span class="line"></span><br><span class="line"><span class="function">Boolean <span class="title">set</span><span class="params">(<span class="keyword">byte</span>[] key, <span class="keyword">byte</span>[] value)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>传入和返回的是二进制数组，实际就是 RedisTemplate 已经序列化的入参和会被反序列化的出参。</li>
</ul>
</li>
</ul>
<h3 id="6-3-具体示例"><a href="#6-3-具体示例" class="headerlink" title="6.3 具体示例"></a>6.3 具体示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PipelineTest.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">PipelineTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Object&gt; results = stringRedisTemplate.executePipelined(<span class="keyword">new</span> RedisCallback&lt;Object&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">                <span class="comment">// set 写入</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                    connection.set(String.format(<span class="string">"yunai:%d"</span>, i).getBytes(), <span class="string">"shuai"</span>.getBytes());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// get</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                    connection.get(String.format(<span class="string">"yunai:%d"</span>, i).getBytes());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 返回 null 即可</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印结果</span></span><br><span class="line">        System.out.println(results);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>#test01()</code> 方法，结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, shuai, shuai, shuai]</span><br></pre></td></tr></table></figure>



<h2 id="7-Session"><a href="#7-Session" class="headerlink" title="7. Session"></a>7. Session</h2><p>Session 不是 Redis 的功能，而是 Spring Data Redis 封装的一个功能。一次 Session ，代表通过同一个 Redis Connection 执行一系列的 Redis 操作。</p>
<p>当我们要执行在同一个 Session 里的操作时，我们通过实现 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/SessionCallback.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.core.SessionCallback</code></a> 接口，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SessionCallback.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SessionCallback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	&lt;K, V&gt; <span class="function">T <span class="title">execute</span><span class="params">(RedisOperations&lt;K, V&gt; operations)</span> <span class="keyword">throws</span> DataAccessException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>相比 RedisCallback 来说，总比是比较相似的。但是比较友好的是，它的入参 <code>operations</code> 是 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/RedisOperations.java" target="_blank" rel="noopener">org.springframework.data.redis.core.RedisOperations</a> 接口类型，而 RedisTemplate 的各种操作，实际就是在 RedisOperations 接口中定义，由 RedisTemplate 来实现。</li>
<li>实际上，在实现 RedisCallback 接口，也能实现在同一个 Connection 执行一系列的 Redis 操作，因为 RedisCallback 的入参本身就是一个 Redis Connection 。</li>
</ul>
<h3 id="7-1-源码分析"><a href="#7-1-源码分析" class="headerlink" title="7.1 源码分析"></a>7.1 源码分析</h3><p>在生产中，Transaction 和 Pipeline 会经常一起时候用，从而提升性能。所以在 <code>RedisTemplate#executePipelined(SessionCallback&lt;?&gt; session, ...)</code> 方法中，提供了这种的功能。而在这个方法的实现上，本质和 <code>RedisTemplate#executePipelined(RedisCallback&lt;?&gt; action, ...)</code> 方法是基本一致的，差别在于<a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/RedisTemplate.java#L289" target="_blank" rel="noopener">这一行</a> ，替换成了调用 <code>#executeSession(SessionCallback&lt;?&gt; session)</code> 方法。所以，直接来看被调用的这个方法的实现。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisTemplate.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(SessionCallback&lt;T&gt; session)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	Assert.isTrue(initialized, <span class="string">"template not initialized; call afterPropertiesSet() before using it"</span>);</span><br><span class="line">	Assert.notNull(session, <span class="string">"Callback object must not be null"</span>);</span><br><span class="line"></span><br><span class="line">	RedisConnectionFactory factory = getRequiredConnectionFactory();</span><br><span class="line">	<span class="comment">// bind connection</span></span><br><span class="line">	<span class="comment">// &lt;1&gt; 获得并绑定 Connection 。</span></span><br><span class="line">	RedisConnectionUtils.bindConnection(factory, enableTransactionSupport);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	   <span class="comment">// &lt;2&gt; 执行定义的一系列 Redis 操作</span></span><br><span class="line">		<span class="keyword">return</span> session.execute(<span class="keyword">this</span>);</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="comment">// &lt;3&gt; 释放并解绑 Connection 。</span></span><br><span class="line">		RedisConnectionUtils.unbindConnection(factory);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code>处，调用 <code>RedisConnectionUtils#bindConnection(RedisConnectionFactory factory, boolean enableTranactionSupport)</code> 方法，实际和开启 <code>enableTranactionSupport</code> 事务时候，获取 Connection 和处理的方式，是一模一样的。也就是说：<ul>
<li>如果当前线程已经有一个绑定的 Connection 则直接使用（例如说，当前正在 Redis Transaction 事务中）；</li>
<li>如果当前线程未绑定一个 Connection ，则进行创建并绑定到当前线程。甚至，如果此时是配置开启 <code>enableTranactionSupport</code> 事务的，那么此处就会触发 Redis Transaction 的开启。</li>
</ul>
</li>
<li><code>&lt;2&gt;</code> 处，调用 <code>SessionCallback#execute(RedisOperations&lt;K, V&gt; operations)</code> 方法，执行定义的一系列的 Redis 操作。看看此处传入的参数是 <code>this</code> </li>
<li><code>&lt;3&gt;</code> 处，调用 <a href="https://github.com/spring-projects/spring-data-redis/blob/64b89137648f6c0e0c810c624e481bcfc0732f4e/src/main/java/org/springframework/data/redis/core/RedisConnectionUtils.java#L253" target="_blank" rel="noopener"><code>RedisConnectionUtils#unbindConnection(RedisConnectionFactory factory)</code></a> 方法，释放并解绑 Connection 。当前，前提是当前不存在激活的 Redis Transaction ，不然不就提早释放了嘛。</li>
</ul>
<h3 id="7-2-具体示例"><a href="#7-2-具体示例" class="headerlink" title="7.2 具体示例"></a>7.2 具体示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SessionTest.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SessionTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String result = stringRedisTemplate.execute(<span class="keyword">new</span> SessionCallback&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                    operations.opsForValue().set(String.format(<span class="string">"yunai:%d"</span>, i), <span class="string">"shuai02"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> (String) operations.opsForValue().get(String.format(<span class="string">"yunai:%d"</span>, <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"result:"</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>#test01()</code> 方法，结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result:shuai02</span><br></pre></td></tr></table></figure>



<h2 id="8-Pub-Sub"><a href="#8-Pub-Sub" class="headerlink" title="8. Pub/Sub"></a>8. Pub/Sub</h2><p>Redis 提供了 Pub/Sub 功能，实现简单的订阅功能</p>
<h3 id="8-1-具体示例"><a href="#8-1-具体示例" class="headerlink" title="8.1 具体示例"></a>8.1 具体示例</h3><p>Spring Data Redis 实现 Pub/Sub 的示例，主要分成两部分：</p>
<ul>
<li>配置 RedisMessageListenerContainer Bean 对象，并添加自己实现的 MessageListener 对象，用于监听处理相应的消息。</li>
<li>使用 RedisTemplate 发布消息。</li>
</ul>
<p>通过四个<strong>小</strong>步骤，来实现一个简单的示例。</p>
<p><strong>第一步，了解 Topic</strong></p>
<p><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/listener/Topic.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.listener.Topic</code></a> 接口，表示 Redis 消息的 Topic 。它有两个子类实现：</p>
<ul>
<li>ChannelTopic ：对应 <a href="http://redis.cn/commands/subscribe.html" target="_blank" rel="noopener">SUBSCRIBE</a> 订阅命令。</li>
<li>PatternTopic ：对应 <a href="http://redis.cn/commands/psubscribe.html" target="_blank" rel="noopener">PSUBSCRIBE</a> 订阅命令。</li>
</ul>
<p><strong>第二步，实现 MessageListener 类</strong></p>
<p>创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-11/lab-07-spring-data-redis-with-jedis/src/main/java/cn/iocoder/springboot/labs/lab10/springdatarediswithjedis/listener/TestChannelTopicMessageListener.java" target="_blank" rel="noopener">TestChannelTopicMessageListener</a> 类，编写代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPatternTopicMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, <span class="keyword">byte</span>[] pattern)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"收到 PatternTopic 消息："</span>);</span><br><span class="line">        System.out.println(<span class="string">"线程编号："</span> + Thread.currentThread().getName());</span><br><span class="line">        System.out.println(<span class="string">"message："</span> + message);</span><br><span class="line">        System.out.println(<span class="string">"pattern："</span> + <span class="keyword">new</span> String(pattern));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>message</code> 参数，可获得到具体的消息内容，不过是二进制数组，需要自己序列化。具体可以看下 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/connection/DefaultMessage.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.connection.DefaultMessage</code></a> 类。</li>
<li><code>pattern</code> 参数，发布的 Topic 的内容。</li>
</ul>
<p>有一点要注意，默认的 RedisMessageListenerContainer 情况下，MessageListener 是<strong>并发</strong>消费，在线程池中执行(具体见<a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/listener/RedisMessageListenerContainer.java#L982-L988" target="_blank" rel="noopener">传送门</a>代码)。所以如果想相同 MessageListener <strong>串行</strong>消费，可以在方法上加 <code>synchronized</code> 修饰，来实现同步。</p>
<p><strong>第三步，创建 RedisMessageListenerContainer Bean</strong></p>
<p>在 RedisConfiguration 中，配置 RedisMessageListenerContainer Bean 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title">listenerContainer</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建 RedisMessageListenerContainer 对象</span></span><br><span class="line">    RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 RedisConnection 工厂。它就是实现多种 Java Redis 客户端接入的秘密工厂。</span></span><br><span class="line">    container.setConnectionFactory(factory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加监听器</span></span><br><span class="line">    container.addMessageListener(<span class="keyword">new</span> TestChannelTopicMessageListener(), <span class="keyword">new</span> ChannelTopic(<span class="string">"TEST"</span>));</span><br><span class="line"><span class="comment">//        container.addMessageListener(new TestChannelTopicMessageListener(), new ChannelTopic("AOTEMAN"));</span></span><br><span class="line"><span class="comment">//        container.addMessageListener(new TestPatternTopicMessageListener(), new PatternTopic("TEST"));</span></span><br><span class="line">    <span class="keyword">return</span> container;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要注意，虽然 RedisConnectionFactory 可以多次调用 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/listener/RedisMessageListenerContainer.java#L375-L396" target="_blank" rel="noopener"><code>#addMessageListener(MessageListener listener, Topic topic)</code></a> 方法，但是一定要都是相同的 Topic 类型。例如说，添加了 ChannelTopic 类型，就不能添加 PatternTopic 类型。为什么呢？因为 RedisMessageListenerContainer 是基于<strong>一次</strong> <a href="http://redis.cn/commands/subscribe.html" target="_blank" rel="noopener">SUBSCRIBE</a> 或 <a href="http://redis.cn/commands/psubscribe.html" target="_blank" rel="noopener">PSUBSCRIBE</a> 命令，所以不支持<strong>不同类型</strong>的 Topic 。当然，如果是<strong>相同类型</strong>的 Topic ，多个 MessageListener 是支持的。</p>
<p>那么，如果添加了 <code>&quot;Test&quot;</code> 给 MessageListener<strong>A</strong> ，<code>&quot;AOTEMAN&quot;</code> 给 MessageListener<strong>B</strong> ，两个 Topic 是怎么分发（Dispatch）的呢？在 RedisMessageListenerContainer 中，有个 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/listener/RedisMessageListenerContainer.java#L961-L988" target="_blank" rel="noopener">DispatchMessageListener</a> 分发器，负责将不同的 Topic 分发到配置的 MessageListener 中。看到此处，有木有想到 Spring MVC 的 DispatcherServlet 分发不同的请求到对应的 <code>@RequestMapping</code> 方法。</p>
<p><strong>第四步，使用 RedisTemplate 发布消息</strong></p>
<p>创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-11/lab-07-spring-data-redis-with-jedis/src/test/java/cn/iocoder/springboot/labs/lab10/springdatarediswithjedis/PubSubTest.java" target="_blank" rel="noopener">PubSubTest</a> 测试类，编写代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">PubSubTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC = <span class="string">"TEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            stringRedisTemplate.convertAndSend(TOPIC, <span class="string">"yunai:"</span> + i);</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过 <code>RedisTemplate#convertAndSend(String channel, Object message)</code> 方法，PUBLISH 消息。</li>
</ul>
<p>执行 <code>#test01()</code> 方法，运行结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">收到 ChannelTopic 消息：</span><br><span class="line">线程编号：listenerContainer-<span class="number">2</span></span><br><span class="line">message：yunai:<span class="number">0</span></span><br><span class="line">pattern：TEST</span><br><span class="line">收到 ChannelTopic 消息：</span><br><span class="line">线程编号：listenerContainer-<span class="number">3</span></span><br><span class="line">message：yunai:<span class="number">1</span></span><br><span class="line">pattern：TEST</span><br><span class="line">收到 ChannelTopic 消息：</span><br><span class="line">线程编号：listenerContainer-<span class="number">4</span></span><br><span class="line">message：yunai:<span class="number">2</span></span><br><span class="line">pattern：TEST</span><br></pre></td></tr></table></figure>

<ul>
<li>整整齐齐，发送和订阅都成功了。注意，<strong>线程编号</strong>。</li>
</ul>
<h2 id="9-Script"><a href="#9-Script" class="headerlink" title="9. Script"></a>9. Script</h2><p>Redis 提供 Lua 脚本，满足我们希望组合排列使用 Redis 的命令，保证<strong>串行</strong>执行的过程中，不存在并发的问题。同时，通过将多个命令组合在同一个 Lua 脚本中，一次请求，直接处理，也是一个提升性能的手段。</p>
<p><strong>第一步，编写 Lua 脚本</strong></p>
<p>创建 <code>resources/compareAndSet.lua</code> 脚本，实现 CAS 功能。代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.call(<span class="string">'GET'</span>, KEYS[<span class="number">1</span>]) ~= ARGV[<span class="number">1</span>] <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">redis.call(<span class="string">'SET'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第 1 到 3 行：判断 <code>KEYS[1]</code> 对应的 VALUE 是否为 <code>ARGV[1]</code> 值。如果不是（Lua 中不等于使用 <code>~=</code>），则直接返回 0 表示失败。</li>
<li>第 4 到 5 行：设置 <code>KEYS[1]</code> 对应的 VALUE 为新值 <code>ARGV[2]</code> ，并返回 1 表示成功。</li>
</ul>
<p><strong>第二步，调用 Lua 脚本</strong></p>
<p>创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-11/lab-07-spring-data-redis-with-jedis/src/test/java/cn/iocoder/springboot/labs/lab10/springdatarediswithjedis/ScriptTest.java" target="_blank" rel="noopener">ScriptTest</a> 测试类，编写代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ScriptTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// &lt;1.1&gt; 读取 /resources/lua/compareAndSet.lua 脚本 。注意，需要引入下 commons-io 依赖。</span></span><br><span class="line">        String  scriptContents = IOUtils.toString(getClass().getResourceAsStream(<span class="string">"/lua/compareAndSet.lua"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="comment">// &lt;1.2&gt; 创建 RedisScript 对象</span></span><br><span class="line">        RedisScript&lt;Long&gt; script = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;(scriptContents, Long<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">// &lt;2&gt; 执行 LUA 脚本</span></span><br><span class="line">        Long result = stringRedisTemplate.execute(script, Collections.singletonList(<span class="string">"yunai:1"</span>), <span class="string">"shuai02"</span>, <span class="string">"shuai"</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1.1&gt;</code> 行，读取 <code>/resources/lua/compareAndSet.lua</code> 脚本。注意，需要引入下 <code>commons-io</code> 依赖。</li>
<li><code>&lt;1.2&gt;</code> 行，创建 DefaultRedisScript 对象。第一个参数是脚本内容( <code>scriptSource</code> )，第二个是脚本执行返回值( <code>resultType</code> )。</li>
<li><code>&lt;2&gt;</code> 处，调用 <a href="https://github.com/spring-projects/spring-data-redis/blob/64b89137648f6c0e0c810c624e481bcfc0732f4e/src/main/java/org/springframework/data/redis/core/RedisTemplate.java#L342-L360" target="_blank" rel="noopener"><code>RedisTemplate#execute(RedisScript script, List keys, Object... args)</code></a> 方法，发送 Redis 执行 LUA 脚本。</li>
</ul>
<h2 id="10-尝试-Redisson"><a href="#10-尝试-Redisson" class="headerlink" title="10. 尝试 Redisson"></a>10. 尝试 Redisson</h2><p>这是 <strong>Java 最强的 Redis 客户端</strong>！除了提供了 Redis 客户端的常见操作之外，还提供了 Redis 分布式锁、BloomFilter 布隆过滤器等强大的功能。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 实现对 Redisson 的自动化配置 --&gt;</span> <span class="comment">&lt;!-- X --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 方便等会写单元测试 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 等会示例会使用 fastjson 作为 JSON 序列化的工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.61<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Data Redis 默认使用 Jackson 作为 JSON 序列化的工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 对应 RedisProperties 类</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line"><span class="comment">#    password: # Redis 服务器密码，默认为空。生产中，一定要设置 Redis 密码！</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># Redis 数据库号，默认为 0 。</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span> <span class="comment"># Redis 连接超时时间，单位：毫秒。</span></span><br><span class="line">    <span class="comment"># 对应 RedissonProperties 类</span></span><br><span class="line">    <span class="attr">redisson:</span></span><br><span class="line">      <span class="attr">config:</span> <span class="string">classpath:redisson.yml</span> <span class="comment"># 具体的每个配置项，见 org.redisson.config.Config 类。</span></span><br></pre></td></tr></table></figure>

<p><strong>1）去掉 Jedis 相关的配置项</strong></p>
<p><strong>2）增加 <code>redisson.config</code> 配置</strong></p>
<p>如下是 Redisson 的每个配置项的解释：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">clusterServersConfig:</span></span><br><span class="line">  <span class="comment"># 连接空闲超时 如果当前连接池里的连接数量超过了最小空闲连接数，而同时有连接空闲时间超过了该数值，那么这些连接将会自动被关闭，并从连接池里去掉。时间单位是毫秒。</span></span><br><span class="line">  <span class="attr">idleConnectionTimeout:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">pingTimeout:</span> <span class="number">1000</span></span><br><span class="line">  <span class="comment"># 连接超时</span></span><br><span class="line">  <span class="attr">connectTimeout:</span> <span class="number">10000</span></span><br><span class="line">  <span class="comment"># 命令等待超时</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="comment"># 命令失败重试次数</span></span><br><span class="line">  <span class="attr">retryAttempts:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 命令重试发送时间间隔</span></span><br><span class="line">  <span class="attr">retryInterval:</span> <span class="number">1500</span></span><br><span class="line">  <span class="comment"># 重新连接时间间隔</span></span><br><span class="line">  <span class="attr">reconnectionTimeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="comment"># failedAttempts</span></span><br><span class="line">  <span class="attr">failedAttempts:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 密码</span></span><br><span class="line">  <span class="attr">password:</span> <span class="literal">null</span></span><br><span class="line">  <span class="comment"># 单个连接最大订阅数量</span></span><br><span class="line">  <span class="attr">subscriptionsPerConnection:</span> <span class="number">5</span></span><br><span class="line">  <span class="comment"># 客户端名称</span></span><br><span class="line">  <span class="attr">clientName:</span> <span class="literal">null</span></span><br><span class="line">  <span class="comment">#负载均衡算法类的选择  默认轮询调度算法RoundRobinLoadBalancer</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> <span class="string">!&lt;org.redisson.connection.balancer.RoundRobinLoadBalancer&gt;</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">slaveSubscriptionConnectionMinimumIdleSize:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">slaveSubscriptionConnectionPoolSize:</span> <span class="number">50</span></span><br><span class="line">  <span class="comment"># 从节点最小空闲连接数</span></span><br><span class="line">  <span class="attr">slaveConnectionMinimumIdleSize:</span> <span class="number">32</span></span><br><span class="line">  <span class="comment"># 从节点连接池大小</span></span><br><span class="line">  <span class="attr">slaveConnectionPoolSize:</span> <span class="number">64</span></span><br><span class="line">  <span class="comment"># 主节点最小空闲连接数</span></span><br><span class="line">  <span class="attr">masterConnectionMinimumIdleSize:</span> <span class="number">32</span></span><br><span class="line">  <span class="comment"># 主节点连接池大小</span></span><br><span class="line">  <span class="attr">masterConnectionPoolSize:</span> <span class="number">64</span></span><br><span class="line">  <span class="comment"># 只在从服务节点里读取</span></span><br><span class="line">  <span class="attr">readMode:</span> <span class="string">"SLAVE"</span></span><br><span class="line">  <span class="comment"># 主节点信息</span></span><br><span class="line">  <span class="attr">nodeAddresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"redis://192.168.56.128:7000"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"redis://192.168.56.128:7001"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"redis://192.168.56.128:7002"</span></span><br><span class="line">  <span class="comment">#集群扫描间隔时间 单位毫秒</span></span><br><span class="line">  <span class="attr">scanInterval:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">threads:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">nettyThreads:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">codec:</span> <span class="string">!&lt;org.redisson.codec.JsonJacksonCodec&gt;</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意</strong> <strong>注意</strong> <strong>注意</strong></p>
<p>如果 <code>redisson.config</code> 对应的配置文件，如果没有配置任何内容，需要在 <code>application.yml</code> 里注释掉 <code>redisson.config</code> 。像这样：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 对应 RedisProperties 类</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line"><span class="comment">#    password: # Redis 服务器密码，默认为空。生产中，一定要设置 Redis 密码！</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># Redis 数据库号，默认为 0 。</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span> <span class="comment"># Redis 连接超时时间，单位：毫秒。</span></span><br><span class="line">    <span class="comment"># 对应 RedissonProperties 类</span></span><br><span class="line"><span class="comment">#    redisson:</span></span><br><span class="line"><span class="comment">#      config: classpath:redisson.yml # 具体的每个配置项，见 org.redisson.config.Config 类。</span></span><br></pre></td></tr></table></figure>



<h2 id="11-Redis-分布式锁"><a href="#11-Redis-分布式锁" class="headerlink" title="11. Redis 分布式锁"></a>11. Redis 分布式锁</h2><p>编写一个简单使用 Redisson 提供的可重入锁 RLock 的示例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">LockTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOCK_KEY = <span class="string">"anylock"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// &lt;2.1&gt; 启动一个线程 A ，去占有锁</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 加锁以后 10 秒钟自动解锁</span></span><br><span class="line">                <span class="comment">// 无需调用 unlock 方法手动解锁</span></span><br><span class="line">                <span class="keyword">final</span> RLock lock = redissonClient.getLock(LOCK_KEY);</span><br><span class="line">                lock.lock(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="comment">// &lt;2.2&gt; 简单 sleep 1 秒，保证线程 A 成功持有锁</span></span><br><span class="line">        Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &lt;3&gt; 尝试加锁，最多等待 100 秒，上锁以后 10 秒自动解锁</span></span><br><span class="line">        System.out.println(String.format(<span class="string">"准备开始获得锁时间：%s"</span>, <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-DD HH:mm:ss"</span>).format(<span class="keyword">new</span> Date())));</span><br><span class="line">        <span class="keyword">final</span> RLock lock = redissonClient.getLock(LOCK_KEY);</span><br><span class="line">        <span class="keyword">boolean</span> res = lock.tryLock(<span class="number">100</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (res) &#123;</span><br><span class="line">            System.out.println(String.format(<span class="string">"实际获得锁时间：%s"</span>, <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-DD HH:mm:ss"</span>).format(<span class="keyword">new</span> Date())));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"加锁失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>整个测试用例，意图是：1）启动一个线程 A ，先去持有锁 10 秒然后释放；2）主线程，也去尝试去持有锁，因为线程 A 目前正在占用着该锁，所以需要等待线程 A 释放到该锁，才能持有成功。</li>
<li><code>&lt;1&gt;</code> 处，注入 RedissonClient 对象。因为需要使用 Redisson 独有的功能，所以需要使用到它。</li>
<li><code>&lt;2.1&gt;</code> 处，启动线程 A ，然后调用 <code>RLock#lock(long leaseTime, TimeUnit unit)</code> 方法，加锁以后 10 秒钟自动解锁，无需调用 unlock 方法手动解锁。</li>
<li><code>&lt;2.2&gt;</code> 处，简单 sleep 1 秒，保证线程 A 成功持有锁。</li>
<li><code>&lt;3&gt;</code> 处，主线程，调用 <code>RLock#tryLock(long waitTime, long leaseTime, TimeUnit unit)</code> 方法，尝试加锁，最多等待 100 秒，上锁以后 10 秒自动解锁。</li>
</ul>
<p>执行 <code>#test()</code> 测试用例，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">准备开始获得锁时间：2019-10-274 00:44:08</span><br><span class="line">实际获得锁时间：2019-10-274 00:44:17</span><br></pre></td></tr></table></figure>

<ul>
<li>9 秒后（因为 sleep 了 1 秒），主线程成功获得到 Redis 分布式锁，符合预期。</li>
</ul>
<h2 id="12-Redis-限流器"><a href="#12-Redis-限流器" class="headerlink" title="12. Redis 限流器"></a>12. Redis 限流器</h2><p>限流算法，常用的分成四种：</p>
<ul>
<li>计数器：每<strong>固定单位</strong>一个计数器即可实现。</li>
<li>滑动窗口：Redisson 提供的是基于<strong>滑动窗口</strong> RateLimiter 的实现。相比<strong>计数器</strong>的实现，它的起点不是固定的，而是以开始计数的那个时刻开始为一个窗口。所以，可以把<strong>计数器</strong>理解成一个滑动窗口的特例，以<strong>固定单位</strong>为一个窗口。</li>
<li>令牌桶算法</li>
<li>漏桶算法：<ul>
<li>令牌桶算法，桶里装的是令牌。每次能拿取到令牌，就可以进行访问。并且，令牌会按照速率不断恢复放到令牌桶中直到桶满。</li>
<li>漏桶算法，桶里装的是请求。当桶满了，请求就进不来。例如说，Hystrix 使用线程池或者 Semaphore 信号量，只有在请求未满的时候，才可以进行执行。</li>
</ul>
</li>
</ul>
<p><strong>Redisson 提供的是基于滑动窗口 RateLimiter 的实现</strong></p>
<h3 id="12-1-具体示例"><a href="#12-1-具体示例" class="headerlink" title="12. 1 具体示例"></a>12. 1 具体示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RateLimiterTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 RRateLimiter 对象</span></span><br><span class="line">        RRateLimiter rateLimiter = redissonClient.getRateLimiter(<span class="string">"myRateLimiter"</span>);</span><br><span class="line">        <span class="comment">// 初始化：最大流速 = 每 1 秒钟产生 2 个令牌</span></span><br><span class="line">        rateLimiter.trySetRate(RateType.OVERALL, <span class="number">2</span>, <span class="number">1</span>, RateIntervalUnit.SECONDS);</span><br><span class="line"><span class="comment">//        rateLimiter.trySetRate(RateType.PER_CLIENT, 50, 1, RateIntervalUnit.MINUTES);</span></span><br><span class="line"></span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            System.out.println(String.format(<span class="string">"%s：获得锁结果(%s)"</span>, simpleDateFormat.format(<span class="keyword">new</span> Date()),</span><br><span class="line">                    rateLimiter.tryAcquire()));</span><br><span class="line">            Thread.sleep(<span class="number">250L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>#test()</code> 测试用例，结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">40</span>：获得锁结果(<span class="keyword">true</span>)</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">40</span>：获得锁结果(<span class="keyword">true</span>)</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">41</span>：获得锁结果(<span class="keyword">false</span>)</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">41</span>：获得锁结果(<span class="keyword">false</span>)</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">41</span>：获得锁结果(<span class="keyword">true</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>第 1、2 次，成功获取锁。</li>
<li>第 3、4 次，因为每 1 秒产生 2 个令牌，所以被限流了。</li>
<li>第 5 次，已经过了 1 秒，所以获得令牌成功。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/03/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-Redis%E5%85%A5%E9%97%A8/" data-id="ckbg9kud0001l2r073sbe3go3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">Spring Boot-基础-01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/" rel="tag">数据访问</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-快速教程-SpringBoot-WebFlux-快速入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/03/%E5%BF%AB%E9%80%9F%E6%95%99%E7%A8%8B-SpringBoot-WebFlux-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-03T06:29:57.000Z" itemprop="datePublished">2020-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/03/%E5%BF%AB%E9%80%9F%E6%95%99%E7%A8%8B-SpringBoot-WebFlux-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">快速教程-SpringBoot-WebFlux-快速入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="WebFlux-快速入门"><a href="#WebFlux-快速入门" class="headerlink" title="WebFlux 快速入门"></a>WebFlux 快速入门</h1><h2 id="1-Spring-Boot-2-0-WebFlux"><a href="#1-Spring-Boot-2-0-WebFlux" class="headerlink" title="1. Spring Boot 2.0 WebFlux"></a>1. Spring Boot 2.0 WebFlux</h2><p>了解 WebFlux ,首先了解下什么是 Reactive Streams。Reactive Streams 是 JVM 中面向流的库标准和规范：</p>
<ul>
<li>处理可能无限数量的元素</li>
<li>按顺序处理</li>
<li>组件之间异步传递</li>
<li>强制性非阻塞背压（Backpressure）</li>
</ul>
<h3 id="1-1-Backpressure-背压"><a href="#1-1-Backpressure-背压" class="headerlink" title="1.1 Backpressure(背压)"></a>1.1 <strong>Backpressure(背压)</strong></h3><p>背压是一种常用策略，使得发布者拥有无限制的缓冲区存储元素，用于确保发布者发布元素太快时，不会去压制订阅者。</p>
<h3 id="1-2-Reactive-Streams（响应式流）"><a href="#1-2-Reactive-Streams（响应式流）" class="headerlink" title="1.2 Reactive Streams（响应式流）"></a>1.2 <strong>Reactive Streams（响应式流）</strong></h3><p>一般由以下组成：</p>
<ul>
<li>发布者：发布元素到订阅者</li>
<li>订阅者：消费元素</li>
<li>订阅：在发布者中，订阅被创建时，将与订阅者共享</li>
<li>处理器：发布者与订阅者之间处理数据</li>
</ul>
<h3 id="1-3-响应式编程"><a href="#1-3-响应式编程" class="headerlink" title="1.3 响应式编程"></a>1.3 <strong>响应式编程</strong></h3><p>有了 Reactive Streams 这种标准和规范，利用规范可以进行响应式编程。那再了解下什么是 Reactive programming 响应式编程。响应式编程是基于异步和事件驱动的非阻塞程序，只是垂直通过在 JVM 内启动少量线程扩展，而不是水平通过集群扩展。这就是一个编程范例，具体项目中如何体现呢？</p>
<p>响应式项目编程实战中，通过基于 Reactive Streams 规范实现的框架 Reactor 去实战。Reactor 一般提供两种响应式 API ：</p>
<ul>
<li>Mono：实现发布者，并返回 0 或 1 个元素</li>
<li>Flux：实现发布者，并返回 N 个元素</li>
</ul>
<h3 id="1-4-Spring-Webflux"><a href="#1-4-Spring-Webflux" class="headerlink" title="1.4 Spring Webflux"></a>1.4 <strong>Spring Webflux</strong></h3><p>Spring Boot Webflux 就是基于 Reactor 实现的。Spring Boot 2.0 包括一个新的 spring-webflux 模块。该模块包含对响应式 HTTP 和 WebSocket 客户端的支持，以及对 REST，HTML 和 WebSocket 交互等程序的支持。一般来说，Spring MVC 用于同步处理，Spring Webflux 用于异步处理。</p>
<p>Spring Boot Webflux 有两种编程模型实现，一种类似 Spring MVC 注解方式，另一种是使用其功能性端点方式。</p>
<h2 id="2-Spring-Boot-2-0-WebFlux-特性"><a href="#2-Spring-Boot-2-0-WebFlux-特性" class="headerlink" title="2. Spring Boot 2.0 WebFlux 特性"></a>2. Spring Boot 2.0 WebFlux 特性</h2><p>常用的 Spring Boot 2.0 WebFlux 生产的特性如下：</p>
<ul>
<li>响应式 API</li>
<li>编程模型</li>
<li>适用性</li>
<li>内嵌容器</li>
<li>Starter 组件</li>
</ul>
<p>还有对日志、Web、消息、测试及扩展等支持。</p>
<h3 id="2-1-响应式-API"><a href="#2-1-响应式-API" class="headerlink" title="2.1 响应式 API"></a>2.1 响应式 API</h3><p>Reactor 框架是 Spring Boot Webflux 响应库依赖，通过 Reactive Streams 并与其他响应库交互。提供了 两种响应式 API : Mono 和 Flux。一般是将 Publisher 作为输入，在框架内部转换成 Reactor 类型并处理逻辑，然后返回 Flux 或 Mono 作为输出。</p>
<h3 id="2-2-适用性"><a href="#2-2-适用性" class="headerlink" title="2.2 适用性"></a>2.2 适用性</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gff3pfhcatj30mf0cgtf4.jpg" alt="image-20200603144913693"></p>
<p>一图就很明确了，WebFlux 和 MVC 有交集，方便大家迁移。但是注意：</p>
<ul>
<li>MVC 能满足场景的，就不需要更改为 WebFlux。</li>
<li>要注意容器的支持，可以看看下面内嵌容器的支持。</li>
<li>微服务体系结构，WebFlux 和 MVC 可以混合使用。尤其开发 IO 密集型服务的时候，选择 WebFlux 去实现。</li>
</ul>
<h3 id="2-3-编程模型"><a href="#2-3-编程模型" class="headerlink" title="2.3 编程模型"></a>2.3 编程模型</h3><p>Spring 5 web 模块包含了 Spring WebFlux 的 HTTP 抽象。类似 Servlet API , WebFlux 提供了 WebHandler API 去定义非阻塞 API 抽象接口。可以选择以下两种编程模型实现：</p>
<ul>
<li>注解控制层。和 MVC 保持一致，WebFlux 也支持响应性 @RequestBody 注解。</li>
<li>功能性端点。基于 lambda 轻量级编程模型，用来路由和处理请求的小工具。和上面最大的区别就是，这种模型，全程控制了请求 – 响应的生命流程</li>
</ul>
<h3 id="2-4-内嵌容器"><a href="#2-4-内嵌容器" class="headerlink" title="2.4 内嵌容器"></a>2.4 内嵌容器</h3><p>跟 Spring Boot 大框架一样启动应用，但 WebFlux 默认是通过 Netty 启动，并且自动设置了默认端口为 8080。另外还提供了对 Jetty、Undertow 等容器的支持。开发者自行在添加对应的容器 Starter 组件依赖，即可配置并使用对应内嵌容器实例。</p>
<p>但是要注意，必须是 Servlet 3.1+ 容器，如 Tomcat、Jetty；或者非 Servlet 容器，如 Netty 和 Undertow。</p>
<h3 id="2-5-Starter-组件"><a href="#2-5-Starter-组件" class="headerlink" title="2.5 Starter 组件"></a>2.5 Starter 组件</h3><p>跟 Spring Boot 大框架一样，Spring Boot Webflux 提供了很多 “开箱即用” 的 Starter 组件。Starter 组件是可被加载在应用中的 Maven 依赖项。只需要在 Maven 配置中添加对应的依赖配置，即可使用对应的 Starter 组件。例如，添加 <code>spring-boot-starter-webflux</code> 依赖，就可用于构建响应式 API 服务，其包含了 Web Flux 和 Tomcat 内嵌容器等。</p>
<h2 id="3-Spring-Boot-2-0-WebFlux-组件"><a href="#3-Spring-Boot-2-0-WebFlux-组件" class="headerlink" title="3. Spring Boot 2.0 WebFlux 组件"></a>3. Spring Boot 2.0 WebFlux 组件</h2><p>Spring Boot WebFlux 官方提供了很多 Starter 组件，每个模块会有多种技术实现选型支持，来实现各种复杂的业务需求：</p>
<ul>
<li>Web：Spring WebFlux</li>
<li>模板引擎：Thymeleaf</li>
<li>存储：Redis、MongoDB、Cassandra。不支持 MySQL</li>
<li>内嵌容器：Tomcat、Jetty、Undertow</li>
</ul>
<h2 id="4-快速入门"><a href="#4-快速入门" class="headerlink" title="4. 快速入门"></a>4. 快速入门</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>spring-boot-starter-webflux 依赖，是核心需要学习 webflux 的包，里面默认包含了 spring-boot-starter-reactor-netty 、spring 5 webflux 包。也就是说默认是通过 netty 启动的。</p>
<p>reactor-test、spring-boot-starter-test 两个依赖搭配是用于单元测试。</p>
<p>spring-boot-maven-plugin 是 Spring Boot Maven 插件，可以运行、编译等调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.BodyInserters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.ServerRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.ServerResponse;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CityHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">helloCity</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.ok().contentType(MediaType.TEXT_PLAIN)</span><br><span class="line">                .body(BodyInserters.fromObject(<span class="string">"Hello, City!"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServerResponse 是对响应的封装，可以设置响应状态，响应头，响应正文。比如 ok 代表的是 200 响应码、MediaType 枚举是代表这文本内容类型、返回的是 String 的对象。</p>
<p>这里用 Mono 作为返回对象，是因为返回包含了一个 ServerResponse 对象，而不是多个元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.spring.springboot.handler.CityHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.RequestPredicates;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.RouterFunction;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.RouterFunctions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.ServerResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CityRouter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title">routeCity</span><span class="params">(CityHandler cityHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RouterFunctions</span><br><span class="line">                .route(RequestPredicates.GET(<span class="string">"/hello"</span>)</span><br><span class="line">                                .and(RequestPredicates.accept(MediaType.TEXT_PLAIN)),</span><br><span class="line">                        cityHandler::helloCity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/03/%E5%BF%AB%E9%80%9F%E6%95%99%E7%A8%8B-SpringBoot-WebFlux-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" data-id="ckbg9kucu001c2r0746hj9khz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-02/" rel="tag">Spring Boot-基础-02</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebFlux/" rel="tag">WebFlux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Web开发-SprintBoot-Tomcat-Jetty-Undertow-基准测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/03/Web%E5%BC%80%E5%8F%91-SprintBoot-Tomcat-Jetty-Undertow-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2020-06-03T03:38:59.000Z" itemprop="datePublished">2020-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/03/Web%E5%BC%80%E5%8F%91-SprintBoot-Tomcat-Jetty-Undertow-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/">Web开发-SprintBoot-Tomcat-Jetty-Undertow-基准测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="性能测试——-Tomcat、Jetty、Undertow-基准测试"><a href="#性能测试——-Tomcat、Jetty、Undertow-基准测试" class="headerlink" title="性能测试—— Tomcat、Jetty、Undertow 基准测试"></a>性能测试—— Tomcat、Jetty、Undertow 基准测试</h1><h2 id="1-测试环境"><a href="#1-测试环境" class="headerlink" title="1. 测试环境"></a>1. 测试环境</h2><p>JVM 本身有<a href="https://codeday.me/bug/20180203/128666.html" target="_blank" rel="noopener">预热</a>的过程，Tomcat、Jetty、Undertow 本也有预热的过程（例如说，线程的初始化），所以需要多次测试，取平均值。</p>
<p>本文，使用 wrk 如下命令进行测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./wrk -t50 -c400 -d30s http://127.0.0.1:8080</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-t50</code> 参数，设置 50 并发线程。</li>
<li><code>-c400</code> 参数，设置 400 连接。</li>
<li><code>-d30s</code> 参数，设置执行 30s 的时长的 HTTP 请求。</li>
<li><code>http://127.0.0.1:8080</code> 参数，请求本地的 Web 服务。</li>
</ul>
<h2 id="2-Tomcat-NIO"><a href="#2-Tomcat-NIO" class="headerlink" title="2. Tomcat NIO"></a>2. Tomcat NIO</h2><p>Tomcat 一共分成三种模式：</p>
<ul>
<li>BIO (blocking I/O)模式：阻塞式 I/O 操作，表示 Tomcat 使用的是传统的 Java I/O 操作（即 <code>java.io</code> 包）。在 Tomcat 7 以及以前版本，默认使用 BIO 模式运行。一般情况下，BIO 模式是三种运行模式中性能最低的。</li>
<li>NIO (Non-blocking I/O)模式：非阻塞时 I/O 操作，表示 Tomcat 使用的是 JDK 1.4 后新提供的 I/O 操作（即 <code>java.nio</code> 包）。在 Tomcat 8 以及到目前最新版本的 Tomcat 9 ，默认使用的都是 NIO 模式运行。相比 BIO 模式来说，它能提供更好的并发性能。</li>
<li>APR (Apache Portable Runtime/Apache 可移植运行库) 模式：APR 是 <a href="https://httpd.apache.org/" target="_blank" rel="noopener">Apache</a> HTTP 服务器的支持库。可以理解成，Tomcat 将以 <a href="https://zh.wikipedia.org/zh-hans/Java本地接口" target="_blank" rel="noopener">JNI</a> 的方式，调用 Apache HTTP 服务器的核心动态链接库来处理文件或网络传输，从而大大的提升 Tomcat 对静态文件的处理性能。Tomcat APR 模式，也是 Tomcat 上运行高并发应用的首选模式。</li>
</ul>
<p>启动 Tomcat 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar lab-05-tomcat-1.0-SNAPSHOT.jar -Xms2g -Xmx2g -Xmn1g -XX:MaxMetaspaceSize=256m -Xss256k</span><br></pre></td></tr></table></figure>

<p>执行 wrk 进行性能测试，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./wrk -t50 -c400 -d30s http://127.0.0.1:8080/hello</span></span><br><span class="line"></span><br><span class="line">Running 30s test @ http://127.0.0.1:8080/hello</span><br><span class="line">  50 threads and 400 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    13.81ms    7.09ms 159.52ms   86.27%</span><br><span class="line">    Req/Sec   594.55     62.11     1.98k    78.31%</span><br><span class="line">  890078 requests in 30.09s, 100.32MB read</span><br><span class="line">Requests/sec:  29575.99</span><br><span class="line">Transfer/sec:      3.33MB</span><br></pre></td></tr></table></figure>

<ul>
<li>QPS 为 29575.99 。</li>
<li>平均延迟为 13.81ms。</li>
</ul>
<h2 id="3-Tomcat-APR"><a href="#3-Tomcat-APR" class="headerlink" title="3. Tomcat APR"></a>3. Tomcat APR</h2><ol>
<li><p>安装 APR 。</p>
<p><em>Apache Portable Runtime/Apache 可移植运行库</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install apr-devel -f</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 Tomcat Native 。</p>
<p><em>Tomcat 将以 JNI 的方式调用 APR 的实现库</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install tomcat-native</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置 Tomcat 使用 APR 。</p>
</li>
</ol>
<p>启动 Tomcat 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar lab-05-tomcat-1.0-SNAPSHOT.jar -Xms2g -Xmx2g -Xmn1g -XX:MaxMetaspaceSize=256m -Xss256k</span><br></pre></td></tr></table></figure>

<p>执行 wrk 进行性能测试，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./wrk -t50 -c400 -d30s http://127.0.0.1:8080</span></span><br><span class="line"></span><br><span class="line">Running 30s test @ http://127.0.0.1:8080/hello</span><br><span class="line">  50 threads and 400 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    12.15ms    5.12ms 229.46ms   87.59%</span><br><span class="line">    Req/Sec   667.77     62.65     2.01k    80.34%</span><br><span class="line">  999673 requests in 30.10s, 112.67MB read</span><br><span class="line">Requests/sec:  33213.47</span><br><span class="line">Transfer/sec:      3.74MB</span><br></pre></td></tr></table></figure>

<ul>
<li>QPS 为 33213.47 。</li>
<li>平均延迟为 12.15ms。</li>
</ul>
<p>相比 Tomcat NIO 模式，大概有 3500 QPS 左右的提升，12% 左右的性能提升。</p>
<h2 id="4-Jetty"><a href="#4-Jetty" class="headerlink" title="4. Jetty"></a>4. Jetty</h2><p>启动 Jetty 容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar lab-05-jetty-apr-1.0-SNAPSHOT.jar -Xms2g -Xmx2g -Xmn1g -XX:MaxMetaspaceSize=256m -Xss256k</span><br></pre></td></tr></table></figure>

<p>执行 wrk 进行性能测试，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./wrk -t50 -c400 -d30s http://127.0.0.1:8080</span></span><br><span class="line"></span><br><span class="line">Running 30s test @ http://127.0.0.1:8080/hello</span><br><span class="line">  50 threads and 400 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     9.61ms    4.82ms 110.04ms   73.24%</span><br><span class="line">    Req/Sec   849.00    167.82     5.16k    87.43%</span><br><span class="line">  1270290 requests in 30.11s, 145.37MB read</span><br><span class="line">Requests/sec:  42193.37</span><br><span class="line">Transfer/sec:      4.83MB</span><br></pre></td></tr></table></figure>

<ul>
<li>QPS 为 42193.37 。</li>
<li>平均延迟为 9.61ms 毫秒。</li>
</ul>
<p>相比 Tomcat NIO 模式，大概有 12617.38 QPS 提升，43% 左右的性能提升。</p>
<h2 id="5-Undertow"><a href="#5-Undertow" class="headerlink" title="5. Undertow"></a>5. Undertow</h2><p>启动 Undertow 服务器:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar lab-05-undertow-1.0.0.jar -Xms2g -Xmx2g -Xmn1g -XX:MaxMetaspaceSize=256m -Xss256k</span><br></pre></td></tr></table></figure>

<p>执行 wrk 进行性能测试，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./wrk -t50 -c400 -d30s http://127.0.0.1:8080</span></span><br><span class="line"></span><br><span class="line">Running 30s test @ http://127.0.0.1:8080/hello</span><br><span class="line">  50 threads and 400 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    10.09ms    4.36ms 207.32ms   74.34%</span><br><span class="line">    Req/Sec   802.76     99.60     2.16k    73.54%</span><br><span class="line">  1198795 requests in 30.10s, 164.63MB read</span><br><span class="line">Requests/sec:  39822.02</span><br><span class="line">Transfer/sec:      5.47MB</span><br></pre></td></tr></table></figure>

<ul>
<li>QPS 为 39822.02 。</li>
<li>平均延迟为 18.46 毫秒。</li>
</ul>
<p>相比 Tomcat NIO 模式，大概有 10246.03 QPS 提升，34% 左右的性能提升。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/03/Web%E5%BC%80%E5%8F%91-SprintBoot-Tomcat-Jetty-Undertow-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" data-id="ckbg9kucw001f2r07dyeqhsc6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jetty/" rel="tag">Jetty</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Undertow/" rel="tag">Undertow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" rel="tag">基准测试</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Web开发-SpringBoot-WebSocket入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/03/Web%E5%BC%80%E5%8F%91-SpringBoot-WebSocket%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-03T02:21:29.000Z" itemprop="datePublished">2020-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/03/Web%E5%BC%80%E5%8F%91-SpringBoot-WebSocket%E5%85%A5%E9%97%A8/">Web开发-SpringBoot-WebSocket入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-WebSocket-入门"><a href="#Spring-Boot-WebSocket-入门" class="headerlink" title="Spring Boot WebSocket 入门"></a>Spring Boot WebSocket 入门</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>WebSocket 协议<strong>重点</strong>是提供了服务端主动向客户端发送数据的能力，这样就可以完成<strong>实时性</strong>较高的需求。</p>
<p>在实现提供 WebSocket 服务的项目中，一般有如下几种解决方案：</p>
<ul>
<li>方案一 <a href="https://docs.spring.io/spring-framework/docs/5.0.0.BUILD-SNAPSHOT/spring-framework-reference/html/websocket.html" target="_blank" rel="noopener">Spring WebSocket</a></li>
<li>方案二 <a href="https://www.cnblogs.com/xdp-gacl/p/5193279.html" target="_blank" rel="noopener">Tomcat WebSocket</a></li>
<li>方案三 <a href="https://netty.io/news/2012/11/15/websocket-enhancement.html" target="_blank" rel="noopener">Netty WebSocket</a></li>
</ul>
<h2 id="2-Tomcat-WebSocket-快速入门"><a href="#2-Tomcat-WebSocket-快速入门" class="headerlink" title="2. Tomcat WebSocket 快速入门"></a>2. Tomcat WebSocket 快速入门</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 实现对 WebSocket 相关依赖的引入，方便~ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 引入 Fastjson ，实现对 JSON 的序列化，因为后续我们会使用它解析消息 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.62<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>定义 Websocket 服务的端点（EndPoint）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@ServerEndpoint</span>(<span class="string">"/"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketServerEndpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(Session session, EndpointConfig config)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[onOpen][session(&#123;&#125;) 接入]"</span>, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Session session, String message)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[onOpen][session(&#123;&#125;) 接收到一条消息(&#123;&#125;)]"</span>, session, message); <span class="comment">// 生产环境下，请设置成 debug 级别</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(Session session, CloseReason closeReason)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[onClose][session(&#123;&#125;) 连接关闭。关闭原因是(&#123;&#125;)&#125;]"</span>, session, closeReason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Session session, Throwable throwable)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[onClose][session(&#123;&#125;) 发生异常]"</span>, session, throwable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <code>@Controller</code> 注解，保证创建一个 WebsocketServerEndpoint Bean 。</li>
<li>在类上，添加 JSR-356 定义的 <a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/server/src/main/java/javax/websocket/server/ServerEndpoint.java" target="_blank" rel="noopener"><code>@ServerEndpoint</code></a> 注解，标记这是一个 WebSocket EndPoint ，路径为 <code>/</code> 。</li>
<li>WebSocket 一共有四个事件，分别对应使用 JSR-356 定义的 <a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/client/src/main/java/javax/websocket/OnOpen.java" target="_blank" rel="noopener"><code>@OnOpen</code></a>、<a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/client/src/main/java/javax/websocket/OnMessage.java" target="_blank" rel="noopener"><code>@OnMessage</code></a>、<a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/client/src/main/java/javax/websocket/OnClose.java" target="_blank" rel="noopener"><code>@OnClose</code></a>、<a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/client/src/main/java/javax/websocket/OnError.java" target="_blank" rel="noopener"><code>@OnError</code></a> 注解。</li>
</ul>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebSocketConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// @EnableWebSocket // 无需添加该注解，因为我们并不是使用 Spring WebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerEndpointExporter <span class="title">serverEndpointExporter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServerEndpointExporter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 <code>#serverEndpointExporter()</code> 方法中，创建 ServerEndpointExporter Bean 。该 Bean 的作用，是扫描添加有 <code>@ServerEndpoint</code> 注解的 Bean 。</li>
</ul>
<p><strong>消息</strong></p>
<p>在 HTTP 协议中，是基于 Request/Response 请求响应的<strong>同步</strong>模型，进行交互。在 Websocket 协议中，是基于 Message 消息的<strong>异步</strong>模型，进行交互。</p>
<p>因为 WebSocket 协议，不像 HTTP 协议有 URI 可以区分不同的 API 请求操作，所以需要在 WebSocket 的 Message 里，增加能够标识消息类型，这里采用 <code>type</code> 字段。所以在这个示例中，采用的 Message 采用 JSON 格式编码，格式如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    type: "", // 消息类型</span><br><span class="line">    body: &#123;&#125; // 消息体</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>type</code> 字段，消息类型。通过该字段，知道使用哪个 MessageHandler 消息处理器。</li>
<li><code>body</code> 字段，消息体。不同的消息类型，会有不同的消息体。</li>
<li>Message 采用 JSON 格式编码，主要考虑便捷性，实际项目下，也可以考虑 <a href="https://github.com/protocolbuffers/protobuf" target="_blank" rel="noopener">Protobuf</a> 等更加高效且节省流量的编码格式。</li>
</ul>
<p>基础消息体，所有消息体都要实现该接口。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Message.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户认证请求。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AuthRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthRequest</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"AUTH_REQUEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证 Token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>TYPE</code> 静态属性，消息类型为 <code>AUTH_REQUEST</code> 。</li>
<li><code>accessToken</code> 属性，认证 Token 。在 WebSocket 协议中，也需要认证当前连接，用户身份是什么。一般情况下，采用用户调用 HTTP 登陆接口，登陆成功后返回的访问令牌 <code>accessToken</code> 。</li>
</ul>
<p>用户认证响应。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AuthResponse.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthResponse</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"AUTH_RESPONSE"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应状态码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应提示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>TYPE</code> 静态属性，消息类型为 <code>AUTH_REQUEST</code> 。实际上，我们在每个 Message 实现类上，都增加了 <code>TYPE</code> 静态属性，作为消息类型。</li>
<li><code>code</code> 属性，响应状态码。</li>
<li><code>message</code> 属性，响应提示。</li>
</ul>
<p>用户成功认证之后，会广播用户加入群聊的通知 Message 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserJoinNoticeRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserJoinNoticeRequest</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"USER_JOIN_NOTICE_REQUEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 昵称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>优化小想法</strong></p>
<p>实际上，可以在需要使用到 Request/Response 模型的地方，将 Message 进行拓展：</p>
<ul>
<li>Request 抽象类，增加 <code>requestId</code> 字段，表示请求编号。</li>
<li>Response 抽象类，增加 <code>requestId</code> 字段，和每一个 Request 请求映射上。同时，里面统一定义 <code>code</code> 和 <code>message</code> 属性，表示响应状态码和响应提示。</li>
</ul>
<p>这样，在使用到同步模型的业务场景下，Message 实现类使用 Request/Reponse 作为后缀。例如说，用户认证请求、删除一个好友请求等等。</p>
<p>而在使用到异步模型能的业务场景下，Message 实现类还是继续 Message 作为后缀。例如说，发送一条消息，用户操作完后，无需阻塞等待结果</p>
<p>发送给指定人的私聊消息的 Message。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendToOneRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendToOneRequest</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"SEND_TO_ONE_REQUEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送给的用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String toUser;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msgId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>发送给所有人的群聊消息的 Message。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendToAllRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendToAllRequest</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"SEND_TO_ALL_REQUEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msgId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在服务端接收到发送消息的请求，需要<strong>异步</strong>响应发送是否成功。发送消息响应结果的 Message 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendResponse.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendResponse</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"SEND_RESPONSE"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msgId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应状态码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应提示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重点看 <code>msgId</code> 字段，消息编号。客户端在发送消息，通过使用 <a href="https://zh.wikipedia.org/zh-hans/通用唯一识别码" target="_blank" rel="noopener">UUID</a> 算法，生成全局唯一消息编号。这样，服务端通过 SendResponse 消息响应，通过 <code>msgId</code> 做映射。</li>
</ul>
<p>在服务端接收到发送消息的请求，需要转发消息给对应的人。发送消息给一个用户的 Message 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendResponse.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendToUserRequest</span> <span class="keyword">implements</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE = <span class="string">"SEND_TO_USER_REQUEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msgId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>相比 SendToOneRequest 来说，少一个 <code>toUser</code> 字段。因为，可以通过 WebSocket 连接，已经知道发送给谁了。</li>
</ul>
<p><strong>消息处理器</strong></p>
<p>每个客户端发起的 Message 消息类型，会声明对应的 MessageHandler 消息处理器。这个就类似在 SpringMVC 中，每个 API 接口对应一个 Controller 的 Method 方法。</p>
<p>消息处理器接口。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MessageHandler.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageHandler</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Message</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行处理消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session 会话</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Session session, T message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 消息类型，即每个 Message 实现类上的 TYPE 静态字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getType</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义了泛型 <code>&lt;T&gt;</code> ，需要是 Message 的实现类。</li>
</ul>
<p>处理 AuthRequest 消息。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AuthMessageHandler.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthMessageHandler</span> <span class="keyword">implements</span> <span class="title">MessageHandler</span>&lt;<span class="title">AuthRequest</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Session session, AuthRequest message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 如果未传递 accessToken </span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(message.getAccessToken())) &#123;</span><br><span class="line">            WebSocketUtil.send(session, AuthResponse.TYPE,</span><br><span class="line">                    <span class="keyword">new</span> AuthResponse().setCode(<span class="number">1</span>).setMessage(<span class="string">"认证 accessToken 未传入"</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加到 WebSocketUtil 中</span></span><br><span class="line">        WebSocketUtil.addSession(session, message.getAccessToken()); <span class="comment">// 考虑到代码简化，我们先直接使用 accessToken 作为 User</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否认证成功。这里，假装直接成功</span></span><br><span class="line">        WebSocketUtil.send(session, AuthResponse.TYPE, <span class="keyword">new</span> AuthResponse().setCode(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知所有人，某个人加入了。这个是可选逻辑，仅仅是为了演示</span></span><br><span class="line">        WebSocketUtil.broadcast(UserJoinNoticeRequest.TYPE,</span><br><span class="line">                <span class="keyword">new</span> UserJoinNoticeRequest().setNickname(message.getAccessToken())); <span class="comment">// 考虑到代码简化，我们先直接使用 accessToken 作为 User</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AuthRequest.TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>处理 SendToOneRequest 消息。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendToOneRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendToOneHandler</span> <span class="keyword">implements</span> <span class="title">MessageHandler</span>&lt;<span class="title">SendToOneRequest</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Session session, SendToOneRequest message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里，假装直接成功</span></span><br><span class="line">        SendResponse sendResponse = <span class="keyword">new</span> SendResponse().setMsgId(message.getMsgId()).setCode(<span class="number">0</span>);</span><br><span class="line">        WebSocketUtil.send(session, SendResponse.TYPE, sendResponse);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建转发的消息</span></span><br><span class="line">        SendToUserRequest sendToUserRequest = <span class="keyword">new</span> SendToUserRequest().setMsgId(message.getMsgId())</span><br><span class="line">                .setContent(message.getContent());</span><br><span class="line">        <span class="comment">// 广播发送</span></span><br><span class="line">        WebSocketUtil.send(message.getToUser(), SendToUserRequest.TYPE, sendToUserRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SendToOneRequest.TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>处理 SendToAllRequest 消息。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendToAllRequest.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendToAllHandler</span> <span class="keyword">implements</span> <span class="title">MessageHandler</span>&lt;<span class="title">SendToAllRequest</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Session session, SendToAllRequest message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里，假装直接成功</span></span><br><span class="line">        SendResponse sendResponse = <span class="keyword">new</span> SendResponse().setMsgId(message.getMsgId()).setCode(<span class="number">0</span>);</span><br><span class="line">        WebSocketUtil.send(session, SendResponse.TYPE, sendResponse);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建转发的消息</span></span><br><span class="line">        SendToUserRequest sendToUserRequest = <span class="keyword">new</span> SendToUserRequest().setMsgId(message.getMsgId())</span><br><span class="line">                .setContent(message.getContent());</span><br><span class="line">        <span class="comment">// 广播发送</span></span><br><span class="line">        WebSocketUtil.broadcast(SendToUserRequest.TYPE, sendToUserRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SendToAllRequest.TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>WebSocketUtil</code> 工具类，主要提供两方面的功能：</p>
<ul>
<li>Session 会话的管理</li>
<li>多种发送消息的方式</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebSocketUtil.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(WebSocketUtil<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 会话相关 ==========</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Session 与用户的映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Session, String&gt; SESSION_USER_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户与 Session 的映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Session&gt; USER_SESSION_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加 Session 。在这个方法中，会添加用户和 Session 之间的映射</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session Session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addSession</span><span class="params">(Session session, String user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 更新 USER_SESSION_MAP</span></span><br><span class="line">        USER_SESSION_MAP.put(user, session);</span><br><span class="line">        <span class="comment">// 更新 SESSION_USER_MAP</span></span><br><span class="line">        SESSION_USER_MAP.put(session, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除 Session 。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session Session</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeSession</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 从 SESSION_USER_MAP 中移除</span></span><br><span class="line">        String user = SESSION_USER_MAP.remove(session);</span><br><span class="line">        <span class="comment">// 从 USER_SESSION_MAP 中移除</span></span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span> &amp;&amp; user.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            USER_SESSION_MAP.remove(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 消息相关 ==========</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 广播发送消息给所有在线用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 消息类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Message&gt; <span class="function"><span class="keyword">void</span> <span class="title">broadcast</span><span class="params">(String type, T message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建消息</span></span><br><span class="line">        String messageText = buildTextMessage(type, message);</span><br><span class="line">        <span class="comment">// 遍历 SESSION_USER_MAP ，进行逐个发送</span></span><br><span class="line">        <span class="keyword">for</span> (Session session : SESSION_USER_MAP.keySet()) &#123;</span><br><span class="line">            sendTextMessage(session, messageText);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息给单个用户的 Session</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session Session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 消息类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Message&gt; <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(Session session, String type, T message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建消息</span></span><br><span class="line">        String messageText = buildTextMessage(type, message);</span><br><span class="line">        <span class="comment">// 遍历给单个 Session ，进行逐个发送</span></span><br><span class="line">        sendTextMessage(session, messageText);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息给指定用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 指定用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 发送是否成功你那个</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Message&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">send</span><span class="params">(String user, String type, T message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获得用户对应的 Session</span></span><br><span class="line">        Session session = USER_SESSION_MAP.get(user);</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"[send][user(&#123;&#125;) 不存在对应的 session]"</span>, user);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        send(session, type, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建完整的消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T extends Message&gt; <span class="function">String <span class="title">buildTextMessage</span><span class="params">(String type, T message)</span> </span>&#123;</span><br><span class="line">        JSONObject messageObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        messageObject.put(<span class="string">"type"</span>, type);</span><br><span class="line">        messageObject.put(<span class="string">"body"</span>, message);</span><br><span class="line">        <span class="keyword">return</span> messageObject.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 真正发送消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session Session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageText 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendTextMessage</span><span class="params">(Session session, String messageText)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"[sendTextMessage][session 为 null]"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        RemoteEndpoint.Basic basic = session.getBasicRemote();</span><br><span class="line">        <span class="keyword">if</span> (basic == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"[sendTextMessage][session 的  为 null]"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            basic.sendText(messageText);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"[sendTextMessage][session(&#123;&#125;) 发送消息&#123;&#125;) 发生异常"</span>,</span><br><span class="line">                    session, messageText, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>完善 WebsokcetServerEndpoint</strong></p>
<p>实现 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-beans/src/main/java/org/springframework/beans/factory/InitializingBean.java" target="_blank" rel="noopener">InitializingBean</a> 接口，在 <code>#afterPropertiesSet()</code> 方法中，扫描所有 MessageHandler Bean ，添加到 MessageHandler 集合中。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息类型与 MessageHandler 的映射</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意，这里设置成静态变量。虽然说 WebsocketServerEndpoint 是单例，但是 Spring Boot 还是会为每个 WebSocket 创建一个 WebsocketServerEndpoint Bean 。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, MessageHandler&gt; HANDLERS = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 通过 ApplicationContext 获得所有 MessageHandler Bean</span></span><br><span class="line">    applicationContext.getBeansOfType(MessageHandler<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>() // 获得所有 <span class="title">MessageHandler</span> <span class="title">Bean</span></span></span><br><span class="line"><span class="class">            .<span class="title">forEach</span>(<span class="title">messageHandler</span> -&gt; <span class="title">HANDLERS</span>.<span class="title">put</span>(<span class="title">messageHandler</span>.<span class="title">getType</span>(), <span class="title">messageHandler</span>))</span>; <span class="comment">// 添加到 handlers 中</span></span><br><span class="line">    logger.info(<span class="string">"[afterPropertiesSet][消息处理器数量：&#123;&#125;]"</span>, HANDLERS.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>重新实现 <code>#onOpen(Session session, EndpointConfig config)</code> 方法，实现连接时，使用 <code>accessToken</code> 参数进行用户认证。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@OnOpen</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(Session session, EndpointConfig config)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[onOpen][session(&#123;&#125;) 接入]"</span>, session);</span><br><span class="line">    <span class="comment">// &lt;1&gt; 解析 accessToken</span></span><br><span class="line">    List&lt;String&gt; accessTokenValues = session.getRequestParameterMap().get(<span class="string">"accessToken"</span>);</span><br><span class="line">    String accessToken = !CollectionUtils.isEmpty(accessTokenValues) ? accessTokenValues.get(<span class="number">0</span>) : <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// &lt;2&gt; 创建 AuthRequest 消息类型</span></span><br><span class="line">    AuthRequest authRequest = <span class="keyword">new</span> AuthRequest().setAccessToken(accessToken);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 获得消息处理器</span></span><br><span class="line">    MessageHandler&lt;AuthRequest&gt; messageHandler = HANDLERS.get(AuthRequest.TYPE);</span><br><span class="line">    <span class="keyword">if</span> (messageHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        logger.error(<span class="string">"[onOpen][认证消息类型，不存在消息处理器]"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    messageHandler.execute(session, authRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code> 处，解析 <code>ws://</code> 地址上的 <code>accessToken</code> 的请求参。例如说：<code>ws://127.0.0.1:8080?accessToken=QINQIN</code> 。</li>
<li><code>&lt;2&gt;</code> 处，创建 AuthRequest 消息类型，并设置 <code>accessToken</code> 属性。</li>
<li><code>&lt;3&gt;</code> 处，获得 AuthRequest 消息类型对应的 MessageHandler 消息处理器，然后调用 <code>MessageHandler#execute(session, message)</code> 方法，执行处理用户认证请求。</li>
</ul>
<p>重新实现 <code>#onMessage(Session session, String message)</code> 方法，实现不同的消息，转发给不同的 MessageHandler 消息处理器。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Session session, String message)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[onOpen][session(&#123;&#125;) 接收到一条消息(&#123;&#125;)]"</span>, session, message); <span class="comment">// 生产环境下，请设置成 debug 级别</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// &lt;1&gt; 获得消息类型</span></span><br><span class="line">        JSONObject jsonMessage = JSON.parseObject(message);</span><br><span class="line">        String messageType = jsonMessage.getString(<span class="string">"type"</span>);</span><br><span class="line">        <span class="comment">// &lt;2&gt; 获得消息处理器</span></span><br><span class="line">        MessageHandler messageHandler = HANDLERS.get(messageType);</span><br><span class="line">        <span class="keyword">if</span> (messageHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">"[onMessage][消息类型(&#123;&#125;) 不存在消息处理器]"</span>, messageType);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &lt;3&gt; 解析消息</span></span><br><span class="line">        Class&lt;? extends Message&gt; messageClass = <span class="keyword">this</span>.getMessageClass(messageHandler);</span><br><span class="line">        <span class="comment">// &lt;4&gt; 处理消息</span></span><br><span class="line">        Message messageObj = JSON.parseObject(jsonMessage.getString(<span class="string">"body"</span>), messageClass);</span><br><span class="line">        messageHandler.execute(session, messageObj);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        logger.info(<span class="string">"[onMessage][session(&#123;&#125;) message(&#123;&#125;) 发生异常]"</span>, session, throwable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>&lt;1&gt;</code> 处，获得消息类型，从 <code>&quot;type&quot;</code> 字段中。</p>
</li>
<li><p><code>&lt;2&gt;</code> 处，获得消息类型对应的 MessageHandler 消息处理器。</p>
</li>
<li><p><code>&lt;3&gt;</code> 处，调用 <code>#getMessageClass(MessageHandler handler)</code> 方法，通过 MessageHandler 中，通过解析其类上的泛型，获得消息类型对应的 Class 类。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Class&lt;? extends Message&gt; getMessageClass(MessageHandler handler) &#123;</span><br><span class="line">    <span class="comment">// 获得 Bean 对应的 Class 类名。因为有可能被 AOP 代理过。</span></span><br><span class="line">    Class&lt;?&gt; targetClass = AopProxyUtils.ultimateTargetClass(handler);</span><br><span class="line">    <span class="comment">// 获得接口的 Type 数组</span></span><br><span class="line">    Type[] interfaces = targetClass.getGenericInterfaces();</span><br><span class="line">    Class&lt;?&gt; superclass = targetClass.getSuperclass();</span><br><span class="line">    <span class="keyword">while</span> ((Objects.isNull(interfaces) || <span class="number">0</span> == interfaces.length) &amp;&amp; Objects.nonNull(superclass)) &#123; <span class="comment">// 此处，是以父类的接口为准</span></span><br><span class="line">        interfaces = superclass.getGenericInterfaces();</span><br><span class="line">        superclass = targetClass.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(interfaces)) &#123;</span><br><span class="line">        <span class="comment">// 遍历 interfaces 数组</span></span><br><span class="line">        <span class="keyword">for</span> (Type type : interfaces) &#123;</span><br><span class="line">            <span class="comment">// 要求 type 是泛型参数</span></span><br><span class="line">            <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                ParameterizedType parameterizedType = (ParameterizedType) type;</span><br><span class="line">                <span class="comment">// 要求是 MessageHandler 接口</span></span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(parameterizedType.getRawType(), MessageHandler<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                    Type[] actualTypeArguments = parameterizedType.getActualTypeArguments();</span><br><span class="line">                    <span class="comment">// 取首个元素</span></span><br><span class="line">                    <span class="keyword">if</span> (Objects.nonNull(actualTypeArguments) &amp;&amp; actualTypeArguments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> (Class&lt;Message&gt;) actualTypeArguments[<span class="number">0</span>];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"类型(%s) 获得不到消息类型"</span>, handler));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"类型(%s) 获得不到消息类型"</span>, handler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这是参考 <a href="https://github.com/apache/rocketmq-spring/" target="_blank" rel="noopener"><code>rocketmq-spring</code></a> 项目的 <a href="https://github.com/apache/rocketmq-spring/blob/8b2426ea89d704d61c00497a1320b9b9ccd5a61e/rocketmq-spring-boot/src/main/java/org/apache/rocketmq/spring/support/DefaultRocketMQListenerContainer.java#L408-L435" target="_blank" rel="noopener"><code>DefaultRocketMQListenerContainer#getMessageType()</code></a> 方法，进行略微修改。</li>
</ul>
</li>
<li><p><code>&lt;4&gt;</code> 处，调用 <code>MessageHandler#execute(session, message)</code> 方法，执行处理请求。</p>
</li>
<li><p>另外，这里增加了 <code>try-catch</code> 代码，避免整个执行的过程中，发生异常。如果在 onMessage 事件的处理中，发生异常，该消息对应的 Session 会话会被<strong>自动</strong>关闭。显然，这个不符合要求。例如说，在 MessageHandler 处理消息的过程中，发生一些异常是无法避免的。</p>
</li>
</ul>
<p>重新实现 <code>#onClose(Session session, CloseReason closeReason)</code> 方法，实现移除关闭的 Session 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(Session session, CloseReason closeReason)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[onClose][session(&#123;&#125;) 连接关闭。关闭原因是(&#123;&#125;)&#125;]"</span>, session, closeReason);</span><br><span class="line">    WebSocketUtil.removeSession(session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>#onError(Session session, Throwable throwable)</code> 方法，保持不变。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebsocketServerEndpoint.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@OnError</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Session session, Throwable throwable)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[onClose][session(&#123;&#125;) 发生异常]"</span>, session, throwable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-Spring-WebSocket-快速入门"><a href="#3-Spring-WebSocket-快速入门" class="headerlink" title="3. Spring WebSocket 快速入门"></a>3. Spring WebSocket 快速入门</h2><p>因为 Tomcat WebSocket 使用的是 <a href="https://github.com/eclipse-ee4j/websocket-api/blob/master/api/client/src/main/java/javax/websocket/Session.java" target="_blank" rel="noopener">Session</a> 作为会话，而 Spring WebSocket 使用的是 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-websocket/src/main/java/org/springframework/web/socket/WebSocketSession.java" target="_blank" rel="noopener">WebSocketSession</a> 作为会话，导致需要<strong>略微</strong>修改下 WebSocketUtil 工具类。改动非常略微，点击 <code>WebSocketUtil</code>查看下。 主要有两点：</p>
<ul>
<li>将所有使用 Session 类的地方，调整成 WebSocketSession 类。</li>
<li>将发送消息，从 Session 修改成 WebSocketSession 。</li>
</ul>
<p>创建 <code>DemoWebSocketShakeInterceptor</code> 拦截器。因为 WebSocketSession 无法获得 ws 地址上的请求参数，所以只好通过该拦截器，获得 <code>accessToken</code> 请求参数，设置到 <code>attributes</code> 中。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DemoWebSocketShakeInterceptor.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoWebSocketShakeInterceptor</span> <span class="keyword">extends</span> <span class="title">HttpSessionHandshakeInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 拦截 Handshake 事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">beforeHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获得 accessToken</span></span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> ServletServerHttpRequest) &#123;</span><br><span class="line">            ServletServerHttpRequest serverRequest = (ServletServerHttpRequest) request;</span><br><span class="line">            attributes.put(<span class="string">"accessToken"</span>, serverRequest.getServletRequest().getParameter(<span class="string">"accessToken"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用父方法，继续执行逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.beforeHandshake(request, response, wsHandler, attributes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DemoWebSocketHandler.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoWebSocketHandler</span> <span class="keyword">extends</span> <span class="title">TextWebSocketHandler</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息类型与 MessageHandler 的映射</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 无需设置成静态变量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MessageHandler&gt; HANDLERS = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 对应 open 事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[afterConnectionEstablished][session(&#123;&#125;) 接入]"</span>, session);</span><br><span class="line">        <span class="comment">// 解析 accessToken</span></span><br><span class="line">        String accessToken = (String) session.getAttributes().get(<span class="string">"accessToken"</span>);</span><br><span class="line">        <span class="comment">// 创建 AuthRequest 消息类型</span></span><br><span class="line">        AuthRequest authRequest = <span class="keyword">new</span> AuthRequest().setAccessToken(accessToken);</span><br><span class="line">        <span class="comment">// 获得消息处理器</span></span><br><span class="line">        MessageHandler&lt;AuthRequest&gt; messageHandler = HANDLERS.get(AuthRequest.TYPE);</span><br><span class="line">        <span class="keyword">if</span> (messageHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">"[onOpen][认证消息类型，不存在消息处理器]"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        messageHandler.execute(session, authRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 对应 message 事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage textMessage)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[handleMessage][session(&#123;&#125;) 接收到一条消息(&#123;&#125;)]"</span>, session, textMessage); <span class="comment">// 生产环境下，请设置成 debug 级别</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获得消息类型</span></span><br><span class="line">            JSONObject jsonMessage = JSON.parseObject(textMessage.getPayload());</span><br><span class="line">            String messageType = jsonMessage.getString(<span class="string">"type"</span>);</span><br><span class="line">            <span class="comment">// 获得消息处理器</span></span><br><span class="line">            MessageHandler messageHandler = HANDLERS.get(messageType);</span><br><span class="line">            <span class="keyword">if</span> (messageHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.error(<span class="string">"[onMessage][消息类型(&#123;&#125;) 不存在消息处理器]"</span>, messageType);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析消息</span></span><br><span class="line">            Class&lt;? extends Message&gt; messageClass = <span class="keyword">this</span>.getMessageClass(messageHandler);</span><br><span class="line">            <span class="comment">// 处理消息</span></span><br><span class="line">            Message messageObj = JSON.parseObject(jsonMessage.getString(<span class="string">"body"</span>), messageClass);</span><br><span class="line">            messageHandler.execute(session, messageObj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            logger.info(<span class="string">"[onMessage][session(&#123;&#125;) message(&#123;&#125;) 发生异常]"</span>, session, throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 对应 close 事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[afterConnectionClosed][session(&#123;&#125;) 连接关闭。关闭原因是(&#123;&#125;)&#125;]"</span>, session, status);</span><br><span class="line">        WebSocketUtil.removeSession(session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 对应 error 事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleTransportError</span><span class="params">(WebSocketSession session, Throwable exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[handleTransportError][session(&#123;&#125;) 发生异常]"</span>, session, exception);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 通过 ApplicationContext 获得所有 MessageHandler Bean</span></span><br><span class="line">        applicationContext.getBeansOfType(MessageHandler<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>() // 获得所有 <span class="title">MessageHandler</span> <span class="title">Bean</span></span></span><br><span class="line"><span class="class">                .<span class="title">forEach</span>(<span class="title">messageHandler</span> -&gt; <span class="title">HANDLERS</span>.<span class="title">put</span>(<span class="title">messageHandler</span>.<span class="title">getType</span>(), <span class="title">messageHandler</span>))</span>; <span class="comment">// 添加到 handlers 中</span></span><br><span class="line">        logger.info(<span class="string">"[afterPropertiesSet][消息处理器数量：&#123;&#125;]"</span>, HANDLERS.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends Message&gt; getMessageClass(MessageHandler handler) &#123;</span><br><span class="line">        <span class="comment">// 获得 Bean 对应的 Class 类名。因为有可能被 AOP 代理过。</span></span><br><span class="line">        Class&lt;?&gt; targetClass = AopProxyUtils.ultimateTargetClass(handler);</span><br><span class="line">        <span class="comment">// 获得接口的 Type 数组</span></span><br><span class="line">        Type[] interfaces = targetClass.getGenericInterfaces();</span><br><span class="line">        Class&lt;?&gt; superclass = targetClass.getSuperclass();</span><br><span class="line">        <span class="keyword">while</span> ((Objects.isNull(interfaces) || <span class="number">0</span> == interfaces.length) &amp;&amp; Objects.nonNull(superclass)) &#123; <span class="comment">// 此处，是以父类的接口为准</span></span><br><span class="line">            interfaces = superclass.getGenericInterfaces();</span><br><span class="line">            superclass = targetClass.getSuperclass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(interfaces)) &#123;</span><br><span class="line">            <span class="comment">// 遍历 interfaces 数组</span></span><br><span class="line">            <span class="keyword">for</span> (Type type : interfaces) &#123;</span><br><span class="line">                <span class="comment">// 要求 type 是泛型参数</span></span><br><span class="line">                <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                    ParameterizedType parameterizedType = (ParameterizedType) type;</span><br><span class="line">                    <span class="comment">// 要求是 MessageHandler 接口</span></span><br><span class="line">                    <span class="keyword">if</span> (Objects.equals(parameterizedType.getRawType(), MessageHandler<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                        Type[] actualTypeArguments = parameterizedType.getActualTypeArguments();</span><br><span class="line">                        <span class="comment">// 取首个元素</span></span><br><span class="line">                        <span class="keyword">if</span> (Objects.nonNull(actualTypeArguments) &amp;&amp; actualTypeArguments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> (Class&lt;Message&gt;) actualTypeArguments[<span class="number">0</span>];</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"类型(%s) 获得不到消息类型"</span>, handler));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"类型(%s) 获得不到消息类型"</span>, handler));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebSocketConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span> <span class="comment">// 开启 Spring WebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfiguration</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addHandler(<span class="keyword">this</span>.webSocketHandler(), <span class="string">"/"</span>) <span class="comment">// 配置处理器</span></span><br><span class="line">                .addInterceptors(<span class="keyword">new</span> DemoWebSocketShakeInterceptor()) <span class="comment">// 配置拦截器</span></span><br><span class="line">                .setAllowedOrigins(<span class="string">"*"</span>); <span class="comment">// 解决跨域问题</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DemoWebSocketHandler <span class="title">webSocketHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DemoWebSocketHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DemoWebSocketShakeInterceptor <span class="title">webSocketShakeInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DemoWebSocketShakeInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <code>@EnableWebSocket</code> 注解，开启 Spring WebSocket 功能。</li>
</ul>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>考虑下边界场景，客户端网络环境较差，特别是在移动端场景下，出现网络<strong>闪断</strong>，可能会出现连接实际已经断开，而服务端以为客户端处于在线的情况。此时，服务端会将消息发给客户端，那么消息实际就发送到“空气”中，产生丢失的情况。要解决这种情况下的问题，需要引入客户端的 ACK 消息机制。目前，主流的有两种做法。</p>
<p>第一种，基于每一条消息编号 ACK 。整体流程如下：</p>
<ul>
<li>无论客户端是否在线，服务端都先把接收到的消息持久化到数据库中。如果客户端此时在线，服务端将<strong>完整消息</strong>推送给客户端。</li>
<li>客户端在接收到消息之后，发送 ACK 消息编号给服务端，告知已经收到该消息。服务端在收到 ACK 消息编号的时候，标记该消息已经发送成功。</li>
<li>服务端定时轮询，在线的客户端，是否有超过 N 秒未 ACK 的消息。如果有，则重新发送消息给对应的客户端。</li>
</ul>
<p>这种方案，因为客户端逐条 ACK 消息编号，所以会导致客户端和服务端交互次数过多。当然，客户端可以异步批量 ACK 多条消息，从而减少次数。</p>
<p>不过因为服务端仍然需要定时轮询，也会导致服务端压力较大。所以，这种方案基本已经不采用了。</p>
<p>第二种，基于滑动窗口 ACK 。整体流程如下：</p>
<ul>
<li>无论客户端是否在线，服务端都先把接收到的消息持久化到数据库中。如果客户端此时在线，服务端将<strong>消息编号</strong>推送给客户端。</li>
<li>客户端在接收到<strong>消息编号</strong>之后，和本地的消息编号进行比对。如果比本地的小，说明该消息已经收到，忽略不处理；如果比本地的大，使用<strong>本地的</strong>消息编号，向服务端拉取<strong>大于</strong>本地的消息编号的消息列表，即增量消息列表。拉取完成后，更新消息列表中最大的消息编号为<strong>新的本地的</strong>消息编号。</li>
<li>服务端在收到客户端拉取增量的消息列表时，将请求的编号记录到数据库中，用于知道客户端此时本地的最新消息编号。</li>
<li>考虑到服务端将<strong>消息编号</strong>推送给客户端，也会存在丢失的情况，所以客户端会每 N 秒定时向服务端拉取<strong>大于</strong>本地的消息编号的消息列表。</li>
</ul>
<p>这种方式，在业务被称为<strong>推拉结合</strong>的方案，在分布式消息队列、配置中心、注册中心实现实时的数据同步，经常被采用。</p>
<p>并且，采用这种方案的情况下，客户端和服务端不一定需要使用<strong>长连接</strong>，也可以使用<strong>长轮询</strong>所替代。客户端发送带有消息版本号的 HTTP 请求到服务端。</p>
<ul>
<li>如果服务端<strong>已有</strong>比客户端新的消息编号，则直接返回增量的消息列表。</li>
<li>如果服务端<strong>没有</strong>比客户端新的消息编号，则 HOLD 住请求，直到有新的消息列表可以返回，或者 HTTP 请求超时。</li>
<li>客户端在收到 HTTP 请求超时时，立即又重新发起带有消息版本号的 HTTP 请求到服务端。如此反复循环，通过消息编号作为<strong>增量标识</strong>，达到实时获取消息的目的。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/03/Web%E5%BC%80%E5%8F%91-SpringBoot-WebSocket%E5%85%A5%E9%97%A8/" data-id="ckbg9kuct001b2r070gu32rac" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebSocket/" rel="tag">WebSocket</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Java基础容器" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/02/Java%E5%9F%BA%E7%A1%80%E5%AE%B9%E5%99%A8/" class="article-date">
  <time datetime="2020-06-02T09:41:19.000Z" itemprop="datePublished">2020-06-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/02/Java%E5%9F%BA%E7%A1%80%E5%AE%B9%E5%99%A8/">Java基础容器</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Java-容器"><a href="#Java-容器" class="headerlink" title="Java 容器"></a>Java 容器</h1><h2 id="1-ArrayList-与-LinkedList-的区别"><a href="#1-ArrayList-与-LinkedList-的区别" class="headerlink" title="1. ArrayList 与 LinkedList 的区别"></a>1. ArrayList 与 LinkedList 的区别</h2><h3 id="1-底层使用的数据结果"><a href="#1-底层使用的数据结果" class="headerlink" title="1. 底层使用的数据结果"></a>1. 底层使用的数据结果</h3><ul>
<li>Arraylist 底层使用的是Object数组，初始化时就会指向的会是一个static修饰的空数组，数组长度一开始为<strong>0</strong>，插入第一个元素时数组长度会初始化为<strong>10</strong>，之后每次数组空间不够进行扩容时都是增加为原来的<strong>1.5倍</strong>。ArrayList的空间浪费主要体现在在list列表的结尾会预留一定的容量空间，而LinkedList的空间花费则体现在它的每一个元素都需要消耗比ArrayList更多的空间（因为要存放直接后继和直接前驱以及数据）</li>
<li>LinkedList 底层使用的是双向链表数据结构，每个节点保存了指向前驱节点和后继结点的指针。初始化时，不执行任何操作，添加第一个元素时，再去构造链表中的节点。</li>
</ul>
<h3 id="2-是否保证线程安全"><a href="#2-是否保证线程安全" class="headerlink" title="2. 是否保证线程安全"></a>2. 是否保证线程安全</h3><p>ArrayList 和 LinkedList 都是不同步的，也就是不保证线程安全。</p>
<p>因为ArrayList的插入元素的方法就是裸奔的，直接将原数组index及后面的元素拷贝到index+1及后面的位置上，然后将index位置设置为插入的值，并发修改时保证不了数据安全性，所以也不允许并发修改，一旦检测到并发修改，会抛出ConcurrentModificationException异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ArrayList的插入元素的方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">        rangeCheckForAdd(index);</span><br><span class="line">        ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">        System.arraycopy(elementData, index, elementData, index + <span class="number">1</span>,</span><br><span class="line">                         size - index);<span class="comment">//将原数组index之后的元素拷贝到原数组index+1后面的位置上</span></span><br><span class="line">        elementData[index] = element;</span><br><span class="line">        size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-插入和删除的复杂度"><a href="#3-插入和删除的复杂度" class="headerlink" title="3. 插入和删除的复杂度"></a>3. 插入和删除的复杂度</h3><ul>
<li>ArrayList 采用数组存储，元素的物理存储地址是连续的，支持以O(1)的时间复杂度对元素快速访问。插入和删除元素后，需要将后面的元素进行移动，所以插入和删除元素的时间复杂度受元素位置的影响。复杂度是 O（n）</li>
<li>LinkedList 采用链表存储，所以不能快速随机访问。所以首尾插入，删除元素时间复杂度不受元素位置的影响，都是近似 O(1)(如果是插入到中间位置还需要考虑寻找插入位置的时间复杂度)。而数组为近似 O(n)。</li>
</ul>
<h3 id="4-继承树"><a href="#4-继承树" class="headerlink" title="4. 继承树"></a>4. 继承树</h3><ul>
<li>ArrayList继承于AbstractList抽象类，实现了List, RandomAccess, Cloneable, java.io.Serializable接口 。</li>
<li>LinkedList继承自AbstractSequentialList 实现List, Deque, Cloneable, java.io.Serializable接口。</li>
</ul>
<p>AbstractSequentialList是AbstractList类的子类，实现了根据下标来访问元素的一些方法，主要是通过listIterator遍历获取特定元素。</p>
<p>List接口代表的是有序结合，与Set相反，List的元素是按照移动的顺序进行排列。</p>
<p>Cloneable接口代表类会重写父类Object的clone()方法，支持对实例对象的clone操作。</p>
<p>java.io.Serializable接口代表类支持序列化。</p>
<p>RandomAccess是一个标示性接口，代表ArrayList支持快速访问，而LinkedList不支持。</p>
<p>Deque接口是双端队列的意思，代表LinkedList支持两端元素插入和移除。</p>
<h3 id="5-使ArralyList、LinkedList-变成线程安全的"><a href="#5-使ArralyList、LinkedList-变成线程安全的" class="headerlink" title="5.  使ArralyList、LinkedList 变成线程安全的"></a>5.  使ArralyList、LinkedList 变成线程安全的</h3><h4 id="1-使用-SynchronizedList"><a href="#1-使用-SynchronizedList" class="headerlink" title="1. 使用 SynchronizedList"></a>1. 使用 SynchronizedList</h4><p>SynchronizedList是一个线程安全的包装类。继承于SynchronizedCollection，SynchronizedCollection实现了Collection接口，SynchronizedList包含一个List对象，对List的访问修改方法进行了一些封装，在封装的方法中会对list使用同步锁加锁，然后再进行存取和修改操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LinkedList&lt;Integer&gt;    linkedList    = <span class="keyword">new</span> LinkedList&lt;Integer&gt;();</span><br><span class="line"><span class="comment">//调用Collections的synchronizedList方法，传入一个linkedList，会返回一个SynchronizedList实例对象</span></span><br><span class="line">List&lt;Integer&gt; synchronizedList =  Collections.synchronizedList(linkedList);</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用Collections的synchronizedList方法，ArrayList，返回一个SynchronizedRandomAccessList实例对象</span></span><br><span class="line">ArrayList&lt;Integer&gt;    arrayList    = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">List&lt;Integer&gt; synchronizedRandomAccessList =  Collections.synchronizedList(linkedList);</span><br></pre></td></tr></table></figure>

<p><code>Collections.synchronizedList()</code>方法会判断传入的对象是否实现了 <code>RandomAccess</code>接口，是的话，会返回一个<code>SynchronizedRandomAccessList</code>对象，<code>SynchronizedRandomAccessList</code>是<code>SynchronizedList</code>的子类，只是会多一个以线程安全的方式获取子数组的方法)。</p>
<p>SynchronizedList类的部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">SynchronizedCollection</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;E&gt; list;<span class="comment">//源list</span></span><br><span class="line">       <span class="keyword">final</span> Object mutex; </span><br><span class="line"></span><br><span class="line">        SynchronizedCollection(Collection&lt;E&gt; c) &#123;</span><br><span class="line">            <span class="keyword">this</span>.c = Objects.requireNonNull(c);</span><br><span class="line">            mutex = <span class="keyword">this</span>;<span class="comment">//mutex就是SynchronizedList实例自己，作为同步锁使用</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">            是父类中的成员变量，在父类中会将list赋值给mutex</span><br><span class="line">                    <span class="keyword">return</span> list.get(index);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> list.set(index, element);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-使用-CopyOnWriteArrayList"><a href="#2-使用-CopyOnWriteArrayList" class="headerlink" title="2. 使用 CopyOnWriteArrayList"></a>2. 使用 CopyOnWriteArrayList</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/02/Java%E5%9F%BA%E7%A1%80%E5%AE%B9%E5%99%A8/" data-id="ckbg9kubk00012r07d2yn82jf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java-%E5%9F%BA%E7%A1%80-01/" rel="tag">Java 基础-01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%B9%E5%99%A8/" rel="tag">容器</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Web开发-SpringBoot参数校验Validation入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/02/Web%E5%BC%80%E5%8F%91-SpringBoot%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8CValidation%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-02T03:02:26.000Z" itemprop="datePublished">2020-06-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/02/Web%E5%BC%80%E5%8F%91-SpringBoot%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8CValidation%E5%85%A5%E9%97%A8/">Web开发-SpringBoot参数校验Validation入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-参数校验-Validation-入门"><a href="#Spring-Boot-参数校验-Validation-入门" class="headerlink" title="Spring Boot 参数校验 Validation 入门"></a>Spring Boot 参数校验 Validation 入门</h1><h2 id="1-Bean-Validation-定义的约束注解"><a href="#1-Bean-Validation-定义的约束注解" class="headerlink" title="1. Bean Validation 定义的约束注解"></a>1. Bean Validation 定义的约束注解</h2><p><a href="https://github.com/eclipse-ee4j/beanvalidation-api/tree/master/src/main/java/javax/validation/constraints" target="_blank" rel="noopener"><code>javax.validation.constraints</code></a> 包下，定义了一系列的约束( constraint )注解。如下</p>
<ul>
<li><p>空和非空检查</p>
<ul>
<li><p><code>@NotBlank</code> ：只能用于字符串不为 <code>null</code> ，并且字符串 <code>#trim()</code> 以后 length 要大于 0 。</p>
</li>
<li><p><code>@NotEmpty</code> ：集合对象的元素不为 0 ，即集合不为空，也可以用于字符串不为 <code>null</code> 。</p>
</li>
<li><p><code>@NotNull</code> ：不能为 <code>null</code> 。</p>
</li>
<li><p><code>@Null</code> ：必须为 <code>null</code> 。</p>
</li>
</ul>
</li>
<li><p>数值检查</p>
<ul>
<li><code>@DecimalMax(value)</code> ：被注释的元素必须是一个数字，其值必须小于等于指定的最大值。</li>
<li><code>@DecimalMin(value)</code> ：被注释的元素必须是一个数字，其值必须大于等于指定的最小值。</li>
<li><code>@Digits(integer, fraction)</code> ：被注释的元素必须是一个数字，其值必须在可接受的范围内。</li>
<li><code>@Positive</code> ：判断正数。</li>
<li><code>@PositiveOrZero</code> ：判断正数或 0 。</li>
<li><code>@Max(value)</code> ：该字段的值只能小于或等于该值。</li>
<li><code>@Min(value)</code> ：该字段的值只能大于或等于该值。</li>
<li><code>@Negative</code> ：判断负数。</li>
<li><code>@NegativeOrZero</code> ：判断负数或 0 。</li>
</ul>
</li>
<li><p>Boolean 值检查</p>
<ul>
<li><code>@AssertFalse</code> ：被注释的元素必须为 <code>true</code> 。</li>
<li><code>@AssertTrue</code> ：被注释的元素必须为 <code>false</code> 。</li>
</ul>
</li>
<li><p>长度检查</p>
<ul>
<li><code>@Size(max, min)</code> ：检查该字段的 <code>size</code> 是否在 <code>min</code> 和 <code>max</code> 之间，可以是字符串、数组、集合、Map 等。</li>
</ul>
</li>
<li><p>日期检查</p>
<ul>
<li><code>@Future</code> ：被注释的元素必须是一个将来的日期。</li>
<li><code>@FutureOrPresent</code> ：判断日期是否是将来或现在日期。</li>
<li><code>@Past</code> ：检查该字段的日期是在过去。</li>
<li><code>@PastOrPresent</code> ：判断日期是否是过去或现在日期。</li>
</ul>
</li>
<li><p>其它检查</p>
<ul>
<li><code>@Email</code> ：被注释的元素必须是电子邮箱地址。</li>
<li><code>@Pattern(value)</code> ：被注释的元素必须符合指定的正则表达式。</li>
</ul>
</li>
</ul>
<h2 id="2-Hibernate-Validator-附加的约束注解"><a href="#2-Hibernate-Validator-附加的约束注解" class="headerlink" title="2. Hibernate Validator 附加的约束注解"></a>2. Hibernate Validator 附加的约束注解</h2><p><a href="https://github.com/hibernate/hibernate-validator/tree/master/engine/src/main/java/org/hibernate/validator/constraints" target="_blank" rel="noopener"><code>org.hibernate.validator.constraints</code></a> 包下，定义了一系列的约束( constraint )注解。如下：</p>
<ul>
<li><code>@Range(min=, max=)</code> ：被注释的元素必须在合适的范围内。</li>
<li><code>@Length(min=, max=)</code> ：被注释的字符串的大小必须在指定的范围内。</li>
<li><code>@URL(protocol=,host=,port=,regexp=,flags=)</code> ：被注释的字符串必须是一个有效的 URL 。</li>
<li><code>@SafeHtml</code> ：判断提交的 HTML 是否安全。例如说，不能包含 javascript 脚本等等。</li>
<li>… 等等，就不一一列举了。</li>
</ul>
<h2 id="3-Valid-和-Validated"><a href="#3-Valid-和-Validated" class="headerlink" title="3. @Valid 和 @Validated"></a>3. @Valid 和 @Validated</h2><p><a href="https://docs.oracle.com/javaee/7/api/javax/validation/Valid.html" target="_blank" rel="noopener"><code>@Valid</code></a> 注解，是 Bean Validation 所定义，可以添加在普通方法、构造方法、方法参数、方法返回、成员变量上，表示它们需要进行约束校验。</p>
<p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/validation/annotation/Validated.java" target="_blank" rel="noopener"><code>@Validated</code></a> 注解，是 Spring Validation 锁定义，可以添加在类、方法参数、普通方法上，表示它们需要进行约束校验。同时，<code>@Validated</code> 有 <code>value</code> 属性，支持分组校验。属性如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Validated.java</span></span><br><span class="line"></span><br><span class="line">Class&lt;?&gt;[] value() <span class="keyword">default</span> &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>① 声明式校验</strong></p>
<p>Spring Validation <strong>仅</strong>对 <code>@Validated</code> 注解，实现声明式校验。</p>
<p><strong>② 分组校验</strong></p>
<p>Bean Validation 提供的 <code>@Valid</code> 注解，因为没有分组校验的属性，所以无法提供分组校验。此时，我们只能使用 <code>@Validated</code> 注解。</p>
<p><strong>③ 嵌套校验</strong></p>
<p>相比来说，<code>@Valid</code> 注解的地方，多了【成员变量】。这就导致，如果有嵌套对象的时候，只能使用 <code>@Valid</code> 注解。例如说：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Valid</span></span><br><span class="line">    <span class="keyword">private</span> UserProfile profile;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserProfile.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserProfile</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果不在 <code>User.profile</code> 属性上，添加 <code>@Valid</code> 注解，就会导致 <code>UserProfile.nickname</code> 属性，不会进行校验。</li>
</ul>
<p><strong>总结</strong></p>
<p>总的来说，绝大多数场景下，使用 <code>@Validated</code> 注解即可。</p>
<p>而在有嵌套校验的场景，使用 <code>@Valid</code> 注解添加到成员属性上。</p>
<h3 id="3-1-示例"><a href="#3-1-示例" class="headerlink" title="3.1. 示例"></a>3.1. 示例</h3><p>在 Spring Boot 体系中，也提供了 <a href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-validation" target="_blank" rel="noopener"><code>spring-boot-starter-validation</code></a> 依赖。在这里，并没有引入。该依赖的目的，重点也是引入 <code>hibernate-validator</code> 依赖，这在 <code>spring-boot-starter-web</code> 已经引入，所以无需重复引入。</p>
<p>创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-22/lab-22-validation-01/src/main/java/cn/iocoder/springboot/lab22/validation/Application.java" target="_blank" rel="noopener"><code>Application.java</code></a> 类，配置 <code>@SpringBootApplication</code> 注解即可。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span>(exposeProxy = <span class="keyword">true</span>) <span class="comment">// http://www.voidcn.com/article/p-zddcuyii-bpt.html</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加 <code>@EnableAspectJAutoProxy</code> 注解，重点是配置 <code>exposeProxy = true</code> ，因为希望 Spring AOP 能将当前代理对象设置到 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-aop/src/main/java/org/springframework/aop/framework/AopContext.java" target="_blank" rel="noopener">AopContext</a> 中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserAddDTO.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAddDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"登陆账号不能为空"</span>)</span><br><span class="line">    <span class="meta">@Length</span>(min = <span class="number">5</span>, max = <span class="number">16</span>, message = <span class="string">"账号长度为 5-16 位"</span>)</span><br><span class="line">    <span class="meta">@Pattern</span>(regexp = <span class="string">"^[A-Za-z0-9]+$"</span>, message = <span class="string">"账号格式为数字以及字母"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"密码不能为空"</span>)</span><br><span class="line">    <span class="meta">@Length</span>(min = <span class="number">4</span>, max = <span class="number">16</span>, message = <span class="string">"密码长度为 4-16 位"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 setting/getting 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> @<span class="title">Min</span><span class="params">(value = <span class="number">1</span>L, message = <span class="string">"编号必须大于 0"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[get][id: &#123;&#125;]"</span>, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(@Valid UserAddDTO addDTO)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[add][addDTO: &#123;&#125;]"</span>, addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <code>@Validated</code> 注解，表示 UserController 是所有接口都需要进行参数校验。</li>
<li>对于 <code>#get(id)</code> 方法，我们在 <code>id</code> 参数上，添加了 <code>@Min</code> 注解，校验 <code>id</code> 必须大于 0 。校验不通过示例如下图：</li>
</ul>
<p>​       <img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfdryzchhbj30p60nimzj.jpg" alt="不通过示例 1"></p>
<ul>
<li>对于 <code>#add(addDTO)</code> 方法，我们在 <code>addDTO</code> 参数上，添加了 <code>@Valid</code> 注解，实现对该参数的校验。校验不通过示例如下图：</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfds47vsmbj30od0x9147.jpg" alt="image-20200602112244798"></p>
<ul>
<li><code>errors</code> 字段，参数错误明细<strong>数组</strong>。每一个数组元素，对应一个参数错误明细。这里，<code>username</code> 违背了长度不满足 <code>[5, 16]</code> 。</li>
</ul>
<p><strong>第一点</strong>，<code>#get(id)</code> 方法上，并没有给 <code>id</code> 添加 <code>@Valid</code> 注解，而 <code>#add(addDTO)</code> 方法上，给 <code>addDTO</code> 添加 <code>@Valid</code> 注解。这个差异，是为什么呢？</p>
<p>​        因为 UserController 使用了 <code>@Validated</code> 注解，那么 Spring Validation 就会使用 AOP 进行切面，进行参数校验。而该切面的拦截器，使用的是 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/validation/beanvalidation/MethodValidationInterceptor.java" target="_blank" rel="noopener">MethodValidationInterceptor</a> 。</p>
<ul>
<li>对于 <code>#get(id)</code> 方法，需要校验的参数 <code>id</code> ，是<strong>平铺</strong>开的，所以无需添加 <code>@Valid</code> 注解。</li>
<li>对于 <code>#add(addDTO)</code> 方法，需要校验的参数 <code>addDTO</code> ，实际相当于<strong>嵌套校验</strong>，要校验的参数的都在 <code>addDTO</code> 里面，所以需要添加 <code>@Valid</code> 注解。</li>
</ul>
<p><strong>第二点</strong>，<code>#get(id)</code> 方法的返回的结果是 <code>status = 500</code> ，而 <code>#add(addDTO)</code> 方法的返回的结果是 <code>status = 400</code> 。</p>
<ul>
<li>对于 <code>#get(id)</code> 方法，在 MethodValidationInterceptor 拦截器中，校验到参数不正确，会抛出 <a href="https://github.com/eclipse-ee4j/beanvalidation-api/blob/master/src/main/java/javax/validation/ConstraintViolationException.java" target="_blank" rel="noopener">ConstraintViolationException</a> 异常。</li>
<li>对于 <code>#add(addDTO)</code> 方法，因为 <code>addDTO</code> 是个 POJO 对象，所以会走 SpringMVC 的 <a href="https://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/validation.html#validation-binder" target="_blank" rel="noopener">DataBinder</a> 机制，它会调用 <code>DataBinder#validate(Object... validationHints)</code> 方法，进行校验。在校验不通过时，会抛出 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/validation/BindException.html" target="_blank" rel="noopener">BindException</a> 。</li>
</ul>
<p>在 SpringMVC 中，默认使用 <a href="https://hyrepo.com/tech/spring-mvc-error-handling/" target="_blank" rel="noopener">DefaultHandlerExceptionResolver</a> 处理异常。</p>
<ul>
<li>对于 BindException 异常，处理成 400 的状态码。</li>
<li>对于 ConstraintViolationException 异常，没有特殊处理，所以处理成 500 的状态码。</li>
</ul>
<p>相比在 Controller 添加参数校验来说，在 Service 进行参数校验，会更加安全可靠。Controller 的参数校验可以不做，<strong>Service 的参数校验一定要做</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserService.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">(@Min(value = <span class="number">1</span>L, message = <span class="string">"编号必须大于 0"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[get][id: &#123;&#125;]"</span>, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(@Valid UserAddDTO addDTO)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"[add][addDTO: &#123;&#125;]"</span>, addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add01</span><span class="params">(UserAddDTO addDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.add(addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add02</span><span class="params">(UserAddDTO addDTO)</span> </span>&#123;</span><br><span class="line">        self().add(addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> UserService <span class="title">self</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (UserService) AopContext.currentProxy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserService.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= Application<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">UserServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        userService.get(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAdd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserAddDTO addDTO = <span class="keyword">new</span> UserAddDTO();</span><br><span class="line">        userService.add(addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAdd01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserAddDTO addDTO = <span class="keyword">new</span> UserAddDTO();</span><br><span class="line">        userService.add01(addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAdd02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserAddDTO addDTO = <span class="keyword">new</span> UserAddDTO();</span><br><span class="line">        userService.add02(addDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>① <code>#testGet()</code> 测试方法</strong></p>
<p>执行，抛出 ConstraintViolationException 异常。日志如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javax.validation.ConstraintViolationException: get.id: 编号必须大于 <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	at org.springframework.validation.beanvalidation.MethodValidationInterceptor.invoke(MethodValidationInterceptor.java:<span class="number">116</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>符合预期</li>
</ul>
<p><strong>② <code>#testAdd()</code> 测试方法</strong></p>
<p>执行，抛出 ConstraintViolationException 异常。日志如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javax.validation.ConstraintViolationException: add.addDTO.username: 登陆账号不能为空, add.addDTO.password: 密码不能为空</span><br><span class="line"></span><br><span class="line">	at org.springframework.validation.beanvalidation.MethodValidationInterceptor.invoke(MethodValidationInterceptor.java:<span class="number">116</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>符合期望。不同于我们在调用 <code>UserController#add(addDTO)</code> 方法，这里被 MethodValidationInterceptor 拦截，进行参数校验，而不是 DataBinder 当中。</li>
</ul>
<p><strong>③ <code>#testAdd01()</code> 测试方法</strong></p>
<p>执行，正常结束。因为进行 <code>this.add(addDTO)</code> 调用时，<code>this</code> 并不是 Spring AOP 代理对象，所以并不会被 MethodValidationInterceptor 所拦截。</p>
<h2 id="5-自定义约束"><a href="#5-自定义约束" class="headerlink" title="5. 自定义约束"></a>5. 自定义约束</h2><p>开发自定义约束一共只要<strong>两步</strong>：1）编写自定义约束的<strong>注解</strong>；2）编写自定义的<strong>校验器 ConstraintValidator</strong> 。</p>
<h3 id="5-1-示例"><a href="#5-1-示例" class="headerlink" title="5.1 示例"></a>5.1 示例</h3><p>创建 IntArrayValuable 接口，用于返回值数组。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IntArrayValuable.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IntArrayValuable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span>[] array();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GenderEnum.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> GenderEnum implements IntArrayValuable &#123;</span><br><span class="line"></span><br><span class="line">    MALE(<span class="number">1</span>, <span class="string">"男"</span>),</span><br><span class="line">    FEMALE(<span class="number">2</span>, <span class="string">"女"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 值数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] ARRAYS = Arrays.stream(values()).mapToInt(GenderEnum::getValue).toArray();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer value;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    GenderEnum(Integer value, String name) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] array() &#123;</span><br><span class="line">        <span class="keyword">return</span> ARRAYS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现 IntArrayValuable 接口，返回值数组 <code>ARRAYS</code> 。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InEnum.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(&#123;METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = InEnumValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">InEnum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实现 IntArrayValuable 接口的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? extends IntArrayValuable&gt; value();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 提示内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "必须在指定范围 </span>&#123;value&#125;<span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * @return 分组</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    Class&lt;?&gt;[] groups() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * @return Payload 数组</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     *  Defines several &#123;@code @InEnum&#125; constraints on the same element.</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    @Target(&#123;METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE&#125;)</span></span><br><span class="line"><span class="string">    @Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="string">    @Documented</span></span><br><span class="line"><span class="string">    @interface List &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        InEnum[] value();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <code>@@Constraint(validatedBy = InEnumValidator.class)</code> 注解，设置使用的<strong>自定义约束的校验器</strong>。</li>
<li><code>value()</code> 属性，设置实现 IntArrayValuable 接口的类。这样，就能获得参数需要校验的值数组。</li>
<li><code>message()</code> 属性，设置提示内容。默认为 <code>&quot;必须在指定范围 {value}&quot;</code> 。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InEnumValidator.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InEnumValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">InEnum</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 值数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Integer&gt; values;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(InEnum annotation)</span> </span>&#123;</span><br><span class="line">        IntArrayValuable[] values = annotation.value().getEnumConstants();</span><br><span class="line">        <span class="keyword">if</span> (values.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.values = Collections.emptySet();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.values = Arrays.stream(values[<span class="number">0</span>].array()).boxed().collect(Collectors.toSet());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Integer value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// &lt;2.1&gt; 校验通过</span></span><br><span class="line">        <span class="keyword">if</span> (values.contains(value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &lt;2.2.1&gt;校验不通过，自定义提示语句（因为，注解上的 value 是枚举类，无法获得枚举类的实际值）</span></span><br><span class="line">        context.disableDefaultConstraintViolation(); <span class="comment">// 禁用默认的 message 的值</span></span><br><span class="line">        context.buildConstraintViolationWithTemplate(context.getDefaultConstraintMessageTemplate()</span><br><span class="line">                .replaceAll(<span class="string">"\\&#123;value&#125;"</span>, values.toString())).addConstraintViolation(); <span class="comment">// 重新添加错误提示语句      </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// &lt;2.2.2.&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现 <a href="https://github.com/beanvalidation/beanvalidation-api/blob/master/src/main/java/javax/validation/ConstraintValidator.java" target="_blank" rel="noopener">ConstraintValidator</a> 接口<ul>
<li>第一个泛型为 <code>A extends Annotation</code> ，设置对应的自定义约束的注解。例如说，这里设置了 <code>@InEnum</code> 注解。</li>
<li>第二个泛型为 <code>T</code> ，设置对应的参数值的类型。例如说，这里设置了 Integer 类型。</li>
</ul>
</li>
<li>实现 <code>#initialize(annotation)</code> 方法，获得 <code>@InEnum</code> 注解的 <code>values()</code> 属性，获得值数组，设置到 <code>values</code> 属性。</li>
<li>实现 <code>#isValid(value, context)</code> 方法，实现校验参数值，是否在 <code>values</code> 范围内。<ul>
<li><code>&lt;2.1&gt;</code> 处，校验参数值在范围内，直接返回 <code>true</code> ，校验通过。</li>
<li><code>&lt;2.2.1&gt;</code> 处，校验不通过，自定义提示语句。</li>
<li><code>&lt;2.2.2&gt;</code> 处，校验不通过，所以返回 <code>false</code> 。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserUpdateGenderDTO.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserUpdateGenderDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull</span>(message = <span class="string">"用户编号不能为空"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull</span>(message = <span class="string">"性别不能为空"</span>)</span><br><span class="line">    <span class="meta">@InEnum</span>(value = GenderEnum<span class="class">.<span class="keyword">class</span>, <span class="title">message</span> </span>= <span class="string">"性别必须是 &#123;value&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 <code>gender</code> 字段上，添加 <code>@InEnum(value = GenderEnum.class, message = &quot;性别必须是 {value}&quot;)</code> 注解，限制传入的参数值，必须在 GenderEnum 枚举范围内。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/update_gender"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateGender</span><span class="params">(@Valid UserUpdateGenderDTO updateGenderDTO)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[updateGender][updateGenderDTO: &#123;&#125;]"</span>, updateGenderDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模拟请求该 API 接口，响应结果如下：<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfdzr3hjekj31560og77b.jpg" alt="响应结果"></p>
<h2 id="6-分组校验"><a href="#6-分组校验" class="headerlink" title="6. 分组校验"></a>6. 分组校验</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserUpdateStatusDTO.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserUpdateStatusDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分组 01 ，要求状态必须为 true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Group01</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态 02 ，要求状态必须为 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Group02</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AssertTrue</span>(message = <span class="string">"状态必须为 true"</span>, groups = Group01<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">AssertFalse</span>(<span class="title">message</span> </span>= <span class="string">"状态必须为 false"</span>, groups = Group02<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">Boolean</span> <span class="title">status</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建了 Group01 和 Group02 接口，作为两个校验分组。不一定要定义在 UserUpdateStatusDTO 类中，这里仅仅是为了方便。</li>
<li><code>status</code> 字段，在 Group01 校验分组时，必须为 <code>true</code> ；在 Group02 校验分组时，必须为 <code>false</code> 。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/update_status_true"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateStatusTrue</span><span class="params">(@Validated(UserUpdateStatusDTO.Group01.class)</span> UserUpdateStatusDTO updateStatusDTO) </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[updateStatusTrue][updateStatusDTO: &#123;&#125;]"</span>, updateStatusDTO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/update_status_false"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateStatusFalse</span><span class="params">(@Validated(UserUpdateStatusDTO.Group02.class)</span> UserUpdateStatusDTO updateStatusDTO) </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"[updateStatusFalse][updateStatusDTO: &#123;&#125;]"</span>, updateStatusDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>对于 <code>#updateStatusTrue(updateStatusDTO)</code> 方法，我们在 <code>updateStatusDTO</code> 参数上，添加了 <code>@Validated</code> 注解，并且设置校验分组为 Group01 。校验不通过示例如下图：<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfe12iny8rj312c0oidiv.jpg" alt="不通过示例 1"></p>
</li>
<li><p>对于 <code>#updateStatusFalse(updateStatusDTO)</code> 方法，我们在 <code>updateStatusDTO</code> 参数上，添加了 <code>@Validated</code> 注解，并且设置校验分组为 Group02 。校验不通过示例如下图：<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfe148ktp3j30vm0oqgod.jpg" alt="不通过示例 2"></p>
</li>
</ul>
<p>所以，使用分组校验，核心在于添加上 <code>@Validated</code> 注解，并设置对应的校验分组。</p>
<h2 id="7-手动校验"><a href="#7-手动校验" class="headerlink" title="7. 手动校验"></a>7. 手动校验</h2><p>增加手动参数校验的示例。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserServiceTest.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span> <span class="comment">// &lt;1.1&gt;</span></span><br><span class="line"><span class="keyword">private</span> Validator validator;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testValidator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 打印，查看 validator 的类型 // &lt;1.2&gt;</span></span><br><span class="line">    System.out.println(validator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 UserAddDTO 对象 // &lt;2&gt;</span></span><br><span class="line">    UserAddDTO addDTO = <span class="keyword">new</span> UserAddDTO();</span><br><span class="line">    <span class="comment">// 校验 // &lt;3&gt;</span></span><br><span class="line">    Set&lt;ConstraintViolation&lt;UserAddDTO&gt;&gt; result = validator.validate(addDTO);</span><br><span class="line">    <span class="comment">// 打印校验结果 // &lt;4&gt;</span></span><br><span class="line">    <span class="keyword">for</span> (ConstraintViolation&lt;UserAddDTO&gt; constraintViolation : result) &#123;</span><br><span class="line">        <span class="comment">// 属性:消息</span></span><br><span class="line">        System.out.println(constraintViolation.getPropertyPath() + <span class="string">":"</span> + constraintViolation.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>&lt;1.1&gt;</code> 处，注入 Validator Bean 对象。</p>
</li>
<li><p><code>&lt;1.2&gt;</code> 处，打印 <code>validator</code> 的类型。输出如下：</p>
<p><code>org.springframework.validation.beanvalidation.LocalValidatorFactoryBean@48c3205a</code></p>
<ul>
<li><code>validator</code> 的类型为 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/validation/beanvalidation/LocalValidatorFactoryBean.java" target="_blank" rel="noopener">LocalValidatorFactoryBean</a> 。LocalValidatorFactoryBean 提供 JSR-303、JSR-349 的支持，同时兼容 Hibernate Validator 。</li>
<li>在 Spring Boot 体系中，使用 <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/validation/ValidationAutoConfiguration.java" target="_blank" rel="noopener">ValidationAutoConfiguration</a> 自动化配置类，默认创建 LocalValidatorFactoryBean 作为 Validator Bean 。</li>
</ul>
</li>
<li><p><code>&lt;2&gt;</code> 处，创建 UserAddDTO 对象。</p>
</li>
<li><p><code>&lt;3&gt;</code> 处，调用 <code>Validator#validate(T object, Class&lt;?&gt;... groups)</code> 方法，进行参数校验。</p>
</li>
<li><p><code>&lt;4&gt;</code> 处，打印校验结果。输出如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username:登陆账号不能为空</span><br><span class="line">password:密码不能为空</span><br></pre></td></tr></table></figure>

<ul>
<li>如果校验通过，则返回的 <code>Set&lt;ConstraintViolation&lt;?&gt;&gt;</code> 集合为空。</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/02/Web%E5%BC%80%E5%8F%91-SpringBoot%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8CValidation%E5%85%A5%E9%97%A8/" data-id="ckbg9kucq00152r07a1zy4w3i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SPring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">SPring Boot-基础-01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Validation/" rel="tag">Validation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Web开发-SpringBootAPI接口文档Swagger入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/01/Web%E5%BC%80%E5%8F%91-SpringBootAPI%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3Swagger%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-01T03:28:52.000Z" itemprop="datePublished">2020-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/01/Web%E5%BC%80%E5%8F%91-SpringBootAPI%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3Swagger%E5%85%A5%E9%97%A8/">Web开发-SpringBootAPI接口文档Swagger入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-API-接口文档-Swagger-入门"><a href="#Spring-Boot-API-接口文档-Swagger-入门" class="headerlink" title="Spring Boot API 接口文档 Swagger 入门"></a>Spring Boot API 接口文档 Swagger 入门</h1><h2 id="1-快速入门-Swagger"><a href="#1-快速入门-Swagger" class="headerlink" title="1. 快速入门 Swagger"></a>1. 快速入门 Swagger</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入 Swagger 依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 引入 Swagger UI 依赖，以实现 API 接口的 UI 界面 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建 SwaggerConfiguration 配置类，用于配置 Swagger 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SwaggerConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2 <span class="comment">// 标记项目启用 Swagger API 接口文档</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 Docket 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2) <span class="comment">// 文档类型，使用 Swagger2</span></span><br><span class="line">                .apiInfo(<span class="keyword">this</span>.apiInfo()) <span class="comment">// 设置 API 信息</span></span><br><span class="line">                <span class="comment">// 扫描 Controller 包路径，获得 API 接口</span></span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"cn.iocoder.springboot.lab24.apidoc.controller"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                <span class="comment">// 构建出 Docket 对象</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 API 信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                .title(<span class="string">"测试接口文档示例"</span>)</span><br><span class="line">                .description(<span class="string">"我是一段描述"</span>)</span><br><span class="line">                .version(<span class="string">"1.0.0"</span>) <span class="comment">// 版本号</span></span><br><span class="line">                .contact(<span class="keyword">new</span> Contact(<span class="string">"芋艿"</span>, <span class="string">"http://www.iocoder.cn"</span>, <span class="string">"zhijiantianya@gmail.com"</span>)) <span class="comment">// 联系人</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，添加 <a href="http://springfox.github.io/springfox/javadoc/2.5.0/index.html?springfox/documentation/swagger2/annotations/EnableSwagger2.html" target="_blank" rel="noopener"><code>@EnableSwagger2</code></a> 注解， 标记项目启用 Swagger API 接口文档。</li>
<li>通过 <code>#createRestApi()</code> 方法，创建 Swagger <a href="https://github.com/springfox/springfox/blob/master/springfox-spring-web/src/main/java/springfox/documentation/spring/web/plugins/Docket.java" target="_blank" rel="noopener">Docket</a> Bean 。其他配置：<ul>
<li><a href="https://github.com/springfox/springfox/blob/master/springfox-spring-web/src/main/java/springfox/documentation/spring/web/plugins/Docket.java" target="_blank" rel="noopener">Docket.java</a></li>
<li><a href="https://github.com/springfox/springfox/blob/master/springfox-core/src/main/java/springfox/documentation/service/ApiInfo.java" target="_blank" rel="noopener">ApiInfo.java</a></li>
</ul>
</li>
</ul>
<p>创建 <code>UserController</code> 类，提供用户 API 接口。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"用户 API 接口"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"查询用户列表"</span>, notes = <span class="string">"目前仅仅是作为测试，所以返回用户全列表"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserVO&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 查询列表</span></span><br><span class="line">        List&lt;UserVO&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">1</span>).setUsername(<span class="string">"yudaoyuanma"</span>));</span><br><span class="line">        result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">2</span>).setUsername(<span class="string">"woshiyutou"</span>));</span><br><span class="line">        result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">3</span>).setUsername(<span class="string">"chifanshuijiao"</span>));</span><br><span class="line">        <span class="comment">// 返回列表</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/get"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"获得指定用户编号的用户"</span>)</span><br><span class="line">    <span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>, value = <span class="string">"用户编号"</span>, paramType = <span class="string">"query"</span>, dataTypeClass = Integer<span class="class">.<span class="keyword">class</span>, <span class="title">required</span> </span>= <span class="keyword">true</span>, example = <span class="string">"1024"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserVO <span class="title">get</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        <span class="comment">// 查询并返回用户</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserVO().setId(id).setUsername(UUID.randomUUID().toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"add"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"添加用户"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">add</span><span class="params">(UserAddDTO addDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 插入用户记录，返回编号</span></span><br><span class="line">        Integer returnId = UUID.randomUUID().hashCode();</span><br><span class="line">        <span class="comment">// 返回用户编号</span></span><br><span class="line">        <span class="keyword">return</span> returnId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"更新指定用户编号的用户"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">update</span><span class="params">(UserUpdateDTO updateDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 更新用户记录</span></span><br><span class="line">        Boolean success = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// 返回更新是否成功</span></span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/delete"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"删除指定用户编号的用户"</span>)</span><br><span class="line">    <span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>, value = <span class="string">"用户编号"</span>, paramType = <span class="string">"query"</span>, dataTypeClass = Integer<span class="class">.<span class="keyword">class</span>, <span class="title">required</span> </span>= <span class="keyword">true</span>, example = <span class="string">"1024"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">delete</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        <span class="comment">// 删除用户记录</span></span><br><span class="line">        Boolean success = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 返回是否更新成功</span></span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-注解"><a href="#2-注解" class="headerlink" title="2. 注解"></a>2. 注解</h2><h3 id="1-Api"><a href="#1-Api" class="headerlink" title="1. @Api"></a>1. <code>@Api</code></h3><p><a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/Api.java" target="_blank" rel="noopener"><code>@Api</code></a> 注解，添加在 Controller 类上，标记它作为 Swagger 文档资源。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"用户 API 接口"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下:</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcqgfrqrbj30mx040gnm.jpg" alt="image-20200601133941415"></p>
<p><code>@Api</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>tags</code> 属性：用于控制 API 所属的标签列表。<code>[]</code> 数组，可以填写多个。 <ul>
<li>可以在<strong>一个</strong> Controller 上的 <code>@Api</code> 的 <code>tags</code> 属性，设置<strong>多个</strong>标签，那么这个 Controller 下的 API 接口，就会出现在这<strong>两个</strong>标签中。</li>
<li>如果在<strong>多个</strong> Controller 上的 <code>@Api</code> 的 <code>tags</code> 属性，设置<strong>一个</strong>标签，那么这些 Controller 下的 API 接口，仅会出现在这<strong>一个</strong>标签中。</li>
<li>本质上，<code>tags</code> 就是为了分组 API 接口，和 Controller 本质上是一个目的。所以绝大数场景下，我们只会给一个 Controller 一个<strong>唯一</strong>的标签。例如说，UserController 的 <code>tags</code> 设置为 <code>&quot;用户 API 接口&quot;</code> 。</li>
</ul>
</li>
</ul>
<p><code>@Api</code> 注解的<strong>不常用属性</strong>，如下：</p>
<ul>
<li><code>produces</code> 属性：请求请求头的<strong>可接受类型</strong>( <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept" target="_blank" rel="noopener">Accept</a> )。如果有多个，使用 <code>,</code> 分隔。</li>
<li><code>consumes</code> 属性：请求请求头的<strong>提交内容类型</strong>( <a href="https://juejin.im/post/5cb34fc06fb9a068a75d3555" target="_blank" rel="noopener">Content-Type</a> )。如果有多个，使用 <code>,</code> 分隔。</li>
<li><code>protocols</code> 属性：协议，可选值为 <code>&quot;http&quot;</code>、<code>&quot;https&quot;</code>、<code>&quot;ws&quot;</code>、<code>&quot;wss&quot;</code> 。如果有多个，使用 <code>,</code> 分隔。</li>
<li><code>authorizations</code> 属性：授权相关的配置，<code>[]</code> 数组，使用 <a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/Authorization.java" target="_blank" rel="noopener"><code>@Authorization</code></a> 注解。</li>
<li><code>hidden</code> 属性：是否隐藏，不再 API 接口文档中显示。</li>
</ul>
<p><code>@Api</code> 注解的<strong>废弃属性</strong>，不建议使用，有 <code>value</code>、<code>description</code>、<code>basePath</code>、<code>position</code> 。</p>
<h3 id="2-ApiOperation"><a href="#2-ApiOperation" class="headerlink" title="2. @ApiOperation"></a>2. <code>@ApiOperation</code></h3><p><a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ApiOperation.java" target="_blank" rel="noopener"><code>@ApiOperation</code></a> 注解，添加在 Controller 方法上，标记它是一个 API 操作。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"查询用户列表"</span>, notes = <span class="string">"目前仅仅是作为测试，所以返回用户全列表"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;UserVO&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 查询列表</span></span><br><span class="line">    List&lt;UserVO&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">1</span>).setUsername(<span class="string">"yudaoyuanma"</span>));</span><br><span class="line">    result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">2</span>).setUsername(<span class="string">"woshiyutou"</span>));</span><br><span class="line">    result.add(<span class="keyword">new</span> UserVO().setId(<span class="number">3</span>).setUsername(<span class="string">"chifanshuijiao"</span>));</span><br><span class="line">    <span class="comment">// 返回列表</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcqo5tcm2j30pk0ft79e.jpg" alt="image-20200601134708940"></p>
<p><code>@ApiOperation</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>value</code> 属性：API 操作名。</li>
<li><code>notes</code> 属性：API 操作的描述。</li>
</ul>
<p><code>@ApiOperation</code> 注解的<strong>不常用属性</strong>，如下：</p>
<ul>
<li><code>tags</code> 属性：和 <code>@API</code> 注解的 <code>tags</code> 属性一致。</li>
<li><code>nickname</code> 属性：API 操作接口的唯一标识，主要用于和第三方工具做对接。</li>
<li><code>httpMethod</code> 属性：请求方法，可选值为 <code>GET</code>、<code>HEAD</code>、<code>POST</code>、<code>PUT</code>、<code>DELETE</code>、<code>OPTIONS</code>、<code>PATCH</code> 。因为 Swagger 会解析 SpringMVC 的注解，所以一般无需填写。</li>
<li><code>produces</code> 属性：和 <code>@API</code> 注解的 <code>produces</code> 属性一致。</li>
<li><code>consumes</code> 属性：和 <code>@API</code> 注解的 <code>consumes</code> 属性一致。</li>
<li><code>protocols</code> 属性：和 <code>@API</code> 注解的 <code>protocols</code> 属性一致。</li>
<li><code>authorizations</code> 属性：和 <code>@API</code> 注解的 <code>authorizations</code> 属性一致。</li>
<li><code>hidden</code> 属性：和 <code>@API</code> 注解的 <code>hidden</code> 属性一致。</li>
<li><code>response</code> 属性：响应结果类型。因为 Swagger 会解析方法的返回类型，所以一般无需填写。</li>
<li><code>responseContainer</code> 属性：响应结果的容器，可选值为 <code>List</code>、<code>Set</code>、<code>Map</code> 。</li>
<li><code>responseReference</code> 属性：指定对响应类型的引用。这个引用可以是本地，也可以是远程。并且，当设置了它时，会覆盖 <code>response</code> 属性。可以忽略这个属性。</li>
<li><code>responseHeaders</code> 属性：响应头，<code>[]</code> 数组，使用 <a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ResponseHeader.java" target="_blank" rel="noopener"><code>@ResponseHeader</code></a> 注解。</li>
<li><code>code</code> 属性：响应状态码，默认为 200 。</li>
<li><code>extensions</code> 属性：拓展属性，<code>[]</code> 属性，使用 <a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/Extension.java" target="_blank" rel="noopener"><code>@Extension</code></a> 注解。</li>
<li><code>ignoreJsonView</code> 属性：在解析操作和类型，忽略 JsonView 注释。主要是为了向后兼容。</li>
</ul>
<p><code>@ApiOperation</code> 注解的<strong>废弃属性</strong>，不建议使用，有 <code>position</code> 。</p>
<h3 id="3-ApiImplicitParam"><a href="#3-ApiImplicitParam" class="headerlink" title="3. @ApiImplicitParam"></a>3. <code>@ApiImplicitParam</code></h3><p><a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ApiImplicitParam.java" target="_blank" rel="noopener"><code>@ApiImplicitParam</code></a> 注解，添加在 Controller 方法上，声明每个请求参数的信息。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/delete"</span>)</span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"删除指定用户编号的用户"</span>)</span><br><span class="line"><span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>, value = <span class="string">"用户编号"</span>, paramType = <span class="string">"query"</span>, dataTypeClass = Integer<span class="class">.<span class="keyword">class</span>, <span class="title">required</span> </span>= <span class="keyword">true</span>, example = <span class="string">"1024"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">delete</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">    <span class="comment">// 删除用户记录</span></span><br><span class="line">    Boolean success = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 返回是否更新成功</span></span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcqtsmu9cj30pt05xjsu.jpg" alt="image-20200601135232838"></p>
<p><code>@ApiImplicitParam</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>name</code> 属性：参数名。</li>
<li><code>value</code> 属性：参数的简要说明。</li>
<li><code>required</code> 属性：是否为必传参数。默认为 <code>false</code> 。</li>
<li><code>dataType</code> 属性：数据类型，通过字符串 String 定义。</li>
<li><code>dataTypeClass</code> 属性：数据类型，通过 <code>dataTypeClass</code> 定义。在设置了 <code>dataTypeClass</code> 属性的情况下，会覆盖 <code>dataType</code> 属性。<strong>推荐采用这个方式</strong>。</li>
<li><code>paramType</code> 属性：参数所在位置的类型。有如下 5 种方式：<ul>
<li><code>&quot;path&quot;</code> 值：对应 SpringMVC 的 <code>@PathVariable</code> 注解。</li>
<li>【<em>默认值</em>】<code>&quot;query&quot;</code> 值：对应 SpringMVC 的 <code>@PathVariable</code> 注解。</li>
<li><code>&quot;body&quot;</code> 值：对应 SpringMVC 的 <code>@RequestBody</code> 注解。</li>
<li><code>&quot;header&quot;</code> 值：对应 SpringMVC 的 <code>@RequestHeader</code> 注解。</li>
<li><code>&quot;form&quot;</code> 值：Form 表单提交，对应 SpringMVC 的 <code>@PathVariable</code> 注解。</li>
<li><strong>绝大多数情况下，使用 <code>&quot;query&quot;</code> 值这个类型即可。</strong></li>
</ul>
</li>
<li><code>example</code> 属性：参数值的简单示例。</li>
<li><code>examples</code> 属性：参数值的复杂示例，使用 <a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/Example.java" target="_blank" rel="noopener"><code>@Example</code></a> 注解。</li>
</ul>
<p><code>@ApiImplicitParam</code> 注解的<strong>不常用属性</strong>，如下：</p>
<ul>
<li><code>defaultValue</code> 属性：默认值。</li>
<li><code>allowableValues</code> 属性：允许的值。如果要设置多个值，有两种方式：<ul>
<li>数组方式，即 <code>{value1, value2, value3}</code> 。例如说，<code>{1, 2, 3}</code> 。</li>
<li>范围方式，即 <code>[value1, value2]</code> 或 <code>[value1, value2)</code> 。例如说 <code>[1, 5]</code> 表示 1 到 5 的所有数字。如果有无穷的，可以使用 <code>(-infinity, value2]</code> 或 <code>[value1, infinity)</code> 。</li>
</ul>
</li>
<li><code>allowEmptyValue</code> 属性：是否允许空值。</li>
<li><code>allowMultiple</code> 属性：是否允许通过多次传递该参数来接受多个值。默认为 <code>false</code> 。</li>
<li><code>type</code> 属性：搞不懂具体用途，对应英文注释为 <code>Adds the ability to override the detected type</code> 。</li>
<li><code>readOnly</code> 属性：是否只读。</li>
<li><code>format</code> 属性：自定义的格式化。</li>
<li><code>collectionFormat</code> 属性：针对 Collection 集合的，自定义的格式化。</li>
</ul>
<p>需要添加在方法上添加多个 <code>@ApiImplicitParam</code> 注解时，可以使用 <a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ApiImplicitParams.java" target="_blank" rel="noopener">@ApiImplicitParams</a> 注解中添加多个。示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiImplicitParams</span>(&#123; <span class="comment">// 参数数组</span></span><br><span class="line">        <span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>, value = <span class="string">"用户编号"</span>, paramType = <span class="string">"query"</span>, dataTypeClass = Integer<span class="class">.<span class="keyword">class</span>, <span class="title">required</span> </span>= <span class="keyword">true</span>, example = <span class="string">"1024"</span>), <span class="comment">// 参数一</span></span><br><span class="line">        <span class="meta">@ApiImplicitParam</span>(name = <span class="string">"name"</span>, value = <span class="string">"昵称"</span>, paramType = <span class="string">"query"</span>, dataTypeClass = String<span class="class">.<span class="keyword">class</span>, <span class="title">required</span> </span>= <span class="keyword">true</span>, example = <span class="string">"芋道"</span>), <span class="comment">// 参数二</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="4-ApiModel"><a href="#4-ApiModel" class="headerlink" title="4. @ApiModel"></a>4. <code>@ApiModel</code></h3><p><a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ApiModel.java" target="_blank" rel="noopener"><code>@ApiModel</code></a> 注解，添加在 POJO 类，声明 POJO 类的信息。而在 Swagger 中，把这种 POJO 类称为 <strong>Model</strong> 类。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserVO.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModel</span>(<span class="string">"用户 VO"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcqykqf0kj30pm0dowgm.jpg" alt="image-20200601135709332"></p>
<p><code>@ApiModel</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>value</code> 属性：Model 名字。</li>
<li><code>description</code> 属性：Model 描述。</li>
</ul>
<h3 id="5-ApiModelProperty"><a href="#5-ApiModelProperty" class="headerlink" title="5. @ApiModelProperty"></a>5. <code>@ApiModelProperty</code></h3><p><a href="https://github.com/swagger-api/swagger-core/blob/1.5/modules/swagger-annotations/src/main/java/io/swagger/annotations/ApiModelProperty.java" target="_blank" rel="noopener"><code>@ApiModelProperty</code></a> 注解，添加在 Model 类的成员变量上，声明每个成员变量的信息。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserVO.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModel</span>(<span class="string">"用户 VO"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户编号"</span>, required = <span class="keyword">true</span>, example = <span class="string">"1024"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"账号"</span>, required = <span class="keyword">true</span>, example = <span class="string">"yudaoyuanma"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略 set/get 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcqzzsoamj30pg0fyjrm.jpg" alt="@ApiModelProperty 示例"></p>
<p><code>@ApiModelProperty</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>value</code> 属性：属性的描述。</li>
<li><code>dataType</code> 属性：和 <code>@ApiImplicitParam</code> 注解的 <code>dataType</code> 属性一致。不过因为 <code>@ApiModelProperty</code> 是添加在成员变量上，可以自动获得成员变量的类型。</li>
<li><code>required</code> 属性：和 <code>@ApiImplicitParam</code> 注解的 <code>required</code> 属性一致。</li>
<li><code>example</code> 属性：<code>@ApiImplicitParam</code> 注解的 <code>example</code> 属性一致。</li>
</ul>
<h3 id="6-ApiResponse"><a href="#6-ApiResponse" class="headerlink" title="6. @ApiResponse"></a>6. <code>@ApiResponse</code></h3><p>在大多数情况下，并不需要使用 <code>@ApiResponse</code> 注解，因为会类似 <code>UserController#get(id)</code> 方法这个接口，返回一个 Model 即可。</p>
<h2 id="3-更好看的-Swagger-UI-界面"><a href="#3-更好看的-Swagger-UI-界面" class="headerlink" title="3. 更好看的 Swagger UI 界面"></a>3. 更好看的 Swagger UI 界面</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1. swagger-bootstrap-ui 目前改名为 knife4j --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 2. 实现 swagger-bootstrap-ui 的自动化配置  --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 3. 因为 knife4j-spring 已经引入 Swagger 依赖，所以无需重复引入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>直接使用 Application 启动项目，无需做其它任何的变更，方便的说。</p>
<p>浏览器访问 <code>http://localhost:8080/doc.html</code> 地址，就可以看到 <strong>新</strong>的 Swagger 生成的 API 接口文档。<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcr552x9ej31h10u0jub.jpg" alt="swagger-bootstrap-ui 示例"></p>
<h2 id="4-更强大的-YApi"><a href="#4-更强大的-YApi" class="headerlink" title="4. 更强大的 YApi"></a>4. 更强大的 YApi</h2><p>使用 <a href="https://github.com/YMFE/yapi" target="_blank" rel="noopener">YApi</a> 可视化接口管理平台，自动调用 Swagger 提供的 <code>v2/api-docs</code> 接口，采集 Swagger 注解生成的 API 接口信息，从而录入到 YApi 中。</p>
<p>FROM <a href="https://github.com/YMFE/yapi" target="_blank" rel="noopener">https://github.com/YMFE/yapi</a></p>
<p>YApi 是<strong>高效</strong>、<strong>易用</strong>、<strong>功能强大</strong>的 api 管理平台，旨在为开发、产品、测试人员提供更优雅的接口管理服务。可以帮助开发者轻松创建、发布、维护 API，YApi 还为用户提供了优秀的交互体验，开发人员只需利用平台提供的接口数据写入工具以及简单的点击操作就可以实现接口的管理。</p>
<ul>
<li>基于 Json5 和 Mockjs 定义接口返回数据的结构和文档，效率提升多倍</li>
<li>扁平化权限设计，即保证了大型企业级项目的管理，又保证了易用性</li>
<li>类似 postman 的接口调试</li>
<li>自动化测试, 支持对 Response 断言</li>
<li>MockServer 除支持普通的随机 mock 外，还增加了 Mock 期望功能，根据设置的请求过滤规则，返回期望数据</li>
<li>支持 postman, har, swagger 数据导入</li>
<li>免费开源，内网部署，信息再也不怕泄露了</li>
</ul>
<h3 id="1-安装-mongodb"><a href="#1-安装-mongodb" class="headerlink" title="1. 安装 mongodb"></a>1. 安装 mongodb</h3><h3 id="2-安装-Node-js"><a href="#2-安装-Node-js" class="headerlink" title="2. 安装 Node.js"></a>2. 安装 Node.js</h3><h3 id="3-安装-yapi-cli"><a href="#3-安装-yapi-cli" class="headerlink" title="3. 安装 yapi-cli"></a>3. 安装 yapi-cli</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装 yapi-cli 工具</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install -g yapi-cli --registry https://registry.npm.taobao.org</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动 YApi 平台部署工具</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yapi server</span></span><br><span class="line">在浏览器打开 http://0.0.0.0:9090 访问。非本地服务器，请将 0.0.0.0 替换成指定的域名或ip</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/01/Web%E5%BC%80%E5%8F%91-SpringBootAPI%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3Swagger%E5%85%A5%E9%97%A8/" data-id="ckbg9kucl000x2r07h9ru4new" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swagger/" rel="tag">Swagger</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache/" rel="tag">Cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-%E5%9F%BA%E7%A1%80-01/" rel="tag">Java 基础-01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jetty/" rel="tag">Jetty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SPring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">SPring Boot-基础-01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">Spring Boot-基础-01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-02/" rel="tag">Spring Boot-基础-02</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swagger/" rel="tag">Swagger</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Undertow/" rel="tag">Undertow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Validation/" rel="tag">Validation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebFlux/" rel="tag">WebFlux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebSocket/" rel="tag">WebSocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" rel="tag">基准测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag">基础知识</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%B9%E5%99%A8/" rel="tag">容器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/" rel="tag">数据库连接池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/" rel="tag">数据访问</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88/" rel="tag">集合</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Java/" style="font-size: 18px;">Java</a> <a href="/tags/Java-%E5%9F%BA%E7%A1%80-01/" style="font-size: 12px;">Java 基础-01</a> <a href="/tags/Jetty/" style="font-size: 10px;">Jetty</a> <a href="/tags/MyBatis/" style="font-size: 10px;">MyBatis</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/SPring-Boot-%E5%9F%BA%E7%A1%80-01/" style="font-size: 10px;">SPring Boot-基础-01</a> <a href="/tags/Spring-Boot/" style="font-size: 20px;">Spring Boot</a> <a href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" style="font-size: 16px;">Spring Boot-基础-01</a> <a href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-02/" style="font-size: 10px;">Spring Boot-基础-02</a> <a href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" style="font-size: 14px;">Spring Boot-基础01</a> <a href="/tags/Swagger/" style="font-size: 10px;">Swagger</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/Undertow/" style="font-size: 10px;">Undertow</a> <a href="/tags/Validation/" style="font-size: 10px;">Validation</a> <a href="/tags/Web/" style="font-size: 14px;">Web</a> <a href="/tags/WebFlux/" style="font-size: 10px;">WebFlux</a> <a href="/tags/WebSocket/" style="font-size: 10px;">WebSocket</a> <a href="/tags/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">基准测试</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 10px;">基础知识</a> <a href="/tags/%E5%AE%B9%E5%99%A8/" style="font-size: 10px;">容器</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/" style="font-size: 10px;">数据库连接池</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/" style="font-size: 12px;">数据访问</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">线程池</a> <a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 10px;">缓存</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 12px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88/" style="font-size: 10px;">集合</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 10px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/06/11/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-MyBatis%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-MyBatis入门</a>
          </li>
        
          <li>
            <a href="/2020/06/10/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-数据库连接池入门</a>
          </li>
        
          <li>
            <a href="/2020/06/08/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E7%BC%93%E5%AD%98Cache%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-缓存Cache入门</a>
          </li>
        
          <li>
            <a href="/2020/06/03/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-Redis%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-Redis入门</a>
          </li>
        
          <li>
            <a href="/2020/06/03/%E5%BF%AB%E9%80%9F%E6%95%99%E7%A8%8B-SpringBoot-WebFlux-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">快速教程-SpringBoot-WebFlux-快速入门</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>