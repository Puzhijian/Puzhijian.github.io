<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-操作命令/gitea_安装命令" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/15/%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/gitea_%E5%AE%89%E8%A3%85%E5%91%BD%E4%BB%A4/" class="article-date">
  <time datetime="2021-04-15T06:34:06.000Z" itemprop="datePublished">2021-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/15/%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/gitea_%E5%AE%89%E8%A3%85%E5%91%BD%E4%BB%A4/">Gitea 安装命令</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/04/15/%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/gitea_%E5%AE%89%E8%A3%85%E5%91%BD%E4%BB%A4/" data-id="ckniif42c0000ge07a5ez41ks" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Gitea/" rel="tag">Gitea</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-docker/docker_命令" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/12/docker/docker_%E5%91%BD%E4%BB%A4/" class="article-date">
  <time datetime="2021-04-12T06:31:11.000Z" itemprop="datePublished">2021-04-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/12/docker/docker_%E5%91%BD%E4%BB%A4/">docker 命令</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="docker-命令"><a href="#docker-命令" class="headerlink" title="docker 命令"></a>docker 命令</h1><h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><p>docker run -d -p 8100:8080 -p 50000:50000 -v jenkins_data:/var/jenkins_home jenkinsci/blueocean</p>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>docker run -d -p 81:81 –name webserver nginx</p>
<h2 id="查看镜像"><a href="#查看镜像" class="headerlink" title="查看镜像"></a>查看镜像</h2><p> docker images</p>
<h2 id="新建容器"><a href="#新建容器" class="headerlink" title="新建容器"></a>新建容器</h2><p>docker create -it ubuntu:latest</p>
<h2 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h2><p>docker start keen_easley(容器的name)</p>
<h2 id="新建并启动容器"><a href="#新建并启动容器" class="headerlink" title="新建并启动容器"></a>新建并启动容器</h2><p>docker run</p>
<h2 id="守护态运行"><a href="#守护态运行" class="headerlink" title="守护态运行"></a>守护态运行</h2><p>docker run -d </p>
<h2 id="暂停容器"><a href="#暂停容器" class="headerlink" title="暂停容器"></a>暂停容器</h2><p>docker pause name(容器name)</p>
<h2 id="终止容器"><a href="#终止容器" class="headerlink" title="终止容器"></a>终止容器</h2><p>docker stop name(容器name)</p>
<h2 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h2><h3 id="attach-命令"><a href="#attach-命令" class="headerlink" title="attach 命令"></a>attach 命令</h3><p>docker attach keen_easley(容器name)</p>
<h2 id="创建数据卷"><a href="#创建数据卷" class="headerlink" title="创建数据卷"></a>创建数据卷</h2><p>docker volume create -d local test(数据卷名称)</p>
<h2 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h2><p>-P  -p 命令指定端口映射</p>
<p>-P（大写），Docker 会随机映射一个 49000~49900 的端口到内部容器开放的网络端口</p>
<p>-p（小写），可以指定要映射的端口</p>
<p>docker run -d -p 5000:5000 —— 本地的5000端口映射到容器的5000端口</p>
<p>docker run -d -p 127.0.0.1:5000:5000——映射到指定地址的指定端口</p>
<p>docker run -d -p 127.0.0.1::5000——本地的任意端口映射到容器的5000端口，本地主机会自动分配一个端口</p>
<h2 id="查看端口映射"><a href="#查看端口映射" class="headerlink" title="查看端口映射"></a>查看端口映射</h2><p>docker port heuristic_gagarin 8080</p>
<h2 id="自定义容器命名"><a href="#自定义容器命名" class="headerlink" title="自定义容器命名"></a>自定义容器命名</h2><p>docker run -d -P –name</p>
<h2 id="容器互联"><a href="#容器互联" class="headerlink" title="容器互联"></a>容器互联</h2><p>docker run -d -P –name web –link db:db</p>
<p>db容器和web容器建立互联关系</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/04/12/docker/docker_%E5%91%BD%E4%BB%A4/" data-id="cknihzldi000n7g0778zdfj0b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-TeamCityVSJenkins选择正确的CI-CD工具" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/27/TeamCityVSJenkins%E9%80%89%E6%8B%A9%E6%AD%A3%E7%A1%AE%E7%9A%84CI-CD%E5%B7%A5%E5%85%B7/" class="article-date">
  <time datetime="2020-07-27T06:28:09.000Z" itemprop="datePublished">2020-07-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/27/TeamCityVSJenkins%E9%80%89%E6%8B%A9%E6%AD%A3%E7%A1%AE%E7%9A%84CI-CD%E5%B7%A5%E5%85%B7/">TeamCityVSJenkins选择正确的CI/CD工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="TeamCity-VS-Jenkins：选择正确的CI-CD工具"><a href="#TeamCity-VS-Jenkins：选择正确的CI-CD工具" class="headerlink" title="TeamCity VS Jenkins：选择正确的CI / CD工具"></a>TeamCity VS Jenkins：选择正确的CI / CD工具</h1><h2 id="1-CI-CD"><a href="#1-CI-CD" class="headerlink" title="1. CI/CD"></a>1. CI/CD</h2><p>在持续集成（CI）中，更改经常被集成到共享存储库中，在其中定期执行构建和DevOps测试（可选步骤）以进行早期错误检测，从而提高了产品质量</p>
<p>持续交付（CD）仅在CI完成后才发生，并且由自动管道组成，可以在其中将代码更改从一个暂存环境部署到另一个暂存环境。它包括使软件可部署所需的所有必要步骤（即使用测试工具进行质量检查，软件签名，部署到预生产环境等）</p>
<p>CI / CD通常与Selenium测试自动化一起使用，以在将其推送到新环境中或集成在一起时对其进行测试，这称为连续测试或DevOps测试。CI / CD与TDD（测试驱动开发）结合使用时，可以有效地结合在一起，因为它可以用于识别产品中与业务相关的错误</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/27/TeamCityVSJenkins%E9%80%89%E6%8B%A9%E6%AD%A3%E7%A1%AE%E7%9A%84CI-CD%E5%B7%A5%E5%85%B7/" data-id="cknihzld800037g07asdx8iz6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CI-CD/" rel="tag">CI/CD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TeamCity/" rel="tag">TeamCity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-SpringMvc-基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/27/SpringMvc-%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2020-07-27T05:40:51.000Z" itemprop="datePublished">2020-07-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/27/SpringMvc-%E5%9F%BA%E7%A1%80/">SpringMvc-基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h1><h2 id="一、SpringMVC-简单使用"><a href="#一、SpringMVC-简单使用" class="headerlink" title="一、SpringMVC 简单使用"></a>一、SpringMVC 简单使用</h2><h3 id="1-在-web-xml-中配置-DispatcherServlet"><a href="#1-在-web-xml-中配置-DispatcherServlet" class="headerlink" title="1) 在 web.xml 中配置 DispatcherServlet"></a>1) 在 web.xml 中配置 DispatcherServlet</h3><h3 id="2）加入-Spring-MVC-的配置文件"><a href="#2）加入-Spring-MVC-的配置文件" class="headerlink" title="2）加入 Spring MVC 的配置文件"></a>2）加入 Spring MVC 的配置文件</h3><h3 id="3-编写处理请求的处理器，并使用-Controller-注解标识为处理器"><a href="#3-编写处理请求的处理器，并使用-Controller-注解标识为处理器" class="headerlink" title="3) 编写处理请求的处理器，并使用 @Controller 注解标识为处理器"></a>3) 编写处理请求的处理器，并使用 @Controller 注解标识为处理器</h3><h3 id="4-编写视图-JSP"><a href="#4-编写视图-JSP" class="headerlink" title="4) 编写视图 JSP"></a>4) 编写视图 JSP</h3><h2 id="二、使用-RequestMapping-映射请求"><a href="#二、使用-RequestMapping-映射请求" class="headerlink" title="二、使用 @RequestMapping 映射请求"></a>二、使用 @RequestMapping 映射请求</h2><ul>
<li>Spring MVC 使用 <code>@RequestMapping</code> 注解为控制器指定可以处理哪些 URL 请求</li>
<li>在控制器的<code>类</code>定义及<code>方法</code>定义处都可标注<ul>
<li><em>类定义</em>：提供初步的请求映射信息。相对于 WEB 应用的根目录</li>
<li><em>方法</em>：提供进一步的细分映射信息。相对于类定义处的 URL。若类定义处未标注 @RequestMapping，则方法处标记的 URL 相对于<code>WEB 应用的根目录</code></li>
</ul>
</li>
<li><code>DispatcherServlet</code> 截获请求后，就通过控制器上<code>@RequestMapping</code>提供的映射信息确定请求所对应的处理 方法。</li>
</ul>
<ol>
<li><h4 id="RequestMapping"><a href="#RequestMapping" class="headerlink" title="@RequestMapping"></a>@RequestMapping</h4><p>@RequestMapping 的<strong>value</strong>、<strong>method</strong>、<strong>params</strong> 及 <strong>heads</strong> 分别表示<strong><em>请求 URL\</em></strong>、<strong><em>请求方法\</em></strong>、<strong><em>请求参数\</em></strong>及<strong><em>请求头的映射条件\</em></strong>，他们之间是<em>与</em>的关系，联合使用多个条件可让请求映射更加精确化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**     </span></span><br><span class="line"><span class="comment">* 可以使用 params 和 headers 来更加精确的映射请求. params 和 headers 支持简单的表达式.     </span></span><br><span class="line"><span class="comment">*      </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span>     </span></span><br><span class="line"><span class="comment">*/</span>   </span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"testParamsAndHeaders"</span>,                    </span><br><span class="line">                params = &#123; <span class="string">"username"</span>,<span class="string">"age!=10"</span> &#125;,                    </span><br><span class="line">                headers = &#123; <span class="string">"Accept-Language=en-US,zh;q=0.8"</span> &#125;,                    </span><br><span class="line">                method = RequestMethod.POST)    </span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;        </span><br><span class="line">  System.out.println(<span class="string">"test..."</span>);        </span><br><span class="line">  <span class="keyword">return</span> <span class="string">"success"</span>;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><h4 id="支持Ant-风格"><a href="#支持Ant-风格" class="headerlink" title="支持Ant 风格"></a>支持Ant 风格</h4></li>
</ol>
<ul>
<li><code>?</code> ：匹配文件名中的一个字符</li>
</ul>
<p><strong>/user/createUser?</strong></p>
<p>匹配 /user/createUser<em>a</em> 或者 user/createUser<em>b</em> 等 URL</p>
<ul>
<li><code>*</code> ：匹配文件名中的任意字符</li>
</ul>
<p><strong>/user/*/createUser</strong></p>
<p>匹配 /user/<em>aaa</em>/createUser 或者 /user/<em>bbb</em>/createUser 等 URL</p>
<ul>
<li><code>**</code> ：匹配多层路径</li>
</ul>
<p><strong>/user/\</strong>/createUser**</p>
<p>匹配 /user/createUser 或者 /user/<em>aaa/bbb</em>/createUser 等 URL</p>
<h2 id="四丶-PathVariable"><a href="#四丶-PathVariable" class="headerlink" title="四丶@PathVariable"></a>四丶@PathVariable</h2><ul>
<li>通过<code>@PathVariable</code>可以将 URL 中占位符参数绑定到控制器处理方法的入参中：URL 中的 <code>{xxx}</code> 占位符可以通过<code>@PathVariable(&quot;xxx&quot;)</code> 绑定到操作方法的入参中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* <span class="doctag">@PathVariable</span> 可以来映射 URL 中的占位符到目标方法的参数中. </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/testPathVariable/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id) </span>&#123;    </span><br><span class="line">  System.out.println(<span class="string">"id: "</span> + id);    </span><br><span class="line">  <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="五、-RequestParam-绑定请求参数值"><a href="#五、-RequestParam-绑定请求参数值" class="headerlink" title="五、@RequestParam 绑定请求参数值"></a>五、@RequestParam 绑定请求参数值</h2><ul>
<li>在处理方法入参处使用 @RequestParam 可以把请求参数传递给请求方法</li>
<li><code>value</code>：参数名</li>
<li><code>required</code>：是否必须；默认为 true，表示请求参数中必须包含对应的参数，若不存在，将抛出异常</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* <span class="doctag">@RequestParam</span> 来映射请求参数. value 值即请求参数的参数名 required 该参数是否必须. 默认为 true </span></span><br><span class="line"><span class="comment">*               defaultValue 请求参数的默认值 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/testRequestParam"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testRequestParam</span><span class="params">(        </span></span></span><br><span class="line"><span class="function"><span class="params">  		@RequestParam(value = <span class="string">"username"</span>)</span> String username,        </span></span><br><span class="line"><span class="function">  		@<span class="title">RequestParam</span><span class="params">(value = <span class="string">"age"</span>, required = <span class="keyword">false</span>, defaultValue = <span class="string">"0"</span>)</span> <span class="keyword">int</span> age) </span>&#123;   </span><br><span class="line">  System.out.println(<span class="string">"testRequestParam, username: "</span> + username + <span class="string">", age: "</span> + age);   </span><br><span class="line">  <span class="keyword">return</span> <span class="string">"success"</span>;                                                                                 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="六、-RequestHeader-绑定请求报头的属性值"><a href="#六、-RequestHeader-绑定请求报头的属性值" class="headerlink" title="六、@RequestHeader 绑定请求报头的属性值"></a>六、@RequestHeader 绑定请求报头的属性值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">*   映射请求头信息 用法同 <span class="doctag">@RequestParam</span> </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/testRequestHeader"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testRequestHeader</span><span class="params">(        </span></span></span><br><span class="line"><span class="function"><span class="params">  	@RequestHeader(value = <span class="string">"Accept-Language"</span>)</span> String al) </span>&#123;    			</span><br><span class="line">  System.out.println(<span class="string">"testRequestHeader, Accept-Language: "</span> + al);    </span><br><span class="line">  <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="七、-CookieValue-绑定请求中的-Cookie-值"><a href="#七、-CookieValue-绑定请求中的-Cookie-值" class="headerlink" title="七、@CookieValue 绑定请求中的 Cookie 值"></a>七、@CookieValue 绑定请求中的 Cookie 值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* <span class="doctag">@CookieValue</span>: 映射一个 Cookie 值. 属性同 <span class="doctag">@RequestParam</span> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/testCookieValue"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testCookieValue</span><span class="params">(@CookieValue(<span class="string">"JSESSIONID"</span>)</span> String sessionId) </span>&#123;    </span><br><span class="line">  System.out.println(<span class="string">"testCookieValue: sessionId: "</span> + sessionId);    </span><br><span class="line">  <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="八、POJO-对象绑定请求参数值"><a href="#八、POJO-对象绑定请求参数值" class="headerlink" title="八、POJO 对象绑定请求参数值"></a>八、POJO 对象绑定请求参数值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* Spring MVC 会按请求参数名和 POJO 属性名进行自动匹配， 自动为该对象填充属性值。支持级联属性。 </span></span><br><span class="line"><span class="comment">* 如：dept.deptId、dept.address.tel 等 */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/testPojo"</span>)<span class="function"><span class="keyword">public</span> String <span class="title">testPojo</span><span class="params">(User user)</span> </span>&#123;    </span><br><span class="line">  System.out.println(<span class="string">"testPojo: "</span> + user);    </span><br><span class="line">  <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="九、MVC-中Handler-方法可以接收的ServletAPI-类型的参数"><a href="#九、MVC-中Handler-方法可以接收的ServletAPI-类型的参数" class="headerlink" title="九、MVC 中Handler 方法可以接收的ServletAPI 类型的参数"></a>九、MVC 中Handler 方法可以接收的ServletAPI 类型的参数</h2><ul>
<li><em>HttpServletRequest</em></li>
<li><em>HttpServletResponse</em></li>
<li><em>HttpSession</em></li>
<li><em>Writer</em></li>
<li>java.security.Principal</li>
<li>Locale</li>
<li>InputStream</li>
<li>OutputStream</li>
<li>Reader</li>
</ul>
<h2 id="十、处理模型数据"><a href="#十、处理模型数据" class="headerlink" title="十、处理模型数据"></a>十、处理模型数据</h2><p>1）<code>ModelAndView</code></p>
<p>处理方法返回值类型为 ModelAndView时，方法体可通过该对象添加模型数据，ModelAndView中既包含<strong>视图信息</strong>，也包含<strong>模型数据信息</strong>。</p>
<p>2）<code>Map 及 Model</code></p>
<p>入参为 <strong>org.springframework.ui.Model</strong>、<strong>org.springframework.ui.ModelMap</strong> 或 <strong>java.uti.Map</strong> 时，处理方法返回时，Map 中的数据会自动添加到模型中。</p>
<p>3）<code>@SessionAttributes:</code></p>
<p>将模型中的某个属性暂存到<strong>HttpSession</strong>中，以便多个请求之间可以共享这个属性（从<strong>session</strong>域中获取）</p>
<ul>
<li><p>若希望在多个请求之间共用某个模型属性数据，则可以在 控制器<em>类</em>上标注一个 <code>@SessionAttributes</code>，Spring MVC 将在模型中对应的属性暂存到 <code>HttpSession</code> 中。</p>
</li>
<li><p><code>@SessionAttributes</code>除了可以通过属性名指定需要放到会话中的属性外，还可以通过模型属性的对象类型指定哪些模型属性需要放到会话中</p>
<p>1）<em>@SessionAttributes(types=User.class)</em>： 会将隐含模型中所有类型为 <strong>User.class</strong> 的属性添加到会话中</p>
<p>2）<em>@SessionAttributes(value={“user1”, “user2”})</em>：会将隐含模型中对象名为<strong>user1</strong>，<strong>user2</strong> 的属性添加到会话中</p>
<p>3）<em>@SessionAttributes(types={User.class, Dept.class})</em>：会将隐含模型中所有类型为 <strong>User.class</strong>，<strong>Dept.class</strong> 的属性添加到会话中</p>
<p>4）<em>@SessionAttributes(value={“user1”, “user2”}, types={Dept.class})</em>：会将隐含模型中对象名为<strong>user1</strong>，<strong>user2</strong>的属性和所有类型为 <strong>Dept.class</strong> 的属性添加到会话中</p>
</li>
</ul>
<p>4）<code>@ModelAttribute</code></p>
<p>方法入参标注该注解后, 入参的对象就会放到数据模型中</p>
<h2 id="十一、-ModelAttribute"><a href="#十一、-ModelAttribute" class="headerlink" title="十一、@ModelAttribute"></a>十一、@ModelAttribute</h2><ul>
<li>在方法定义上使用 <code>@ModelAttribute</code> 注解：Spring MVC在调用目标处理方法前，会先逐个调用在方法级上标注了<code>@ModelAttribute</code> 的方法。</li>
<li>在方法的入参前使用 <code>@ModelAttribute</code> 注解：</li>
<li>可以从隐含对象中获取隐含的模型数据中获取对象，再将请求参数绑定到对象中，再传入入参</li>
<li>将方法入参对象添加到模型中</li>
</ul>
<h2 id="十二、视图和视图解析器"><a href="#十二、视图和视图解析器" class="headerlink" title="十二、视图和视图解析器"></a>十二、视图和视图解析器</h2><ul>
<li>请求处理方法执行完成后，最终返回一个 <code>ModelAndView</code> 对象。对于那些返回 <strong>String</strong>，<strong>View</strong> 或 <strong>ModeMap</strong> 等类型的处理方法，Spring MVC 也会在内部将它们装配成一个 ModelAndView 对象，它包含了<em>逻辑名</em>和<em>模型对象的视图</em>。</li>
<li>Spring MVC 借助视图解析器（<code>ViewResolver</code>）得到最终的视图对象（<code>View</code>），最终的视图可以是 <code>JSP</code>，也可能是 <code>Excel</code>、<code>JFreeChart</code>等各种表现形式的视图。</li>
<li>对于最终究竟采取何种视图对象对模型数据进行渲染，处理器并不关心，处理器工作重点聚焦在生产模型数据的工 作上，从而实现 MVC 的充分解耦。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/27/SpringMvc-%E5%9F%BA%E7%A1%80/" data-id="cknihzld100017g07furzecm0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringMVC/" rel="tag">SpringMVC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Redis-基于Redis分布式锁" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/17/Redis-%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="article-date">
  <time datetime="2020-07-17T10:26:08.000Z" itemprop="datePublished">2020-07-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/17/Redis-%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">Redis-基于Redis分布式锁</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="基于-Redis-分布式锁"><a href="#基于-Redis-分布式锁" class="headerlink" title="基于 Redis 分布式锁"></a>基于 Redis 分布式锁</h1><h2 id="1-加锁实现"><a href="#1-加锁实现" class="headerlink" title="1. 加锁实现"></a>1. 加锁实现</h2><p>使用 <code>SENTX</code> 命令，将key的值设为value，当且仅当key不存在。若给定的key已经存在，则 SENTX 不做任何动作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 尝试获取锁</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, String value, <span class="keyword">long</span> expire, <span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> stringRedisTemplate.opsForValue().setIfAbsent(key,value,expire,TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 尝试获取锁，并至多等待 timeout 时长</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> key 锁的 redis key</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> value 锁的value</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> expire 过期时间/秒</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> timeout 超时时长</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> unit 时间单位</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> 是否获取成功</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, String value, <span class="keyword">long</span> expire, <span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> waitMillis = unit.toMillis(timeout);</span><br><span class="line">  <span class="keyword">long</span> waitAlready = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (!stringRedisTemplate.opsForValue().setIfAbsent(key, value, expire, TimeUnit.SECONDS) &amp;&amp; waitAlready &lt; waitMillis) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Thread.sleep(waitMillisPer);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      log.error(<span class="string">"Interrupted when trying to get a lock. key: &#123;&#125;"</span>, key, e);</span><br><span class="line">    &#125;</span><br><span class="line">    waitAlready += waitMillisPer;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (waitAlready &lt; waitMillisPer) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  log.warn(<span class="string">"&lt;========== lock &#123;&#125; failed after waiting for &#123;&#125; ms"</span>, key, waitAlready);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>客户端互斥：可以将expire过期时间设置为大于同步代码的执行时间，比如同步代码块执行时间为1s，则可将expire设置为3s或5s。避免同步代码执行过程中expire时间到，其他客户端又可以获取执行同步代码块。</li>
<li></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/17/Redis-%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" data-id="cknihzlcw00007g072kl9b8ar" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" rel="tag">分布式锁</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据访问-SpringBoot-JPA入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/15/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-JPA%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-15T08:59:34.000Z" itemprop="datePublished">2020-06-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/15/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-JPA%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-JPA入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-JPA-入门"><a href="#Spring-Boot-JPA-入门" class="headerlink" title="Spring Boot JPA 入门"></a>Spring Boot JPA 入门</h1><h2 id="1-快速入门"><a href="#1-快速入门" class="headerlink" title="1. 快速入门"></a>1. 快速入门</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 实现对数据库连接池的自动化配置 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 实际上 spring-boot-starter-data-jpa 已经包括 spring-boot-starter-jdbc --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 本示例，我们使用 MySQL --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.48<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 实现对 Spring Data JPA 的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 方便等会写单元测试 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://47.112.193.81:3306/testb5f4?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">testb5f4</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">F4df4db0ed86@11</span></span><br><span class="line">  <span class="comment"># JPA 配置内容，对应 JpaProperties 类</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span> <span class="comment"># 打印 SQL 。生产环境，建议关闭</span></span><br><span class="line">    <span class="comment"># Hibernate 配置内容，对应 HibernateProperties 类</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">none</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>ddl-auto</code> 配置项，设置 Hibernate DDL 处理策略。一共有 <code>none</code>、<code>create</code>、<code>create-drop</code>、<code>update</code>、<code>validate</code> 五个选项。<ul>
<li>create ：每次加载 hibernate 时都会删除上一次的生成的表，然后根据你的 model 类再重新来生成新表，哪怕两次没有任何改变也要这样执行，这就是导致数据库表数据丢失的一个重要原因。</li>
<li>create-drop ：每次加载 hibernate 时根据 model 类生成表，但是 sessionFactory 一关闭，表就自动删除。</li>
<li>update ：最常用的属性，第一次加载 hibernate 时根据 model 类会自动建立起表的结构（前提是先建立好数据库），以后加载 hibernate 时根据 model 类自动更新表结构，即使表结构改变了但表中的行仍然存在不会删除以前的行。要注意的是当部署到服务器后，表结构是不会被马上建立起来的，是要等应用第一次运行起来后才会。</li>
<li>validate ：每次加载 hibernate 时，验证创建数据库表结构，只会和数据库中的表进行比较，不会创建新表，但是会插入新值。<ul>
<li>生产环境下，建议配置 <code>none</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserDO.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY,  <span class="comment">// strategy 设置使用数据库主键自增策略；</span></span><br><span class="line">            generator = <span class="string">"JDBC"</span>) <span class="comment">// generator 设置插入完成后，查询最后生成的 ID 填充到该属性中。</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Column</span>(nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码（明文）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ps：生产环境下，千万不要明文噢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Column</span>(nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"create_time"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略 setting/getting 方法</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserRepository01.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository01</span> <span class="keyword">extends</span> <span class="title">CrudRepository</span>&lt;<span class="title">UserDO</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>继承 <code>org.springframework.data.repository.CrudRepository</code> 接口，第一个泛型设置对应的实体是 UserDO ，第二个泛型设置对应的主键类型是 Integer 。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/15/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-JPA%E5%85%A5%E9%97%A8/" data-id="cknihzldg000i7g07c1r4alii" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JPA/" rel="tag">JPA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据访问-SpringBoot-MyBatis入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/11/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-MyBatis%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-11T03:08:36.000Z" itemprop="datePublished">2020-06-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/11/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-MyBatis%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-MyBatis入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-MyBatis-入门"><a href="#Spring-Boot-MyBatis-入门" class="headerlink" title="Spring Boot MyBatis 入门"></a>Spring Boot MyBatis 入门</h1><h2 id="1-Mybatis-XML"><a href="#1-Mybatis-XML" class="headerlink" title="1. Mybatis + XML"></a>1. Mybatis + XML</h2><p>配置 <code>@MapperScan</code> 注解，扫描对应 Mapper 接口所在的包路径。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Application.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = <span class="string">"cn.iocoder.springboot.lab12.mybatis.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://47.112.193.81:3306/testb5f4?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">testb5f4</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">F4df4db0ed86@11</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis 配置内容</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis-config.xml</span> <span class="comment"># 配置 MyBatis 配置文件路径</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span> <span class="comment"># 配置 Mapper XML 地址</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">cn.iocoder.springboot.lab12.mybatis.dataobject</span> <span class="comment"># 配置数据库实体包路径</span></span><br></pre></td></tr></table></figure>



<p>在 <a href="https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-12/lab-12-mybatis-xml/src/main/resources" target="_blank" rel="noopener"><code>resources</code></a> 目录下，创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-12/lab-12-mybatis-xml/src/main/resources/mybatis-config.xml" target="_blank" rel="noopener"><code>mybatis-config.xml</code></a> 配置文件。配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用驼峰命名法转换字段。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Integer"</span> <span class="attr">type</span>=<span class="string">"java.lang.Integer"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Long"</span> <span class="attr">type</span>=<span class="string">"java.lang.Long"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"HashMap"</span> <span class="attr">type</span>=<span class="string">"java.util.HashMap"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"LinkedHashMap"</span> <span class="attr">type</span>=<span class="string">"java.util.LinkedHashMap"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"ArrayList"</span> <span class="attr">type</span>=<span class="string">"java.util.ArrayList"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"LinkedList"</span> <span class="attr">type</span>=<span class="string">"java.util.LinkedList"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>因为在数据库中的表的字段，是使用下划线风格，而数据库实体的字段使用驼峰风格，所以通过 <code>mapUnderscoreToCamelCase = true</code> 来自动转换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserMapper.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insert</span><span class="params">(UserDO user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateById</span><span class="params">(UserDO user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>; <span class="comment">// 生产请使用标记删除，除非有点想不开，嘿嘿。</span></span><br><span class="line"></span><br><span class="line">    <span class="function">UserDO <span class="title">selectById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">UserDO <span class="title">selectByUsername</span><span class="params">(@Param(<span class="string">"username"</span>)</span> String username)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;UserDO&gt; <span class="title">selectByIds</span><span class="params">(@Param(<span class="string">"ids"</span>)</span>Collection&lt;Integer&gt; ids)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@Repository</code> 注解，用于标记是数据访问 Bean 对象。在 MyBatis 的接口，实际<strong>非必须</strong>，只是为了避免在 Service 中，<code>@Autowired</code> 注入时无需报警。</li>
<li><code>@Param</code> 注解，声明变量名。<ul>
<li>在方法为单参数时，<strong>非必须</strong>。</li>
<li>在方法为多参数时，<strong>必须</strong>。</li>
</ul>
</li>
<li><code>#selectByUsername(@Param(&quot;username&quot;) String username)</code> 等方法，是使用 <em>By</em> 字段结尾。一般情况下，在 SQL 中的 <code>WHERE</code> 条件字段，建议能够带在方法名后。原因无它，简单明了。如果是多个字段，可以使用 <em>AND</em> 分隔。当然，如果查询字段比较多，可能方法名会比较长。</li>
</ul>
<p>在 <a href="https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-12/lab-12-mybatis-xml/src/main/resources/mapper" target="_blank" rel="noopener"><code>resources/mapper</code></a> 路径下，创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-12/lab-12-mybatis-xml/src/main/resources/mapper/UserMapper.xml" target="_blank" rel="noopener"><code>UserMapper.xml</code></a> 配置文件。代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"cn.iocoder.springboot.lab12.mybatis.mapper.UserMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"FIELDS"</span>&gt;</span></span><br><span class="line">        id, username, password, create_time</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert"</span> <span class="attr">parameterType</span>=<span class="string">"UserDO"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        INSERT INTO users (</span><br><span class="line">          username, password, create_time</span><br><span class="line">        ) VALUES (</span><br><span class="line">          #&#123;username&#125;, #&#123;password&#125;, #&#123;createTime&#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateById"</span> <span class="attr">parameterType</span>=<span class="string">"UserDO"</span>&gt;</span></span><br><span class="line">        UPDATE users</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null"</span>&gt;</span></span><br><span class="line">                , username = #&#123;username&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"password != null"</span>&gt;</span></span><br><span class="line">                , password = #&#123;password&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteById"</span> <span class="attr">parameterType</span>=<span class="string">"Integer"</span>&gt;</span></span><br><span class="line">        DELETE FROM users</span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectById"</span> <span class="attr">parameterType</span>=<span class="string">"Integer"</span> <span class="attr">resultType</span>=<span class="string">"UserDO"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"FIELDS"</span> /&gt;</span></span><br><span class="line">        FROM users</span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectByUsername"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span> <span class="attr">resultType</span>=<span class="string">"UserDO"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"FIELDS"</span> /&gt;</span></span><br><span class="line">        FROM users</span><br><span class="line">        WHERE username = #&#123;username&#125;</span><br><span class="line">        LIMIT 1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectByIds"</span> <span class="attr">resultType</span>=<span class="string">"UserDO"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"FIELDS"</span> /&gt;</span></span><br><span class="line">        FROM users</span><br><span class="line">        WHERE id IN</span><br><span class="line">            <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"id"</span> <span class="attr">collection</span>=<span class="string">"ids"</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">close</span>=<span class="string">")"</span> <span class="attr">index</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                #&#123;id&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>建议 1 ：对于绝大多数查询，我们是返回统一字段，所以可以使用 <code>&lt;sql /&gt;</code> 标签，定义 SQL 段。对于性能或者查询字段比较大的查询，按需要的字段查询。</li>
<li>建议 2 ：对于数据库的关键字，使用大写。例如说，<code>SELECT</code>、<code>WHERE</code> 等等。</li>
<li>建议 3 ：基本是每“块”数据库关键字占用一行</li>
</ul>
<h2 id="2-MyBatis-注解"><a href="#2-MyBatis-注解" class="headerlink" title="2. MyBatis + 注解"></a>2. MyBatis + 注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserMapper.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"INSERT INTO users(username, password, create_time) VALUES(#&#123;username&#125;, #&#123;password&#125;, #&#123;createTime&#125;)"</span>)</span><br><span class="line">    <span class="meta">@Options</span>(useGeneratedKeys = <span class="keyword">true</span>, keyProperty = <span class="string">"id"</span>, keyColumn = <span class="string">"id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insert</span><span class="params">(UserDO user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span>(value = &#123;</span><br><span class="line">            <span class="string">"&lt;script&gt;"</span>,</span><br><span class="line">            <span class="string">"UPDATE users"</span>,</span><br><span class="line">            <span class="string">"&lt;set&gt;"</span>,</span><br><span class="line">            <span class="string">"&lt;if test='username != null'&gt;, username = #&#123;username&#125;&lt;/if&gt;"</span>,</span><br><span class="line">            <span class="string">"&lt;if test='password != null'&gt;, password = #&#123;password&#125;&lt;/if&gt;"</span>,</span><br><span class="line">            <span class="string">"&lt;/set&gt;"</span>,</span><br><span class="line">            <span class="string">"&lt;/script&gt;"</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateById</span><span class="params">(UserDO user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"DELETE FROM users WHERE id = #&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>; <span class="comment">// 生产请使用标记删除，除非有点想不开，嘿嘿。</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT username, password, create_time FROM users WHERE id = #&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">UserDO <span class="title">selectById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT username, password, create_time FROM users WHERE username = #&#123;username&#125;"</span>)</span><br><span class="line">    <span class="function">UserDO <span class="title">selectByUsername</span><span class="params">(@Param(<span class="string">"username"</span>)</span> String username)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(value = &#123;</span><br><span class="line">            <span class="string">"&lt;script&gt;"</span>,</span><br><span class="line">            <span class="string">"SELECT username, password, create_time FROM users"</span>,</span><br><span class="line">            <span class="string">"WHERE id IN"</span>,</span><br><span class="line">            <span class="string">"&lt;foreach item='id' collection='ids' separator=',' open='(' close=')' index=''&gt;"</span>,</span><br><span class="line">            <span class="string">"#&#123;id&#125;"</span>,</span><br><span class="line">            <span class="string">"&lt;/foreach&gt;"</span>,</span><br><span class="line">            <span class="string">"&lt;/script&gt;"</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function">List&lt;UserDO&gt; <span class="title">selectByIds</span><span class="params">(@Param(<span class="string">"ids"</span>)</span> Collection&lt;Integer&gt; ids)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-MyBatis-Plus"><a href="#3-MyBatis-Plus" class="headerlink" title="3. MyBatis-Plus"></a>3. MyBatis-Plus</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 实现对 MyBatis Plus 的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://47.112.193.81:3306/testb5f4?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">testb5f4</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">F4df4db0ed86@11</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis-plus 配置内容</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span> <span class="comment"># 虽然默认为 true ，但是还是显示去指定下。</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span> <span class="comment"># ID 主键自增</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span> <span class="comment"># 逻辑已删除值(默认为 1)</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span> <span class="comment"># 逻辑未删除值(默认为 0)</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">cn.iocoder.springboot.lab12.mybatis.dataobject</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># logging</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># dao 开启 debug 模式 mybatis 输入 sql</span></span><br><span class="line">    <span class="attr">cn:</span></span><br><span class="line">      <span class="attr">iocoder:</span></span><br><span class="line">        <span class="attr">springboot:</span></span><br><span class="line">          <span class="attr">lab12:</span></span><br><span class="line">            <span class="attr">mybatis:</span></span><br><span class="line">              <span class="attr">mapper:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserDO.java</span></span><br><span class="line"><span class="meta">@TableName</span>(value = <span class="string">"users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码（明文）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ps：生产环境下，千万不要明文噢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableLogic</span></span><br><span class="line">    <span class="keyword">private</span> Integer deleted;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略 setting/getting 方法</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加了 <a href="https://mybatis.plus/guide/annotation.html#tablename" target="_blank" rel="noopener"><code>@TableName</code></a> 注解，设置了 UserDO 对应的表名是 <code>users</code> 。毕竟，我们要使用 MyBatis-Plus 给咱自动生成 CRUD 操作。</li>
<li>增加了 <code>deleted</code> 字段，并添加了 <code>@TableLogic</code> 注解，设置该字段为逻辑删除的标记。<ul>
<li>在 <code>application.yaml</code> 配置文件中，我们配置了删除（<code>logic-delete-value = 1</code>）和未删除（<code>logic-not-delete-value = 0</code>）。当然，也可以通过注解的 <code>value</code> 和 <code>delval</code> 来定义未删除和删除。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserMapper.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">UserDO</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> UserDO <span class="title">selectByUsername</span><span class="params">(@Param(<span class="string">"username"</span>)</span> String username) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> selectOne(<span class="keyword">new</span> QueryWrapper&lt;UserDO&gt;().eq(<span class="string">"username"</span>, username));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;UserDO&gt; <span class="title">selectByIds</span><span class="params">(@Param(<span class="string">"ids"</span>)</span> Collection&lt;Integer&gt; ids)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> IPage&lt;UserDO&gt; <span class="title">selectPageByCreateTime</span><span class="params">(IPage&lt;UserDO&gt; page, @Param(<span class="string">"createTime"</span>)</span> Date createTime) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> selectPage(page,</span><br><span class="line">                <span class="keyword">new</span> QueryWrapper&lt;UserDO&gt;().gt(<span class="string">"create_time"</span>, createTime));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/11/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-MyBatis%E5%85%A5%E9%97%A8/" data-id="ckbg9kucv001e2r07bcoq5stt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据访问-SpringBoot-数据库连接池入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/10/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-10T06:06:35.000Z" itemprop="datePublished">2020-06-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/10/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-数据库连接池入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-数据库连接池入门"><a href="#Spring-Boot-数据库连接池入门" class="headerlink" title="Spring Boot 数据库连接池入门"></a>Spring Boot 数据库连接池入门</h1><p>在目前数据库连接池的选型中，主要是</p>
<ul>
<li><a href="https://github.com/alibaba/druid" target="_blank" rel="noopener">Druid</a> ，为<strong>监控</strong>而生的数据库连接池。</li>
<li><a href="https://github.com/brettwooldridge/HikariCP" target="_blank" rel="noopener">HikariCP</a> ，号称<strong>性能</strong>最好的数据库连接池。</li>
</ul>
<h2 id="1-HikariCP-数据源"><a href="#1-HikariCP-数据源" class="headerlink" title="1. HikariCP 数据源"></a>1. HikariCP 数据源</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容，对应 DataSourceProperties 配置属性类</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span> <span class="comment"># 数据库账号</span></span><br><span class="line">    <span class="attr">password:</span> <span class="comment"># 数据库密码</span></span><br><span class="line">    <span class="comment"># HikariCP 自定义配置，对应 HikariConfig 配置属性类</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">minimum-idle:</span> <span class="number">10</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 10 个。</span></span><br><span class="line">      <span class="attr">maximum-pool-size:</span> <span class="number">10</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 10 个。</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">配置项</th>
<th align="left">描述</th>
<th align="left">构造器默认值</th>
<th align="left">默认配置validate之后的值</th>
<th align="left">validate重置</th>
</tr>
</thead>
<tbody><tr>
<td align="left">autoCommit</td>
<td align="left">自动提交从池中返回的连接</td>
<td align="left">true</td>
<td align="left">true</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">connectionTimeout</td>
<td align="left">等待来自池的连接的最大毫秒数</td>
<td align="left">SECONDS.toMillis(30) = 30000</td>
<td align="left">30000</td>
<td align="left">如果小于250毫秒，则被重置回30秒</td>
</tr>
<tr>
<td align="left">idleTimeout</td>
<td align="left">连接允许在池中闲置的最长时间</td>
<td align="left">MINUTES.toMillis(10) = 600000</td>
<td align="left">600000</td>
<td align="left">如果idleTimeout+1秒&gt;maxLifetime 且 maxLifetime&gt;0，则会被重置为0（代表永远不会退出）；如果idleTimeout!=0且小于10秒，则会被重置为10秒</td>
</tr>
<tr>
<td align="left">maxLifetime</td>
<td align="left">池中连接最长生命周期</td>
<td align="left">MINUTES.toMillis(30) = 1800000</td>
<td align="left">1800000</td>
<td align="left">如果不等于0且小于30秒则会被重置回30分钟</td>
</tr>
<tr>
<td align="left">connectionTestQuery</td>
<td align="left">如果您的驱动程序支持JDBC4，我们强烈建议您不要设置此属性</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">minimumIdle</td>
<td align="left">池中维护的最小空闲连接数</td>
<td align="left">-1</td>
<td align="left">10</td>
<td align="left">minIdle&lt;0或者minIdle&gt;maxPoolSize,则被重置为maxPoolSize</td>
</tr>
<tr>
<td align="left">maximumPoolSize</td>
<td align="left">池中最大连接数，包括闲置和使用中的连接</td>
<td align="left">-1</td>
<td align="left">10</td>
<td align="left">如果maxPoolSize小于1，则会被重置。当minIdle&lt;=0被重置为DEFAULT_POOL_SIZE则为10;如果minIdle&gt;0则重置为minIdle的值</td>
</tr>
<tr>
<td align="left">metricRegistry</td>
<td align="left">该属性允许您指定一个 Codahale / Dropwizard <code>MetricRegistry</code> 的实例，供池使用以记录各种指标</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">healthCheckRegistry</td>
<td align="left">该属性允许您指定池使用的Codahale / Dropwizard HealthCheckRegistry的实例来报告当前健康信息</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">poolName</td>
<td align="left">连接池的用户定义名称，主要出现在日志记录和JMX管理控制台中以识别池和池配置</td>
<td align="left">null</td>
<td align="left">HikariPool-1</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">initializationFailTimeout</td>
<td align="left">如果池无法成功初始化连接，则此属性控制池是否将 <code>fail fast</code></td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">isolateInternalQueries</td>
<td align="left">是否在其自己的事务中隔离内部池查询，例如连接活动测试</td>
<td align="left">false</td>
<td align="left">false</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">allowPoolSuspension</td>
<td align="left">控制池是否可以通过JMX暂停和恢复</td>
<td align="left">false</td>
<td align="left">false</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">readOnly</td>
<td align="left">从池中获取的连接是否默认处于只读模式</td>
<td align="left">false</td>
<td align="left">false</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">registerMbeans</td>
<td align="left">是否注册JMX管理Bean（<code>MBeans</code>）</td>
<td align="left">false</td>
<td align="left">false</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">catalog</td>
<td align="left">为支持 <code>catalog</code> 概念的数据库设置默认 <code>catalog</code></td>
<td align="left">driver default</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">connectionInitSql</td>
<td align="left">该属性设置一个SQL语句，在将每个新连接创建后，将其添加到池中之前执行该语句。</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">driverClassName</td>
<td align="left">HikariCP将尝试通过仅基于jdbcUrl的DriverManager解析驱动程序，但对于一些较旧的驱动程序，还必须指定driverClassName</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">transactionIsolation</td>
<td align="left">控制从池返回的连接的默认事务隔离级别</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">validationTimeout</td>
<td align="left">连接将被测试活动的最大时间量</td>
<td align="left">SECONDS.toMillis(5) = 5000</td>
<td align="left">5000</td>
<td align="left">如果小于250毫秒，则会被重置回5秒</td>
</tr>
<tr>
<td align="left">leakDetectionThreshold</td>
<td align="left">记录消息之前连接可能离开池的时间量，表示可能的连接泄漏</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">如果大于0且不是单元测试，则进一步判断：(leakDetectionThreshold &lt; SECONDS.toMillis(2) or (leakDetectionThreshold &gt; maxLifetime &amp;&amp; maxLifetime &gt; 0)，会被重置为0 . 即如果要生效则必须&gt;0，而且不能小于2秒，而且当maxLifetime &gt; 0时不能大于maxLifetime</td>
</tr>
<tr>
<td align="left">dataSource</td>
<td align="left">这个属性允许你直接设置数据源的实例被池包装，而不是让HikariCP通过反射来构造它</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">schema</td>
<td align="left">该属性为支持模式概念的数据库设置默认模式</td>
<td align="left">driver default</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">threadFactory</td>
<td align="left">此属性允许您设置将用于创建池使用的所有线程的java.util.concurrent.ThreadFactory的实例。</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">scheduledExecutor</td>
<td align="left">此属性允许您设置将用于各种内部计划任务的java.util.concurrent.ScheduledExecutorService实例</td>
<td align="left">null</td>
<td align="left">null</td>
<td align="left">-</td>
</tr>
</tbody></table>
<h2 id="2-HikariCP-多数据源"><a href="#2-HikariCP-多数据源" class="headerlink" title="2. HikariCP 多数据源"></a>2. HikariCP 多数据源</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 订单数据源配置</span></span><br><span class="line">    <span class="attr">orders:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test_orders?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="comment"># HikariCP 自定义配置，对应 HikariConfig 配置属性类</span></span><br><span class="line">      <span class="attr">hikari:</span></span><br><span class="line">        <span class="attr">minimum-idle:</span> <span class="number">20</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 10 个。</span></span><br><span class="line">        <span class="attr">maximum-pool-size:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 10 个。</span></span><br><span class="line">    <span class="comment"># 用户数据源配置</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test_users?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="comment"># HikariCP 自定义配置，对应 HikariConfig 配置属性类</span></span><br><span class="line">      <span class="attr">hikari:</span></span><br><span class="line">        <span class="attr">minimum-idle:</span> <span class="number">15</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 10 个。</span></span><br><span class="line">        <span class="attr">maximum-pool-size:</span> <span class="number">15</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 10 个。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DataSourceConfig.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 orders 数据源的配置对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"ordersDataSourceProperties"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.orders"</span>) <span class="comment">// 读取 spring.datasource.orders 配置到 DataSourceProperties 对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceProperties <span class="title">ordersDataSourceProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 orders 数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"ordersDataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.orders.hikari"</span>) <span class="comment">// 读取 spring.datasource.orders 配置到 HikariDataSource 对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">ordersDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// &lt;1.1&gt; 获得 DataSourceProperties 对象</span></span><br><span class="line">        DataSourceProperties properties =  <span class="keyword">this</span>.ordersDataSourceProperties();</span><br><span class="line">        <span class="comment">// &lt;1.2&gt; 创建 HikariDataSource 对象</span></span><br><span class="line">        <span class="keyword">return</span> createHikariDataSource(properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 users 数据源的配置对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"usersDataSourceProperties"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.users"</span>) <span class="comment">// 读取 spring.datasource.users 配置到 DataSourceProperties 对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceProperties <span class="title">usersDataSourceProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 users 数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"usersDataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.users.hikari"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">usersDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获得 DataSourceProperties 对象</span></span><br><span class="line">        DataSourceProperties properties =  <span class="keyword">this</span>.usersDataSourceProperties();</span><br><span class="line">        <span class="comment">// 创建 HikariDataSource 对象</span></span><br><span class="line">        <span class="keyword">return</span> createHikariDataSource(properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HikariDataSource <span class="title">createHikariDataSource</span><span class="params">(DataSourceProperties properties)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 HikariDataSource 对象</span></span><br><span class="line">        HikariDataSource dataSource = properties.initializeDataSourceBuilder().type(HikariDataSource<span class="class">.<span class="keyword">class</span>).<span class="title">build</span>()</span>;</span><br><span class="line">        <span class="comment">// 设置线程池名</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(properties.getName())) &#123;</span><br><span class="line">            dataSource.setPoolName(properties.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>#ordersDataSourceProperties()</code> 方法，创建 <code>&quot;orders&quot;</code> 数据源的 DataSourceProperties 配置对象。<ul>
<li><a href="http://www.yihaomen.com/article/java/581.htm" target="_blank" rel="noopener"><code>@Primary</code></a> 注解，保证项目中有一个<strong>主</strong>的 DataSourceProperties Bean 。</li>
<li><code>new DataSourceProperties()</code> 代码段，会创建一个 DataSourceProperties 数据源的配置对象。</li>
<li>搭配上 <code>@Bean(name = &quot;ordersDataSourceProperties&quot;)</code> 注解，会创建一个名字为 <code>&quot;ordersDataSourceProperties&quot;</code> 的 DataSourceProperties Bean 。</li>
<li><code>@ConfigurationProperties(prefix = &quot;spring.datasource.orders&quot;)</code> 注解，会将 <code>&quot;spring.datasource.orders&quot;</code> 配置项，逐个属性赋值给 DataSourceProperties Bean 。</li>
</ul>
</li>
<li><code>#ordersDataSource()</code> 方法，创建 <code>orders</code> 数据源。<ul>
<li><code>&lt;1.1&gt;</code> 处，调用 <code>#ordersDataSourceProperties()</code> 方法，获得 <code>orders</code> 数据源的 DataSourceProperties 。</li>
<li><code>&lt;1.2&gt;</code> 处，调用 <code>#createHikariDataSource(DataSourceProperties properties)</code> 方法，创建 HikariDataSource 对象。这样，<code>&quot;spring.datasource.orders&quot;</code> 配置项，逐个属性赋值给 HikariDataSource Bean 。</li>
<li>搭配上 <code>@Bean(name = &quot;ordersDataSource&quot;)</code> 注解，会创建一个名字为 <code>&quot;ordersDataSource&quot;</code> 的 HikariDataSource Bean 。</li>
<li><code>@ConfigurationProperties(prefix = &quot;spring.datasource.orders.hikari&quot;)</code> 注解，会将 HikariCP 的 <code>&quot;spring.datasource.orders.hikari&quot;</code> 自定义配置项，逐个属性赋值给 HikariDataSource Bean </li>
</ul>
</li>
</ul>
<h2 id="3-Druid-单数据源"><a href="#3-Druid-单数据源" class="headerlink" title="3. Druid 单数据源"></a>3. Druid 单数据源</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 实现对 Druid 连接池的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容，对应 DataSourceProperties 配置属性类</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span> <span class="comment"># 数据库账号</span></span><br><span class="line">    <span class="attr">password:</span> <span class="comment"># 数据库密码</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 设置类型为 DruidDataSource</span></span><br><span class="line">    <span class="comment"># Druid 自定义配置，对应 DruidDataSource 中的 setting 方法的属性</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 0 个。</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 8 个。</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span> <span class="comment"># 配置 StatFilter ，对应文档 https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatFilter</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span> <span class="comment"># 开启慢查询记录</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">5000</span> <span class="comment"># 慢 SQL 的标准，单位：毫秒</span></span><br><span class="line">      <span class="attr">stat-view-servlet:</span> <span class="comment"># 配置 StatViewServlet ，对应文档 https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatViewServlet%E9%85%8D%E7%BD%AE</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 是否开启 StatViewServlet</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">yudaoyuanma</span> <span class="comment"># 账号</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="string">javaniubi</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>spring.datasource</code> 配置项，设置 Spring 数据源的通用配置。其中，<code>spring.datasource.type</code> 配置项，<strong>需要主动</strong>设置使用 DruidDataSource 。因为默认情况下，<code>spring-boot-starter-jdbc</code> 的 <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/jdbc/DataSourceBuilder.java#L49-L50" target="_blank" rel="noopener">DataSourceBuilder</a> 会按照 <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/jdbc/DataSourceBuilder.java#L49-L50" target="_blank" rel="noopener"><code>DATA_SOURCE_TYPE_NAMES</code></a> 的顺序，尝试推断数据源的类型。</li>
<li><code>spring.datasource.druid</code> 配置项，设置 Druid 连接池的自定义配置。然后 DruidDataSourceAutoConfigure 会自动化配置 Druid 连接池。<ul>
<li>在 <a href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter#配置属性" target="_blank" rel="noopener">《Druid —— 配置属性》</a> 和 <a href="https://github.com/alibaba/druid/wiki/DruidDataSource配置属性列表" target="_blank" rel="noopener">《DruidDataSource 配置属性列表》</a> 下，提供了各种 Druid 的配置项</li>
<li><code>filter.stat</code> 配置项，配置了 Druid <a href="https://github.com/alibaba/druid/blob/master/src/main/java/com/alibaba/druid/filter/stat/StatFilter.java" target="_blank" rel="noopener">StatFilter</a> ，用于统计监控信息。对应文档 <a href="https://github.com/alibaba/druid/wiki/配置_StatFilter" target="_blank" rel="noopener">《Druid —— 配置_StatFilter》</a> 。要注意，StatFilter 并不是 <a href="https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/Filter.java" target="_blank" rel="noopener"><code>javax.servlet.Filter</code></a> ，而是 Druid 提供的 <a href="https://github.com/alibaba/druid/wiki/配置_Filter配置" target="_blank" rel="noopener">Filter</a> 拓展机制。</li>
<li><code>filter.stat-view-servlet</code> 配置项，配置了 Druid <a href="https://github.com/alibaba/druid/blob/master/src/main/java/com/alibaba/druid/support/http/StatViewServlet.java" target="_blank" rel="noopener">StatViewServlet</a> ，用于提供监控信息的<strong>展示的 html 页面</strong>和 <strong>JSON API</strong> 。对应文档 <a href="https://github.com/alibaba/druid/wiki/配置_StatViewServlet配置" target="_blank" rel="noopener">《Druid —— 配置_StatViewServlet 配置》</a> 。StatViewServlet 就是 <a href="https://github.com/javaee/servlet-spec/blob/master/src/main/java/javax/servlet/Servlet.java" target="_blank" rel="noopener"><code>javax.servlet.Filter</code></a> 。</li>
</ul>
</li>
</ul>
<h2 id="4-Druid-多数据源"><a href="#4-Druid-多数据源" class="headerlink" title="4. Druid 多数据源"></a>4. Druid 多数据源</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 订单数据源配置</span></span><br><span class="line">    <span class="attr">orders:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test_orders?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 设置类型为 DruidDataSource</span></span><br><span class="line">      <span class="comment"># Druid 自定义配置，对应 DruidDataSource 中的 setting 方法的属性</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 0 个。</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 8 个。</span></span><br><span class="line">    <span class="comment"># 用户数据源配置</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/test_users?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 设置类型为 DruidDataSource</span></span><br><span class="line">      <span class="comment"># Druid 自定义配置，对应 DruidDataSource 中的 setting 方法的属性</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 0 个。</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 8 个。</span></span><br><span class="line">    <span class="comment"># Druid 自定已配置</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="comment"># 过滤器配置</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span> <span class="comment"># 配置 StatFilter ，对应文档 https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatFilter</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span> <span class="comment"># 开启慢查询记录</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">5000</span> <span class="comment"># 慢 SQL 的标准，单位：毫秒</span></span><br><span class="line">      <span class="comment"># StatViewServlet 配置</span></span><br><span class="line">      <span class="attr">stat-view-servlet:</span> <span class="comment"># 配置 StatViewServlet ，对应文档 https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatViewServlet%E9%85%8D%E7%BD%AE</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 是否开启 StatViewServlet</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">yudaoyuanma</span> <span class="comment"># 账号</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="string">javaniubi</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Druid 的自定义配置，和 <code>url</code>、<code>driver-class-name</code> 等数据源的通用配置放在同一级，这样后续我们只需要使用 <code>@ConfigurationProperties(prefix = &quot;spring.datasource.orders&quot;)</code> 的方式，就能完成 DruidDataSource 的配置属性设置。</li>
<li>在 <code>spring.datasource.druid</code> 配置项下，配置了 <code>filter.stat</code> 和 <code>stat-view-servlet</code> 配置项，用于 Druid 监控功能。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DataSourceConfig.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 orders 数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"ordersDataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.orders"</span>) <span class="comment">// 读取 spring.datasource.orders 配置到 HikariDataSource 对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">ordersDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 users 数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"usersDataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.users"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">usersDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Application.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(Application<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"ordersDataSource"</span>)</span><br><span class="line">    <span class="keyword">private</span> DataSource ordersDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"usersDataSource"</span>)</span><br><span class="line">    <span class="keyword">private</span> DataSource usersDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 启动 Spring Boot 应用</span></span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// orders 数据源</span></span><br><span class="line">        logger.info(<span class="string">"[run][获得数据源：&#123;&#125;]"</span>, ordersDataSource.getClass());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// users 数据源</span></span><br><span class="line">        logger.info(<span class="string">"[run][获得数据源：&#123;&#125;]"</span>, usersDataSource.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/10/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%85%A5%E9%97%A8/" data-id="ckbg9kucx001g2r07dnvu5mlf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">Spring Boot-基础-01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/" rel="tag">数据库连接池</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据访问-SpringBoot-缓存Cache入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/08/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E7%BC%93%E5%AD%98Cache%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-08T03:32:02.000Z" itemprop="datePublished">2020-06-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/08/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E7%BC%93%E5%AD%98Cache%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-缓存Cache入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-缓存-Cache-入门"><a href="#Spring-Boot-缓存-Cache-入门" class="headerlink" title="Spring Boot 缓存 Cache 入门"></a>Spring Boot 缓存 Cache 入门</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><ul>
<li>读写分离。通过将读操作分流到从节点，避免主节点压力过多。</li>
<li>分库分表。通过将读写操作分摊到多个节点，避免单节点压力过多。</li>
<li>缓存。相比数据库来说，缓存往往能够提供更快的读性能，减小数据库的压力。</li>
</ul>
<p>在引入缓存之后，读操作的代码，往往代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserService.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserMapper userMapper; <span class="comment">// 读取 DB</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserCacheDao userCacheDao; <span class="comment">// 读取 Cache</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDO <span class="title">getUser</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从 Cache 中，查询用户信息</span></span><br><span class="line">    UserDO user = userCacheDao.get(id);</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果 Cache 查询不到，从 DB 中读取</span></span><br><span class="line">    user = userMapper.selectById(id);</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123; <span class="comment">// 非空，则缓存到 Cache 中</span></span><br><span class="line">        userCacheDao.put(user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回结果</span></span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这段代码，是比较常用的缓存策略，俗称<strong>“被动写”</strong>。整体步骤如下：<ul>
<li>1）首先，从 Cache 中，读取用户缓存。如果存在，则直接返回。</li>
<li>2）然后，从 DB 中，读取用户数据。如果存在，写入 Cache 中。</li>
<li>3）最后，返回 DB 的查询结果。</li>
</ul>
</li>
</ul>
<p>简单来说，可以像使用 <code>@Transactional</code> 声明式<strong>事务</strong>，使用 Spring Cache 提供的 <code>@Cacheable</code> 等注解， 声明式<strong>缓存</strong>。而在实现原理上，也是基于 Spring AOP 拦截，实现缓存相关的操作。</p>
<p>下面，我们使用 Spring Cache 将 <code>#getUser(Integer id)</code> 方法进行简化。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserService.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDO <span class="title">getUser2</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userMapper.selectById(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserMapper.java</span></span><br><span class="line"><span class="meta">@Cacheable</span>(value = <span class="string">"users"</span>, key = <span class="string">"#id"</span>)</span><br><span class="line"><span class="function">UserDO <span class="title">selectById</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 UserService 的 <code>#getUser2(Integer id)</code> 方法上，我们直接调用 UserMapper ，从 DB 中查询数据。</li>
<li>在 UserMapper 的 <code>#selectById(Integer id)</code> 方法上，有 <code>@Cacheable</code> 注解。Spring Cache 会拦截有 <code>@Cacheable</code> 注解的方法，实现“<strong>被动写</strong>”的逻辑。</li>
</ul>
<h2 id="2-注解"><a href="#2-注解" class="headerlink" title="2. 注解"></a>2. 注解</h2><p>在入门 Spring Cache 之前，先了解下其提供的所有注解：</p>
<ul>
<li><code>@Cacheable</code></li>
<li><code>@CachePut</code></li>
<li><code>@CacheEvict</code></li>
<li><code>@CacheConfig</code></li>
<li><code>@Caching</code></li>
<li><code>@EnableCaching</code></li>
</ul>
<h3 id="2-1-Cacheable"><a href="#2-1-Cacheable" class="headerlink" title="2.1 @Cacheable"></a>2.1 @Cacheable</h3><p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/cache/annotation/Cacheable.java" target="_blank" rel="noopener"><code>@Cacheable</code></a> 注解，添加在方法上，缓存方法的执行结果。执行过程如下：</p>
<ul>
<li>1）首先，判断方法执行结果的缓存。如果有，则直接返回该缓存结果。</li>
<li>2）然后，执行方法，获得方法结果。</li>
<li>3）之后，根据是否满足缓存的条件。如果满足，则缓存方法结果到缓存。</li>
<li>4）最后，返回方法结果。</li>
</ul>
<p><code>@Cacheable</code> 注解的<strong>常用属性</strong>，如下：</p>
<ul>
<li><code>cacheNames</code> 属性：缓存名。<strong>必填</strong>。<code>[]</code> 数组，可以填写多个缓存名。</li>
<li><code>values</code> 属性：和 <code>cacheNames</code> 属性相同，是它的别名。</li>
<li><code>key</code> 属性：缓存的 key 。允许空。<ul>
<li>如果为空，则默认方法的所有参数进行组合。</li>
<li>如果非空，则需要按照 <a href="http://itmyhome.com/spring/expressions.html" target="_blank" rel="noopener">SpEL(Spring Expression Language)</a> 来配置。例如说，<code>@Cacheable(value = &quot;users&quot;, key = &quot;#id&quot;)</code> ，使用方法参数 <code>id</code> 的值作为缓存的 key 。</li>
</ul>
</li>
<li><code>condition</code> 属性：基于方法入参，判断要缓存的条件。允许空。<ul>
<li>如果为空，则不进行入参的判断。</li>
<li>如果非空，则需要按照 <a href="http://itmyhome.com/spring/expressions.html" target="_blank" rel="noopener">SpEL(Spring Expression Language)</a> 来配置。例如说，<code>@Cacheable(condition=&quot;#id &gt; 0&quot;)</code> ，需要传入的 <code>id</code> 大于零。</li>
</ul>
</li>
<li><code>unless</code> 属性：基于方法返回，判断不缓存的条件。允许空。<ul>
<li>如果为空，则不进行入参的判断。</li>
<li>如果非空，则需要按照 <a href="http://itmyhome.com/spring/expressions.html" target="_blank" rel="noopener">SpEL(Spring Expression Language)</a> 来配置。例如说，<code>@Cacheable(unless=&quot;#result == null&quot;)</code> ，如果返回结果为 <code>null</code> ，则不进行缓存。</li>
<li>要注意，<code>condition</code> 和 <code>unless</code> 都是条件属性，差别在于前者针对入参，后者针对结果。</li>
</ul>
</li>
</ul>
<h3 id="2-2-CachePut"><a href="#2-2-CachePut" class="headerlink" title="2.2 @CachePut"></a>2.2 @CachePut</h3><p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/cache/annotation/CachePut.java" target="_blank" rel="noopener"><code>@CachePut</code></a> 注解，添加在方法上，缓存方法的执行结果。不同于 <code>@Cacheable</code> 注解，它的执行过程如下：</p>
<ul>
<li>1）首先，执行方法，获得方法结果。<strong>也就是说，无论是否有缓存，都会执行方法</strong>。</li>
<li>2）然后，根据是否满足缓存的条件。如果满足，则缓存方法结果到缓存。</li>
<li>3）最后，返回方法结果。</li>
</ul>
<p>一般来说，使用方式如下：</p>
<ul>
<li><code>@Cacheable</code>：搭配<strong>读</strong>操作，实现缓存的<strong>被动</strong>写。</li>
<li><code>@CachePut</code>：配置<strong>写</strong>操作，实现缓存的<strong>主动</strong>写。</li>
</ul>
<p><code>@Cacheable</code> 注解的属性，和 <code>@Cacheable</code> 注解的属性，基本<strong>一致</strong>，只少一个 <code>sync</code> 属性。</p>
<h3 id="2-3-CacheEvict"><a href="#2-3-CacheEvict" class="headerlink" title="2.3 @CacheEvict"></a>2.3 @CacheEvict</h3><p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/cache/annotation/CacheEvict.java" target="_blank" rel="noopener"><code>@CacheEvict</code></a> 注解，添加在方法上，删除缓存。</p>
<p>相比 <code>@CachePut</code> 注解，它额外多了两个属性：</p>
<ul>
<li><code>allEntries</code> 属性，是否删除缓存名( <code>cacheNames</code> )下，所有 key 对应的缓存。默认为 <code>false</code> ，只删除指定 key 的缓存。</li>
<li><code>beforeInvocation</code> 属性，是否在方法执行<strong>前</strong>删除缓存。默认为 <code>false</code> ，在方法执行<strong>后</strong>删除缓存。</li>
</ul>
<h3 id="2-4-CacheConfig"><a href="#2-4-CacheConfig" class="headerlink" title="2.4 @CacheConfig"></a>2.4 @CacheConfig</h3><p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/cache/annotation/CacheConfig.java" target="_blank" rel="noopener"><code>@CacheConfig</code></a> 注解，添加在类上，共享如下四个属性的配置：</p>
<ul>
<li><code>cacheNames</code></li>
<li><code>keyGenerator</code></li>
<li><code>cacheManager</code></li>
<li><code>cacheResolver</code></li>
</ul>
<h3 id="2-5-EnableCaching"><a href="#2-5-EnableCaching" class="headerlink" title="2.5 @EnableCaching"></a>2.5 @EnableCaching</h3><p><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/cache/annotation/EnableCaching.java" target="_blank" rel="noopener"><code>@EnableCaching</code></a> 注解，标记开启 Spring Cache 功能，所以一定要添加。</p>
<h2 id="3-Spring-Boot-集成"><a href="#3-Spring-Boot-集成" class="headerlink" title="3. Spring Boot 集成"></a>3. Spring Boot 集成</h2><p>在 Spring Boot 里，提供了 <a href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-cache" target="_blank" rel="noopener"><code>spring-boot-starter-cache</code></a> 库，实现 Spring Cache 的自动化配置，通过 <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/cache/CacheAutoConfiguration.java" target="_blank" rel="noopener">CacheAutoConfiguration</a> 配置类。</p>
<p>在 Java 后端开发中，常见的缓存工具和框架列举如下：</p>
<ul>
<li><p>本地缓存：Guava LocalCache、Ehcache、Caffeine 。</p>
<p><em>Ehcache 的功能更加丰富，Caffeine 的性能要比 Guava LocalCache 好。</em></p>
</li>
<li><p>分布式缓存：Redis、Memcached、Tair 。</p>
<p><em>Redis 最为主流和常用。</em></p>
</li>
</ul>
<h2 id="4-Ehcache-示例"><a href="#4-Ehcache-示例" class="headerlink" title="4. Ehcache 示例"></a>4. Ehcache 示例</h2><p>EhCache 是一个纯 Java 的进程内缓存框架，具有快速、精干等特点，是 Hibernate 中默认的 CacheProvider 。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 实现对数据库连接池的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 本示例，我们使用 MySQL --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 实现对 MyBatis Plus 的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 实现对 Caches 的自动化配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Ehcache 依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.ehcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 方便等会写单元测试 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># datasource 数据源配置内容</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/lab-21-cache-demo?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span></span><br><span class="line">  <span class="comment"># cache 缓存配置内容</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ehcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis-plus 配置内容</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span> <span class="comment"># 虽然默认为 true ，但是还是显示去指定下。</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span> <span class="comment"># ID 主键自增</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span> <span class="comment"># 逻辑已删除值(默认为 1)</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span> <span class="comment"># 逻辑未删除值(默认为 0)</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">cn.iocoder.springboot.lab21.cache.dataobject</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># logging</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># dao 开启 debug 模式 mybatis 输入 sql</span></span><br><span class="line">    <span class="attr">cn:</span></span><br><span class="line">      <span class="attr">iocoder:</span></span><br><span class="line">        <span class="attr">springboot:</span></span><br><span class="line">          <span class="attr">lab21:</span></span><br><span class="line">            <span class="attr">cache:</span></span><br><span class="line">              <span class="attr">mapper:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>spring.datasource</code> 配置项下，设置数据源相关的配置。</li>
<li><code>spring.cache</code> 配置项下，设置 Cache 相关的配置。<ul>
<li><code>type</code> 属性，设置 Cache 使用方案为 Ehcache 。</li>
</ul>
</li>
<li><code>mybatis-plus</code> 配置项下，设置 MyBatis-Plus 相关的配置。</li>
<li><code>logging</code> 配置项，设置打印 SQL 日志，方便查看是否读取了 DB 。</li>
</ul>
<h3 id="4-3-Ehcache-配置文件"><a href="#4-3-Ehcache-配置文件" class="headerlink" title="4.3 Ehcache 配置文件"></a>4.3 Ehcache 配置文件</h3><p>在 <a href="https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-21/lab-21-cache-ehcache/src/main/resources" target="_blank" rel="noopener"><code>resources</code></a> 目录下，创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-21/lab-21-cache-ehcache/src/main/resources/ehcache.xml" target="_blank" rel="noopener"><code>ehcache.xml</code></a> 配置文件。配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"http://ehcache.org/ehcache.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- users 缓存 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- name：缓存名 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- maxElementsInMemory：最大缓存 key 数量 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- timeToLiveSeconds：缓存过期时长，单位：秒 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- memoryStoreEvictionPolicy：缓存淘汰策略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"users"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">maxElementsInMemory</span>=<span class="string">"1000"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">timeToLiveSeconds</span>=<span class="string">"60"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">memoryStoreEvictionPolicy</span>=<span class="string">"LRU"</span>/&gt;</span>  <span class="comment">&lt;!-- 缓存淘汰策略 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Application.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = <span class="string">"cn.iocoder.springboot.lab21.cache.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 <code>@EnableCaching</code> 注解，开启 Spring Cache 功能。</li>
<li>配置 <code>@MapperScan</code> 注解，扫描对应 Mapper 接口所在的包路径。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserMapper.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@CacheConfig</span>(cacheNames = <span class="string">"users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">UserDO</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable</span>(key = <span class="string">"#id"</span>)</span><br><span class="line">    <span class="function">UserDO <span class="title">selectById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CachePut</span>(key = <span class="string">"#user.id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> UserDO <span class="title">insert0</span><span class="params">(UserDO user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 插入记录</span></span><br><span class="line">        <span class="keyword">this</span>.insert(user);</span><br><span class="line">        <span class="comment">// 返回用户</span></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict</span>(key = <span class="string">"#id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在类上，我们添加了 <code>@CacheConfig(cacheNames = &quot;users&quot;)</code> 注解，统一配置该 UserMapper 使用的缓存名为 <code>users</code> 。</li>
<li><code>#selectById(Integer id)</code> 方法，添加了 <code>@Cacheable(key = &quot;#id&quot;)</code> 注解，优先读缓存。</li>
<li><code>#insert0(UserDO user)</code> 方法，添加了 <code>@CachePut(key = &quot;#user.id&quot;)</code> 注解，主动写缓存。</li>
<li><code>#deleteById(Integer id)</code> 方法，添加了 <code>@CacheEvict(key = &quot;#id&quot;)</code> 注解，删除缓存。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/08/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-%E7%BC%93%E5%AD%98Cache%E5%85%A5%E9%97%A8/" data-id="ckbg9kud2001o2r07a9zm6otm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cache/" rel="tag">Cache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">Spring Boot-基础-01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/" rel="tag">数据访问</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据访问-SpringBoot-Redis入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/03/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-Redis%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-06-03T07:43:58.000Z" itemprop="datePublished">2020-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/03/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-Redis%E5%85%A5%E9%97%A8/">数据访问-SpringBoot-Redis入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Spring-Boot-Redis-入门"><a href="#Spring-Boot-Redis-入门" class="headerlink" title="Spring Boot Redis 入门"></a>Spring Boot Redis 入门</h1><h2 id="1-快速入门"><a href="#1-快速入门" class="headerlink" title="1. 快速入门"></a>1. 快速入门</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 实现对 Spring Data Redis 的自动化配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 去掉对 Lettuce 的依赖，因为 Spring Boot 优先使用 Lettuce 作为 Redis 客户端 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 引入 Jedis 的依赖，这样 Spring Boot 实现对 Jedis 的自动化配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 方便等会写单元测试 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 等会示例会使用 fastjson 作为 JSON 序列化的工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.61<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Data Redis 默认使用 Jackson 作为 JSON 序列化的工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 对应 RedisProperties 类</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="comment"># Redis 服务器密码，默认为空。生产中，一定要设置 Redis 密码！</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># Redis 数据库号，默认为 0 。</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span> <span class="comment"># Redis 连接超时时间，单位：毫秒。</span></span><br><span class="line">    <span class="comment"># 对应 RedisProperties.Jedis 内部类</span></span><br><span class="line">    <span class="attr">jedis:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># 连接池最大连接数，默认为 8 。使用负数表示没有限制。</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment"># 默认连接数最小空闲的连接数，默认为 8 。使用负数表示没有限制。</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 默认连接池最小空闲的连接数，默认为 0 。允许设置 0 和 正数。</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="number">-1</span> <span class="comment"># 连接池最大阻塞等待时间，单位：毫秒。默认为 -1 ，表示不限制。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">Test01</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStringSetKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">"yunai"</span>, <span class="string">"shuai"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="1-1-RedisTemplate"><a href="#1-1-RedisTemplate" class="headerlink" title="1.1 RedisTemplate"></a>1.1 RedisTemplate</h3><p><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/RedisTemplate.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.core.RedisTemplate</code></a> 类，从类名上，我们就明明白白知道，提供 Redis 操作模板 API 。核心属性如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisTemplate.java</span></span><br><span class="line"><span class="comment">// 省略了一些不重要的属性。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;1&gt; 序列化相关属性</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>) <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer keySerializer = <span class="keyword">null</span>;</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>) <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer valueSerializer = <span class="keyword">null</span>;</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>) <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer hashKeySerializer = <span class="keyword">null</span>;</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>) <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer hashValueSerializer = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> RedisSerializer&lt;String&gt; stringSerializer = RedisSerializer.string();</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;2&gt; Lua 脚本执行器</span></span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> ScriptExecutor&lt;K&gt; scriptExecutor;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;3&gt; 常见数据结构操作类</span></span><br><span class="line"><span class="comment">// cache singleton objects (where possible)</span></span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> ValueOperations&lt;K, V&gt; valueOps;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> ListOperations&lt;K, V&gt; listOps;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> SetOperations&lt;K, V&gt; setOps;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> ZSetOperations&lt;K, V&gt; zSetOps;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> GeoOperations&lt;K, V&gt; geoOps;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> HyperLogLogOperations&lt;K, V&gt; hllOps;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code> 处，看到了四个序列化相关的属性，用于 KEY 和 VALUE 的序列化。<ul>
<li>例如说，在使用 POJO 对象存储到 Redis 中，一般情况下，会使用 JSON 方式序列化成字符串，存储到 Redis 中。</li>
<li>在上文中，看到了 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/StringRedisTemplate.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.core.StringRedisTemplate</code></a> 类，它继承 RedisTemplate 类，使用 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/StringRedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.StringRedisSerializer</code></a> 字符串序列化方式。</li>
</ul>
</li>
<li><code>&lt;2&gt;</code> 处，Lua 脚本执行器，提供 <a href="http://redis.cn/commands.html#scripting" target="_blank" rel="noopener">Redis scripting</a> API 操作。</li>
<li><code>&lt;3&gt;</code> 处，Redis 常见数据结构操作类。<ul>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/ValueOperations.java" target="_blank" rel="noopener">ValueOperations</a> 类，提供 <a href="http://redis.cn/commands.html#string" target="_blank" rel="noopener">Redis String</a> API 操作。</li>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/ListOperations.java" target="_blank" rel="noopener">ListOperations</a> 类，提供 <a href="http://redis.cn/commands.html#list" target="_blank" rel="noopener">Redis List</a> API 操作。</li>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/SetOperations.java" target="_blank" rel="noopener">SetOperations</a> 类，提供 <a href="http://redis.cn/commands.html#set" target="_blank" rel="noopener">Redis Set</a> API 操作。</li>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/ZSetOperations.java" target="_blank" rel="noopener">ZSetOperations</a> 类，提供 <a href="http://redis.cn/commands.html#sorted_set" target="_blank" rel="noopener">Redis ZSet(Sorted Set)</a> API 操作。</li>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/GeoOperations.java" target="_blank" rel="noopener">GeoOperations</a> 类，提供 <a href="http://redis.cn/commands.html#geo" target="_blank" rel="noopener">Redis Geo</a> API 操作。</li>
<li><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/HyperLogLogOperations.java" target="_blank" rel="noopener">HyperLogLogOperations</a> 类，提供 <a href="http://redis.cn/commands.html#hyperloglog" target="_blank" rel="noopener">Redis HyperLogLog</a> API 操作。</li>
</ul>
</li>
</ul>
<h2 id="2-序列化"><a href="#2-序列化" class="headerlink" title="2. 序列化"></a>2. 序列化</h2><h3 id="2-1-RedisSerializer"><a href="#2-1-RedisSerializer" class="headerlink" title="2.1 RedisSerializer"></a>2.1 RedisSerializer</h3><p><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/RedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.RedisSerializer</code></a> 接口，Redis 序列化接口，用于 Redis KEY 和 VALUE 的序列化。简化代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisSerializer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedisSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">byte</span>[] serialize(<span class="meta">@Nullable</span> T t) <span class="keyword">throws</span> SerializationException;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">T <span class="title">deserialize</span><span class="params">(@Nullable <span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> SerializationException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义了对象 <code>&lt;T&gt;</code> 和二进制数组的转换。</li>
</ul>
<h3 id="2-2-JDK-序列化方式"><a href="#2-2-JDK-序列化方式" class="headerlink" title="2.2 JDK 序列化方式"></a>2.2 JDK 序列化方式</h3><p><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/JdkSerializationRedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.JdkSerializationRedisSerializer</code></a> ，默认情况下，RedisTemplate 使用该数据列化方式。具体的，可以看看 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/RedisTemplate.java" target="_blank" rel="noopener"><code>RedisTemplate#afterPropertiesSet()</code></a> 方法，在 RedisTemplate 未设置序列化的情况下，使用 JdkSerializationRedisSerializer 作为序列化实现。在 Spring Boot 自动化配置 RedisTemplate Bean 对象时，就未设置。</p>
<p>不会使用 JdkSerializationRedisSerializer 进行序列化</p>
<h3 id="2-3-String-序列化方式"><a href="#2-3-String-序列化方式" class="headerlink" title="2.3 String 序列化方式"></a>2.3 String 序列化方式</h3><p>① <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/StringRedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.StringRedisSerializer</code></a> ，字符串和二进制数组的<strong>直接</strong>转换。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StringRedisSerializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Charset charset;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">deserialize</span><span class="params">(@Nullable <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (bytes == <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> String(bytes, charset));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(<span class="meta">@Nullable</span> String string) &#123;</span><br><span class="line">	<span class="keyword">return</span> (string == <span class="keyword">null</span> ? <span class="keyword">null</span> : string.getBytes(charset));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>绝大多数情况下， KEY 和 VALUE 都会使用这种序列化方案</strong>。而 VALUE 的序列化和反序列化，自己在逻辑调用 JSON 方法去序列化。</p>
<p>② <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/GenericToStringSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.GenericToStringSerializer</code></a> ，使用 Spring <a href="https://codeday.me/bug/20180111/117294.html" target="_blank" rel="noopener">ConversionService</a> 实现 <code>&lt;T&gt;</code> 对象和 String 的转换，从而 String 和二进制数组的转换。</p>
<p>例如说，序列化的过程，首先 <code>&lt;T&gt;</code> 对象通过 ConversionService 转换成 String ，然后 String 再序列化成二进制数组。</p>
<p>基本不会用</p>
<h3 id="2-4-JSON-序列化"><a href="#2-4-JSON-序列化" class="headerlink" title="2.4 JSON 序列化"></a>2.4 JSON 序列化</h3><p>① <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/GenericJackson2JsonRedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer</code></a> ，使用 Jackson 实现 JSON 的序列化方式，并且从 Generic 单词可以看出，是支持所有类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GenericJackson2JsonRedisSerializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GenericJackson2JsonRedisSerializer</span><span class="params">(@Nullable String classPropertyTypeName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>(<span class="keyword">new</span> ObjectMapper());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// simply setting &#123;@code mapper.disable(SerializationFeature.FAIL_ON_EMPTY_BEANS)&#125; does not help here since we need</span></span><br><span class="line">	<span class="comment">// the type hint embedded for deserialization using the default typing feature.</span></span><br><span class="line">	mapper.registerModule(<span class="keyword">new</span> SimpleModule().addSerializer(<span class="keyword">new</span> NullValueSerializer(classPropertyTypeName)));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &lt;1&gt;</span></span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasText(classPropertyTypeName)) &#123;</span><br><span class="line">		mapper.enableDefaultTypingAsProperty(DefaultTyping.NON_FINAL, classPropertyTypeName);</span><br><span class="line">	<span class="comment">// &lt;2&gt;</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mapper.enableDefaultTyping(DefaultTyping.NON_FINAL, As.PROPERTY);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code> 处，如果传入了 <code>classPropertyTypeName</code> 属性，就是使用使用传入对象的 <code>classPropertyTypeName</code> 属性对应的值，作为默认类型（Default Typing）。</li>
<li><code>&lt;2&gt;</code> 处，如果未传入 <code>classPropertyTypeName</code> 属性，则使用传入对象的类全名，作为默认类型（Default Typing）。</li>
</ul>
<p>Jackson 通过 Default Typing ，会在字符串多冗余一个类型，这样反序列化就知道具体的类型了。</p>
<ul>
<li><p>标准序列化的结果，如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"芋道源码"</span>,</span><br><span class="line">    <span class="attr">"gender"</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 Jackson Default Typing 机制序列化的结果，如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">       <span class="attr">"@class"</span>: <span class="string">"cn.iocoder.springboot.labs.lab10.springdatarediswithjedis.cacheobject.UserCacheObject"</span>,</span><br><span class="line">       <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">       <span class="attr">"name"</span>: <span class="string">"芋道源码"</span>,</span><br><span class="line">       <span class="attr">"gender"</span>: <span class="number">1</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>@class</code> 属性，它看似完美解决了反序列化后的对象类型，但是带来 JSON 字符串占用变大，所以实际项目中，也并不会采用 Jackson2JsonRedisSerializer 类。</p>
</li>
</ul>
<p>② <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/serializer/GenericJackson2JsonRedisSerializer.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer</code></a> ，使用 Jackson 实现 JSON 的序列化方式，并且显示指定 <code>&lt;T&gt;</code> 类型。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Jackson2JsonRedisSerializer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jackson2JsonRedisSerializer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">RedisSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ... 省略不重要的代码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset DEFAULT_CHARSET = StandardCharsets.UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定类型，和 &lt;T&gt; 要一致。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JavaType javaType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-配置序列化方式"><a href="#3-配置序列化方式" class="headerlink" title="3. 配置序列化方式"></a>3. 配置序列化方式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 RedisTemplate 对象</span></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        <span class="comment">// 设置 RedisConnection 工厂。它就是实现多种 Java Redis 客户端接入的秘密工厂。</span></span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 String 序列化方式，序列化 KEY 。</span></span><br><span class="line">        template.setKeySerializer(RedisSerializer.string());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 JSON 序列化方式（库是 Jackson ），序列化 VALUE 。</span></span><br><span class="line">        template.setValueSerializer(RedisSerializer.json());</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>RedisSerializer#string()</code> 静态方法，返回的就是使用 UTF-8 编码的 StringRedisSerializer 对象。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisSerializer.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> RedisSerializer&lt;String&gt; <span class="title">string</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> StringRedisSerializer.UTF_8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringRedisSerializer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> StringRedisSerializer ISO_8859_1 = <span class="keyword">new</span> StringRedisSerializer(StandardCharsets.ISO_8859_1);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>RedisSerializer#json()</code> 静态方法，返回 GenericJackson2JsonRedisSerializer 对象。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisSerializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> RedisSerializer&lt;Object&gt; <span class="title">json</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> GenericJackson2JsonRedisSerializer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="4-自定义-RedisSerializer-实现类"><a href="#4-自定义-RedisSerializer-实现类" class="headerlink" title="4. 自定义 RedisSerializer 实现类"></a>4. 自定义 RedisSerializer 实现类</h2><p>源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GenericFastJsonRedisSerializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericFastJsonRedisSerializer</span> <span class="keyword">implements</span> <span class="title">RedisSerializer</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ParserConfig defaultRedisConfig = <span class="keyword">new</span> ParserConfig();</span><br><span class="line">    <span class="keyword">static</span> &#123; defaultRedisConfig.setAutoTypeSupport(<span class="keyword">true</span>);&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object object) <span class="keyword">throws</span> SerializationException &#123;</span><br><span class="line">        <span class="comment">// 空，直接返回空数组</span></span><br><span class="line">        <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 使用 JSON 进行序列化成二进制数组，同时通过 SerializerFeature.WriteClassName 参数，声明写入类全名。</span></span><br><span class="line">            <span class="keyword">return</span> JSON.toJSONBytes(object, SerializerFeature.WriteClassName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">"Could not serialize: "</span> + ex.getMessage(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> SerializationException </span>&#123;</span><br><span class="line">        <span class="comment">// 如果为空，则返回空对象</span></span><br><span class="line">        <span class="keyword">if</span> (bytes == <span class="keyword">null</span> || bytes.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 使用 JSON 解析成对象。</span></span><br><span class="line">            <span class="keyword">return</span> JSON.parseObject(<span class="keyword">new</span> String(bytes, IOUtils.UTF8), Object<span class="class">.<span class="keyword">class</span>, <span class="title">defaultRedisConfig</span>)</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">"Could not deserialize: "</span> + ex.getMessage(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-项目实践"><a href="#5-项目实践" class="headerlink" title="5. 项目实践"></a>5. 项目实践</h2><h3 id="5-1-Cache-Object"><a href="#5-1-Cache-Object" class="headerlink" title="5.1 Cache Object"></a>5.1 Cache Object</h3><p>对于复杂的缓存对象，创建了 <code>cacheobject</code> 包，和 <code>dataobject</code> 包同层。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service # 业务逻辑层</span><br><span class="line">dao # 数据库访问层</span><br><span class="line">dataobject # DO</span><br><span class="line">cacheobject # 缓存对象</span><br></pre></td></tr></table></figure>

<p>并且所有的 Cache Object 对象使用 CacheObject 结尾，例如说 UserCacheObject、ProductCacheObject 。</p>
<h3 id="5-2-数据访问层"><a href="#5-2-数据访问层" class="headerlink" title="5.2 数据访问层"></a>5.2 数据访问层</h3><p>在访问数据库时，会创建 <code>dao</code> 包，存放每个 DO 对应的 Dao 对应。那么对于每一个 CacheObject 类，也会创建一个其对应的 Dao 类。例如说，UserCacheObject 对应 UserCacheObjectDao 类。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserCacheDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PATTERN = <span class="string">"user:%d"</span>; <span class="comment">// user:用户编号 &lt;1&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"SpringJavaInjectionPointsAutowiringInspection"</span>)</span><br><span class="line">    <span class="keyword">private</span> ValueOperations&lt;String, String&gt; operations; <span class="comment">// &lt;2&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">buildKey</span><span class="params">(Integer id)</span> </span>&#123; <span class="comment">// &lt;3&gt;</span></span><br><span class="line">        <span class="keyword">return</span> String.format(KEY_PATTERN, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserCacheObject <span class="title">get</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        String key = buildKey(id);</span><br><span class="line">        String value = operations.get(key);</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.parseObject(value, UserCacheObject<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Integer id, UserCacheObject object)</span> </span>&#123;</span><br><span class="line">        String key = buildKey(id);</span><br><span class="line">        String value = JSONUtil.toJSONString(object);</span><br><span class="line">        operations.set(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code> 处，通过静态变量，声明 KEY 的前缀，并且使用冒号作为间隔</li>
<li><code>&lt;2&gt;</code> 处，通过 <code>@Resource</code> 注入指定名字的 RedisTemplate 对应的 Operations 对象，这样明确每个 KEY 的类型。</li>
<li><code>&lt;3&gt;</code> 处，声明 <code>KEY_PATTERN</code> 对应的 KEY 拼接方法，避免散落在每个方法中。</li>
</ul>
<p>将 <code>dao</code> 包下拆成 <code>mysql</code>、<code>redis</code> 包。这样，MySQL 相关的 Dao 放在 <code>mysql</code> 包下，Redis 相关的 Dao 放在 <code>redis</code> 。</p>
<h2 id="6-示例补充"><a href="#6-示例补充" class="headerlink" title="6.  示例补充"></a>6.  示例补充</h2><h3 id="6-1-Pipleline"><a href="#6-1-Pipleline" class="headerlink" title="6.1 Pipleline"></a>6.1 Pipleline</h3><p>在 RedisTemplate 类中，提供了 2 组四个方法，用于执行 Redis Pipeline 操作。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;1&gt; 基于 Session 执行 Pipeline</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">executePipelined</span><span class="params">(SessionCallback&lt;?&gt; session)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> executePipelined(session, valueSerializer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">executePipelined</span><span class="params">(SessionCallback&lt;?&gt; session, @Nullable RedisSerializer&lt;?&gt; resultSerializer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ... 省略代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;2&gt; 直接执行 Pipeline</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">executePipelined</span><span class="params">(RedisCallback&lt;?&gt; action)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> executePipelined(action, valueSerializer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">executePipelined</span><span class="params">(RedisCallback&lt;?&gt; action, @Nullable RedisSerializer&lt;?&gt; resultSerializer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ... 省略代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>两组方法的差异，在于是否是 Session 中执行。</li>
<li>每组方法里，差别在于是否传入 RedisSerializer 参数。如果不传，则使用 RedisTemplate 自己的序列化相关的属性。</li>
</ul>
<h3 id="6-2-源码解读"><a href="#6-2-源码解读" class="headerlink" title="6.2 源码解读"></a>6.2 源码解读</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisTemplate.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">executePipelined</span><span class="params">(RedisCallback&lt;?&gt; action, @Nullable RedisSerializer&lt;?&gt; resultSerializer)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// &lt;1&gt; 执行 Redis 方法</span></span><br><span class="line">	<span class="keyword">return</span> execute((RedisCallback&lt;List&lt;Object&gt;&gt;) connection -&gt; &#123;</span><br><span class="line">		<span class="comment">// &lt;2&gt; 打开 pipeline</span></span><br><span class="line">		connection.openPipeline();</span><br><span class="line">		<span class="keyword">boolean</span> pipelinedClosed = <span class="keyword">false</span>; <span class="comment">// 标记 pipeline 是否关闭</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// &lt;3&gt; 执行</span></span><br><span class="line">			Object result = action.doInRedis(connection);</span><br><span class="line">			<span class="comment">// &lt;4&gt; 不要返回结果</span></span><br><span class="line">			<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> InvalidDataAccessApiUsageException(</span><br><span class="line">						<span class="string">"Callback cannot return a non-null value as it gets overwritten by the pipeline"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// &lt;5&gt; 提交 pipeline 执行</span></span><br><span class="line">			List&lt;Object&gt; closePipeline = connection.closePipeline();</span><br><span class="line">			pipelinedClosed = <span class="keyword">true</span>;</span><br><span class="line">			<span class="comment">// &lt;6&gt; 反序列化结果，并返回</span></span><br><span class="line">			<span class="keyword">return</span> deserializeMixedResults(closePipeline, resultSerializer, hashKeySerializer, hashValueSerializer);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (!pipelinedClosed) &#123;</span><br><span class="line">				connection.closePipeline();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code> 处，调用 <code>#execute(RedisCallback&lt;T&gt; action)</code> 方法，执行 Redis 方法。注意，此处传入的 <code>action</code> 参数，不是传入的 RedisCallback 参数。传入的会在该 <code>action</code> 中被执行。</li>
<li><code>&lt;2&gt;</code> 处，调用 <code>RedisConnection#openPipeline()</code> 方法，<strong>自动</strong>打开 Pipeline 模式。这样，就不需要手动去打开了。</li>
<li><code>&lt;3&gt;</code> 处，调用传入的实现的 <code>RedisCallback#doInRedis(RedisConnection connection)</code> 方法，执行在 Pipeline 中，想要执行的 Redis 操作。</li>
<li><code>&lt;4&gt;</code> 处，不要返回结果。因为 RedisCallback 是统一定义的接口，所以可以返回一个结果。但是在 Pipeline 中，未提交执行时，显然是没有结果，返回也没有意思。简单来说，就是在实现 <code>RedisCallback#doInRedis(RedisConnection connection)</code> 方法时，返回 <code>null</code> 即可。</li>
<li><code>&lt;5&gt;</code> 处，调用 <code>RedisConnection#closePipeline()</code> 方法，<strong>自动</strong>提交 Pipeline 执行，并返回执行结果。</li>
<li><code>&lt;6&gt;</code> 处，反序列化结果，并返回 Pipeline 结果。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisCallback.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedisCallback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Gets called by &#123;<span class="doctag">@link</span> RedisTemplate&#125; with an active Redis connection. Does not need to care about activating or</span></span><br><span class="line"><span class="comment">	 * closing the connection or handling exceptions.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> connection active Redis connection</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a result object or &#123;<span class="doctag">@code</span> null&#125; if none</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> DataAccessException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">T <span class="title">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>虽然接口名是以 Callback 结尾，但是通过 <code>#doInRedis(RedisConnection connection)</code> 方法可以很容易知道，实际可以理解是 Redis Action ，想要执行的 Redis 操作。</p>
</li>
<li><p>有一点要注意，传入的 <code>connection</code> 参数是 RedisConnection 对象，它提供的 <code>&#39;low level&#39;</code> 更底层的 Redis API 操作。例如说：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisStringCommands.java</span></span><br><span class="line"><span class="comment">// RedisConnection 实现 RedisStringCommands 接口</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span>[] get(<span class="keyword">byte</span>[] key);</span><br><span class="line"></span><br><span class="line"><span class="function">Boolean <span class="title">set</span><span class="params">(<span class="keyword">byte</span>[] key, <span class="keyword">byte</span>[] value)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>传入和返回的是二进制数组，实际就是 RedisTemplate 已经序列化的入参和会被反序列化的出参。</li>
</ul>
</li>
</ul>
<h3 id="6-3-具体示例"><a href="#6-3-具体示例" class="headerlink" title="6.3 具体示例"></a>6.3 具体示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PipelineTest.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">PipelineTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Object&gt; results = stringRedisTemplate.executePipelined(<span class="keyword">new</span> RedisCallback&lt;Object&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">                <span class="comment">// set 写入</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                    connection.set(String.format(<span class="string">"yunai:%d"</span>, i).getBytes(), <span class="string">"shuai"</span>.getBytes());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// get</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                    connection.get(String.format(<span class="string">"yunai:%d"</span>, i).getBytes());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 返回 null 即可</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印结果</span></span><br><span class="line">        System.out.println(results);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>#test01()</code> 方法，结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, shuai, shuai, shuai]</span><br></pre></td></tr></table></figure>



<h2 id="7-Session"><a href="#7-Session" class="headerlink" title="7. Session"></a>7. Session</h2><p>Session 不是 Redis 的功能，而是 Spring Data Redis 封装的一个功能。一次 Session ，代表通过同一个 Redis Connection 执行一系列的 Redis 操作。</p>
<p>当我们要执行在同一个 Session 里的操作时，我们通过实现 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/SessionCallback.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.core.SessionCallback</code></a> 接口，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SessionCallback.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SessionCallback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	&lt;K, V&gt; <span class="function">T <span class="title">execute</span><span class="params">(RedisOperations&lt;K, V&gt; operations)</span> <span class="keyword">throws</span> DataAccessException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>相比 RedisCallback 来说，总比是比较相似的。但是比较友好的是，它的入参 <code>operations</code> 是 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/RedisOperations.java" target="_blank" rel="noopener">org.springframework.data.redis.core.RedisOperations</a> 接口类型，而 RedisTemplate 的各种操作，实际就是在 RedisOperations 接口中定义，由 RedisTemplate 来实现。</li>
<li>实际上，在实现 RedisCallback 接口，也能实现在同一个 Connection 执行一系列的 Redis 操作，因为 RedisCallback 的入参本身就是一个 Redis Connection 。</li>
</ul>
<h3 id="7-1-源码分析"><a href="#7-1-源码分析" class="headerlink" title="7.1 源码分析"></a>7.1 源码分析</h3><p>在生产中，Transaction 和 Pipeline 会经常一起时候用，从而提升性能。所以在 <code>RedisTemplate#executePipelined(SessionCallback&lt;?&gt; session, ...)</code> 方法中，提供了这种的功能。而在这个方法的实现上，本质和 <code>RedisTemplate#executePipelined(RedisCallback&lt;?&gt; action, ...)</code> 方法是基本一致的，差别在于<a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/core/RedisTemplate.java#L289" target="_blank" rel="noopener">这一行</a> ，替换成了调用 <code>#executeSession(SessionCallback&lt;?&gt; session)</code> 方法。所以，直接来看被调用的这个方法的实现。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisTemplate.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(SessionCallback&lt;T&gt; session)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	Assert.isTrue(initialized, <span class="string">"template not initialized; call afterPropertiesSet() before using it"</span>);</span><br><span class="line">	Assert.notNull(session, <span class="string">"Callback object must not be null"</span>);</span><br><span class="line"></span><br><span class="line">	RedisConnectionFactory factory = getRequiredConnectionFactory();</span><br><span class="line">	<span class="comment">// bind connection</span></span><br><span class="line">	<span class="comment">// &lt;1&gt; 获得并绑定 Connection 。</span></span><br><span class="line">	RedisConnectionUtils.bindConnection(factory, enableTransactionSupport);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	   <span class="comment">// &lt;2&gt; 执行定义的一系列 Redis 操作</span></span><br><span class="line">		<span class="keyword">return</span> session.execute(<span class="keyword">this</span>);</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="comment">// &lt;3&gt; 释放并解绑 Connection 。</span></span><br><span class="line">		RedisConnectionUtils.unbindConnection(factory);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1&gt;</code>处，调用 <code>RedisConnectionUtils#bindConnection(RedisConnectionFactory factory, boolean enableTranactionSupport)</code> 方法，实际和开启 <code>enableTranactionSupport</code> 事务时候，获取 Connection 和处理的方式，是一模一样的。也就是说：<ul>
<li>如果当前线程已经有一个绑定的 Connection 则直接使用（例如说，当前正在 Redis Transaction 事务中）；</li>
<li>如果当前线程未绑定一个 Connection ，则进行创建并绑定到当前线程。甚至，如果此时是配置开启 <code>enableTranactionSupport</code> 事务的，那么此处就会触发 Redis Transaction 的开启。</li>
</ul>
</li>
<li><code>&lt;2&gt;</code> 处，调用 <code>SessionCallback#execute(RedisOperations&lt;K, V&gt; operations)</code> 方法，执行定义的一系列的 Redis 操作。看看此处传入的参数是 <code>this</code> </li>
<li><code>&lt;3&gt;</code> 处，调用 <a href="https://github.com/spring-projects/spring-data-redis/blob/64b89137648f6c0e0c810c624e481bcfc0732f4e/src/main/java/org/springframework/data/redis/core/RedisConnectionUtils.java#L253" target="_blank" rel="noopener"><code>RedisConnectionUtils#unbindConnection(RedisConnectionFactory factory)</code></a> 方法，释放并解绑 Connection 。当前，前提是当前不存在激活的 Redis Transaction ，不然不就提早释放了嘛。</li>
</ul>
<h3 id="7-2-具体示例"><a href="#7-2-具体示例" class="headerlink" title="7.2 具体示例"></a>7.2 具体示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SessionTest.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SessionTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String result = stringRedisTemplate.execute(<span class="keyword">new</span> SessionCallback&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                    operations.opsForValue().set(String.format(<span class="string">"yunai:%d"</span>, i), <span class="string">"shuai02"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> (String) operations.opsForValue().get(String.format(<span class="string">"yunai:%d"</span>, <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"result:"</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>#test01()</code> 方法，结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result:shuai02</span><br></pre></td></tr></table></figure>



<h2 id="8-Pub-Sub"><a href="#8-Pub-Sub" class="headerlink" title="8. Pub/Sub"></a>8. Pub/Sub</h2><p>Redis 提供了 Pub/Sub 功能，实现简单的订阅功能</p>
<h3 id="8-1-具体示例"><a href="#8-1-具体示例" class="headerlink" title="8.1 具体示例"></a>8.1 具体示例</h3><p>Spring Data Redis 实现 Pub/Sub 的示例，主要分成两部分：</p>
<ul>
<li>配置 RedisMessageListenerContainer Bean 对象，并添加自己实现的 MessageListener 对象，用于监听处理相应的消息。</li>
<li>使用 RedisTemplate 发布消息。</li>
</ul>
<p>通过四个<strong>小</strong>步骤，来实现一个简单的示例。</p>
<p><strong>第一步，了解 Topic</strong></p>
<p><a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/listener/Topic.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.listener.Topic</code></a> 接口，表示 Redis 消息的 Topic 。它有两个子类实现：</p>
<ul>
<li>ChannelTopic ：对应 <a href="http://redis.cn/commands/subscribe.html" target="_blank" rel="noopener">SUBSCRIBE</a> 订阅命令。</li>
<li>PatternTopic ：对应 <a href="http://redis.cn/commands/psubscribe.html" target="_blank" rel="noopener">PSUBSCRIBE</a> 订阅命令。</li>
</ul>
<p><strong>第二步，实现 MessageListener 类</strong></p>
<p>创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-11/lab-07-spring-data-redis-with-jedis/src/main/java/cn/iocoder/springboot/labs/lab10/springdatarediswithjedis/listener/TestChannelTopicMessageListener.java" target="_blank" rel="noopener">TestChannelTopicMessageListener</a> 类，编写代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPatternTopicMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, <span class="keyword">byte</span>[] pattern)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"收到 PatternTopic 消息："</span>);</span><br><span class="line">        System.out.println(<span class="string">"线程编号："</span> + Thread.currentThread().getName());</span><br><span class="line">        System.out.println(<span class="string">"message："</span> + message);</span><br><span class="line">        System.out.println(<span class="string">"pattern："</span> + <span class="keyword">new</span> String(pattern));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>message</code> 参数，可获得到具体的消息内容，不过是二进制数组，需要自己序列化。具体可以看下 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/connection/DefaultMessage.java" target="_blank" rel="noopener"><code>org.springframework.data.redis.connection.DefaultMessage</code></a> 类。</li>
<li><code>pattern</code> 参数，发布的 Topic 的内容。</li>
</ul>
<p>有一点要注意，默认的 RedisMessageListenerContainer 情况下，MessageListener 是<strong>并发</strong>消费，在线程池中执行(具体见<a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/listener/RedisMessageListenerContainer.java#L982-L988" target="_blank" rel="noopener">传送门</a>代码)。所以如果想相同 MessageListener <strong>串行</strong>消费，可以在方法上加 <code>synchronized</code> 修饰，来实现同步。</p>
<p><strong>第三步，创建 RedisMessageListenerContainer Bean</strong></p>
<p>在 RedisConfiguration 中，配置 RedisMessageListenerContainer Bean 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RedisConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title">listenerContainer</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建 RedisMessageListenerContainer 对象</span></span><br><span class="line">    RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 RedisConnection 工厂。它就是实现多种 Java Redis 客户端接入的秘密工厂。</span></span><br><span class="line">    container.setConnectionFactory(factory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加监听器</span></span><br><span class="line">    container.addMessageListener(<span class="keyword">new</span> TestChannelTopicMessageListener(), <span class="keyword">new</span> ChannelTopic(<span class="string">"TEST"</span>));</span><br><span class="line"><span class="comment">//        container.addMessageListener(new TestChannelTopicMessageListener(), new ChannelTopic("AOTEMAN"));</span></span><br><span class="line"><span class="comment">//        container.addMessageListener(new TestPatternTopicMessageListener(), new PatternTopic("TEST"));</span></span><br><span class="line">    <span class="keyword">return</span> container;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要注意，虽然 RedisConnectionFactory 可以多次调用 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/listener/RedisMessageListenerContainer.java#L375-L396" target="_blank" rel="noopener"><code>#addMessageListener(MessageListener listener, Topic topic)</code></a> 方法，但是一定要都是相同的 Topic 类型。例如说，添加了 ChannelTopic 类型，就不能添加 PatternTopic 类型。为什么呢？因为 RedisMessageListenerContainer 是基于<strong>一次</strong> <a href="http://redis.cn/commands/subscribe.html" target="_blank" rel="noopener">SUBSCRIBE</a> 或 <a href="http://redis.cn/commands/psubscribe.html" target="_blank" rel="noopener">PSUBSCRIBE</a> 命令，所以不支持<strong>不同类型</strong>的 Topic 。当然，如果是<strong>相同类型</strong>的 Topic ，多个 MessageListener 是支持的。</p>
<p>那么，如果添加了 <code>&quot;Test&quot;</code> 给 MessageListener<strong>A</strong> ，<code>&quot;AOTEMAN&quot;</code> 给 MessageListener<strong>B</strong> ，两个 Topic 是怎么分发（Dispatch）的呢？在 RedisMessageListenerContainer 中，有个 <a href="https://github.com/spring-projects/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/listener/RedisMessageListenerContainer.java#L961-L988" target="_blank" rel="noopener">DispatchMessageListener</a> 分发器，负责将不同的 Topic 分发到配置的 MessageListener 中。看到此处，有木有想到 Spring MVC 的 DispatcherServlet 分发不同的请求到对应的 <code>@RequestMapping</code> 方法。</p>
<p><strong>第四步，使用 RedisTemplate 发布消息</strong></p>
<p>创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-11/lab-07-spring-data-redis-with-jedis/src/test/java/cn/iocoder/springboot/labs/lab10/springdatarediswithjedis/PubSubTest.java" target="_blank" rel="noopener">PubSubTest</a> 测试类，编写代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">PubSubTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC = <span class="string">"TEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            stringRedisTemplate.convertAndSend(TOPIC, <span class="string">"yunai:"</span> + i);</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过 <code>RedisTemplate#convertAndSend(String channel, Object message)</code> 方法，PUBLISH 消息。</li>
</ul>
<p>执行 <code>#test01()</code> 方法，运行结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">收到 ChannelTopic 消息：</span><br><span class="line">线程编号：listenerContainer-<span class="number">2</span></span><br><span class="line">message：yunai:<span class="number">0</span></span><br><span class="line">pattern：TEST</span><br><span class="line">收到 ChannelTopic 消息：</span><br><span class="line">线程编号：listenerContainer-<span class="number">3</span></span><br><span class="line">message：yunai:<span class="number">1</span></span><br><span class="line">pattern：TEST</span><br><span class="line">收到 ChannelTopic 消息：</span><br><span class="line">线程编号：listenerContainer-<span class="number">4</span></span><br><span class="line">message：yunai:<span class="number">2</span></span><br><span class="line">pattern：TEST</span><br></pre></td></tr></table></figure>

<ul>
<li>整整齐齐，发送和订阅都成功了。注意，<strong>线程编号</strong>。</li>
</ul>
<h2 id="9-Script"><a href="#9-Script" class="headerlink" title="9. Script"></a>9. Script</h2><p>Redis 提供 Lua 脚本，满足我们希望组合排列使用 Redis 的命令，保证<strong>串行</strong>执行的过程中，不存在并发的问题。同时，通过将多个命令组合在同一个 Lua 脚本中，一次请求，直接处理，也是一个提升性能的手段。</p>
<p><strong>第一步，编写 Lua 脚本</strong></p>
<p>创建 <code>resources/compareAndSet.lua</code> 脚本，实现 CAS 功能。代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.call(<span class="string">'GET'</span>, KEYS[<span class="number">1</span>]) ~= ARGV[<span class="number">1</span>] <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">redis.call(<span class="string">'SET'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第 1 到 3 行：判断 <code>KEYS[1]</code> 对应的 VALUE 是否为 <code>ARGV[1]</code> 值。如果不是（Lua 中不等于使用 <code>~=</code>），则直接返回 0 表示失败。</li>
<li>第 4 到 5 行：设置 <code>KEYS[1]</code> 对应的 VALUE 为新值 <code>ARGV[2]</code> ，并返回 1 表示成功。</li>
</ul>
<p><strong>第二步，调用 Lua 脚本</strong></p>
<p>创建 <a href="https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-11/lab-07-spring-data-redis-with-jedis/src/test/java/cn/iocoder/springboot/labs/lab10/springdatarediswithjedis/ScriptTest.java" target="_blank" rel="noopener">ScriptTest</a> 测试类，编写代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ScriptTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// &lt;1.1&gt; 读取 /resources/lua/compareAndSet.lua 脚本 。注意，需要引入下 commons-io 依赖。</span></span><br><span class="line">        String  scriptContents = IOUtils.toString(getClass().getResourceAsStream(<span class="string">"/lua/compareAndSet.lua"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="comment">// &lt;1.2&gt; 创建 RedisScript 对象</span></span><br><span class="line">        RedisScript&lt;Long&gt; script = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;(scriptContents, Long<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">// &lt;2&gt; 执行 LUA 脚本</span></span><br><span class="line">        Long result = stringRedisTemplate.execute(script, Collections.singletonList(<span class="string">"yunai:1"</span>), <span class="string">"shuai02"</span>, <span class="string">"shuai"</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;1.1&gt;</code> 行，读取 <code>/resources/lua/compareAndSet.lua</code> 脚本。注意，需要引入下 <code>commons-io</code> 依赖。</li>
<li><code>&lt;1.2&gt;</code> 行，创建 DefaultRedisScript 对象。第一个参数是脚本内容( <code>scriptSource</code> )，第二个是脚本执行返回值( <code>resultType</code> )。</li>
<li><code>&lt;2&gt;</code> 处，调用 <a href="https://github.com/spring-projects/spring-data-redis/blob/64b89137648f6c0e0c810c624e481bcfc0732f4e/src/main/java/org/springframework/data/redis/core/RedisTemplate.java#L342-L360" target="_blank" rel="noopener"><code>RedisTemplate#execute(RedisScript script, List keys, Object... args)</code></a> 方法，发送 Redis 执行 LUA 脚本。</li>
</ul>
<h2 id="10-尝试-Redisson"><a href="#10-尝试-Redisson" class="headerlink" title="10. 尝试 Redisson"></a>10. 尝试 Redisson</h2><p>这是 <strong>Java 最强的 Redis 客户端</strong>！除了提供了 Redis 客户端的常见操作之外，还提供了 Redis 分布式锁、BloomFilter 布隆过滤器等强大的功能。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 实现对 Redisson 的自动化配置 --&gt;</span> <span class="comment">&lt;!-- X --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 方便等会写单元测试 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 等会示例会使用 fastjson 作为 JSON 序列化的工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.61<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Data Redis 默认使用 Jackson 作为 JSON 序列化的工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 对应 RedisProperties 类</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line"><span class="comment">#    password: # Redis 服务器密码，默认为空。生产中，一定要设置 Redis 密码！</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># Redis 数据库号，默认为 0 。</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span> <span class="comment"># Redis 连接超时时间，单位：毫秒。</span></span><br><span class="line">    <span class="comment"># 对应 RedissonProperties 类</span></span><br><span class="line">    <span class="attr">redisson:</span></span><br><span class="line">      <span class="attr">config:</span> <span class="string">classpath:redisson.yml</span> <span class="comment"># 具体的每个配置项，见 org.redisson.config.Config 类。</span></span><br></pre></td></tr></table></figure>

<p><strong>1）去掉 Jedis 相关的配置项</strong></p>
<p><strong>2）增加 <code>redisson.config</code> 配置</strong></p>
<p>如下是 Redisson 的每个配置项的解释：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">clusterServersConfig:</span></span><br><span class="line">  <span class="comment"># 连接空闲超时 如果当前连接池里的连接数量超过了最小空闲连接数，而同时有连接空闲时间超过了该数值，那么这些连接将会自动被关闭，并从连接池里去掉。时间单位是毫秒。</span></span><br><span class="line">  <span class="attr">idleConnectionTimeout:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">pingTimeout:</span> <span class="number">1000</span></span><br><span class="line">  <span class="comment"># 连接超时</span></span><br><span class="line">  <span class="attr">connectTimeout:</span> <span class="number">10000</span></span><br><span class="line">  <span class="comment"># 命令等待超时</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="comment"># 命令失败重试次数</span></span><br><span class="line">  <span class="attr">retryAttempts:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 命令重试发送时间间隔</span></span><br><span class="line">  <span class="attr">retryInterval:</span> <span class="number">1500</span></span><br><span class="line">  <span class="comment"># 重新连接时间间隔</span></span><br><span class="line">  <span class="attr">reconnectionTimeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="comment"># failedAttempts</span></span><br><span class="line">  <span class="attr">failedAttempts:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 密码</span></span><br><span class="line">  <span class="attr">password:</span> <span class="literal">null</span></span><br><span class="line">  <span class="comment"># 单个连接最大订阅数量</span></span><br><span class="line">  <span class="attr">subscriptionsPerConnection:</span> <span class="number">5</span></span><br><span class="line">  <span class="comment"># 客户端名称</span></span><br><span class="line">  <span class="attr">clientName:</span> <span class="literal">null</span></span><br><span class="line">  <span class="comment">#负载均衡算法类的选择  默认轮询调度算法RoundRobinLoadBalancer</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> <span class="string">!&lt;org.redisson.connection.balancer.RoundRobinLoadBalancer&gt;</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">slaveSubscriptionConnectionMinimumIdleSize:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">slaveSubscriptionConnectionPoolSize:</span> <span class="number">50</span></span><br><span class="line">  <span class="comment"># 从节点最小空闲连接数</span></span><br><span class="line">  <span class="attr">slaveConnectionMinimumIdleSize:</span> <span class="number">32</span></span><br><span class="line">  <span class="comment"># 从节点连接池大小</span></span><br><span class="line">  <span class="attr">slaveConnectionPoolSize:</span> <span class="number">64</span></span><br><span class="line">  <span class="comment"># 主节点最小空闲连接数</span></span><br><span class="line">  <span class="attr">masterConnectionMinimumIdleSize:</span> <span class="number">32</span></span><br><span class="line">  <span class="comment"># 主节点连接池大小</span></span><br><span class="line">  <span class="attr">masterConnectionPoolSize:</span> <span class="number">64</span></span><br><span class="line">  <span class="comment"># 只在从服务节点里读取</span></span><br><span class="line">  <span class="attr">readMode:</span> <span class="string">"SLAVE"</span></span><br><span class="line">  <span class="comment"># 主节点信息</span></span><br><span class="line">  <span class="attr">nodeAddresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"redis://192.168.56.128:7000"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"redis://192.168.56.128:7001"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"redis://192.168.56.128:7002"</span></span><br><span class="line">  <span class="comment">#集群扫描间隔时间 单位毫秒</span></span><br><span class="line">  <span class="attr">scanInterval:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">threads:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">nettyThreads:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">codec:</span> <span class="string">!&lt;org.redisson.codec.JsonJacksonCodec&gt;</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意</strong> <strong>注意</strong> <strong>注意</strong></p>
<p>如果 <code>redisson.config</code> 对应的配置文件，如果没有配置任何内容，需要在 <code>application.yml</code> 里注释掉 <code>redisson.config</code> 。像这样：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 对应 RedisProperties 类</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line"><span class="comment">#    password: # Redis 服务器密码，默认为空。生产中，一定要设置 Redis 密码！</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># Redis 数据库号，默认为 0 。</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">0</span> <span class="comment"># Redis 连接超时时间，单位：毫秒。</span></span><br><span class="line">    <span class="comment"># 对应 RedissonProperties 类</span></span><br><span class="line"><span class="comment">#    redisson:</span></span><br><span class="line"><span class="comment">#      config: classpath:redisson.yml # 具体的每个配置项，见 org.redisson.config.Config 类。</span></span><br></pre></td></tr></table></figure>



<h2 id="11-Redis-分布式锁"><a href="#11-Redis-分布式锁" class="headerlink" title="11. Redis 分布式锁"></a>11. Redis 分布式锁</h2><p>编写一个简单使用 Redisson 提供的可重入锁 RLock 的示例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">LockTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOCK_KEY = <span class="string">"anylock"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// &lt;2.1&gt; 启动一个线程 A ，去占有锁</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 加锁以后 10 秒钟自动解锁</span></span><br><span class="line">                <span class="comment">// 无需调用 unlock 方法手动解锁</span></span><br><span class="line">                <span class="keyword">final</span> RLock lock = redissonClient.getLock(LOCK_KEY);</span><br><span class="line">                lock.lock(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="comment">// &lt;2.2&gt; 简单 sleep 1 秒，保证线程 A 成功持有锁</span></span><br><span class="line">        Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &lt;3&gt; 尝试加锁，最多等待 100 秒，上锁以后 10 秒自动解锁</span></span><br><span class="line">        System.out.println(String.format(<span class="string">"准备开始获得锁时间：%s"</span>, <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-DD HH:mm:ss"</span>).format(<span class="keyword">new</span> Date())));</span><br><span class="line">        <span class="keyword">final</span> RLock lock = redissonClient.getLock(LOCK_KEY);</span><br><span class="line">        <span class="keyword">boolean</span> res = lock.tryLock(<span class="number">100</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (res) &#123;</span><br><span class="line">            System.out.println(String.format(<span class="string">"实际获得锁时间：%s"</span>, <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-DD HH:mm:ss"</span>).format(<span class="keyword">new</span> Date())));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"加锁失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>整个测试用例，意图是：1）启动一个线程 A ，先去持有锁 10 秒然后释放；2）主线程，也去尝试去持有锁，因为线程 A 目前正在占用着该锁，所以需要等待线程 A 释放到该锁，才能持有成功。</li>
<li><code>&lt;1&gt;</code> 处，注入 RedissonClient 对象。因为需要使用 Redisson 独有的功能，所以需要使用到它。</li>
<li><code>&lt;2.1&gt;</code> 处，启动线程 A ，然后调用 <code>RLock#lock(long leaseTime, TimeUnit unit)</code> 方法，加锁以后 10 秒钟自动解锁，无需调用 unlock 方法手动解锁。</li>
<li><code>&lt;2.2&gt;</code> 处，简单 sleep 1 秒，保证线程 A 成功持有锁。</li>
<li><code>&lt;3&gt;</code> 处，主线程，调用 <code>RLock#tryLock(long waitTime, long leaseTime, TimeUnit unit)</code> 方法，尝试加锁，最多等待 100 秒，上锁以后 10 秒自动解锁。</li>
</ul>
<p>执行 <code>#test()</code> 测试用例，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">准备开始获得锁时间：2019-10-274 00:44:08</span><br><span class="line">实际获得锁时间：2019-10-274 00:44:17</span><br></pre></td></tr></table></figure>

<ul>
<li>9 秒后（因为 sleep 了 1 秒），主线程成功获得到 Redis 分布式锁，符合预期。</li>
</ul>
<h2 id="12-Redis-限流器"><a href="#12-Redis-限流器" class="headerlink" title="12. Redis 限流器"></a>12. Redis 限流器</h2><p>限流算法，常用的分成四种：</p>
<ul>
<li>计数器：每<strong>固定单位</strong>一个计数器即可实现。</li>
<li>滑动窗口：Redisson 提供的是基于<strong>滑动窗口</strong> RateLimiter 的实现。相比<strong>计数器</strong>的实现，它的起点不是固定的，而是以开始计数的那个时刻开始为一个窗口。所以，可以把<strong>计数器</strong>理解成一个滑动窗口的特例，以<strong>固定单位</strong>为一个窗口。</li>
<li>令牌桶算法</li>
<li>漏桶算法：<ul>
<li>令牌桶算法，桶里装的是令牌。每次能拿取到令牌，就可以进行访问。并且，令牌会按照速率不断恢复放到令牌桶中直到桶满。</li>
<li>漏桶算法，桶里装的是请求。当桶满了，请求就进不来。例如说，Hystrix 使用线程池或者 Semaphore 信号量，只有在请求未满的时候，才可以进行执行。</li>
</ul>
</li>
</ul>
<p><strong>Redisson 提供的是基于滑动窗口 RateLimiter 的实现</strong></p>
<h3 id="12-1-具体示例"><a href="#12-1-具体示例" class="headerlink" title="12. 1 具体示例"></a>12. 1 具体示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RateLimiterTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 RRateLimiter 对象</span></span><br><span class="line">        RRateLimiter rateLimiter = redissonClient.getRateLimiter(<span class="string">"myRateLimiter"</span>);</span><br><span class="line">        <span class="comment">// 初始化：最大流速 = 每 1 秒钟产生 2 个令牌</span></span><br><span class="line">        rateLimiter.trySetRate(RateType.OVERALL, <span class="number">2</span>, <span class="number">1</span>, RateIntervalUnit.SECONDS);</span><br><span class="line"><span class="comment">//        rateLimiter.trySetRate(RateType.PER_CLIENT, 50, 1, RateIntervalUnit.MINUTES);</span></span><br><span class="line"></span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            System.out.println(String.format(<span class="string">"%s：获得锁结果(%s)"</span>, simpleDateFormat.format(<span class="keyword">new</span> Date()),</span><br><span class="line">                    rateLimiter.tryAcquire()));</span><br><span class="line">            Thread.sleep(<span class="number">250L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>#test()</code> 测试用例，结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">40</span>：获得锁结果(<span class="keyword">true</span>)</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">40</span>：获得锁结果(<span class="keyword">true</span>)</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">41</span>：获得锁结果(<span class="keyword">false</span>)</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">41</span>：获得锁结果(<span class="keyword">false</span>)</span><br><span class="line"><span class="number">2019</span>-<span class="number">10</span>-<span class="number">02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">41</span>：获得锁结果(<span class="keyword">true</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>第 1、2 次，成功获取锁。</li>
<li>第 3、4 次，因为每 1 秒产生 2 个令牌，所以被限流了。</li>
<li>第 5 次，已经过了 1 秒，所以获得令牌成功。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/03/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE-SpringBoot-Redis%E5%85%A5%E9%97%A8/" data-id="ckbg9kud0001l2r073sbe3go3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">Spring Boot-基础-01</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/" rel="tag">数据访问</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CI-CD/" rel="tag">CI/CD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache/" rel="tag">Cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gitea/" rel="tag">Gitea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JPA/" rel="tag">JPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-%E5%9F%BA%E7%A1%80-01/" rel="tag">Java 基础-01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jetty/" rel="tag">Jetty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SPring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">SPring Boot-基础-01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" rel="tag">Spring Boot-基础-01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-02/" rel="tag">Spring Boot-基础-02</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" rel="tag">Spring Boot-基础01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/" rel="tag">SpringMVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swagger/" rel="tag">Swagger</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TeamCity/" rel="tag">TeamCity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Undertow/" rel="tag">Undertow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Validation/" rel="tag">Validation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebFlux/" rel="tag">WebFlux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebSocket/" rel="tag">WebSocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" rel="tag">分布式锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" rel="tag">基准测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag">基础知识</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%B9%E5%99%A8/" rel="tag">容器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/" rel="tag">数据库连接池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/" rel="tag">数据访问</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88/" rel="tag">集合</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CI-CD/" style="font-size: 10px;">CI/CD</a> <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Gitea/" style="font-size: 10px;">Gitea</a> <a href="/tags/JPA/" style="font-size: 10px;">JPA</a> <a href="/tags/Java/" style="font-size: 18px;">Java</a> <a href="/tags/Java-%E5%9F%BA%E7%A1%80-01/" style="font-size: 12px;">Java 基础-01</a> <a href="/tags/Jenkins/" style="font-size: 10px;">Jenkins</a> <a href="/tags/Jetty/" style="font-size: 10px;">Jetty</a> <a href="/tags/MyBatis/" style="font-size: 10px;">MyBatis</a> <a href="/tags/Redis/" style="font-size: 12px;">Redis</a> <a href="/tags/SPring-Boot-%E5%9F%BA%E7%A1%80-01/" style="font-size: 10px;">SPring Boot-基础-01</a> <a href="/tags/Spring-Boot/" style="font-size: 20px;">Spring Boot</a> <a href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-01/" style="font-size: 16px;">Spring Boot-基础-01</a> <a href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%80-02/" style="font-size: 10px;">Spring Boot-基础-02</a> <a href="/tags/Spring-Boot-%E5%9F%BA%E7%A1%8001/" style="font-size: 16px;">Spring Boot-基础01</a> <a href="/tags/SpringMVC/" style="font-size: 10px;">SpringMVC</a> <a href="/tags/Swagger/" style="font-size: 10px;">Swagger</a> <a href="/tags/TeamCity/" style="font-size: 10px;">TeamCity</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/Undertow/" style="font-size: 10px;">Undertow</a> <a href="/tags/Validation/" style="font-size: 10px;">Validation</a> <a href="/tags/Web/" style="font-size: 14px;">Web</a> <a href="/tags/WebFlux/" style="font-size: 10px;">WebFlux</a> <a href="/tags/WebSocket/" style="font-size: 10px;">WebSocket</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 10px;">分布式锁</a> <a href="/tags/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">基准测试</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">基础</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 10px;">基础知识</a> <a href="/tags/%E5%AE%B9%E5%99%A8/" style="font-size: 10px;">容器</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/" style="font-size: 10px;">数据库连接池</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/" style="font-size: 12px;">数据访问</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">线程池</a> <a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 10px;">缓存</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 12px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88/" style="font-size: 10px;">集合</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 10px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/04/15/%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/gitea_%E5%AE%89%E8%A3%85%E5%91%BD%E4%BB%A4/">Gitea 安装命令</a>
          </li>
        
          <li>
            <a href="/2021/04/12/docker/docker_%E5%91%BD%E4%BB%A4/">docker 命令</a>
          </li>
        
          <li>
            <a href="/2020/07/27/TeamCityVSJenkins%E9%80%89%E6%8B%A9%E6%AD%A3%E7%A1%AE%E7%9A%84CI-CD%E5%B7%A5%E5%85%B7/">TeamCityVSJenkins选择正确的CI/CD工具</a>
          </li>
        
          <li>
            <a href="/2020/07/27/SpringMvc-%E5%9F%BA%E7%A1%80/">SpringMvc-基础</a>
          </li>
        
          <li>
            <a href="/2020/07/17/Redis-%E5%9F%BA%E4%BA%8ERedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">Redis-基于Redis分布式锁</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>